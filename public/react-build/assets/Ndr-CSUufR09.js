import{a as Re,b as De,r as o,j as e}from"./index-B_YWOrie.js";import{R as Pe,S as Le}from"./search-B91U6_p5.js";import{P as Fe}from"./phone-CT70hgbi.js";const Me=({shop:le})=>{const[ie]=Re(),de=De(),R=le||ie.get("shop"),[N,Q]=o.useState([]),[b,F]=o.useState(!0),[v,I]=o.useState(""),[A,W]=o.useState(""),[D,K]=o.useState("all"),[P,X]=o.useState("all"),[he,Y]=o.useState(!1),[u,q]=o.useState("nimbuspost"),[Z,me]=o.useState(!1),[ee,ue]=o.useState(!1),[g,_]=o.useState(new Set),[se,f]=o.useState(!1),[te,U]=o.useState(!1),[ne,j]=o.useState(0),[E,S]=o.useState(""),[re,ae]=o.useState(null),pe=s=>{if(s==null)return 0;if(typeof s=="number")return s;if(typeof s=="string"){const t=s.replace(/[^0-9.-]/g,""),n=parseFloat(t);return Number.isNaN(n)?0:n}return 0},B=o.useMemo(()=>{let s=0,t=null;return N.forEach(n=>{const c=pe(n.order_total_price||n.orderTotalPrice||n.total_price||n.order_value||n.value);c>0&&(s+=c,t||(t=(n.order_currency||n.currency||"").toString().trim()||"INR"))}),{total:s,currency:t}},[N]),ge=(s,t)=>{if(!s||s<=0)return"";const n=t&&t.length===3?t:"INR";try{return new Intl.NumberFormat("en-IN",{style:"currency",currency:n,maximumFractionDigits:2}).format(s)}catch{const r=new Intl.NumberFormat("en-IN",{maximumFractionDigits:2});return`${t&&t.length!==3?t:"â‚¹"} ${r.format(s)}`}},[Ne,$]=o.useState(!1),[fe,V]=o.useState(!1),[x,xe]=o.useState("re-attempt"),[i,w]=o.useState({re_attempt_date:"",name:"",address_1:"",address_2:"",phone:""}),[M,C]=o.useState(!1),[be,O]=o.useState(null),je=o.useMemo(()=>{const s=new Set;return N.forEach(t=>{const n=t.courier_remarks||t.reason||"";n&&n!=="N/A"&&s.add(n)}),Array.from(s).sort()},[N]),ve=o.useMemo(()=>{const s=new Set;return N.forEach(t=>{const n=t.total_attempts||t.attempts||"";n&&n!=="N/A"&&s.add(String(n))}),Array.from(s).sort((t,n)=>parseInt(t)-parseInt(n))},[N]),p=o.useMemo(()=>N.filter(s=>{if(A.trim()){const t=A.toLowerCase(),n=(s.awb_number||s.awb||"").toString().toLowerCase(),c=(s.order_number||s.orderNumber||s.order_id||"").toString().toLowerCase(),r=(s.customer_name||s.customerName||s.name||"").toLowerCase(),a=(s.phone||s.customer_phone||s.phoneNumber||"").toString().toLowerCase(),l=(s.address||s.customer_address||s.delivery_address||"").toLowerCase(),m=(s.courier_remarks||s.reason||"").toLowerCase();if(!(n.includes(t)||c.includes(t)||r.includes(t)||a.includes(t)||l.includes(t)||m.includes(t)))return!1}return!(D!=="all"&&String(s.total_attempts||s.attempts||"")!==D||P!=="all"&&(s.courier_remarks||s.reason||"")!==P)}),[N,A,D,P]);o.useEffect(()=>{p.length>0?f(g.size===p.length):f(!1)},[p.length,g.size]);const _e=(s,t=0)=>{const n=s.awb_number||s.awb||"N/A";return n!=="N/A"?n:t};o.useEffect(()=>{(async()=>{try{console.log("[NDR] Checking aggregator connections...");let t=!1;try{const r=await fetch("/api/nimbuspost/status",{credentials:"include"});r.ok&&(t=(await r.json()).connected||!1,me(t),console.log("[NDR] NimbusPost connected:",t))}catch(r){console.error("Error checking NimbusPost:",r)}let n=!1;try{const r=await fetch("/api/shiprocket/status",{credentials:"include"});r.ok&&(n=(await r.json()).connected||!1,ue(n),console.log("[NDR] Shiprocket connected:",n))}catch(r){console.error("Error checking Shiprocket:",r)}console.log("[NDR] Connection status - NimbusPost:",t,"Shiprocket:",n);const c=t||n;Y(c),c?t&&(!n||u==="nimbuspost")?(q("nimbuspost"),L("nimbuspost")):n&&(q("shiprocket"),L("shiprocket")):(F(!1),I("No aggregator connected. Please connect NimbusPost or Shiprocket in Settings."))}catch(t){console.error("Error checking connections:",t),F(!1),Y(!1),I("Failed to check connection status.")}})()},[R]);const L=async(s=u)=>{F(!0),I(""),j(5),S("Initializing"),ae(null);try{const n=await fetch(s==="shiprocket"?"/api/shiprocket/ndr-list":"/api/nimbuspost/ndr-list",{credentials:"include"});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);S("Counting orders"),j(12);const c=n.headers.get("content-length"),r=c?parseInt(c,10):null;let a;if(n.body&&(r||n.body.getReader)){S("Fetching orders");const l=n.body.getReader(),m=new TextDecoder;let h=0,d="",y=performance.now();for(;;){const{done:z,value:k}=await l.read();if(z)break;h+=k.length,d+=m.decode(k,{stream:!0});const T=performance.now();if(T-y>120){if(r){const H=12+Math.min(h/r,1)*70;j(H)}else j(H=>Math.min(H+5,80));y=T}}d+=m.decode(),a=JSON.parse(d)}else S("Fetching orders"),j(60),a=await n.json();if(j(l=>Math.max(l,85)),S("Storing orders"),a.success&&Array.isArray(a.ndrList))console.log("NDR List received:",a.ndrList.length,"records"),console.log("First record (full):",JSON.stringify(a.ndrList[0],null,2)),console.log("First record order_number:",a.ndrList[0]?.order_number),console.log("First record customer_name:",a.ndrList[0]?.customer_name),console.log("First record phone:",a.ndrList[0]?.phone),console.log("First record address:",a.ndrList[0]?.address),Q(a.ndrList),ae(a.ndrList.length||0),j(100),S("Done");else throw new Error(a.error||"Invalid response format")}catch(t){console.error("Error loading NDR list:",t),I(t.message||"Failed to load NDR list"),Q([])}finally{setTimeout(()=>{F(!1),S(""),j(0)},300)}},Se=async s=>{console.log("ðŸ”„ Switching aggregator to:",s),q(s),await L(s)},we=async()=>{await L(u)},Ce=s=>{const t=new Set(g);t.has(s)?t.delete(s):t.add(s),_(t),f(t.size===p.length&&p.length>0)},Ae=()=>{if(se)_(new Set),f(!1);else{const s=new Set(p.map((t,n)=>{const c=t.awb_number||t.awb||"N/A";return c!=="N/A"?c:n}));_(s),f(!0)}},ye=async s=>{await oe([s])},G=()=>{V(!1),O(null)},oe=async(s=null)=>{if(!s&&g.size===0){alert("Please select at least one NDR item to call");return}U(!0);try{const t=s||p.filter((d,y)=>g.has(_e(d,y))),n=[];if(t.forEach(d=>{d.order_id&&d.order_id!=="N/A"?n.push(String(d.order_id)):d.order_number&&d.order_number!=="N/A"&&n.push(d.order_number)}),n.length===0){alert("âŒ Could not find order IDs for selected NDR items. Please ensure orders have order_id or order_number from bulk tracking."),U(!1);return}const c=`Order ID
`+n.join(`
`),r=new Blob([c],{type:"text/csv"}),a=new File([r],`ndr-campaign-${Date.now()}.csv`,{type:"text/csv"}),l=new FormData;l.append("csvFile",a),l.append("shop",R);const h=await(await fetch(`/api/upload-csv?shop=${encodeURIComponent(R)}`,{method:"POST",body:l,credentials:"include"})).json();h.success?(_(new Set),f(!1),de(`/campaigns?shop=${encodeURIComponent(R||"")}`)):alert(`âŒ Failed to create campaign: ${h.error||"Unknown error"}`)}catch(t){console.error("Error creating campaign:",t),alert(`âŒ Error creating campaign: ${t.message}`)}finally{U(!1)}},ce=(s=null,t=null)=>{if(!s&&g.size===0){alert("Please select at least one NDR item");return}if(u!=="nimbuspost"){alert("NDR actions are only available for NimbusPost at this time.");return}s&&t!==null?(_(new Set([t])),f(!1),O(s)):O(null),$(!0)},J=(s,t=null)=>{$(!1),xe(s);const n=t||be;w(n?{re_attempt_date:"",name:n.customer_name||n.customerName||"",address_1:(n.address||n.customer_address||"").split(",")[0]||"",address_2:(n.address||n.customer_address||"").split(",").slice(1).join(",")||"",phone:n.phone||n.customer_phone||""}:{re_attempt_date:"",name:"",address_1:"",address_2:"",phone:""}),V(!0)},ke=async()=>{if(u!=="nimbuspost"){alert("NDR actions are only available for NimbusPost at this time.");return}C(!0);try{const s=p.filter((r,a)=>{const l=r.awb_number||r.awb||"N/A",m=l!=="N/A"?l:a;return g.has(m)});if(s.length===0){alert("Please select at least one NDR item"),C(!1);return}const t=s.map(r=>{const a=r.awb_number||r.awb;if(!a||a==="N/A")return null;const l={awb:a};if(x==="re-attempt"){if(!i.re_attempt_date)return alert("Please enter a re-attempt date"),C(!1),null;l.action="re-attempt",l.action_data={re_attempt_date:i.re_attempt_date}}else if(x==="change_address"){if(!i.name||!i.address_1)return alert("Please enter customer name and address"),C(!1),null;l.action="change_address",l.action_data={name:i.name,address_1:i.address_1,address_2:i.address_2||""}}else if(x==="change_phone"){if(!i.phone)return alert("Please enter a phone number"),C(!1),null;l.action="change_phone",l.action_data={phone:i.phone}}return l}).filter(Boolean);if(t.length===0){C(!1);return}const c=await(await fetch("/api/nimbuspost/ndr-action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({actions:t}),credentials:"include"})).json();if(c.success){const r=c.results||[],a=r.filter(h=>h.status===!0).length,l=r.filter(h=>h.status===!1).length;let m=`âœ… NDR Action submitted!

ðŸ“Š Results:
â€¢ Successful: ${a}
â€¢ Failed: ${l}`;if(l>0){const h=r.filter(d=>d.status===!1).map(d=>`  â€¢ ${d.awb}: ${d.message}`).join(`
`);m+=`

âŒ Failures:
${h}`}alert(m),await L(u),_(new Set),f(!1),O(null),V(!1)}else alert(`âŒ NDR Action failed: ${c.error||"Unknown error"}`)}catch(s){console.error("Error submitting NDR action:",s),alert(`âŒ Error submitting NDR action: ${s.message}`)}finally{C(!1)}};return he?e.jsx("div",{className:"ndr-page",children:e.jsxs("div",{className:"ndr-container",children:[e.jsxs("div",{className:"ndr-header",children:[e.jsx("div",{children:e.jsx("h1",{className:"ndr-title",children:"NDR Orders"})}),e.jsxs("div",{className:"ndr-header-actions",children:[(Z||ee)&&e.jsxs("select",{className:"ndr-aggregator-select",value:u,onChange:s=>Se(s.target.value),disabled:b,children:[Z&&e.jsx("option",{value:"nimbuspost",children:"NimbusPost"}),ee&&e.jsx("option",{value:"shiprocket",children:"Shiprocket"})]}),e.jsx("button",{className:"ndr-btn-refresh",onClick:we,disabled:b,children:e.jsx(Pe,{size:16,className:b?"spinning":""})})]})]}),!b&&!v&&N.length>0&&e.jsxs("div",{className:"ndr-stats-card",children:[e.jsx("div",{className:"ndr-stat-value",children:p.length}),e.jsx("div",{className:"ndr-stat-label",children:"Action Pending"})]}),e.jsxs("div",{className:"ndr-filters-section",children:[e.jsxs("div",{className:"ndr-search-wrapper",children:[e.jsx(Le,{size:16,className:"ndr-search-icon"}),e.jsx("input",{type:"text",className:"ndr-search-input",placeholder:"Search...",value:A,onChange:s=>W(s.target.value)})]}),e.jsxs("div",{className:"ndr-filters-row",children:[e.jsxs("select",{className:"ndr-filter-select",value:D,onChange:s=>K(s.target.value),children:[e.jsx("option",{value:"all",children:"All Attempts"}),ve.map(s=>e.jsxs("option",{value:s,children:[s," ",s==="1"?"Attempt":"Attempts"]},s))]}),e.jsxs("select",{className:"ndr-filter-select",value:P,onChange:s=>X(s.target.value),children:[e.jsx("option",{value:"all",children:"All Reasons"}),je.map(s=>e.jsx("option",{value:s,children:s},s))]}),(D!=="all"||P!=="all"||A.trim())&&e.jsx("button",{className:"ndr-clear-filters",onClick:()=>{K("all"),X("all"),W("")},children:"Clear"})]})]}),v&&e.jsxs("div",{className:"ndr-error-message",children:[e.jsx(AlertCircle,{size:16}),e.jsx("span",{children:v})]}),b&&e.jsxs("div",{className:"ndr-progress-card",children:[e.jsxs("div",{className:"ndr-progress-header",children:[e.jsx("span",{children:"Preparing NDR list"}),e.jsxs("span",{children:[Math.min(100,Math.round(ne)),"%"]})]}),e.jsx("div",{className:"ndr-progress-bar",children:e.jsx("div",{className:"ndr-progress-fill",style:{width:`${Math.min(100,Math.round(ne))}%`}})}),e.jsx("div",{className:"ndr-progress-stage",children:E||"Starting..."}),e.jsx("div",{className:"ndr-progress-steps",children:["Counting orders","Fetching orders","Storing orders"].map(s=>{const t=["Counting orders","Fetching orders","Storing orders"],n=t.indexOf(E),c=t.indexOf(s),r=s===E,a=E==="Done"||n>c&&n!==-1;return e.jsx("span",{className:`ndr-progress-step ${r?"active":""} ${a?"completed":""}`,children:s},s)})})]}),!b&&!v&&re!==null&&e.jsxs("div",{className:"ndr-info-row",children:[e.jsxs("div",{className:"ndr-found-indicator",children:[e.jsxs("div",{className:"ndr-found-count",children:[re," NDR found"]}),e.jsx("div",{className:"ndr-found-text",children:"Fetching complete. Ready for actions."})]}),B.total>0&&e.jsxs("div",{className:"ndr-value-indicator",children:[e.jsx("div",{className:"ndr-value-title",children:"Total Goods Value"}),e.jsx("div",{className:"ndr-value-amount",children:ge(B.total,B.currency)}),e.jsx("div",{className:"ndr-value-caption",children:"Based on matched orders"})]})]}),!b&&!v&&g.size>0&&e.jsxs("div",{className:"ndr-bulk-actions",children:[e.jsxs("span",{className:"ndr-selected-count",children:[g.size," selected"]}),e.jsxs("div",{className:"ndr-bulk-buttons",children:[e.jsxs("button",{className:"ndr-btn-bulk-call",onClick:oe,disabled:te,children:[e.jsx(Fe,{size:16}),e.jsx("span",{children:te?"Processing...":"AI Call"})]}),u==="nimbuspost"&&e.jsx("button",{className:"ndr-btn-action",onClick:()=>ce(),disabled:M,children:"Submit Action"}),e.jsx("button",{className:"ndr-btn-clear",onClick:()=>{_(new Set),f(!1)},children:"Clear"})]})]}),Ne&&e.jsx("div",{className:"ndr-modal-overlay",onClick:()=>$(!1),children:e.jsxs("div",{className:"ndr-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"ndr-modal-header",children:[e.jsx("h3",{children:"Select Action"}),e.jsx("button",{className:"ndr-modal-close",onClick:()=>$(!1),children:"Ã—"})]}),e.jsx("div",{className:"ndr-modal-body",children:e.jsxs("div",{className:"ndr-action-options",children:[e.jsxs("button",{className:"ndr-action-option-btn",onClick:()=>J("re-attempt"),children:[e.jsx("div",{className:"ndr-action-option-title",children:"Re-Attempt Delivery"}),e.jsx("div",{className:"ndr-action-option-desc",children:"Schedule a new delivery attempt"})]}),e.jsxs("button",{className:"ndr-action-option-btn",onClick:()=>J("change_address"),children:[e.jsx("div",{className:"ndr-action-option-title",children:"Change Address"}),e.jsx("div",{className:"ndr-action-option-desc",children:"Update customer delivery address"})]}),e.jsxs("button",{className:"ndr-action-option-btn",onClick:()=>J("change_phone"),children:[e.jsx("div",{className:"ndr-action-option-title",children:"Change Phone"}),e.jsx("div",{className:"ndr-action-option-desc",children:"Update customer phone number"})]})]})})]})}),!b&&!v&&e.jsx(e.Fragment,{children:p.length===0?e.jsx("div",{className:"ndr-empty",children:e.jsxs("p",{children:["No NDR records found",A?" matching your search":"","."]})}):e.jsx("div",{className:"ndr-table-wrapper",children:e.jsxs("table",{className:"ndr-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"40px"},children:e.jsx("input",{type:"checkbox",checked:se,onChange:Ae,style:{cursor:"pointer"}})}),e.jsx("th",{children:"Aggregator"}),e.jsx("th",{children:"AWB Number"}),e.jsx("th",{children:"Order Number"}),e.jsx("th",{children:"Customer Name"}),e.jsx("th",{children:"Phone"}),e.jsx("th",{children:"Address"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Attempts"}),u==="nimbuspost"&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:p.map((s,t)=>{const n=s.awb_number||s.awb||"N/A",c=n!=="N/A"?n:t,r=s.order_number||s.orderNumber||s.order_id||"N/A",a=s.customer_name||s.customerName||s.name||s.customer||"N/A",l=s.phone||s.customer_phone||s.phoneNumber||s.phone_number||s.mobile||"N/A",m=s.address||s.customer_address||s.delivery_address||s.address_line||s.shipping_address||"N/A",h=s.courier_remarks||s.reason||"N/A",d=s.event_date||s.date||"N/A",y=s.total_attempts||"N/A",z=g.has(c),k=s.aggregator||u,T=k==="shiprocket"?"Shiprocket":"NimbusPost";return e.jsxs("tr",{className:z?"ndr-row-selected":"",children:[e.jsx("td",{style:{textAlign:"center"},children:e.jsx("input",{type:"checkbox",checked:z,onChange:()=>Ce(c),style:{cursor:"pointer"}})}),e.jsx("td",{className:"ndr-aggregator",children:e.jsx("span",{style:{padding:"4px 8px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",background:k==="shiprocket"?"#fef3c7":"#dbeafe",color:k==="shiprocket"?"#92400e":"#1e40af"},children:T})}),e.jsx("td",{className:"ndr-awb",children:n}),e.jsx("td",{className:"ndr-order",children:r}),e.jsx("td",{className:"ndr-customer",children:a}),e.jsx("td",{className:"ndr-phone",children:l}),e.jsx("td",{className:"ndr-address",children:m}),e.jsx("td",{className:"ndr-reason",children:h}),e.jsx("td",{className:"ndr-date",children:d}),e.jsxs("td",{className:"ndr-attempts",children:["Attempt ",y]}),u==="nimbuspost"&&e.jsxs("td",{className:"ndr-row-actions",children:[e.jsx("button",{className:"ndr-row-action-btn",onClick:()=>ce(s,c),title:"Submit Action",children:"Submit Action"}),e.jsx("button",{className:"ndr-row-action-btn",onClick:()=>ye(s),title:"AI Call",children:"AI Call"})]})]},c)})})]})})}),fe&&e.jsx("div",{className:"ndr-modal-overlay",onClick:G,children:e.jsxs("div",{className:"ndr-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"ndr-modal-header",children:[e.jsxs("h3",{children:[x==="re-attempt"&&"Re-Attempt Delivery",x==="change_address"&&"Change Address",x==="change_phone"&&"Change Phone"]}),e.jsx("button",{className:"ndr-modal-close",onClick:G,children:"Ã—"})]}),e.jsxs("div",{className:"ndr-modal-body",children:[x==="re-attempt"&&e.jsx("div",{className:"ndr-action-form",children:e.jsxs("div",{className:"ndr-form-group",children:[e.jsxs("label",{children:["Re-Attempt Date ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"date",value:i.re_attempt_date,onChange:s=>w({...i,re_attempt_date:s.target.value}),required:!0})]})}),x==="change_address"&&e.jsxs("div",{className:"ndr-action-form",children:[e.jsxs("div",{className:"ndr-form-group",children:[e.jsxs("label",{children:["Customer Name ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",value:i.name,onChange:s=>w({...i,name:s.target.value}),placeholder:"Enter customer name",required:!0})]}),e.jsxs("div",{className:"ndr-form-group",children:[e.jsxs("label",{children:["Address Line 1 ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"text",value:i.address_1,onChange:s=>w({...i,address_1:s.target.value}),placeholder:"Enter address line 1",required:!0})]}),e.jsxs("div",{className:"ndr-form-group",children:[e.jsx("label",{children:"Address Line 2"}),e.jsx("input",{type:"text",value:i.address_2,onChange:s=>w({...i,address_2:s.target.value}),placeholder:"Enter address line 2 (optional)"})]})]}),x==="change_phone"&&e.jsx("div",{className:"ndr-action-form",children:e.jsxs("div",{className:"ndr-form-group",children:[e.jsxs("label",{children:["Phone Number ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"tel",value:i.phone,onChange:s=>w({...i,phone:s.target.value}),placeholder:"Enter 10-digit phone number",required:!0})]})}),e.jsxs("div",{className:"ndr-modal-footer",children:[e.jsx("button",{className:"ndr-btn-cancel",onClick:G,disabled:M,children:"Cancel"}),e.jsx("button",{className:"ndr-btn-submit",onClick:ke,disabled:M,children:M?"Submitting...":"Submit Action"})]})]})]})})]})}):e.jsx("div",{className:"ndr-page",children:e.jsx("div",{className:"ndr-container",children:e.jsxs("div",{className:"ndr-error-state",children:[e.jsx("h2",{children:"No Aggregator Connected"}),e.jsx("p",{children:v||"Please connect NimbusPost or Shiprocket account in Settings to view NDR list."}),e.jsx("button",{className:"ndr-btn-primary",onClick:()=>window.location.href=`/settings?shop=${encodeURIComponent(R||"")}&card=nimbuspost`,children:"Go to Settings"})]})})})};export{Me as default};
