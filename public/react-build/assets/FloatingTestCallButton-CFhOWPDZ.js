import{b as ee,r,R as te,j as e}from"./index-B_YWOrie.js";import{getCallScripts as se,getTestOrders as ae,createTestOrder as re,updateOrderScript as W,makeTestCall as U}from"./api-CYk9FEKy.js";const S=a=>{if(!a)return"";const c=document.createElement("div");return c.textContent=a,c.innerHTML},z=["/images/1 Happy.svg","/images/2 Happy.svg","/images/3 happy.svg","/images/4 happy.svg","/images/6 happy.svg","/images/Character=Angela, Skin tone=White, Posture=1 Happy.svg","/images/Character=Darlene, Skin tone=White, Posture=1 Happy.svg","/images/Character=Jeniffer, Skin tone=White, Posture=1 Happy.svg","/images/Character=Kim, Skin tone=White, Posture=1 Happy.svg"],G=["#F9FFF1","#FFF9F0","#F0F9FF","#F9F0FF","#FFF0F9","#F0FFF9","#FFF5F0","#F5F0FF","#F0F5FF","#FFF0F5"],K=a=>{const c=a?parseInt(a)%z.length:0,w=a?parseInt(a)%G.length:0;return{memoji:z[c],background:G[w]}},oe=({shop:a,isEmbedded:c=!1,onClose:w})=>{const v=ee(),[N,m]=r.useState(!1),[h,_]=r.useState([]),[d,E]=r.useState(""),[k,D]=r.useState([]),[F,P]=r.useState("create"),[T,I]=r.useState(!1),[L,p]=r.useState(!1),[x,b]=r.useState(null),[C,A]=r.useState(!1),[$,j]=r.useState(null),[i,y]=r.useState(0),[n,g]=r.useState({customerName:"",customerPhone:"",customerEmail:"",customerAddress:"",totalPrice:"",currency:"INR",orderNumber:""}),u=r.useMemo(()=>h.find(t=>t.id.toString()===d),[h,d]),f=r.useMemo(()=>u?K(u.id):null,[u]),B=r.useMemo(()=>n.customerName.trim()!==""&&n.customerPhone.trim()!==""&&d!=="",[n.customerName,n.customerPhone,d]);r.useEffect(()=>{N&&a&&q()},[N,a]),r.useEffect(()=>{if(N&&h.length>0){const t=sessionStorage.getItem("testCallDefaultAgentId");if(t){const s=h.find(o=>o.id.toString()===t);s&&E(s.id.toString()),sessionStorage.removeItem("testCallDefaultAgentId")}}},[N,h]),r.useEffect(()=>{const t=s=>{T&&!s.target.closest(".agent-selector-wrapper")&&I(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[T]),r.useEffect(()=>{if(i>0){const t=setTimeout(()=>{y(i-1)},1e3);return()=>clearTimeout(t)}},[i]);const q=async()=>{try{const t=await se(a),s=t?.scripts||t||[],o=Array.isArray(s)?s.filter(R=>R&&R.id):[],l=[{id:"template-test-scalysis-intro-laughter",name:"Test Scalysis Intro (Laughter)",description:"A naturally conversational test agent that sounds human. Perfect for testing how natural AI calling can feel with real conversations.",isTemplate:!0,templateKey:"test-scalysis-intro-laughter"},{id:"template-test-scalysis-no-laughter",name:"Test Scalysis (No laughter)",description:"A naturally conversational test agent that sounds human. Perfect for testing how natural AI calling can feel with real conversations.",isTemplate:!0,templateKey:"test-scalysis-no-laughter"}],O=[...o,...l];_(O),O.length>0&&!d&&(sessionStorage.getItem("testCallDefaultAgentId")||E(O[0].id.toString()))}catch(t){console.error("[FloatingTestCall] Error loading agents:",t),_([])}},H=async()=>{try{const t=await ae(a),s=t?.orders||t||[];D(Array.isArray(s)?s:[])}catch(t){console.error("[FloatingTestCall] Error loading test orders:",t),D([])}},J=async t=>{if(t.preventDefault(),!d){alert("Please select an agent first");return}A(!0),j(null);try{const s=await re(n,a);if(!s.success||!s.order)throw new Error(s.error||"Failed to create test order");const o=s.order.id;if(!o)throw new Error("Order created but no ID returned");try{await W(o,parseInt(d),a)}catch(l){console.error("[FloatingTestCall] Error updating order script:",l)}try{const l=await U(o);b({agentName:u?.name||"Agent",agentMemoji:f,phoneNumber:n.customerPhone,callResult:l.call_result||null,callStatus:l.call_result?.call_status||"completed",callDuration:l.call_result?.call_duration||null,callOutcome:l.call_result?.retry_result?.call_outcome||null}),p(!0),y(31)}catch(l){l.message.includes("429")||l.message.includes("Rate limit")?j("Rate limit exceeded. Please wait 1 minute before making another test call."):j(l.message||"Error making test call"),b({agentName:u?.name||"Agent",agentMemoji:f,phoneNumber:n.customerPhone,error:l.message}),p(!0),y(31)}}catch(s){console.error("[FloatingTestCall] Error:",s),j(s.message||"Error creating test order"),alert(s.message||"Error creating test order")}finally{A(!1)}},Q=()=>{v("/dashboard"),m(!1),p(!1)},V=()=>{p(!1),b(null),g({customerName:"",customerPhone:"",customerEmail:"",customerAddress:"",totalPrice:"",currency:"INR",orderNumber:""}),P("create"),j(null)},Y=async t=>{if(!d){alert("Please select an agent first");return}A(!0),j(null);try{try{await W(t,parseInt(d),a)}catch(s){console.error("[FloatingTestCall] Error updating order script:",s)}try{const s=await U(t),o=k.find(l=>(l.id||l.orderId)===t);b({agentName:u?.name||"Agent",agentMemoji:f,phoneNumber:o?.customerPhone||"N/A",callResult:s.call_result||null,callStatus:s.call_result?.call_status||"completed",callDuration:s.call_result?.call_duration||null,callOutcome:s.call_result?.retry_result?.call_outcome||null}),p(!0),H(),y(31)}catch(s){s.message.includes("429")||s.message.includes("Rate limit")?alert("Rate limit exceeded. Please wait 1 minute before making another test call."):alert(s.message||"Error making test call"),y(31)}}catch(s){console.error("[FloatingTestCall] Error:",s),alert(s.message||"Error making test call")}finally{A(!1)}},X=()=>{m(!1);const t=a?`?shop=${encodeURIComponent(a)}`:"";v(`/playground${t}`)},Z=(t,s)=>{s.stopPropagation(),m(!1);const o=a?`?shop=${encodeURIComponent(a)}`:"";v(`/playground${o}#agent-${t}`)};te.useEffect(()=>{c&&m(!0)},[c]);const M=()=>{m(!1),c&&w&&w()};return e.jsxs(e.Fragment,{children:[!c&&e.jsx("button",{className:"floating-test-call-btn",onClick:()=>m(!0),title:"Test Call",children:e.jsxs("div",{className:"floating-test-call-sound-wave",children:[e.jsx("div",{className:"floating-test-call-sound-bar"}),e.jsx("div",{className:"floating-test-call-sound-bar"}),e.jsx("div",{className:"floating-test-call-sound-bar"}),e.jsx("div",{className:"floating-test-call-sound-bar"}),e.jsx("div",{className:"floating-test-call-sound-bar"})]})}),N&&e.jsx("div",{className:"floating-test-call-modal",onClick:t=>{t.target.className==="floating-test-call-modal"&&M()},children:e.jsxs("div",{className:`floating-test-call-modal-content ${L?"modal-success":""}`,children:[e.jsxs("div",{className:"modal-top-row",children:[e.jsx("div",{className:"modal-voice-icon-bordered",children:e.jsxs("div",{className:"floating-test-call-sound-wave",children:[e.jsx("div",{className:"floating-test-call-sound-bar"}),e.jsx("div",{className:"floating-test-call-sound-bar"}),e.jsx("div",{className:"floating-test-call-sound-bar"}),e.jsx("div",{className:"floating-test-call-sound-bar"}),e.jsx("div",{className:"floating-test-call-sound-bar"})]})}),e.jsx("button",{className:"close-modal",onClick:()=>{M(),p(!1),b(null)},children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M18 6L6 18M6 6L18 18",stroke:"#6B7280",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]}),L?e.jsxs("div",{className:"modal-success-content",children:[e.jsx("div",{className:"success-hand-icon",children:e.jsx("img",{src:"/images/Group 8744.svg",alt:"Call Initiated",width:"96",height:"113"})}),e.jsx("h2",{className:"success-title",children:"Your Call was Finished Successfully"}),x&&e.jsxs("div",{className:"success-agent-chip",children:[x.agentMemoji&&e.jsx("div",{className:"agent-chip-memoji",style:{backgroundColor:x.agentMemoji.background},children:e.jsx("img",{src:x.agentMemoji.memoji,alt:""})}),e.jsxs("div",{className:"agent-chip-info",children:[e.jsx("span",{className:"agent-chip-name",children:x.agentName}),e.jsx("span",{className:"agent-chip-phone",children:x.phoneNumber})]})]}),e.jsxs("div",{className:"success-actions",children:[e.jsx("button",{className:"btn-go-dashboard",onClick:Q,children:"Go to Dashboard"}),e.jsx("button",{className:"btn-call-another",onClick:V,children:"Call another"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"floating-test-call-modal-header-new",children:[e.jsx("div",{className:"modal-header-left",children:e.jsxs("div",{className:"modal-header-text",children:[e.jsx("h3",{children:"Test your agent"}),e.jsx("p",{children:"test call yourself or anyone to configure your agent"})]})}),e.jsx("div",{className:"modal-header-right",children:e.jsxs("div",{className:"agent-selector-wrapper",children:[e.jsxs("div",{className:"agent-selector",onClick:()=>I(!T),children:[u&&f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"agent-memoji",style:{backgroundColor:f.background},children:e.jsx("img",{src:f.memoji,alt:""})}),e.jsx("span",{className:"agent-name",children:u.name})]}):e.jsx("span",{className:"agent-placeholder",children:"Select Agent"}),e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M6 9L12 15L18 9",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})]}),T&&e.jsxs("div",{className:"agent-dropdown-menu",children:[h.map(t=>{const s=K(t.id);return e.jsxs("div",{className:"agent-dropdown-item",onClick:()=>{E(t.id.toString()),I(!1)},children:[e.jsx("div",{className:"agent-memoji",style:{backgroundColor:s.background},children:e.jsx("img",{src:s.memoji,alt:""})}),e.jsx("span",{className:"agent-name",children:t.name}),e.jsx("button",{className:"agent-edit-btn",onClick:o=>Z(t.id,o),children:e.jsx("img",{src:"/images/Edit.svg",alt:"Edit",width:"16",height:"16"})})]},t.id)}),e.jsx("div",{className:"agent-dropdown-item",onClick:()=>{m(!1);const t=a?`?shop=${encodeURIComponent(a)}`:"";v(`/playground${t}${t?"&":"?"}template=test-scalysis-intro-laughter`)},style:{borderTop:"1px solid #E5E7EB",marginTop:"8px",paddingTop:"8px"},children:e.jsx("span",{style:{fontSize:"12px",color:"#6B7280",fontWeight:"500"},children:"Test Scalysis Intro (Laughter)"})}),e.jsx("div",{className:"agent-dropdown-item",onClick:()=>{m(!1);const t=a?`?shop=${encodeURIComponent(a)}`:"";v(`/playground${t}${t?"&":"?"}template=test-scalysis-no-laughter`)},children:e.jsx("span",{style:{fontSize:"12px",color:"#6B7280",fontWeight:"500"},children:"Test Scalysis (No laughter)"})}),e.jsxs("div",{className:"agent-dropdown-item agent-create-new",onClick:X,style:{borderTop:"1px solid #E5E7EB",marginTop:"8px",paddingTop:"8px"},children:[e.jsx("span",{className:"agent-create-icon",children:"+"}),e.jsx("span",{children:"create new"})]})]})]})})]}),e.jsx("div",{className:"modal-divider-dotted"}),e.jsxs("div",{className:"modal-tabs",children:[e.jsx("button",{className:`tab-btn ${F==="create"?"active":""}`,onClick:()=>P("create"),children:"create test order"}),e.jsx("button",{className:`tab-btn ${F==="existing"?"active":""}`,onClick:()=>{P("existing"),H()},children:"use existing"})]}),F==="create"&&e.jsx("div",{className:"tab-content active",children:e.jsxs("form",{onSubmit:J,className:"test-order-form",children:[e.jsxs("div",{className:"form-row-grid",children:[e.jsxs("div",{className:"form-group-vertical",children:[e.jsxs("label",{htmlFor:"floatingTestCustomerName",children:[e.jsx("img",{src:"/images/Name.svg",alt:"",width:"16",height:"16"}),e.jsx("span",{children:"Name*:"})]}),e.jsx("input",{type:"text",id:"floatingTestCustomerName",value:n.customerName,onChange:t=>g(s=>({...s,customerName:t.target.value})),required:!0})]}),e.jsxs("div",{className:"form-group-vertical form-group-right",children:[e.jsxs("label",{htmlFor:"floatingTestCustomerPhone",children:[e.jsx("img",{src:"/images/Phone.svg",alt:"",width:"16",height:"16"}),e.jsx("span",{children:"Phone*:"})]}),e.jsx("input",{type:"tel",id:"floatingTestCustomerPhone",value:n.customerPhone,onChange:t=>g(s=>({...s,customerPhone:t.target.value})),required:!0})]})]}),e.jsxs("div",{className:"form-row-grid",children:[e.jsxs("div",{className:"form-group-vertical",children:[e.jsxs("label",{htmlFor:"floatingTestCustomerEmail",children:[e.jsx("img",{src:"/images/Email.svg",alt:"",width:"16",height:"16"}),e.jsx("span",{children:"Email:"})]}),e.jsx("input",{type:"email",id:"floatingTestCustomerEmail",value:n.customerEmail,onChange:t=>g(s=>({...s,customerEmail:t.target.value}))})]}),e.jsxs("div",{className:"form-group-vertical form-group-right",children:[e.jsxs("label",{htmlFor:"floatingTestOrderNumber",children:[e.jsx("img",{src:"/images/Order.svg",alt:"",width:"16",height:"16"}),e.jsx("span",{children:"Order Number:"})]}),e.jsx("input",{type:"text",id:"floatingTestOrderNumber",value:n.orderNumber,onChange:t=>g(s=>({...s,orderNumber:t.target.value})),placeholder:"Auto-generated if empty"})]})]}),e.jsxs("div",{className:"form-group-vertical form-group-address",children:[e.jsxs("label",{htmlFor:"floatingTestCustomerAddress",children:[e.jsx("img",{src:"/images/Address.svg",alt:"",width:"16",height:"16"}),e.jsx("span",{children:"Address:"})]}),e.jsx("textarea",{id:"floatingTestCustomerAddress",rows:"3",value:n.customerAddress,onChange:t=>g(s=>({...s,customerAddress:t.target.value}))})]}),e.jsxs("div",{className:"form-row-grid",children:[e.jsxs("div",{className:"form-group-vertical",children:[e.jsxs("label",{htmlFor:"floatingTestTotalPrice",children:[e.jsx("img",{src:"/images/Price.svg",alt:"",width:"16",height:"16"}),e.jsx("span",{children:"Total Price:"})]}),e.jsx("input",{type:"text",id:"floatingTestTotalPrice",value:n.totalPrice,onChange:t=>g(s=>({...s,totalPrice:t.target.value}))})]}),e.jsxs("div",{className:"form-group-vertical form-group-right",children:[e.jsxs("label",{htmlFor:"floatingTestCurrency",children:[e.jsx("img",{src:"/images/Currency.svg",alt:"",width:"16",height:"16"}),e.jsx("span",{children:"Currency:"})]}),e.jsx("input",{type:"text",id:"floatingTestCurrency",value:n.currency,onChange:t=>g(s=>({...s,currency:t.target.value}))})]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsxs("button",{type:"button",className:"btn-cancel",onClick:M,children:[e.jsx("img",{src:"/images/Trash.svg",alt:"",width:"16",height:"16"}),"cancel"]}),e.jsx("button",{type:"submit",className:`btn-create-queue ${!B||C||i>0?"btn-disabled":""}`,disabled:!B||C||i>0,children:C?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"circular-loader-small"}),e.jsx("span",{children:"Ongoing"})]}):i>0?e.jsx(e.Fragment,{children:e.jsxs("span",{children:["Cooldown: ",i,"s"]})}):e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"+"})," create and call"]})}),$&&e.jsx("div",{style:{marginTop:"12px",padding:"12px",background:"#fee2e2",borderRadius:"8px",color:"#991b1b",fontSize:"13px"},children:$})]})]})}),F==="existing"&&e.jsx("div",{className:"tab-content active",children:e.jsx("div",{className:"test-order-list",children:k.length>0?k.map(t=>e.jsxs("div",{className:"test-order-item",children:[e.jsxs("div",{className:"test-order-info",children:[e.jsx("h4",{children:S(t.customerName||"Unknown")}),e.jsxs("p",{children:[S(t.customerPhone||"No phone")," |"," ",S(t.orderNumber||t.orderId)]}),e.jsxs("p",{style:{marginTop:"4px",fontSize:"11px",color:"#9ca3af"},children:["Status: ",S(t.callStatus||"N/A")," | Created:"," ",t.createdAt?new Date(t.createdAt).toLocaleString():"N/A"]})]}),e.jsx("button",{className:"btn btn-success",onClick:()=>Y(t.id),disabled:C||i>0,children:C?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"circular-loader-small"}),e.jsx("span",{children:"Ongoing"})]}):i>0?e.jsxs("span",{children:["Cooldown: ",i,"s"]}):"Make Test Call"})]},t.orderId||t.id)):e.jsx("p",{style:{textAlign:"center",color:"#6b7280",padding:"40px"},children:'No test orders yet. Create one in the "Create Test Order" tab.'})})})]})]})})]})};export{oe as default};
