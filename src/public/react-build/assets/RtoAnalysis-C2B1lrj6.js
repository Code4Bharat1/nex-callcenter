import{a as De,r as l,b as $e,R as K,j as e}from"./index-B_YWOrie.js";import{api as Te}from"./api-CYk9FEKy.js";const ds=({shop:_})=>{const[Y]=De(),d=_||Y.get("shop"),[Be,Z]=l.useState(null),[Pe,Le]=l.useState(!1),[N,E]=l.useState([]),[y,Fe]=l.useState(null),[ze,He]=l.useState(null),[Me,qe]=l.useState(null),[Je,G]=l.useState([]),[D,Ve]=l.useState(null),[We,$]=l.useState(!1),[Ke,Q]=l.useState(1),[_e,X]=l.useState(null),[Ye,ee]=l.useState({}),[Ze,se]=l.useState({}),[Ge,T]=l.useState({}),[Qe,B]=l.useState({}),[Xe,P]=l.useState({}),[S,te]=l.useState([]),[ae,f]=l.useState(!1),[k,L]=l.useState([]),[re,F]=l.useState(!1),[ne,g]=l.useState(!1),[c,oe]=l.useState(null),[m,le]=l.useState([]),[z,H]=l.useState(!1),[x,w]=l.useState(new Set),[M,O]=l.useState(!1),[C,es]=l.useState([]),[ss,ts]=l.useState(""),[as,rs]=l.useState("all"),[R,ie]=l.useState(""),[ns,os]=l.useState({});l.useEffect(()=>{d&&(de(),he(1))},[d]);const de=async()=>{try{const s=await Te.getScripts(d),t=s?.scripts||s||[];te(t)}catch(s){console.error("[RtoAnalysis] Error loading scripts:",s)}},ce=$e(),he=async(s=1)=>{if(d){$(!0);try{console.log("[RtoAnalysis] Loading CSV history for shop:",d,"page:",s);const a=await(await fetch(`/api/csv-history?shop=${encodeURIComponent(d)}&page=${s}&limit=10&isRtoAnalysis=true`,{credentials:"include"})).json();if(console.log("[RtoAnalysis] CSV history response:",a),a.success){const r=a.data.uploads||[];console.log("[RtoAnalysis] Setting CSV history with",r.length,"uploads"),console.log("[RtoAnalysis] Upload IDs:",r.map(n=>n.id)),G(r),X(a.data.pagination),Q(s)}else console.error("[RtoAnalysis] Failed to load CSV history:",a.error)}catch(t){console.error("[RtoAnalysis] Error loading CSV history:",t)}finally{$(!1)}}},ue=s=>{const t=s.target.files[0];t&&Z(t)},q=async s=>{B(t=>({...t,[s]:!0}));try{const a=await(await fetch(`/api/csv-results?csvUploadId=${s}&shop=${encodeURIComponent(d)}`,{credentials:"include"})).json();a.success&&(ee(r=>({...r,[s]:a.orders||[]})),pe(s,a.orders),me(s))}catch(t){console.error(`[RtoAnalysis] Error loading orders for ${s}:`,t)}finally{B(t=>({...t,[s]:!1}))}},pe=(s,t)=>{const a={};t.forEach(n=>{if(n.script&&n.script.id){const o=n.script.id;a[o]=(a[o]||0)+1}});const r=Object.entries(a).sort((n,o)=>o[1]-n[1])[0]?.[0];if(r){const n=S.find(o=>o.id===parseInt(r))||t.find(o=>o.script&&o.script.id===parseInt(r))?.script;n&&T(o=>({...o,[s]:n}))}else{const n=S.find(o=>{const i=o.name.toLowerCase();return i.includes("house")&&i.includes("direction")||i.includes("house dir")||i.includes("address")&&i.includes("extraction")});n&&T(o=>({...o,[s]:n}))}},me=async s=>{P(t=>({...t,[s]:!0}));try{const a=await(await fetch(`/api/csv-stats?csvUploadId=${s}&shop=${encodeURIComponent(d)}`,{credentials:"include"})).json();a.success&&se(r=>({...r,[s]:a.stats}))}catch(t){console.error(`[RtoAnalysis] Error loading stats for ${s}:`,t)}finally{P(t=>({...t,[s]:!1}))}},J=s=>{L(s),f(!0)},xe=async(s,t)=>{f(!1),F(!0);try{const r=await(await fetch("/api/set-queue-bulk",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderIds:k,shop:d,scriptId:s}),credentials:"include"})).json();if(r.success){const n=r.updated||0,o=r.failed?.length||0;alert(`âœ… Bulk AI Call completed!

ðŸ“Š Results:
â€¢ Successfully queued: ${n}
â€¢ Failed: ${o}`)}else alert(`âŒ Bulk AI Call failed: ${r.error||"Unknown error"}`);if(D&&q(D),y){const o=await(await fetch(`/api/csv-results?csvUploadId=${y}&shop=${encodeURIComponent(d)}`,{credentials:"include"})).json();o.success&&E(o.orders||[])}L([])}catch(a){console.error("Error in bulk call:",a),alert("Error processing bulk call")}finally{F(!1)}},U=async s=>{H(!0),g(!0);try{const a=await(await fetch(`/api/order-details?orderId=${s}&shop=${encodeURIComponent(d)}`,{credentials:"include"})).json();a.success?(oe(a.order),le(a.calls||[])):(alert("Failed to load order details"),g(!1))}catch(t){console.error("[RtoAnalysis] Error loading order details:",t),alert("Error loading order details"),g(!1)}finally{H(!1)}},ye=s=>{if(!s)return"N/A";try{const t=new Date(s),a=5.5*60*60*1e3;return new Date(t.getTime()+a).toLocaleString("en-IN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})}catch{return"N/A"}},fe=async(s,t)=>{if(confirm("Are you sure you want to update the address in Shopify? This will change the actual order address."))try{console.log("[RtoAnalysis] Updating address in Shopify:",{orderId:s,shop:d,newAddress:t});const r=await(await fetch("/api/update-order-address",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:s,shop:d,newAddress:t})})).json();r.success?(alert("âœ… Address updated successfully in Shopify!"),c&&U(c.orderId||c.id)):alert("âŒ Failed to update address: "+(r.error||"Unknown error"))}catch(a){console.error("[RtoAnalysis] Error updating address:",a),alert("âŒ Error updating address: "+a.message)}},ge=(s,t,a)=>{const r=document.createElement("div");r.className="modal-overlay",r.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      font-family: Inter, system-ui, -apple-system, sans-serif;
    `;const n=document.createElement("div");n.style.cssText=`
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    `,n.innerHTML=`
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #202223; font-size: 18px; font-weight: 600;">Address Comparison</h3>
        <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6d7175; padding: 0; width: 24px; height: 24px;">&times;</button>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div style="border: 1px solid #e1e3e5; border-radius: 8px; padding: 16px; background: #f8f9fa;">
          <div style="display: flex; align-items: center; margin-bottom: 12px;">
            <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%; margin-right: 8px;"></div>
            <h4 style="margin: 0; color: #ef4444; font-size: 14px; font-weight: 600; text-transform: uppercase;">Current Address</h4>
          </div>
          <div style="color: #202223; font-size: 14px; line-height: 1.5; word-wrap: break-word;">${t||"N/A"}</div>
        </div>
        
        <div style="border: 1px solid #e1e3e5; border-radius: 8px; padding: 16px; background: #f0f8f0;">
          <div style="display: flex; align-items: center; margin-bottom: 12px;">
            <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 8px;"></div>
            <h4 style="margin: 0; color: #10b981; font-size: 14px; font-weight: 600; text-transform: uppercase;">New Address</h4>
          </div>
          <textarea id="newAddressEdit" style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; line-height: 1.5; resize: vertical; font-family: inherit;">${a||""}</textarea>
        </div>
      </div>
      
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button onclick="this.closest('.modal-overlay').remove()" style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; font-size: 14px; cursor: pointer;">Close</button>
        <button id="saveNewAddressBtn" style="padding: 8px 16px; border: none; background: #10b981; color: white; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 500;">Save Changes</button>
      </div>
    `,r.appendChild(n),document.body.appendChild(r);const o=n.querySelector("#saveNewAddressBtn");o.onclick=async()=>{const h=n.querySelector("#newAddressEdit").value.trim();if(!h){alert("Please enter a new address");return}try{const u=await(await fetch("/api/update-csv-new-address",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callId:s,newAddress:h})})).json();u.success?(alert("âœ… Address updated successfully!"),r.remove(),c&&U(c.orderId||c.id)):alert("âŒ Error updating address: "+u.error)}catch(p){console.error("[RtoAnalysis] Error saving new address:",p),alert("âŒ Error saving address: "+p.message)}}},je=(s,t)=>{try{console.log("[RtoAnalysis] Downloading audio from URL:",s);const a=document.createElement("a");a.href=s,a.download=`call_${t||"audio"}.mp3`,a.target="_blank",document.body.appendChild(a),a.click(),document.body.removeChild(a)}catch(a){console.error("[RtoAnalysis] Error downloading audio:",a),alert("Error downloading audio: "+a.message)}},ve=async s=>{if(confirm("Are you sure you want to update ALL addresses with new addresses in Shopify? This will change the actual order addresses for all orders that have updated addresses."))try{console.log("[RtoAnalysis] Starting bulk address update for upload:",s);const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 10000;
      `,t.textContent="Updating addresses in Shopify...",document.body.appendChild(t);const r=await(await fetch("/api/bulk-update-addresses",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uploadId:s,shop:d})})).json();if(t.remove(),r.success){const{updated:n,failed:o,total:i}=r.results;let h=`âœ… Bulk update completed!

`;if(h+=`ðŸ“Š Results:
`,h+=`â€¢ Total orders processed: ${i}
`,h+=`â€¢ Successfully updated: ${n}
`,h+=`â€¢ Failed: ${o}
`,o>0&&r.results.errors&&console.error("[RtoAnalysis] Bulk update errors:",r.results.errors),alert(h),s===y){const u=await(await fetch(`/api/csv-results?csvUploadId=${s}&shop=${encodeURIComponent(d)}`,{credentials:"include"})).json();u.success&&E(u.orders||[])}else q(s)}else alert("âŒ Bulk update failed: "+(r.error||"Unknown error"))}catch(t){console.error("[RtoAnalysis] Error in bulk address update:",t),alert("âŒ Error in bulk address update: "+t.message)}},be=s=>{if(!s)return"N/A";try{const t=new Date(s),a=t.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),r=t.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return`${a} at ${r}`}catch{return"N/A"}},Ne=s=>{if(!s)return{filledBars:2,totalBars:4,label:"Neutral",color:"#fef3c7",barColor:"#f59e0b"};const t=s.toLowerCase();return t.includes("very happy")||t.includes("very_happy")||t==="veryhappy"?{filledBars:4,totalBars:4,label:"Very happy",color:"#d1fae5",barColor:"#10b981"}:t.includes("happy")||t==="positive"?{filledBars:3,totalBars:4,label:"Happy",color:"#dbeafe",barColor:"#3b82f6"}:t.includes("unhappy")||t.includes("negative")||t==="sad"||t==="angry"?{filledBars:1,totalBars:4,label:"Unhappy",color:"#fce7f3",barColor:"#ec4899"}:{filledBars:2,totalBars:4,label:"Neutral",color:"#fef3c7",barColor:"#f59e0b"}},V=s=>s?s.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" "):"Pending",Se=s=>{const t=s.orderId||s.id;w(a=>{const r=new Set(a);return r.has(t)?r.delete(t):r.add(t),r})},we=()=>{const s=C.length>0?C:N;if(M)w(new Set),O(!1);else{const t=s.map(a=>a.orderId||a.id);w(new Set(t)),O(!0)}},Ce=()=>{w(new Set),O(!1)},Ae=()=>{const s=new Date,t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],a=s.getDate(),r=t[s.getMonth()],n=s.getFullYear().toString().slice(-2);return`${a} ${r} ${n}`},ke=(s="hinglish")=>{const a=`RTO analysis agent ${Ae()}`,r=["delivery too late","got somewhere else","delivery boy didnt call","didnt want anymore","other reason - here we put reason in summary"],n=["unclear reason","user not responsive"],o=`Analyze the call to determine the RTO reason. The success criteria are: ${r.join(", ")}. The other criteria are: ${n.join(", ")}. If the reason doesn't fall into any of these categories, use "other reason" and put the actual reason in the summary.`,i=`Namaste, main ${a} se bol raha hoon. Aapka order RTO ho gaya hai, iska reason pata karna hai.

Pehle main aapko order details batata hoon:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Address: {customerAddress}

Ab main aapse reason puchta hoon:
Kya aapko delivery wale ka call aaya tha? Agar haan, to kya hua? Agar nahi, to kya reason hai?

Agar reason unclear hai, to main follow-up questions puchunga:
1. Kya delivery boy ne aapko call kiya tha?
2. Kya aapko order mil gaya ya nahi?
3. Kya aapko order chahiye tha ya cancel karna hai?
4. Koi aur reason hai to bataiye.

Please mujhe clear reason batayein.`,h=`Hello, this is ${a}. Your order has been RTO'd, and I need to find out the reason.

First, let me tell you the order details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Address: {customerAddress}

Now I'll ask you about the reason:
Did the delivery person call you? If yes, what happened? If no, what's the reason?

If the reason is unclear, I'll ask follow-up questions:
1. Did the delivery boy call you?
2. Did you receive the order or not?
3. Did you want the order or want to cancel it?
4. Is there any other reason, please tell me.

Please give me a clear reason.`,p=s==="hinglish"?i:h,u=new URLSearchParams({agent:"new",name:a,successCriteria:JSON.stringify(r),otherCriteria:JSON.stringify(n),customAnalysisPrompt:o,script:p,useCustomAnalysis:"true",language:s});ce(`/playground?${u.toString()}${d?`&shop=${encodeURIComponent(d)}`:""}`)},[j,Oe]=l.useState(null),[Re,W]=l.useState(!1),[I,Ue]=l.useState(!1),A=K.useRef(null),v=K.useRef(null),Ie=[{reason:"Wrong address provided",percentage:47},{reason:"Customer not available",percentage:46},{reason:"Address not found",percentage:44},{reason:"Customer refused delivery",percentage:43},{reason:"Incomplete address",percentage:41},{reason:"Customer moved",percentage:39},{reason:"Phone number incorrect",percentage:35},{reason:"Delivery location inaccessible",percentage:34},{reason:"Customer requested reschedule",percentage:33},{reason:"Other reasons",percentage:28}],Ee=async()=>{if(d){W(!0);try{const t=await(await fetch(`/api/csv-history?shop=${encodeURIComponent(d)}&page=1&limit=100&isRtoAnalysis=true`,{credentials:"include"})).json();if(t.success&&t.data.uploads){const a=t.data.uploads,r={},n={};a.forEach(o=>{const i=new Date(o.createdAt).toISOString().split("T")[0];r[i]||(r[i]={date:i,total:0,reasons:{}}),r[i].total+=o.totalOrders||0});for(const o of a)try{const h=await(await fetch(`/api/csv-stats?csvUploadId=${o.id}&shop=${encodeURIComponent(d)}`,{credentials:"include"})).json();if(h.success&&h.stats){const u=h.stats.successCounts||{};Object.keys(u).forEach(b=>{n[b]||(n[b]=0),n[b]+=u[b]||0})}}catch(i){console.error(`Error loading stats for upload ${o.id}:`,i)}Oe({dates:Object.values(r).sort((o,i)=>new Date(o.date)-new Date(i.date)),reasons:n})}}catch(s){console.error("[RtoAnalysis] Error loading chart data:",s)}finally{W(!1)}}};return l.useEffect(()=>{d&&Ee()},[d]),l.useEffect(()=>{if(!j||!A.current)return;if(typeof window.Chart>"u"){const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js",t.onload=()=>s(),document.head.appendChild(t)}else s();function s(){if(!A.current||typeof window.Chart>"u")return;v.current&&v.current.destroy();const t=A.current.getContext("2d"),{dates:a,reasons:r}=j;if(a.length===0)return;const n=a.map(p=>new Date(p.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})),o=[],i=Object.keys(r),h=["#4B5CFF","#10B981","#F59E0B","#EF4444","#8B5CF6"];i.forEach((p,u)=>{o.push({label:p,data:a.map(b=>Math.round((r[p]||0)/a.length)),borderColor:h[u%h.length],backgroundColor:h[u%h.length]+"20",tension:.4})}),v.current=new window.Chart(t,{type:a.length===1?"bar":"line",data:{labels:n,datasets:o},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0}},scales:{y:{beginAtZero:!0}}}})}return()=>{v.current&&v.current.destroy()}},[j]),e.jsxs("div",{className:"rto-analysis-container",children:[e.jsxs("div",{className:"rto-header",children:[e.jsx("h1",{className:"rto-title",children:"RTO Insights"}),e.jsxs("div",{className:"rto-header-actions",children:[e.jsx("input",{type:"file",id:"campaigns-csv-file",accept:".csv",onChange:ue,style:{display:"none"}}),e.jsxs("button",{className:"rto-upload-btn",onClick:()=>document.getElementById("campaigns-csv-file").click(),children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"17 8 12 3 7 8"}),e.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]}),"Upload CSV"]})]})]}),e.jsxs("div",{className:"rto-card",children:[e.jsxs("div",{className:"rto-card-header",children:[e.jsx("h2",{className:"rto-card-title",children:"RTO Reasons"}),e.jsxs("label",{className:"rto-sample-toggle",children:[e.jsx("input",{type:"checkbox",checked:I,onChange:s=>Ue(s.target.checked),className:"rto-sample-checkbox"}),e.jsx("span",{className:"rto-sample-toggle-slider"}),e.jsx("span",{className:"rto-sample-toggle-label",children:"Sample"})]})]}),e.jsx("div",{className:"rto-card-body",children:Re&&!I?e.jsxs("div",{className:"rto-empty-state",children:[e.jsx("div",{className:"rto-loading-spinner"}),e.jsx("p",{className:"rto-empty-text",children:"Loading chart data..."})]}):I?e.jsx("div",{className:"rto-bar-chart-container",children:Ie.map((s,t)=>e.jsxs("div",{className:"rto-bar-chart-item",children:[e.jsx("div",{className:"rto-bar-chart-label",children:s.reason}),e.jsx("div",{className:"rto-bar-chart-bar-wrapper",children:e.jsx("div",{className:"rto-bar-chart-bar",style:{width:`${s.percentage}%`}})}),e.jsxs("div",{className:"rto-bar-chart-percentage",children:[s.percentage,"%"]})]},t))}):!j||j.dates.length===0?e.jsxs("div",{className:"rto-empty-state rto-empty-state-enhanced",children:[e.jsx("div",{className:"rto-empty-illustration",children:e.jsx("svg",{width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("path",{d:"M9 11l3 3L22 4M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"})})}),e.jsx("h3",{className:"rto-empty-title",children:"No Analysis Data"}),e.jsx("p",{className:"rto-empty-description",children:"Upload a CSV file with RTO orders to start analyzing return reasons. Track trends and identify patterns in customer returns."}),e.jsxs("button",{className:"rto-btn rto-btn-primary",onClick:()=>ke("hinglish"),children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{marginRight:"6px"},children:e.jsx("path",{d:"M12 5v14M5 12h14"})}),"Create RTO Agent"]})]}):e.jsx("div",{className:"rto-chart-container",children:e.jsx("canvas",{ref:A,style:{width:"100%",height:"400px"}})})})]}),N.length>0&&e.jsxs("div",{className:"rto-card",children:[e.jsxs("div",{className:"rto-card-header",children:[e.jsxs("h2",{className:"rto-card-title",children:["Orders (",N.length,")"]}),e.jsx("input",{type:"text",className:"rto-search-input",placeholder:"Search orders...",value:R,onChange:s=>ie(s.target.value)})]}),e.jsx("div",{className:"rto-card-body",children:e.jsxs("div",{className:"orders-table-container",children:[x.size>0&&e.jsx("div",{className:"bulk-actions-panel",children:e.jsxs("div",{className:"bulk-actions-content",children:[e.jsxs("span",{className:"selected-count",children:[x.size," orders selected"]}),e.jsxs("div",{className:"bulk-buttons",children:[e.jsx("button",{className:"btn btn-success btn-sm",onClick:()=>J(Array.from(x)),disabled:x.size===0,children:"Bulk AI Call"}),y&&e.jsx("button",{className:"btn btn-primary btn-sm",onClick:()=>ve(y),children:"Bulk Update Addresses"}),e.jsx("button",{className:"btn btn-secondary btn-sm",onClick:Ce,disabled:x.size===0,children:"Clear Selection"})]})]})}),e.jsxs("table",{className:"orders-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx("input",{type:"checkbox",checked:M,onChange:we})}),e.jsx("th",{children:"Order #"}),e.jsx("th",{children:"Customer"}),e.jsx("th",{children:"Phone"}),e.jsx("th",{children:"Address"}),e.jsx("th",{children:"Total Calls"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Sentiment"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:(()=>{let s=C.length>0?C:N;if(R.trim()){const t=R.toLowerCase();s=s.filter(a=>{const r=(a.orderNumber||a.id||"").toString().toLowerCase(),n=(a.customerName||"").toLowerCase(),o=(a.customerPhone||"").toLowerCase(),i=(a.customerAddress||"").toLowerCase();return r.includes(t)||n.includes(t)||o.includes(t)||i.includes(t)})}return s.map(t=>e.jsxs("tr",{onClick:()=>U(t.id),style:{cursor:"pointer"},children:[e.jsx("td",{onClick:a=>a.stopPropagation(),children:e.jsx("input",{type:"checkbox",checked:x.has(t.orderId||t.id),onChange:()=>Se(t)})}),e.jsx("td",{style:{fontWeight:600,color:"#202223"},children:t.orderNumber||t.id}),e.jsxs("td",{children:[e.jsx("div",{style:{fontWeight:500,color:"#202223"},children:t.customerName||"N/A"}),t.customerEmail&&e.jsx("div",{style:{fontSize:"12px",color:"#6D7175"},children:t.customerEmail})]}),e.jsx("td",{style:{color:"#6D7175"},children:t.customerPhone||"N/A"}),e.jsxs("td",{className:"address-cell",style:{position:"relative"},children:[e.jsx("div",{style:{color:"#202223",maxWidth:"200px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.customerAddress?t.customerAddress.length>30?t.customerAddress.substring(0,30)+"...":t.customerAddress:"N/A"}),t.calls&&t.calls.some(a=>a.newAddress)&&e.jsx("div",{style:{color:"#50B83C",fontSize:"12px",marginTop:"4px"},children:"âœï¸ Updated Address Available"})]}),e.jsx("td",{style:{textAlign:"center"},children:e.jsx("span",{className:"call-count-badge",style:{background:"#f5f5f5",color:"#202223",padding:"4px 8px",borderRadius:"12px",fontSize:"12px",fontWeight:600},children:t.totalCallCount||0})}),e.jsx("td",{style:{textAlign:"center"},children:e.jsx("span",{className:"status-badge",children:V(t.callStatus)})}),e.jsx("td",{style:{textAlign:"center"},children:(()=>{const r=(t.calls&&t.calls.length>0?t.calls[0]:null)?.callSentiment||t.callSentiment||null,n=Ne(r);return e.jsxs("span",{className:"sentiment-tag",style:{backgroundColor:n.color},children:[e.jsx("span",{className:"sentiment-bars-container",children:Array.from({length:n.totalBars}).map((o,i)=>e.jsx("span",{className:`sentiment-bar ${i<n.filledBars?"filled":""}`,style:{backgroundColor:i<n.filledBars?n.barColor:"#e5e7eb"}},i))}),e.jsx("span",{className:"sentiment-label",children:n.label})]})})()}),e.jsx("td",{style:{textAlign:"center"},onClick:a=>a.stopPropagation(),children:e.jsx("button",{className:"btn btn-primary btn-sm",onClick:()=>J([t.orderId||t.id]),children:"AI Call"})})]},t.id))})()})]})]})})]}),ae&&e.jsx("div",{className:"modal-overlay",onClick:()=>f(!1),children:e.jsxs("div",{className:"modal-content",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h3",{children:["Bulk AI Call - ",k.length," Orders"]}),e.jsx("button",{className:"modal-close",onClick:()=>f(!1),children:"Ã—"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("p",{children:"Choose a script to use for the selected orders:"}),e.jsx("div",{className:"scripts-list",children:S.length>0?S.map(s=>e.jsxs("div",{className:"script-option",onClick:()=>xe(s.id,s.name),children:[e.jsx("div",{className:"script-name",children:s.name}),e.jsx("div",{className:"script-preview",children:s.content?s.content.substring(0,100)+(s.content.length>100?"...":""):"No content"})]},s.id)):e.jsx("p",{style:{textAlign:"center",color:"#666"},children:"No scripts available. Please create a script first."})}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-secondary",onClick:()=>f(!1),children:"Cancel"})})]})]})}),re&&e.jsx("div",{className:"modal-overlay",children:e.jsx("div",{className:"modal-content",children:e.jsxs("div",{className:"modal-body",style:{textAlign:"center"},children:[e.jsx("h3",{children:"Processing Bulk AI Call"}),e.jsxs("p",{children:["Setting ",k.length," orders in queue..."]}),e.jsx("div",{className:"spinner"})]})})}),ne&&e.jsx("div",{className:"modal-overlay",onClick:()=>g(!1),children:e.jsxs("div",{className:"modal-content order-details-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:z?"Loading...":`Order Details - ${c?.orderNumber||"N/A"}`}),e.jsx("button",{className:"modal-close",onClick:()=>g(!1),children:"Ã—"})]}),z?e.jsx("div",{className:"modal-body",style:{textAlign:"center",padding:"40px"},children:e.jsx("div",{className:"spinner"})}):c&&e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"order-info",children:[e.jsxs("div",{className:"info-section",children:[e.jsx("h4",{children:"Customer Information"}),e.jsxs("div",{className:"info-grid",children:[e.jsxs("div",{className:"info-item",children:[e.jsx("label",{children:"Name:"}),e.jsx("span",{children:c.customerName||"N/A"})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("label",{children:"Phone:"}),e.jsx("span",{children:c.customerPhone||"N/A"})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("label",{children:"Email:"}),e.jsx("span",{children:c.customerEmail||"N/A"})]})]})]}),e.jsxs("div",{className:"info-section",children:[e.jsx("h4",{children:"Address Information"}),e.jsxs("div",{className:"address-comparison",children:[e.jsxs("div",{className:"address-item",children:[e.jsx("label",{children:"Original Address:"}),e.jsx("div",{className:"address-text",children:c.customerAddress||"N/A"})]}),m.some(s=>s.newAddress)&&e.jsxs("div",{className:"address-item",children:[e.jsx("label",{children:"Updated Address:"}),e.jsx("div",{className:"address-text updated",children:m.find(s=>s.newAddress)?.newAddress||"N/A"}),e.jsxs("div",{style:{marginTop:"8px",display:"flex",gap:"8px"},children:[e.jsx("button",{className:"btn btn-secondary btn-sm",onClick:()=>ge(m.find(s=>s.newAddress)?.id,c.customerAddress,m.find(s=>s.newAddress)?.newAddress),children:"Edit Address"}),e.jsx("button",{className:"btn btn-success btn-sm",onClick:()=>fe(c.orderId||c.id,m.find(s=>s.newAddress)?.newAddress),children:"Update in Shopify"})]})]})]})]}),e.jsxs("div",{className:"info-section",children:[e.jsx("h4",{children:"Order Information"}),e.jsxs("div",{className:"info-grid",children:[e.jsxs("div",{className:"info-item",children:[e.jsx("label",{children:"Order Number:"}),e.jsx("span",{children:c.orderNumber})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("label",{children:"Amount:"}),e.jsx("span",{children:c.totalPrice?`${c.totalPrice} ${c.currency||""}`:"N/A"})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("label",{children:"Date:"}),e.jsx("span",{children:be(c.createdAt)})]}),e.jsxs("div",{className:"info-item",children:[e.jsx("label",{children:"Status:"}),e.jsx("span",{className:"status-badge",children:V(c.callStatus)})]})]})]})]}),e.jsxs("div",{className:"calls-section",children:[e.jsxs("h4",{children:["Call History (",m.length," calls)"]}),m.length>0?e.jsx("div",{className:"calls-list",children:m.map((s,t)=>e.jsxs("div",{className:"call-item",children:[e.jsxs("div",{className:"call-header",children:[e.jsxs("div",{className:"call-info",children:[e.jsxs("div",{className:"call-number",children:["Call #",t+1]}),e.jsxs("div",{className:"call-meta",children:[e.jsx("div",{className:"call-date",children:ye(s.createdAt||s.startedAt)}),e.jsxs("div",{className:"call-duration",children:["Duration: ",s.callDuration?s.callDuration+"s":"N/A"]})]})]}),e.jsx("div",{className:"call-status",children:e.jsx("span",{className:"status-badge",children:s.callStatus||"Unknown"})})]}),e.jsxs("div",{className:"call-content",children:[s.callOutcomeCategory&&e.jsxs("div",{className:"call-row",children:[e.jsx("div",{className:"call-label",children:"Outcome:"}),e.jsx("div",{className:"call-value",children:s.callOutcomeCategory})]}),s.callInterestScore&&e.jsxs("div",{className:"call-row",children:[e.jsx("div",{className:"call-label",children:"Interest Score:"}),e.jsx("div",{className:"call-value",children:s.callInterestScore})]}),s.addressChangeRequested&&e.jsxs("div",{className:"call-row",children:[e.jsx("div",{className:"call-label",children:"Address Change:"}),e.jsx("div",{className:"call-value",children:"Requested"})]}),s.newAddress&&e.jsxs("div",{className:"call-row",children:[e.jsx("div",{className:"call-label",children:"New Address:"}),e.jsx("div",{className:"call-value",children:s.newAddress})]}),s.audioUrl&&s.audioUrl.startsWith("https://")&&e.jsxs("div",{className:"call-audio",children:[e.jsx("div",{className:"call-label",children:"Audio:"}),e.jsxs("div",{className:"call-value",children:[e.jsx("audio",{controls:!0,style:{width:"100%",height:"40px",margin:"8px 0"},children:e.jsx("source",{src:s.audioUrl,type:"audio/mpeg"})}),e.jsx("button",{className:"btn btn-secondary btn-sm",onClick:()=>je(s.audioUrl,s.callId||s.id),style:{marginTop:"8px",width:"100%"},children:"ðŸ“¥ Download Audio"})]})]}),s.transcript&&e.jsxs("div",{className:"call-transcript",children:[e.jsx("div",{className:"call-label",children:"Transcript:"}),e.jsx("div",{className:"call-value",children:e.jsx("div",{className:"transcript-content",children:s.transcript})})]}),s.callSummary&&e.jsxs("div",{className:"call-summary",children:[e.jsx("div",{className:"call-label",children:"Summary:"}),e.jsx("div",{className:"call-value",children:e.jsx("div",{className:"summary-content",children:s.callSummary})})]})]})]},s.id||t))}):e.jsx("div",{className:"no-calls",children:e.jsx("p",{children:"No calls made for this order yet."})})]})]})]})})]})};export{ds as default};
