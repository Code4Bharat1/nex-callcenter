import{a as oe,r as a,j as e}from"./index-B_YWOrie.js";import{api as de}from"./api-CYk9FEKy.js";const ue=({shop:L})=>{const[_]=oe(),i=L||_.get("shop"),[H,Q]=a.useState([]),[n,k]=a.useState(null),[B,X]=a.useState(null),[U,j]=a.useState(!0),[T,E]=a.useState(!1),[o,v]=a.useState("phrasing"),[N,Y]=a.useState({totalTalks:0,refinedCount:0,conversionRate:0}),[P,Z]=a.useState([]),[A,K]=a.useState([]),[D,M]=a.useState(15),[h,O]=a.useState(""),[u,z]=a.useState(""),[m,I]=a.useState([]),[x,F]=a.useState([]),[W,q]=a.useState([]),[G,$]=a.useState([]),[r,J]=a.useState(!1),[d,V]=a.useState([]),[p,ee]=a.useState([]),[b,se]=a.useState(30),[g,te]=a.useState(null),[f,ae]=a.useState(null),S=a.useRef(null),w=a.useRef(null);a.useEffect(()=>{i&&ne()},[i]),a.useEffect(()=>{n&&ie()},[n,i,b]);const ne=async()=>{try{const s=await de.getScripts(i),t=s?.scripts||s||[];Q(t),t.length>0&&!n&&k(t[0].id)}catch(s){console.error("Error loading scripts:",s)}finally{j(!1)}},ie=async()=>{if(!(!n||!i))try{j(!0);const s=await fetch(`/api/script-refinement-data?scriptId=${n}&shop=${encodeURIComponent(i)}&durationJump=${b}`,{credentials:"include"});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const t=await s.json();t.success&&(X(t.script),Y({totalTalks:t.metrics.totalTalks||0,refinedCount:t.metrics.refinedCount||0,conversionRate:t.metrics.conversionRate||0}),I(t.phrasingNotes||[]),F(t.wayOfReplyingNotes||[]),q(t.phrasingExamples||[]),$(t.wayOfReplyingExamples||[]),V(t.graphs?.turnsDistribution||[]),ee(t.graphs?.durationDistribution||[]))}catch(s){console.error("Error loading script data:",s)}finally{j(!1)}};a.useEffect(()=>{if(!d.length&&!p.length)return;if(typeof window.Chart>"u"){const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js",t.onload=()=>s(),document.head.appendChild(t)}else s();function s(){if(!(typeof window.Chart>"u")){if(g&&g.destroy(),f&&f.destroy(),S.current&&d.length>0){const t=S.current.getContext("2d"),l=d.map(c=>`${c.turns} turns`),C=d.map(c=>c.count),R=new window.Chart(t,{type:"line",data:{labels:l,datasets:[{label:"Number of Calls",data:C,borderColor:"#4B5CFF",backgroundColor:"rgba(75, 92, 255, 0.1)",borderWidth:2,fill:!0,tension:.4,pointRadius:4,pointHoverRadius:6}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},title:{display:!0,text:"Total Turns in Call Frequency Distribution"}},scales:{y:{beginAtZero:!0,ticks:{stepSize:1}},x:{title:{display:!0,text:"Number of Turns"}}}}});te(R)}if(w.current&&p.length>0){const t=w.current.getContext("2d"),l=p.map(c=>c.range+"s"),C=p.map(c=>c.count),R=new window.Chart(t,{type:"line",data:{labels:l,datasets:[{label:"Number of Calls",data:C,borderColor:"#10B981",backgroundColor:"rgba(16, 185, 129, 0.1)",borderWidth:2,fill:!0,tension:.4,pointRadius:4,pointHoverRadius:6}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},title:{display:!0,text:"Total Call Duration Frequency Distribution"}},scales:{y:{beginAtZero:!0,ticks:{stepSize:1}},x:{title:{display:!0,text:"Duration Range (seconds)"}}}}});ae(R)}}}return()=>{g&&g.destroy(),f&&f.destroy()}},[d,p]);const re=async()=>{if(!n||!i){alert("Please select a script first");return}try{E(!0);const t=await(await fetch("/api/script-refinement-analyze",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({scriptId:n,shop:i,transcriptCount:D})})).json();t.success?(Z(t.phrases||[]),K(t.qaPairs||[]),alert(`Analysis complete! Found ${t.phrases.length} unique phrases and ${t.qaPairs.length} Q&A pairs.`)):alert(t.error||"Analysis failed")}catch(s){console.error("Error analyzing:",s),alert("Error analyzing transcripts")}finally{E(!1)}},le=async()=>{if(!(!h.trim()||!n))try{const t=await(await fetch("/api/script-refinement-note",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({scriptId:n,type:"phrasing",note:h})})).json();t.success&&(I([...m,t.note]),O(""),alert("Note saved successfully"))}catch(s){console.error("Error saving note:",s),alert("Error saving note")}},ce=async()=>{if(!(!u.trim()||!n))try{const t=await(await fetch("/api/script-refinement-note",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({scriptId:n,type:"way_of_replying",note:u})})).json();t.success&&(F([...x,t.note]),z(""),alert("Note saved successfully"))}catch(s){console.error("Error saving note:",s),alert("Error saving note")}},y=async s=>{if(n)try{J(!0);const l=await(await fetch("/api/script-refinement-generate-examples",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({scriptId:n,type:s})})).json();l.success?(s==="phrasing"?q(l.examples||[]):$(l.examples||[]),alert("Examples generated successfully")):alert(l.error||"Failed to generate examples")}catch(t){console.error("Error generating examples:",t),alert("Error generating examples")}finally{J(!1)}};return U&&!B?e.jsx("div",{className:"script-refining-container",children:"Loading..."}):e.jsxs("div",{className:"script-refining-container",children:[e.jsxs("div",{className:"script-refining-header",children:[e.jsx("h1",{children:"Script Refiner"}),e.jsx("p",{className:"subtitle",children:"Prompt Refining"})]}),e.jsxs("div",{className:"script-selector-section",children:[e.jsx("label",{htmlFor:"script-select",children:"Select Script"}),e.jsxs("select",{id:"script-select",value:n||"",onChange:s=>k(parseInt(s.target.value)),className:"script-select",children:[e.jsx("option",{value:"",children:"-- Select a script --"}),H.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"metrics-cards",children:[e.jsxs("div",{className:"metric-card",children:[e.jsx("div",{className:"metric-value",children:N.totalTalks}),e.jsx("div",{className:"metric-label",children:"TOTAL TALKS"}),e.jsx("div",{className:"metric-subtext",children:"(happened with script after last refined)"})]}),e.jsxs("div",{className:"metric-card",children:[e.jsx("div",{className:"metric-value",children:N.refinedCount}),e.jsx("div",{className:"metric-label",children:"REFINED"}),e.jsx("div",{className:"metric-subtext",children:"times"})]}),e.jsxs("div",{className:"metric-card",children:[e.jsxs("div",{className:"metric-value",children:[N.conversionRate.toFixed(1),"%"]}),e.jsx("div",{className:"metric-label",children:"CONVERSION RATE"}),e.jsx("div",{className:"metric-subtext",children:"(after last refined)"})]})]}),e.jsxs("div",{className:"graphs-section",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"20px",marginBottom:"30px"},children:[e.jsx("div",{className:"graph-container",style:{background:"white",padding:"20px",borderRadius:"8px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},children:e.jsx("canvas",{ref:S,style:{maxHeight:"300px"}})}),e.jsxs("div",{className:"graph-container",style:{background:"white",padding:"20px",borderRadius:"8px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},children:[e.jsxs("div",{style:{marginBottom:"12px",display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("label",{style:{fontSize:"14px",fontWeight:"500",color:"#374151"},children:"Duration Jump (seconds):"}),e.jsx("input",{type:"number",min:"10",max:"300",step:"10",value:b,onChange:s=>{const t=parseInt(s.target.value)||30;se(t)},style:{width:"80px",padding:"6px 8px",border:"1px solid #d1d5db",borderRadius:"6px",fontSize:"14px"}})]}),e.jsx("canvas",{ref:w,style:{maxHeight:"300px"}})]})]}),e.jsx("div",{className:"analyze-section",children:e.jsxs("div",{className:"analyze-controls",children:[e.jsxs("label",{children:["Transcripts to analyze:",e.jsx("input",{type:"number",min:"1",max:"100",value:D,onChange:s=>M(parseInt(s.target.value)||15),className:"transcript-count-input"})]}),e.jsx("button",{onClick:re,disabled:T||!n,className:"analyze-button",children:T?"Analyzing...":"Analyze"})]})}),e.jsxs("div",{className:"tabs-container",children:[e.jsxs("div",{className:"tabs",children:[e.jsx("button",{className:`tab ${o==="phrasing"?"active":""}`,onClick:()=>v("phrasing"),children:"Phrasing"}),e.jsx("button",{className:`tab ${o==="way-of-replying"?"active":""}`,onClick:()=>v("way-of-replying"),children:"Way of Replying"}),e.jsx("button",{className:`tab ${o==="review"?"active":""}`,onClick:()=>v("review"),children:"Review"})]}),e.jsxs("div",{className:"tab-content",children:[o==="phrasing"&&e.jsx("div",{className:"phrasing-tab",children:e.jsxs("div",{className:"two-column-layout",children:[e.jsxs("div",{className:"left-column",children:[e.jsx("h3",{children:"Unique Phrases Spoken by Agent"}),e.jsx("div",{className:"phrases-list",children:P.length===0?e.jsx("p",{className:"empty-state",children:'No phrases extracted yet. Click "Analyze" to extract phrases from transcripts.'}):P.map((s,t)=>e.jsx("div",{className:"phrase-item",children:s},t))})]}),e.jsx("div",{className:"right-column",children:e.jsxs("div",{className:"note-taker-widget",children:[e.jsx("h4",{children:"Note Taker (Phrasing)"}),e.jsx("textarea",{value:h,onChange:s=>O(s.target.value),placeholder:"Write feelings about phrasing...",className:"note-textarea",rows:"8"}),e.jsx("button",{onClick:le,disabled:!h.trim(),className:"save-note-button",children:"Save Note"})]})})]})}),o==="way-of-replying"&&e.jsx("div",{className:"way-of-replying-tab",children:e.jsxs("div",{className:"two-column-layout",children:[e.jsxs("div",{className:"left-column",children:[e.jsx("h3",{children:"Unique Q&A Pairs"}),e.jsx("div",{className:"qa-pairs-list",children:A.length===0?e.jsx("p",{className:"empty-state",children:'No Q&A pairs extracted yet. Click "Analyze" to extract Q&A pairs from transcripts.'}):A.map((s,t)=>e.jsxs("div",{className:"qa-pair-item",children:[e.jsxs("div",{className:"customer-question",children:[e.jsx("strong",{children:"Customer:"})," ",s.customer]}),e.jsxs("div",{className:"agent-reply",children:[e.jsx("strong",{children:"Agent:"})," ",s.agent]})]},t))})]}),e.jsx("div",{className:"right-column",children:e.jsxs("div",{className:"note-taker-widget",children:[e.jsx("h4",{children:"Note Taker (Way of Replying)"}),e.jsx("textarea",{value:u,onChange:s=>z(s.target.value),placeholder:"Write feelings about way of replying...",className:"note-textarea",rows:"8"}),e.jsx("button",{onClick:ce,disabled:!u.trim(),className:"save-note-button",children:"Save Note"})]})})]})}),o==="review"&&e.jsxs("div",{className:"review-tab",children:[e.jsxs("div",{className:"review-section",children:[e.jsx("h3",{children:"Phrasing Notes"}),m.length===0?e.jsx("p",{className:"empty-state",children:"No notes saved yet"}):e.jsx("div",{className:"notes-list",children:m.map((s,t)=>e.jsxs("div",{className:"saved-note",children:[s.note,e.jsx("span",{className:"note-date",children:new Date(s.createdAt).toLocaleDateString()})]},t))}),e.jsxs("div",{className:"affect-section",children:[e.jsx("h4",{children:"Affect"}),W.length===0?e.jsxs("div",{children:[e.jsx("p",{children:"GPT produced: Currently X kind of phrase will be Y kind of"}),e.jsx("p",{className:"empty-state",children:"No examples generated yet. Click 'Fix' to generate."}),e.jsx("button",{onClick:()=>y("phrasing"),disabled:r||m.length===0,className:"fix-button",children:r?"Generating...":"Fix"})]}):e.jsxs("div",{children:[e.jsx("p",{children:"GPT produced: Currently X kind of phrase will be Y kind of"}),e.jsx("div",{className:"examples-list",children:W.map((s,t)=>e.jsx("div",{className:"example-item",children:s.example},t))}),e.jsx("button",{onClick:()=>y("phrasing"),disabled:r,className:"fix-button",children:r?"Generating...":"Fix"})]})]})]}),e.jsxs("div",{className:"review-section",children:[e.jsx("h3",{children:"Way of Replying Notes"}),x.length===0?e.jsx("p",{className:"empty-state",children:"No notes saved yet"}):e.jsx("div",{className:"notes-list",children:x.map((s,t)=>e.jsxs("div",{className:"saved-note",children:[s.note,e.jsx("span",{className:"note-date",children:new Date(s.createdAt).toLocaleDateString()})]},t))}),e.jsxs("div",{className:"affect-section",children:[e.jsx("h4",{children:"Affect"}),G.length===0?e.jsxs("div",{children:[e.jsx("p",{children:"GPT produced: Currently X kind of reply will be replied like this"}),e.jsx("p",{className:"empty-state",children:"No examples generated yet. Click 'Fix' to generate."}),e.jsx("button",{onClick:()=>y("way_of_replying"),disabled:r||x.length===0,className:"fix-button",children:r?"Generating...":"Fix"})]}):e.jsxs("div",{children:[e.jsx("p",{children:"GPT produced: Currently X kind of reply will be replied like this"}),e.jsx("div",{className:"examples-list",children:G.map((s,t)=>e.jsx("div",{className:"example-item",children:s.example},t))}),e.jsx("button",{onClick:()=>y("way_of_replying"),disabled:r,className:"fix-button",children:r?"Generating...":"Fix"})]})]})]})]})]})]})]})};export{ue as default};
