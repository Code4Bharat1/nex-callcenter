import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { Play, Copy, Download, Save, ArrowLeft, ThumbsUp, ThumbsDown, Layers, MessageCircle, Zap, HelpCircle, FileText, Workflow } from 'lucide-react';
import { SkeletonBox, SkeletonText } from '../components/SkeletonLoader';
import ReactMarkdown from 'react-markdown';

// Memoji files array (same as TestCall)
const MEMOJI_FILES = [
  '/images/1 Happy.svg',
  '/images/2 Happy.svg',
  '/images/3 happy.svg',
  '/images/4 happy.svg',
  '/images/6 happy.svg',
  '/images/Character=Angela, Skin tone=White, Posture=1 Happy.svg',
  '/images/Character=Darlene, Skin tone=White, Posture=1 Happy.svg',
  '/images/Character=Jeniffer, Skin tone=White, Posture=1 Happy.svg',
  '/images/Character=Kim, Skin tone=White, Posture=1 Happy.svg',
];

const MEMOJI_BACKGROUNDS = [
  '#F9FFF1', '#FFF9F0', '#F0F9FF', '#F9F0FF', '#FFF0F9',
  '#F0FFF9', '#FFF5F0', '#F5F0FF', '#F0F5FF', '#FFF0F5',
];

const getAgentMemoji = (agentId) => {
  const index = agentId ? (parseInt(agentId) % MEMOJI_FILES.length) : 0;
  const bgIndex = agentId ? (parseInt(agentId) % MEMOJI_BACKGROUNDS.length) : 0;
  return {
    memoji: MEMOJI_FILES[index],
    background: MEMOJI_BACKGROUNDS[bgIndex],
  };
};
import {
  getCallScripts,
  createScript,
  updateScript,
  deleteScript,
  getTestOrders,
  createTestOrder,
  queueTestOrder,
  getVoices,
  previewVoice,
  previewSarvamVoice,
  getKnowledgeBooks,
  createKnowledgeBook,
  updateKnowledgeBook,
  deleteKnowledgeBook,
  generateScriptWithClaude,
  api,
} from '../utils/api';
import Editor from '@monaco-editor/react';
import FlowMaker from '../components/FlowMaker';
import Loading from '../components/Loading';
import './Playground.css';
import './Settings.css';

const SMART_ADDRESS_SCRIPT = `# boAt Voice AI Agent - Dynamic Address Verification Script (COD Orders)

**Agent Profile:** Female voice, warm & helpful
**Brand:** boAt Lifestyle
**Objective:** Complete incomplete address details for COD delivery
**Tone:** Conversational, quick, respectful of customer's time
**CRITICAL RULE:** ALL numbers must ALWAYS be spoken digit-by-digit in English (e.g., "one four nine nine" not "fourteen ninety-nine" or "1499")
**LAUGHTER USAGE:** Agent can use [laughter] naturally to keep conversation light and friendly - TTS will speak this as actual laughter
**DYNAMIC VARIABLES:** Script uses {variable} format for all customer-specific data

---

## DYNAMIC VARIABLES REFERENCE
**Required Variables (Must be provided):**
- {customer_name} - Customer's first name or full name
- {order_number} - Order ID/number
- {order_amount} - Total order value in rupees (spoken digit-by-digit)
- {customer_address} - Current incomplete address string
- {delivery_date} - Expected delivery date
- {product_name} - Product ordered
- {phone_number} - Customer's phone number (10 digits, spoken digit-by-digit)

**Optional Variables (Good to have):**
- {city} - City name from partial address (if available)
- {state} - State name from partial address (if available)
- {product_model} - Specific model number
- {order_date} - When order was placed

**Variables to be Collected During Call:**
- {house_number} - House/Flat/Building number
- {locality} - Area/Locality/Sector name
- {pincode} - 6-digit pincode
- {landmark} - Optional nearby landmark

---

## OPENING SEQUENCE
**Agent:** Hello! Am I speaking with {customer_name}?
*[Wait for confirmation]*

**Agent:** Hi {customer_name}! This is Priya from boAt delivery team. I'm calling about your order - the {product_name} that you placed for {order_amount} rupees COD. Your address is incomplete, I just need your house number, locality name, and pincode to confirm delivery. This will take just one minute. Can we do it quickly now?

*[If busy]* No worries! [laughter] When should I call back? Ten minutes? Fifteen minutes?
*[If available - continue directly to collection]*

---

## INFORMATION COLLECTION FLOW
### Step 1: House/Flat Number
**Agent:** Perfect! So your current address shows as "{customer_address}" - let me complete the missing parts. First, what's your house number or flat number? You know, jo building mein aapka number hai?
*[Customer responds with house/flat number]*

**Responses based on answer:**
- **If clear number given:** **Agent:** Perfect! [Repeat number digit-by-digit]. Got it noted down.
- **If vague answer:** **Agent:** Okay second floor, but is there a specific flat number? [laughter] Because usually buildings have numbering na? Just so the delivery person doesn't have to knock multiple doors.
- **If says "independent house":** **Agent:** Achha, independent house hai! Okay, toh house number kya hai? Like H dash two three type?
- **If customer doesn't know exact number:** **Agent:** No worries! [laughter] Umm, okay so when delivery person comes, kaunsa building ya which floor aapka hai? We can mention that as reference.

### Step 2: Locality/Area Name
**Agent:** Cool! Next, the area or locality name? {customer_address} mein jo area hai, uska specific naam kya hai?
*[Customer responds with locality]*

**Responses based on answer:**
- **If clear locality given:** **Agent:** [Locality name], perfect! That's exactly what I needed.
- **If says "I just know it's near XYZ":** **Agent:** Haan I understand, but see the thing is, for our system and for the delivery partner GPS, we need the actual locality name. Umm, ek kaam karo - Google Maps mein dekh lo quickly? [laughter] It'll show the area name when you search your location. I can wait. *[Brief pause]* Or if you have any recent Amazon or Flipkart delivery, check the address on that? Usually same locality toh hoga?
- **If customer is confused:** **Agent:** No problem! Let me help. So your location, it's in which sector or which main road ke paas hai? *[Take whatever customer provides and confirm]* Okay so I'm putting [Customer's Answer] as the locality. Agar delivery person ko issue aaye we'll call you, don't worry. [laughter]

### Step 3: Pincode
**Agent:** Last thing {customer_name}, and we're done - what's the pincode for this area?
*[Customer responds with pincode]*

**Responses based on answer:**
- **If correct 6-digit pincode given:** **Agent:** [Repeat pincode digit-by-digit], perfect! Let me just verify... yes, confirmed!
- **If wrong format:** **Agent:** Umm, {customer_name} I think woh poora nahi aaya. Pincode is usually six digits. Can you check once?
- **If customer doesn't know:** **Agent:** Achha, no problem! [laughter] Umm, do you know any nearby landmark? Like koi main market ya popular place nearby? *[Customer mentions landmark]* Let me check based on the landmark... *[Alternative]* You know what, ek kaam karo - Google mein type karo "pincode {customer_address}" or "pincode near [landmark]". Pehla result mein aa jayega. I'll hold.

### Step 4: Optional Landmark (Bonus Info)
**Agent:** {customer_name}, one last optional thing - is there any landmark near your place? Like koi famous shop, park, hospital, anything? Not mandatory, but it helps the delivery person. [laughter]
- **If provided:** **Agent:** [Landmark name], noted! That's super helpful actually.
- **If no:** **Agent:** No worries at all! We have enough information.

---

## ADDRESS CONFIRMATION
**Agent:** Awesome! Let me just quickly read out your complete address once, just to make sure everything's correct. Okay?
So it's:
[House/Flat Number], {customer_address},
[Locality Name], {city} {state} - [Pincode - each digit separately]
*[If landmark collected: Landmark: [Name]]*
And your contact number is {phone_number}.
Sahi hai na sab?

- **If yes:** **Agent:** Perfect! Your address is now updated in our system.
- **If change needed:** **Agent:** Sure sure, batao kya change karna hai? *[Make corrections and re-confirm]*

---

## CLOSING SEQUENCE
### Standard Closing (Address Complete)
**Agent:** Excellent {customer_name}! Your complete address is now locked in. So your {product_name} will be delivered by {delivery_date}.

Just a quick reminder since it's a Cash on Delivery order - keep exact cash ready ya. [laughter] {order_amount} rupees rahega total. Delivery person won't have change usually.

Aur haan, once the product is dispatched, you'll get a tracking link on your phone via SMS. You can track it live.

If the delivery person faces any issue finding your location, he'll call you on {phone_number}, so just keep your phone handy on delivery day.

Anything else you need help with regarding this order?
- **If no:** **Agent:** Perfect! Thank you for ordering with boAt. You're gonna love the {product_name}. Welcome to the boAthead family! Agar koi bhi question hai, you can call us at zero two two dash six nine one eight dash one nine two zero between ten to nine. Bye {customer_name}, have a great day!
- **If yes:** *[Address the question and close]*

### Alternative Closing (If Customer Seems Rushed)
**Agent:** Done {customer_name}! Your address is updated. Your {product_name} will reach you by {delivery_date}, keep {order_amount} rupees cash ready, and you'll get tracking link on SMS. Any confusion, call us anytime. Thanks, bye!

---

## HANDLING SPECIAL SCENARIOS
### Scenario 1: Customer Asks "Why do you need this?"
**Agent:** Great question! So actually, when you placed order {order_number}, the address field had "{customer_address}" but it didn't have the complete house number, locality name, and pincode. Without these, our delivery partner won't be able to deliver. [laughter] Their GPS needs the pincode to route the package, and the delivery person needs the house number to actually hand it to you, right? I'm just completing that info so your order doesn't get stuck or returned. That's it! Should we quickly do it now?

### Scenario 2: Customer Says "Can't I just update it online?"
**Agent:** Umm, you could, but the thing is your order {order_number} is already in processing. Once it's confirmed, the address can only be updated through our team - system mein direct edit nahi hota. [laughter] Since I have you on the line right now, we can finish it in one minute. Otherwise you'll have to call support, explain everything again, wait on hold... this is faster na? Plus I need to verify it's really you making the change, for security reasons. So shall we just complete it quickly?

### Scenario 3: Customer Mentions Different City/Location
**Agent:** Oh wait, sorry {customer_name} - you said [Different City]? But in the order, {customer_address} is mentioned.
*[If deliver elsewhere]* **Agent:** Alright, let me quickly check if we deliver to [City] and what the timeline would be...
- **If serviceable:** Need full address for new city.
- **If not:** Explain COD not available, offer prepaid or original address.

### Scenario 4: Customer Cancels/Changes Mind About Order
**Agent:** Oh! Okay, no problem. So you want to cancel order {order_number}? *[Customer confirms]* **Agent:** Sure, I can help with that. [laughter] Can I just know the reason? Just for our feedback - was it delivery time, or price, or something else?
*[Listen and respond, then confirm cancellation details]*

### Scenario 5: Customer Gives Wrong/Fake Information
**Agent:** Umm {customer_name}, I'm just verifying this in our system... the pincode you mentioned, [repeat digit-by-digit], it's not showing as valid. [laughter] Can you double-check that once?
- **If insists:** **Agent:** Okay, I'm putting [pincode]. But if the courier rejects it, we'll have to call you again to update. Maybe check an old courier package to be sure?

### Scenario 6: Customer's Phone Keeps Cutting/Bad Network
**Agent:** Hello? {customer_name}? Can you hear me?
- *[If call drops]* Call back after 30 seconds.
- *[If network bad]* Offer WhatsApp message with required details or schedule callback.

### Scenario 7: Multiple Interruptions/Customer Busy
**Agent:** Hey {customer_name}, I can sense you're in the middle of something. No problem! When's a good time for me to call you back? Evening around six? Or should I just send everything on WhatsApp at {phone_number} and you can reply with the details whenever you're free?

---

## CONVERSATION PRINCIPLES FOR ADDRESS CALLS
**DO:**
- ALWAYS speak numbers digit-by-digit in English.
- Use [laughter] naturally 3-5 times.
- Always use dynamic variables.
- Get to the main objective within first ten seconds.
- Keep it quick and appreciative.
- Read back the complete address for confirmation.
- Remind them of COD amount so they keep cash ready.

**DON'T:**
- Group digits while speaking numbers.
- Overuse [laughter].
- Hardcode customer data.
- Waste time with long intros.
- Sound doubtful or keep them on call too long.
- Forget to confirm the final address.

**LAUGHTER PLACEMENT TIPS:** Use after awkward moments, light requests, minor issuesâ€”never during critical info confirmation.

**TIME TARGET:** 1-2 minutes max.
**ENERGY:** Helpful, efficient, collaborative.

---

## VARIABLE HANDLING NOTES FOR IMPLEMENTATION
### Number Speaking Rule (CRITICAL)
Any variable containing numbers must be spoken digit-by-digit:
- {order_amount} = "one four nine nine"
- {phone_number} = "nine eight seven six five four three two one zero"
- {pincode} = "one eight zero zero zero four"
- {order_number} = "B O A T" plus digits

### Text Variables
Spoken naturally as written (e.g., {customer_name}, {product_name}, {city}, {state}, {delivery_date}).

### Fallback Handling
If any variable is missing or null, use generic terms or skip optional mentions. Keep the conversation flowing.

### Example Variable Population
customer_name: Aditya
order_number: BOAT2024112401
order_amount: 1499
customer_address: Near Pretty Day Apartments, Jammu
delivery_date: November 28, 2025
product_name: boAt Airdopes 141
phone_number: 9876543210
city: Jammu
state: Jammu and Kashmir

### Example Rendered Script Opening
"Hi Aditya! This is Priya from boAt delivery team. I'm calling about your order - the boAt Airdopes one four one that you placed for one four nine nine rupees COD. Your address is incomplete..."

---

## SYSTEM NOTES TEMPLATE (Internal - Don't Read Out)
Order Number: {order_number}
Customer Name: {customer_name}
Address Verified: Yes
Verified By: Priya (AI Agent)
Verification Date: [Current Date]
Verification Time: [Current Time]
Complete Address Collected:
House/Flat: {house_number}
Address Line: {customer_address}
Locality: {locality}
City: {city}
State: {state}
Pincode: {pincode}
Landmark: {landmark} (if provided)
Phone: {phone_number}
Customer Confirmed: Yes
Special Instructions: [Any additional notes from conversation]

---

**END OF SCRIPT**
Note: This script is designed for dynamic calling. All customer-specific data is variable-driven. Test with different variable combinations before deploying at scale.`;

const COD_THANK_YOU_SCRIPT = `# boAt Voice AI Agent - COD Order Quick Gratitude Call

**Agent Profile:** Female voice, warm & sweet
**Brand:** boAt Lifestyle
**Objective:** Quick thank you + support offer
**Tone:** Natural, conversational, brief
**CRITICAL RULE:** ALL numbers must ALWAYS be spoken digit-by-digit in English
**Call Duration:** 15-20 seconds
**DYNAMIC VARIABLES:** Script uses {variable} format for all customer-specific data

---

## DYNAMIC VARIABLES REFERENCE
**Required Variables:**
- {customer_name} - Customer's first name
- {product_name} - Product ordered
- {order_number} - Order ID/number
- {phone_number} - Customer's contact number (spoken digit-by-digit)

**Optional Variables:**
- {delivery_date} - Expected delivery date
- {order_amount} - Order value in rupees (spoken digit-by-digit)

---

## THE CALL
**Agent:** Hello {customer_name}! I'm Priya from boAt. I'm calling on behalf of the boAt team to congratulate you for ordering from us. I personally want to thank you so much for believing in us, and hum make sure karte hai parcel acche se pack aur deliver ho. And if you ever need to return or product issues, you can anytime contact us back on this number. And is there anything you would want to know about the order?

*[Pause - wait for customer response]*

---

## HANDLING CUSTOMER RESPONSES
### Customer Says: "No" / "I'm good" / "Nothing"
**Agent:** Perfect! Thank you so much, bye {customer_name}!

### Customer Says: "When will it be delivered?"
**Agent:** Your {product_name} will be delivered in {delivery_date}. You'll get tracking link on your phone once it's shipped. Anything else?
*[If no]:* Thank you, bye!

### Customer Says: "What's the order number?"
**Agent:** Your order number is {order_number}. Anything else?
*[If no]:* Thank you, bye!

### Customer Says: "How much is the order amount?"
**Agent:** It's {order_amount} rupees. Cash on delivery. Keep exact amount ready when it arrives! Anything else?
*[If no]:* Thank you, bye!

### Customer Says: "What's your contact number?"
**Agent:** This number only - {phone_number}. You can call or WhatsApp anytime. Anything else?
*[If no]:* Thank you, bye!

### Customer Says: "I want to change my address"
**Agent:** Sure! What's the new address?
*[Take details: house number, locality, pincode]*
Done! Your order {order_number} will now be delivered to [repeat new address]. Anything else?
*[If no]:* Thank you, bye {customer_name}!

### Customer Says: "I want to cancel"
**Agent:** Okay, no problem! Can I just know why?
*[Listen to reason]*
Understood! I'll cancel order {order_number} right now. Since it's COD there's no refund process. You'll get a confirmation message in ten minutes. Thank you for your time, bye!

### Customer Says: "Can I change to prepaid?"
**Agent:** Once the order is placed as COD, we can't change payment method in the system. But I can cancel order {order_number} and you can place a fresh order with prepaid. Should I do that?
*[If yes - cancel and guide]*  *[If no]:* Okay, no problem. Anything else?

### Customer Says: "I didn't order this"
**Agent:** Oh! Did someone at home order using your number maybe?
*[If customer confirms no]* Okay, I'll cancel order {order_number} immediately. Really sorry for the confusion, bye!

### Customer Says: "Why are you calling?"
**Agent:** Just calling to congratulate you on your order and check if you need any help! That's all. Anything you'd like to know?
*[If no]:* Thank you, bye!

### Customer Asks: "What did I order?"
**Agent:** You ordered {product_name}! Coming in {delivery_date}. Anything else?
*[If no]:* Thank you, bye!

### Customer Says: "I'm busy right now"
**Agent:** Sure! Should I call back later?
*[If yes - take timing and schedule callback]*  *[If no]:* No problem! You can call us on {phone_number} if you need anything. Bye!

### Customer Is Rude: "Don't call me!" / "Stop calling!"
**Agent:** I understand. I'll make sure you don't receive any more calls. Sorry for disturbing, bye.

### Customer Has Product Question
**Agent:** Let me check that for you...
*[If info available, share it. If not]* I don't have that detail right now, but our support team can help. Call {phone_number} and they'll answer everything. Anything else?
*[If no]:* Thank you, bye!

---

## CALL PRINCIPLES
**DO:**
- Use all variables properly
- Keep it under 20 seconds if no questions
- Sound genuinely warm and grateful
- Always ask if they need help
- Be quick and helpful if they ask something
- End with "Thank you so much, bye {customer_name}"

**DON'T:**
- Drag unnecessarily
- Sound robotic
- Push back if customer wants to cancel
- Forget to use variables
- Keep them on call longer than 1-2 minutes

**TONE:** Sweet, genuine friend congratulating them and offering help. Quick, warm, professional.

---

## VARIABLE USAGE EXAMPLE
customer_name: Rahul
product_name: boAt Airdopes one four one
order_number: BOAT2024112401
phone_number: zero two two dash six nine one eight dash one nine two zero
delivery_date: three to four days
order_amount: one four nine nine

Rendered Call Opening:
"Hello Rahul! I'm Priya from boAt. I'm calling on behalf of the boAt team to congratulate you for ordering from us..."

---

## SYSTEM NOTES TEMPLATE
Call Type: COD Gratitude Call
Order Number: {order_number}
Customer Name: {customer_name}
Call Date: [Current Date]
Call Time: [Current Time]
Call Duration: [Seconds]
Customer Response: [Positive/Neutral/Negative/Special Request]
Action Taken: [None/Address Change/Cancellation/Other]
Follow-up Required: [Yes/No]
Notes: [Any special remarks from conversation]

---

**END OF SCRIPT**
Note: This script focuses on gratitude and support offer. Numbers are always spoken digit-by-digit.`;

// Normalize variable name for case-insensitive matching
const normalizeVariableName = (name) => {
  if (!name) return '';
  return name.trim().toLowerCase();
};

// Check if a variable is valid (case-insensitive)
const isValidVariable = (variableName) => {
  const normalized = normalizeVariableName(variableName);
  return Array.from(AUTO_VARIABLE_SET).some(validVar => normalizeVariableName(validVar) === normalized);
};

const extractVariables = (content = '') => {
  // Match both single braces {variable} and double braces {{variable}}
  const singleBracesRegex = /{([^{}]+)}/g;
  const doubleBracesRegex = /{{([^{}]+)}}/g;
  const matches = new Set();
  
  // Extract from single braces
  let match;
  while ((match = singleBracesRegex.exec(content)) !== null) {
    const variableName = match[1]?.trim();
    if (variableName && !variableName.startsWith('{')) { // Avoid matching double braces as single
      matches.add(variableName);
    }
  }
  
  // Extract from double braces
  while ((match = doubleBracesRegex.exec(content)) !== null) {
    const variableName = match[1]?.trim();
    if (variableName) {
      matches.add(variableName);
    }
  }
  
  return Array.from(matches).sort((a, b) => a.localeCompare(b));
};

const generateVariableBookId = () => `vb-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;

const AUTO_VARIABLE_GROUPS = [
  {
    label: 'Customer Name',
    description: 'Auto-filled from order information (fallback "Customer").',
    variables: ['customerName', 'CustomerName', 'customer_name', 'CUSTOMER_NAME', 'Customer_Name'],
    source: 'order.customer_name',
    shopifyFetched: false,
  },
  {
    label: 'Order Number',
    description: 'Auto-filled from order number.',
    variables: ['orderNumber', 'OrderNumber', 'order_number', 'ORDER_NUMBER'],
    source: 'order.order_number',
    shopifyFetched: false,
  },
  {
    label: 'Order Total / Price',
    description: 'Auto-filled from order total (formatted as string, integers shown without decimals).',
    variables: ['orderTotal', 'OrderTotal', 'order_total', 'ORDER_TOTAL', 'totalPrice', 'TOTAL_PRICE', 'orderAmount', 'OrderAmount', 'order_amount', 'Order_Amount'],
    source: 'order.total_price',
    shopifyFetched: false,
  },
  {
    label: 'Delivery Address',
    description: 'Auto-filled from delivery address.',
    variables: ['deliveryAddress', 'DeliveryAddress', 'delivery_address', 'DELIVERY_ADDRESS', 'address', 'ADDRESS'],
    source: 'order.customer_address',
    shopifyFetched: false,
  },
  {
    label: 'City',
    description: 'Auto-filled from inferred city within the address (4th from last comma-separated part).',
    variables: ['city', 'City', 'CITY'],
    source: 'extract_city(order.customer_address)',
    shopifyFetched: false,
  },
  {
    label: 'Order Date',
    description: 'Auto-filled from order placement date.',
    variables: ['order_date', 'OrderDate', 'orderDate', 'ORDER_DATE'],
    source: 'order.order_date',
    shopifyFetched: false,
  },
  {
    label: 'Order ID',
    description: 'Auto-filled from internal order ID.',
    variables: ['order_id', 'OrderId', 'orderId', 'ORDER_ID'],
    source: 'order.order_id',
    shopifyFetched: false,
  },
  {
    label: 'Product Name',
    description: 'Fetched from Shopify API using order number. Only fetched if placeholder is present in script. Limited to first 3 products, joined with " aur ".',
    variables: ['product_name', 'productName', 'ProductName', 'PRODUCT_NAME'],
    source: 'Shopify API (fetched on-demand)',
    shopifyFetched: true,
  },
  {
    label: 'Repeat Order Dates',
    description: 'Auto-filled with previous order dates if any. Only calculated if placeholder appears in script.',
    variables: ['repeat_order_dates'],
    source: 'repeat order metadata',
    shopifyFetched: false,
  },
  {
    label: 'Repeat Order Count',
    description: 'Auto-filled with repeat order count. Only calculated if placeholder appears in script.',
    variables: ['repeat_order_count'],
    source: 'repeat order metadata',
    shopifyFetched: false,
  },
];

const AUTO_VARIABLE_SET = new Set();
const AUTO_VARIABLE_METADATA = {};
const VARIABLE_NORMALIZED_MAP = new Map(); // Maps normalized name to original variable name

AUTO_VARIABLE_GROUPS.forEach((group) => {
  group.variables.forEach((variable) => {
    AUTO_VARIABLE_SET.add(variable);
    AUTO_VARIABLE_METADATA[variable] = group;
    // Map normalized name to original for case-insensitive lookup
    const normalized = normalizeVariableName(variable);
    if (!VARIABLE_NORMALIZED_MAP.has(normalized)) {
      VARIABLE_NORMALIZED_MAP.set(normalized, variable);
    }
  });
});

// Helper to get original variable name from any case variant
const getOriginalVariableName = (variableName) => {
  const normalized = normalizeVariableName(variableName);
  return VARIABLE_NORMALIZED_MAP.get(normalized) || variableName;
};

// Utility function to escape HTML
const escapeHtml = (text) => {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
};

// Helper function to extract knowledge book IDs from script content
// Knowledge books are stored in content after frontendDisplayScript
const getKnowledgeBookIdsFromContent = (content, frontendDisplayScript) => {
  if (!content || !frontendDisplayScript) return [];
  
  // If content is the same as frontendDisplayScript, no knowledge books
  if (content.trim() === frontendDisplayScript.trim()) return [];
  
  // Content should be: frontendDisplayScript + knowledge books
  // We need to find which knowledge books are in the content
  // For now, we'll need to store the IDs separately or parse them
  // This will be handled by storing selected KB IDs in state
  return [];
};

// Generating text component with animated dots
const GeneratingText = () => {
  const [dots, setDots] = useState('');

  useEffect(() => {
    const interval = setInterval(() => {
      setDots(prev => {
        if (prev === '') return '.';
        if (prev === '.') return '..';
        if (prev === '..') return '...';
        return '';
      });
    }, 500);

    return () => clearInterval(interval);
  }, []);

  return <span>GENERATING{dots}</span>;
};

// CollapsibleSection component - memoized to prevent re-renders
const CollapsibleSection = React.memo(({ title, sectionKey, isOpen, onToggle, icon, children }) => {
  return (
    <div style={{ marginBottom: '16px', border: '1px solid #E5E7EB', borderRadius: '10px', overflow: 'hidden', background: '#FFFFFF' }}>
      <button
        type="button"
        onClick={() => onToggle(sectionKey)}
        style={{
          width: '100%',
          padding: '14px 16px',
          background: isOpen ? '#F9FAFB' : '#FFFFFF',
          border: 'none',
          borderBottom: isOpen ? '1px solid #E5E7EB' : 'none',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          cursor: 'pointer',
          transition: 'all 0.2s',
          textAlign: 'left'
        }}
      >
        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
          {icon && <span style={{ display: 'flex', alignItems: 'center' }}>{icon}</span>}
          <span style={{ fontSize: '15px', fontWeight: '600', color: '#111827' }}>{title}</span>
        </div>
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          style={{
            transform: isOpen ? 'rotate(180deg)' : 'rotate(0deg)',
            transition: 'transform 0.2s',
            color: '#6b7280'
          }}
        >
          <path d="M6 9l6 6 6-6" />
        </svg>
      </button>
      {isOpen && (
        <div style={{ padding: '16px' }}>
          {children}
        </div>
      )}
    </div>
  );
});

CollapsibleSection.displayName = 'CollapsibleSection';

function Playground({ shop }) {
  const [searchParams, setSearchParams] = useSearchParams();
  const navigate = useNavigate();
  const [agents, setAgents] = useState([]);
  const [knowledgeBooks, setKnowledgeBooks] = useState([]);
  const [currentAgentId, setCurrentAgentId] = useState(null);
  const [scriptEditorKey, setScriptEditorKey] = useState(0);
  const monacoEditorRef = useRef(null); // Ref for Monaco editor instance
  const [currentKnowledgeBookId, setCurrentKnowledgeBookId] = useState(null);
  const [showForm, setShowForm] = useState(false);
  const [showKnowledgeBookForm, setShowKnowledgeBookForm] = useState(false);
  const [showTestCallModal, setShowTestCallModal] = useState(false);
  const [showVoiceModal, setShowVoiceModal] = useState(false);
  const [showTestPopup, setShowTestPopup] = useState(false);
  const testButtonRef = useRef(null);
  const testPopupRef = useRef(null);
  const [testOrders, setTestOrders] = useState([]);
  const [voices, setVoices] = useState([]);
  const [voiceSearchQuery, setVoiceSearchQuery] = useState('');
  const [loading, setLoading] = useState(true);
  const [scriptSearchQuery, setScriptSearchQuery] = useState('');
  const [testCallTab, setTestCallTab] = useState('create');
  const [selectedKnowledgeBookIds, setSelectedKnowledgeBookIds] = useState([]);
  const [selectedQnaBookIds, setSelectedQnaBookIds] = useState([]);
  const [hoveredLatencyItem, setHoveredLatencyItem] = useState(null);
  const [agentStats, setAgentStats] = useState({}); // { agentId: { talk time, language, conversionRate } }
  const [showTemplateModal, setShowTemplateModal] = useState(false);
  const [templateDirection, setTemplateDirection] = useState(null); // 'outbound' or 'inbound'
  const [activeTab, setActiveTab] = useState('script'); // Track active tab: script, voice, language, config, knowledge, results, suggestions, stats, evaluate
  
  // Tab configuration with default order
  const defaultTabOrder = [
    { id: 'script', label: 'Script' },
    { id: 'voice', label: 'Voice' },
    { id: 'knowledge', label: 'Add QNA' },
    // HIDDEN: Run Simulation tab - See HIDDEN_FEATURES.md for details
    // { id: 'evaluate', label: 'Run Simulation' },
    // HIDDEN: Top queries tab - See HIDDEN_FEATURES.md for details
    // { id: 'suggestions', label: 'Top queries' },
    { id: 'variables', label: 'Variables' },
    { id: 'results', label: 'Call Outcome' },
    { id: 'transcript-analytics', label: 'Analytics' },
    { id: 'callback-context', label: 'Callback Context' },
    { id: 'config', label: 'Settings' },
    // REMOVED: Edit Script and Test Agent from main tabs - moved to mini nav
    // { id: 'edit-script', label: 'Edit Script' },
    // { id: 'test-agent', label: 'Test Agent' },
    { id: 'versions', label: 'Versions' }
  ];

  // --- Script Callback Context State ---
  const [scriptCallbackContext, setScriptCallbackContext] = useState('');
  const [scriptCallbackContextSaving, setScriptCallbackContextSaving] = useState(false);

  // Fetch scriptCallbackContext when agent changes
  useEffect(() => {
    if (!currentAgentId || !agents.length) {
      setScriptCallbackContext('');
      console.log('[CallbackContext] No currentAgentId or agents not loaded');
      return;
    }
    // Debug: log agent lookup
    console.log('[CallbackContext] currentAgentId:', currentAgentId, 'agents:', agents.map(a => a.id));
    const agent = agents.find(a => String(a.id) === String(currentAgentId));
    console.log('[CallbackContext] Found agent:', agent);
    setScriptCallbackContext(agent?.scriptCallbackContext || '');
    console.log('[CallbackContext] scriptCallbackContext:', agent?.scriptCallbackContext);
  }, [currentAgentId, agents]);

  // Save scriptCallbackContext
  const saveScriptCallbackContext = async () => {
    if (!currentAgentId) return;
    setScriptCallbackContextSaving(true);
    try {
      const scriptData = { scriptCallbackContext };
      await updateScript(currentAgentId, scriptData, shop);
      // Optionally show a success message
    } catch (err) {
      // Optionally show an error message
    } finally {
      setScriptCallbackContextSaving(false);
    }
  };

  // Tab content rendering
  let tabContent = null;
  if (activeTab === 'callback-context') {
    tabContent = (
      <div className="playground-tab-content">
        <h2 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '16px' }}>Callback Context (Script-specific)</h2>
        <div className="form-group">
          <label htmlFor="scriptCallbackContext" style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#111827', marginBottom: '8px' }}>
            Script Callback Context
          </label>
          <textarea
            id="scriptCallbackContext"
            name="scriptCallbackContext"
            value={scriptCallbackContext}
            onChange={e => setScriptCallbackContext(e.target.value)}
            placeholder="Enter script callback context..."
            style={{
              width: '100%',
              minHeight: '100px',
              maxHeight: '200px',
              padding: '12px',
              border: '1px solid #D1D5DB',
              borderRadius: '6px',
              fontSize: '14px',
              color: '#111827',
              background: '#F9FAFB',
              marginBottom: '12px'
            }}
          />
          <button
            className="profile-save-button-new"
            onClick={saveScriptCallbackContext}
            disabled={scriptCallbackContextSaving}
            style={{ marginTop: '8px' }}
          >
            {scriptCallbackContextSaving ? 'Saving...' : 'Save Callback Context'}
          </button>
        </div>
      </div>
    );
  }
  // ...existing code...
  // At the end of the component, in the main return:
  // return (
  //   ...
  //   {tabContent}
  //   ...
  // );

  // Load tab order from localStorage or use default
  const [tabOrder, setTabOrder] = useState(() => {
    try {
      const saved = localStorage.getItem('playgroundTabOrder');
      if (saved) {
        const parsed = JSON.parse(saved);
        // Validate that all tabs are present
        const savedIds = parsed.map(t => t.id);
        const defaultIds = defaultTabOrder.map(t => t.id);
        if (savedIds.length === defaultIds.length && defaultIds.every(id => savedIds.includes(id))) {
          // Map saved order to use current labels from defaultTabOrder
          const labelMap = {};
          defaultTabOrder.forEach(tab => {
            labelMap[tab.id] = tab.label;
          });
          return parsed.map(tab => ({
            ...tab,
            label: labelMap[tab.id] || tab.label // Use current label, fallback to saved label
          }));
        }
      }
    } catch (e) {
      console.error('Error loading tab order:', e);
    }
    return defaultTabOrder;
  });

  // Drag and drop state
  const [draggedTabIndex, setDraggedTabIndex] = useState(null);
  const [dragOverIndex, setDragOverIndex] = useState(null);
  const [isDragging, setIsDragging] = useState(false);
  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
  const [dragStartPosition, setDragStartPosition] = useState({ left: 0, top: 0 });
  const [isReadyToDrag, setIsReadyToDrag] = useState(false);
  const [lastClickTime, setLastClickTime] = useState(0);
  const [clickCount, setClickCount] = useState(0);
  const [isEditingAgentName, setIsEditingAgentName] = useState(false);
  const [selectedVoiceForPreview, setSelectedVoiceForPreview] = useState(null);
  const [voicePreviewText, setVoicePreviewText] = useState('');
  const [isPlayingVoice, setIsPlayingVoice] = useState(false);
  const [playingVoiceId, setPlayingVoiceId] = useState(null);
  const [voiceLanguages, setVoiceLanguages] = useState({}); // Track language selection per voice
  const playingAudioRef = useRef(null); // Store the current audio element for pause/resume
  const [adaptToCustomerLanguage, setAdaptToCustomerLanguage] = useState(false);
  const [scriptContext, setScriptContext] = useState(''); // Select LLM: Scalysis FineTunedLLM, Claude, GPT, etc.
  const [fineTunedModels, setFineTunedModels] = useState([]); // Finetuned models from FinetuneLLM tab
  const [temperature, setTemperature] = useState(0.7); // Temperature slider (0-1)
  const [temperatureMode, setTemperatureMode] = useState('manual'); // 'manual' or 'script'
  const [scriptType, setScriptType] = useState('simple'); // 'simple', 'advanced', 'freeFlow'
  const [llmModel, setLlmModel] = useState('Scalysis 190B Finetuned (Finetuned For Latency)'); // Selected LLM model - default to Scalysis 190B
  const [scriptLanguage, setScriptLanguage] = useState([]); // Languages: Array of selected languages (for backward compatibility)
  const [primaryLanguage, setPrimaryLanguage] = useState(''); // Primary language (single select)
  const [secondaryLanguages, setSecondaryLanguages] = useState([]); // Secondary languages (multi-select)
  const [showLanguageDropdown, setShowLanguageDropdown] = useState(false);
  const [languageSearchQuery, setLanguageSearchQuery] = useState('');
  const languageDropdownRef = useRef(null);
  const [showKnowledgeBookDropdown, setShowKnowledgeBookDropdown] = useState(false);
  const [showQnaBookDropdown, setShowQnaBookDropdown] = useState(false);
  const [variableSearchQuery, setVariableSearchQuery] = useState('');
  const knowledgeBookDropdownRef = useRef(null);
  const qnaBookDropdownRef = useRef(null);
  const [scriptPersonality, setScriptPersonality] = useState(''); // Personality: Friendly, Salesy, Listener/Helping
  const [isImageHovered, setIsImageHovered] = useState(false); // Track hover state for scriptvoicetab1 image
  const [isSearchFocused, setIsSearchFocused] = useState(false); // Track focus state for voice search input
  const [isFilterHovered, setIsFilterHovered] = useState(false); // Track hover state for filter button
  const [isFilterPanelOpen, setIsFilterPanelOpen] = useState(false); // Track filter panel visibility
  const [selectedLanguage, setSelectedLanguage] = useState(''); // Selected language filter
  const [selectedGender, setSelectedGender] = useState(''); // Selected gender filter
  const [selectedCategories, setSelectedCategories] = useState([]); // Selected category filters
  const [selectedSourceGender, setSelectedSourceGender] = useState({}); // { source: gender } for per-source gender filtering
  const [isLanguageDropdownOpen, setIsLanguageDropdownOpen] = useState(false); // Language dropdown state
  const [scalysisV3FlagshipFilter, setScalysisV3FlagshipFilter] = useState(true); // V3 Flagship filter for Scalysis voices (always true since Scalysis shows only Ultra Realistic)
  const [selectedSourceLanguages, setSelectedSourceLanguages] = useState({ cloned: [], scalysis: [], other: [] }); // { source: [languages] } for per-source language filtering
  const [isScalysisLanguageDropdownOpen, setIsScalysisLanguageDropdownOpen] = useState(false); // Scalysis language dropdown state
  const [isOtherLanguageDropdownOpen, setIsOtherLanguageDropdownOpen] = useState(false); // Other language dropdown state
  
  // Collapsible settings sections state
  const [openSettingsSections, setOpenSettingsSections] = useState({
    voice: false,
    callSettings: false,
    callSettingsAdvanced: false,
    inbound: false,
    language: false,
    llm: false,
    knowledge: false,
    memory: false,
    advanced: false
  });
  const [voiceSearchInSettings, setVoiceSearchInSettings] = useState(''); // Voice search query for settings section
  const [selectedVoiceProvider, setSelectedVoiceProvider] = useState(''); // Selected voice provider: 'scalysis', 'sarvam', 'cartesia', 'elevenlabs'
  
  const toggleSettingsSection = (section) => {
    setOpenSettingsSections(prev => ({
      ...prev,
      [section]: !prev[section]
    }));
  };
  
  // Context settings state
  const [memorySettings, setMemorySettings] = useState({
    currentConversationMemory: true,
    crossSessionMemory: false,
    liveContextAwareness: true
  });
  const [isGenderDropdownOpen, setIsGenderDropdownOpen] = useState(false); // Gender dropdown state
  const filterLanguageDropdownRef = useRef(null);
  const filterGenderDropdownRef = useRef(null);
  const scalysisLanguageDropdownRef = useRef(null);
  const otherLanguageDropdownRef = useRef(null);

  // Close language, knowledge book dropdowns, and test popup when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (languageDropdownRef.current && !languageDropdownRef.current.contains(event.target)) {
        setShowLanguageDropdown(false);
        setLanguageSearchQuery('');
      }
      if (knowledgeBookDropdownRef.current && !knowledgeBookDropdownRef.current.contains(event.target)) {
        setShowKnowledgeBookDropdown(false);
      }
      if (qnaBookDropdownRef.current && !qnaBookDropdownRef.current.contains(event.target)) {
        setShowQnaBookDropdown(false);
      }
      if (testPopupRef.current && testButtonRef.current &&
          !testPopupRef.current.contains(event.target) &&
          !testButtonRef.current.contains(event.target)) {
        setShowTestPopup(false);
      }
      if (filterLanguageDropdownRef.current && !filterLanguageDropdownRef.current.contains(event.target)) {
        setIsLanguageDropdownOpen(false);
      }
      if (filterGenderDropdownRef.current && !filterGenderDropdownRef.current.contains(event.target)) {
        setIsGenderDropdownOpen(false);
      }
      if (scalysisLanguageDropdownRef.current && !scalysisLanguageDropdownRef.current.contains(event.target)) {
        setIsScalysisLanguageDropdownOpen(false);
      }
      if (otherLanguageDropdownRef.current && !otherLanguageDropdownRef.current.contains(event.target)) {
        setIsOtherLanguageDropdownOpen(false);
      }
    };

    if (showLanguageDropdown || showKnowledgeBookDropdown || showQnaBookDropdown || showTestPopup || isLanguageDropdownOpen || isGenderDropdownOpen || isScalysisLanguageDropdownOpen || isOtherLanguageDropdownOpen) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showLanguageDropdown, showKnowledgeBookDropdown, showQnaBookDropdown, showTestPopup]);

  // Load finetuned models from localStorage (shared with FinetuneLLM tab)
  useEffect(() => {
    const loadFineTunedModels = () => {
      try {
        const saved = localStorage.getItem('fineTunedModels');
        if (saved) {
          const models = JSON.parse(saved);
          setFineTunedModels(models);
        }
      } catch (error) {
        console.error('Error loading finetuned models:', error);
      }
    };
    
    loadFineTunedModels();
    
    // Listen for custom event when models are updated in FinetuneLLM tab
    const handleModelsUpdate = () => {
      loadFineTunedModels();
    };
    window.addEventListener('fineTunedModelsUpdated', handleModelsUpdate);
    
    // Also check on window focus (in case user switches tabs)
    const handleFocus = () => {
      loadFineTunedModels();
    };
    window.addEventListener('focus', handleFocus);
    
    return () => {
      window.removeEventListener('fineTunedModelsUpdated', handleModelsUpdate);
      window.removeEventListener('focus', handleFocus);
    };
  }, []);

  const [showSupportTicketModal, setShowSupportTicketModal] = useState(false);

  // Get memoji for current agent
  const currentAgentMemoji = useMemo(() => {
    return currentAgentId ? getAgentMemoji(currentAgentId) : null;
  }, [currentAgentId]);
  const [supportTicketDescription, setSupportTicketDescription] = useState('I need help with ...');
  const [supportTicketSuccess, setSupportTicketSuccess] = useState(false);
  const [supportTicketId, setSupportTicketId] = useState('');
  const [enableNaturalPauses, setEnableNaturalPauses] = useState(false);
  const [enableLaughter, setEnableLaughter] = useState(false);
  const [enableVoicemailDetection, setEnableVoicemailDetection] = useState(false);
  const [autoEndCallForSilence, setAutoEndCallForSilence] = useState(false);
  const [silenceDuration, setSilenceDuration] = useState(30);
  const [selfLearningTab, setSelfLearningTab] = useState('top-queries'); // 'overview' or 'top-queries'
  const [selectedAgentIds, setSelectedAgentIds] = useState(new Set());
  const [isBulkSelecting, setIsBulkSelecting] = useState(false);
  const [isDeletingAgents, setIsDeletingAgents] = useState(false);
  const [isSavingAgent, setIsSavingAgent] = useState(false);
  const [showFlowMaker, setShowFlowMaker] = useState(false);
  const [showAIModal, setShowAIModal] = useState(false);
  const [aiModalMode, setAiModalMode] = useState(null); // 'write' or 'rewrite'
  const [aiPrompt, setAiPrompt] = useState('');
  const [showAgentTypeSelection, setShowAgentTypeSelection] = useState(false);
  const [createNewActiveTab, setCreateNewActiveTab] = useState('new'); // 'new' or 'templates'
  const [selectedAgentType, setSelectedAgentType] = useState(null); // 'strict-flow', 'free-flow', 'finetuned'
  const [showWriteAISettings, setShowWriteAISettings] = useState(false);
  const [showWriteAISettingsSection, setShowWriteAISettingsSection] = useState(false);
  const [writeAIMode, setWriteAIMode] = useState('simple'); // 'simple' or 'advanced'
  const [aiGenerationMode, setAiGenerationMode] = useState('simple'); // 'simple' or 'advanced' or 'free-flow' for Write with AI generation
  const [aiGenderSelection, setAiGenderSelection] = useState(null); // null, 'female', or 'male' for Write with AI gender selection
  const [proposedScript, setProposedScript] = useState(null); // Store AI's proposed changes for Edit with AI mode
  const [showEditDiffModal, setShowEditDiffModal] = useState(false); // Show diff modal for Edit with AI
  const [editDiffError, setEditDiffError] = useState(null); // Error message for edit diff generation

  // Handler for applying Edit with AI changes
  const handleAcceptEditChanges = () => {
    setFormData(prev => ({ ...prev, content: proposedScript || '' }));
    setProposedScript(null);
    setShowEditDiffModal(false);
    alert('Changes applied successfully!');
  };

  // Handler for rejecting changes
  const handleRejectEditChanges = () => {
    setProposedScript(null);
    setShowEditDiffModal(false);
  };

  // Handler for adding a criteria item

  // Handler for generating edit diff
  const handleGenerateEditDiff = async () => {
    if (!proposedScript) {
      alert('No changes to apply');
      return;
    }
    
    setIsGeneratingEditDiff(true);
    
     const currentScript = safeFormData?.content || '';

    try {
      const { api } = await import('../utils/api');

      // Create enhanced prompt with context
      const userMessage = `Enhance the current script: ${currentScript || '(No script content yet)'}`;

      const enhancedPrompt = `You are an AI assistant helping to improve a voice agent script.

Current Script:
${currentScript || '(No script content yet)'}

---
User's Enhancement Request:
${userMessage}

Instructions:
- If user asks you to edit/change/update script, provide COMPLETE updated script with all changes applied
- Maintain the script's original structure and formatting
- Use markdown formatting (headings, bold, lists, etc.)
- Keep all important sections intact unless user specifically asks to remove/change them`;


      let fullResponse = '';
      const assistantMessage = { role: 'assistant', content: '', timestamp: new Date() };
      setAiWriterChatHistory(prev => [...prev, assistantMessage]);
      
      for await (const chunk of api.generateScriptWithClaudeStream(
        enhancedPrompt,
        currentScript,
        'rewrite', // Pass mode as 'rewrite' for Edit mode
        null, // No abort signal (for now, diff generation is synchronous)
        (chunk) => {
          fullResponse += chunk;
          setAiWriterChatHistory(prev => {
            const updated = [...prev];
            updated[updated.length - 1] = { ...updated[updated.length - 1], content: fullResponse };
            return updated;
          });
        }
      )) {
        // Chunks are handled in the callback
      }
    } catch (error) {
      console.error('[Playground] Error in AI writer:', error);
      setAiWriterChatHistory(prev => [...prev, {
        role: 'assistant',
        content: `Error: ${error.message || 'Failed to generate response. Please try again.'}`,
        timestamp: new Date()
      }]);
    } finally {
      setIsAiWriterGenerating(false);
    }
  };

  const handleApplyScriptChanges = () => {
    if (pendingScriptChanges) {
      setFormData(prev => ({ ...prev, content: pendingScriptChanges }));
      setPendingScriptChanges(null);
    }
  };

  // Handler for adding a criteria item
  const handleAddCriteria = (type) => {
    const newItem = '';
    setFormData((prev) => ({
      ...prev,
      [type]: [...(prev[type] || []), newItem],
    }));
  };

  // Handler for removing a criteria item
  const handleRemoveCriteria = (type, index) => {
    setFormData((prev) => ({
      ...prev,
      [type]: prev[type].filter((_, i) => i !== index),
    }));
  };

  // Handler for adding a criteria item
  const [streamingContent, setStreamingContent] = useState('');
  const [isStreaming, setIsStreaming] = useState(false);
  const abortControllerRef = useRef(null);
  const [flowData, setFlowData] = useState(null);
  const [noteTakerContent, setNoteTakerContent] = useState('');
  const [noteTakerHistory, setNoteTakerHistory] = useState([]);
  const [showNoteTakerInBox2, setShowNoteTakerInBox2] = useState(false);
  const [box2ActiveTab, setBox2ActiveTab] = useState('settings');
  const [scriptVersions, setScriptVersions] = useState([]);
  const [showLeftBlur, setShowLeftBlur] = useState(false);
  const [showRightBlur, setShowRightBlur] = useState(true);
  const tabsContainerRef = useRef(null);
  const [versionSearchQuery, setVersionSearchQuery] = useState('');
  const [loadingVersions, setLoadingVersions] = useState(false);
  const [lastSavedContent, setLastSavedContent] = useState(null);
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  const [showVersionPanel, setShowVersionPanel] = useState(false);
  const [selectedVersion, setSelectedVersion] = useState(null);
  const [showPersonalityPopup, setShowPersonalityPopup] = useState(false);
  const [selectedPersonality, setSelectedPersonality] = useState('');
  const [isRunningPersonalitySimulation, setIsRunningPersonalitySimulation] = useState(false);
  const [autoSaveEnabled, setAutoSaveEnabled] = useState(false);
  const [autoSaveInterval, setAutoSaveInterval] = useState(5); // in minutes
  const [maxCallDuration, setMaxCallDuration] = useState(null); // in seconds (removed, now using formData)
  const [inactivityPeriod, setInactivityPeriod] = useState(30); // in seconds
  const [inactivityText, setInactivityText] = useState('Are you still there?');
  const inactivityTextRef = useRef(null);
  const [leftPanelWidth, setLeftPanelWidth] = useState(() => {
    try {
      const saved = localStorage.getItem('playgroundLeftPanelWidth');
      return saved ? parseFloat(saved) : 65; // Default 65% width (right panel 35%)
    } catch (e) {
      return 65;
    }
  });
  const [isResizing, setIsResizing] = useState(false);

  const handleVersionClick = (version) => {
    setSelectedVersion(version);
    setShowVersionPanel(true);
  };

  const handleRevertVersion = (versionId) => {
    loadVersion(versionId);
    setShowVersionPanel(false);
  };

  // Handle panel resizing
  useEffect(() => {
    if (!isResizing) return;

    let currentWidth = leftPanelWidth;

    const handleMouseMove = (e) => {
      const container = document.querySelector('.script-tab-grid');
      if (!container) return;
      
      const rect = container.getBoundingClientRect();
      const newWidth = ((e.clientX - rect.left) / rect.width) * 100;
      
      // Constrain between 30% and 80%
      const constrainedWidth = Math.max(30, Math.min(80, newWidth));
      currentWidth = constrainedWidth;
      setLeftPanelWidth(constrainedWidth);
    };

    const handleMouseUp = () => {
      setIsResizing(false);
      // Save current width to localStorage
      try {
        localStorage.setItem('playgroundLeftPanelWidth', currentWidth.toString());
      } catch (e) {
        console.error('Error saving panel width:', e);
      }
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);

    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
  }, [isResizing, leftPanelWidth]);

  
  // Chat state
  const [chatMessages, setChatMessages] = useState([]);
  const [chatInput, setChatInput] = useState('');
  const [editScriptMessages, setEditScriptMessages] = useState([]);
  const [editScriptInput, setEditScriptInput] = useState('');
  const [isEditScriptLoading, setIsEditScriptLoading] = useState(false);
  const [originalScriptContent, setOriginalScriptContent] = useState(null); // Store original script when editing starts
  const [proposedScriptChanges, setProposedScriptChanges] = useState(null); // Store proposed changes from AI
  const [scriptEditHistory, setScriptEditHistory] = useState([]); // Track edit history for undo
  const [uploadedFiles, setUploadedFiles] = useState([]);
  const [pastedCodeReferences, setPastedCodeReferences] = useState([]);
  const editScriptMessagesEndRef = useRef(null);
  const [isChatLoading, setIsChatLoading] = useState(false);
  
  // Script Box 2 Chat state (new chat inside script-tab-box-2)
  const [scriptBox2ChatMessages, setScriptBox2ChatMessages] = useState([]);
  const [scriptBox2ChatInput, setScriptBox2ChatInput] = useState('');
  const [scriptBox2ChatLoading, setScriptBox2ChatLoading] = useState(false);
  
  // Analytics state
  const [analyticsLimit, setAnalyticsLimit] = useState(100);
  const [analyticsData, setAnalyticsData] = useState(null);
  const [analyticsLoading, setAnalyticsLoading] = useState(false);
  const [analyticsError, setAnalyticsError] = useState(null);
  const turnChartRef = useRef(null);
  const secondChartRef = useRef(null);
  const turnChartInstance = useRef(null);
  const secondChartInstance = useRef(null);
  
  // Evaluation state
  const [extractorPrompt, setExtractorPrompt] = useState(`You are an expert at analyzing AI voice agent scripts and extracting evaluation criteria.

Analyze the following script and extract key evaluation rules that should be used to score conversations generated by this script.

Extract rules for:
1. Personality adherence (does the agent match the intended personality?)
2. Objective completion (does the agent achieve the stated objective?)
3. Context handling (does the agent use context appropriately?)
4. Flow adherence (does the agent follow the conversation flow/tree?)
5. Exception handling (does the agent handle edge cases well?)
6. Language rules (Hinglish/English usage, number formatting, etc.)
7. Tone and style (natural conversation, no acknowledgements, etc.)

Return a JSON object with this structure:
{
  "personalityRules": ["rule1", "rule2", ...],
  "objectiveRules": ["rule1", "rule2", ...],
  "contextRules": ["rule1", "rule2", ...],
  "flowRules": ["rule1", "rule2", ...],
  "exceptionHandlingRules": ["rule1", "rule2", ...],
  "languageRules": ["rule1", "rule2", ...],
  "toneStyleRules": ["rule1", "rule2", ...],
  "criticalRules": ["rule1", "rule2", ...] // Must-follow rules
}

Script Content:
{SCRIPT_CONTENT}`);
  const [evaluatorPrompt, setEvaluatorPrompt] = useState(`You are an expert evaluator of AI voice agent conversations.

Evaluate the following conversation against the extracted rules and provide a score out of 10.

Rules to evaluate against:
{RULES_TEXT}

Conversation transcript:
{CONVERSATION_TEXT}

Evaluate the conversation on:
1. Personality adherence (does the agent match the intended personality?)
2. Objective completion (does the agent achieve the stated objective?)
3. Context handling (does the agent use context appropriately?)
4. Flow adherence (does the agent follow the conversation flow/tree?)
5. Exception handling (does the agent handle edge cases well?)
6. Language rules (Hinglish/English usage, number formatting, etc.)
7. Tone and style (natural conversation, no acknowledgements, etc.)

Provide a score out of 10 (where 10 is perfect adherence to all rules) and detailed feedback.

Return a JSON object with this structure:
{
  "overallScore": 8.5,
  "scores": {
    "personality": 9,
    "objective": 8,
    "context": 8.5,
    "flow": 9,
    "exceptionHandling": 7,
    "language": 8,
    "toneStyle": 9
  },
  "feedback": {
    "strengths": ["strength1", "strength2"],
    "weaknesses": ["weakness1", "weakness2"],
    "suggestions": ["suggestion1", "suggestion2"]
  },
  "ruleViolations": [
    {
      "rule": "rule text",
      "severity": "critical|major|minor",
      "description": "how it was violated"
    }
  ],
  "detailedAnalysis": "Detailed paragraph analysis of the conversation"
}`);
  const [testCasePrompt, setTestCasePrompt] = useState(`You are simulating a customer in a phone call conversation. You will respond to the agent's messages based on your personality and the scenario.

Scenario: {SCENARIO}
Your Personality: {PERSONALITY}
Language: {LANGUAGE}

Instructions:
- Respond naturally to what the agent says
- Stay in character according to your personality description
- Use {LANGUAGE} for your responses
- You can say "end call", "bye", or similar if you want to end the conversation naturally
- Keep your responses concise and realistic for a phone call
- Don't repeat what the agent said, respond to it
- React naturally to the agent's tone and content`);
  const [scenario, setScenario] = useState('you ordered a product from this website yesterday');
  const [personalityPrompts, setPersonalityPrompts] = useState({
    engaging: 'You are an engaging and cooperative customer. You are interested in the conversation, ask relevant questions, and are generally helpful and friendly. You respond enthusiastically and want to have a productive conversation.',
    confused: 'You are a confused customer. You are uncertain about things, ask clarifying questions, and sometimes don\'t remember details. You may need things explained multiple times and might seem a bit lost or unsure.',
    angry: 'You are an angry and frustrated customer. You are short-tempered, may raise your voice, and are easily irritated. You might be upset about something or just don\'t want to be bothered. You respond with frustration and may want to end the call quickly.'
  });
  const [testCases, setTestCases] = useState([]);
  const [selectedTestCases, setSelectedTestCases] = useState([]);
  const [evaluationResults, setEvaluationResults] = useState(null);
  const [isRunningEvaluation, setIsRunningEvaluation] = useState(false);
  const [evaluationVariables, setEvaluationVariables] = useState({
    customer_name: 'Rahul',
    order_number: 'ORD-12345',
    product_name: 'Personalized Photo Frame',
    delivery_date: 'Next Monday'
  });
  const evaluationDefaultsLoaded = useRef(false);
  const [aiWriterChatHistory, setAiWriterChatHistory] = useState([]);
  const [aiWriterInput, setAiWriterInput] = useState('');
  const [isAiWriterGenerating, setIsAiWriterGenerating] = useState(false);
  const [pendingScriptChanges, setPendingScriptChanges] = useState(null);

  // Auto-scroll for edit script messages
  useEffect(() => {
    if (editScriptMessagesEndRef.current) {
      editScriptMessagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [editScriptMessages, isEditScriptLoading]);

  // Form state
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    content: '',
    voiceId: '',
    initialGreeting: '',
    prePhrase: 'ji',
    prePhraseArray: [],
    useCustomAnalysis: false,
    customAnalysisPrompt: '',
    disableUnder35Retries: false,
    successCriteria: [],
    otherCriteria: [],
    maxRetries: '',
    retryIntervalMinutes: '',
    cancelOnRetry: false,
    successMetric: '',
    variableDefinitions: {},
    variableBookId: '',
    autoTaggingEnabled: false,
    autoTaggingRules: {
      successCriteria: {},
      otherCriteria: {},
      tagOnMaxRetries: false,
      maxRetriesTagName: ''
    },
    ttsProvider: null,
    interruptions: false,
    interruptionDuration: 1,
    reasoning: false,
    writeAIInstructions: '',
    callFulfilledOrders: true,
    callCancelledOrders: true,
    cancellationCriteria: [],
    retryCriteria: [],
    maxCallDuration: null,
    volume: 50,
    emotions: [],
  });

  // Safe form data to prevent white screens - defined early to avoid initialization errors
  const safeFormData = React.useMemo(() => {
    return formData || {
      name: '',
      description: '',
      content: '',
      voiceId: '',
      language: '',
      initialGreeting: '',
      prePhrase: '',
      successCriteria: [],
      otherCriteria: [],
      cancellationCriteria: [],
      retryCriteria: [],
      maxRetries: '',
      retryIntervalMinutes: '',
      cancelOnRetry: false,
      variableDefinitions: {},
      autoTaggingEnabled: false,
      autoTaggingRules: {
        successCriteria: {},
        otherCriteria: {},
        tagOnMaxRetries: false,
        maxRetriesTagName: ''
      },
      variableBookId: '',
      ttsProvider: null,
      interruptions: false,
      interruptionDuration: 1,
      writeAIInstructions: '',
      volume: 50,
      emotions: []
    };
  }, [formData]);

  const storageScope = shop || 'global';
  const variableBooksStorageKey = `variable_books_${storageScope}`;
  const variableAssignmentsStorageKey = `variable_assignments_${storageScope}`;
  const [variableBooks, setVariableBooks] = useState([]);
  const [variableAssignments, setVariableAssignments] = useState({});
  const [selectedVariableBookId, setSelectedVariableBookId] = useState(null);
  const [pendingVariableBookId, setPendingVariableBookId] = useState(null);
  const [variableInputs, setVariableInputs] = useState({});
  const [isVariableSaving, setIsVariableSaving] = useState(false);
  const [variableBookNameDraft, setVariableBookNameDraft] = useState('');
  const [shopifyVariableSearch, setShopifyVariableSearch] = useState('');

  // Reply Quality (QnA Pairs) form state
  const [showReplyQualityForm, setShowReplyQualityForm] = useState(false);
  const [editingReplyQualityId, setEditingReplyQualityId] = useState(null);
  const [replyQualityFormData, setReplyQualityFormData] = useState({
    name: '',
    description: '',
    qnaPairs: [{ question: '', answer: '' }]
  });

  // Knowledge Book form state
  const [knowledgeBookFormData, setKnowledgeBookFormData] = useState({
    name: '',
    description: '',
    content: '',
  });

  // Test order form state
  const [testOrderForm, setTestOrderForm] = useState({
    customerName: '',
    customerPhone: '',
    customerEmail: '',
    customerAddress: '',
    totalPrice: '',
    currency: 'INR',
    orderNumber: '',
  });

  useEffect(() => {
    try {
      const storedBooks = JSON.parse(localStorage.getItem(variableBooksStorageKey)) || [];
      const normalizedBooks = Array.isArray(storedBooks)
        ? storedBooks.map((book) => ({
            ...book,
            definitions: typeof book.definitions === 'object' && book.definitions !== null ? book.definitions : {}
          }))
        : [];
      setVariableBooks(normalizedBooks);
    } catch (error) {
      console.error('[Playground] Failed to load variable books from storage:', error);
      setVariableBooks([]);
    }
    try {
      const storedAssignments = JSON.parse(localStorage.getItem(variableAssignmentsStorageKey)) || {};
      setVariableAssignments(typeof storedAssignments === 'object' && storedAssignments !== null ? storedAssignments : {});
    } catch (error) {
      console.error('[Playground] Failed to load variable assignments from storage:', error);
      setVariableAssignments({});
    }
    setSelectedVariableBookId(null);
    setPendingVariableBookId(null);
  }, [variableBooksStorageKey, variableAssignmentsStorageKey]);

  const persistVariableBooks = (books) => {
    setVariableBooks(books);
    try {
      localStorage.setItem(variableBooksStorageKey, JSON.stringify(books));
    } catch (error) {
      console.error('[Playground] Failed to persist variable books:', error);
    }
  };

  const persistVariableAssignments = (assignments) => {
    setVariableAssignments(assignments);
    try {
      localStorage.setItem(variableAssignmentsStorageKey, JSON.stringify(assignments));
    } catch (error) {
      console.error('[Playground] Failed to persist variable assignments:', error);
    }
  };

const variablesUsed = React.useMemo(() => extractVariables(safeFormData?.content || ''), [safeFormData?.content]);
const variablesKey = variablesUsed.join('|');
const manualVariables = React.useMemo(
  () => variablesUsed.filter((variable) => !isValidVariable(variable)),
  [variablesKey]
);
const manualVariablesKey = manualVariables.join('|');
const selectedVariableBook = variableBooks.find((book) => book.id === selectedVariableBookId) || null;

useEffect(() => {
  if (currentAgentId) {
    const assignedId = variableAssignments[currentAgentId] || null;
    setSelectedVariableBookId(assignedId);
    setPendingVariableBookId(null);
  } else if (!currentAgentId && pendingVariableBookId) {
    setSelectedVariableBookId(pendingVariableBookId);
  } else if (!currentAgentId && !pendingVariableBookId) {
    setSelectedVariableBookId((prev) => prev && variableBooks.some((book) => book.id === prev) ? prev : null);
  }
}, [currentAgentId, variableAssignments, pendingVariableBookId, variableBooks]);

useEffect(() => {
  const book = variableBooks.find((b) => b.id === selectedVariableBookId);
  const inputs = {};
  manualVariables.forEach((name) => {
    inputs[name] = book?.definitions?.[name] || '';
  });
  setVariableInputs(inputs);
  setVariableBookNameDraft(book?.name || '');
}, [selectedVariableBookId, manualVariablesKey, variableBooks]);

const attachVariableBookToCurrent = (bookId) => {
  if (!bookId) {
    setSelectedVariableBookId(null);
    if (currentAgentId) {
      const updatedAssignments = { ...variableAssignments };
      if (updatedAssignments[currentAgentId]) {
        delete updatedAssignments[currentAgentId];
        persistVariableAssignments(updatedAssignments);
      }
    } else {
      setPendingVariableBookId(null);
    }
    return;
  }

  setSelectedVariableBookId(bookId);
  if (currentAgentId) {
    const updatedAssignments = { ...variableAssignments, [currentAgentId]: bookId };
    persistVariableAssignments(updatedAssignments);
  } else {
    setPendingVariableBookId(bookId);
  }
};

const handleCreateVariableBook = () => {
  const defaultName = `Variable Book ${variableBooks.length + 1}`;
  const name = window.prompt('Enter variable book name', defaultName);
  if (!name || !name.trim()) return;
  const newBook = {
    id: generateVariableBookId(),
    name: name.trim(),
    definitions: {}
  };
  persistVariableBooks([...variableBooks, newBook]);
  attachVariableBookToCurrent(newBook.id);
};

const handleVariableInputChange = (variable, value) => {
  setVariableInputs((prev) => ({
    ...prev,
    [variable]: value
  }));
};

const handleSaveVariableDefinitions = () => {
  if (!selectedVariableBookId) {
    alert('Select or create a variable book first.');
    return;
  }
  const bookIndex = variableBooks.findIndex((book) => book.id === selectedVariableBookId);
  if (bookIndex === -1) {
    alert('Variable book not found.');
    return;
  }
  
  const trimmedName = (variableBookNameDraft || '').trim() || 'Untitled Variable Book';
  if (!trimmedName) {
    alert('Please enter a name for the variable book.');
    return;
  }
  
  setIsVariableSaving(true);
  
  // Create updated book with name and definitions
  const updatedBooks = variableBooks.map((book) => {
    if (book.id === selectedVariableBookId) {
      return {
        ...book,
        name: trimmedName,
        definitions: {
          ...book.definitions,
          ...variableInputs
        }
      };
    }
    return book;
  });
  
  // Save the variable book
  persistVariableBooks(updatedBooks);
  
  // Update the state to reflect the saved book
  setVariableBooks(updatedBooks);
  
  // Attach the book to the current agent
  attachVariableBookToCurrent(selectedVariableBookId);
  
  // Append variables to script content in format: {variable_name}: "value"
  const currentContent = formData?.content || '';
  
  // Remove any existing variable entries from the script (to avoid duplicates)
  // Look for lines matching the pattern: {variable_name}: "value"
  const variableEntryPattern = /^\{[^}]+\}:\s*"[^"]*"$/gm;
  const cleanedContent = currentContent.replace(variableEntryPattern, '').trim();
  
  // Create new variable entries
  const variableEntries = Object.entries(variableInputs)
    .filter(([_, value]) => value && value.trim().length > 0) // Only include variables with values
    .map(([name, value]) => {
      // Format: {variable_name}: "value"
      return `{${name}}: "${value.trim()}"`;
    });
  
  // Append variables to the end of the script
  if (variableEntries.length > 0) {
    const newContent = cleanedContent 
      ? `${cleanedContent}\n\n${variableEntries.join('\n')}`
      : variableEntries.join('\n');
    setFormData(prev => ({ ...prev, content: newContent }));
  } else if (cleanedContent) {
    // If no variables but we cleaned the content, update it
    setFormData(prev => ({ ...prev, content: cleanedContent }));
  }
  
  setIsVariableSaving(false);
  
  // Show success message
  alert(`Variable book "${trimmedName}" saved and attached successfully! Variables have been appended to the script.`);
};

const handleDefineVariablesClick = () => {
  if (variablesUsed.length === 0) {
    alert('No template variables detected in this script.');
    return;
  }
  const manualList = manualVariables;
  if (manualList.length === 0) {
    alert('All variables in this script are auto-filled from the order. Nothing to define manually.');
    setActiveTab('variables');
    return;
  }
  const newBookName = `Variable Book ${variableBooks.length + 1}`;
  const definitions = {};
  manualList.forEach((name) => {
    definitions[name] = '';
  });
  const newBook = {
    id: generateVariableBookId(),
    name: newBookName,
    definitions,
  };
  setVariableBooks((prev) => [...prev, newBook]);
  attachVariableBookToCurrent(newBook.id);
  setVariableBookNameDraft(newBookName);
  const blankInputs = {};
  manualList.forEach((name) => {
    blankInputs[name] = '';
  });
  setVariableInputs(blankInputs);
  setActiveTab('variables');
};

const variableStatus = variablesUsed.map((name) => {
  const originalName = getOriginalVariableName(name);
  const isAuto = isValidVariable(name);
  const autoInfo = AUTO_VARIABLE_METADATA[originalName];
  const value = isAuto ? (autoInfo?.source || 'Auto-filled from order') : (selectedVariableBook?.definitions?.[name] || '');
  return {
    name,
    originalName,
    value,
    defined: isAuto || !!(value && value.trim().length > 0),
    auto: isAuto,
    group: autoInfo?.label || null,
    isValid: isAuto,
  };
  });
const autoVariableCount = variableStatus.filter((item) => item.auto).length;
const manualVariableCount = variableStatus.length - autoVariableCount;
const hasInvalidVariables = variableStatus.some((item) => !item.isValid);

  // Load agents and knowledge books on mount
  useEffect(() => {
    const loadData = async () => {
      await loadAgents();
      await loadKnowledgeBooks();
      
      // After agents are loaded, check URL params
      const agentId = searchParams.get('agent');
      const kbId = searchParams.get('knowledge-book');
      const prefillName = searchParams.get('name');
      const prefillSuccessCriteria = searchParams.get('successCriteria');
      const prefillOtherCriteria = searchParams.get('otherCriteria');
      const prefillCustomAnalysis = searchParams.get('customAnalysisPrompt');
      const prefillScript = searchParams.get('script');
      const prefillUseCustomAnalysis = searchParams.get('useCustomAnalysis');
      
      if (agentId) {
        if (agentId === 'new') {
          // Check if we have pre-fill data (from RTO Analysis)
          if (prefillName || prefillScript) {
            handleCreateNewWithPrefill({
              name: prefillName,
              successCriteria: prefillSuccessCriteria ? JSON.parse(prefillSuccessCriteria) : [],
              otherCriteria: prefillOtherCriteria ? JSON.parse(prefillOtherCriteria) : [],
              customAnalysisPrompt: prefillCustomAnalysis,
              script: prefillScript,
              useCustomAnalysis: prefillUseCustomAnalysis === 'true'
            });
          } else {
            handleCreateNew();
          }
        } else {
          // Wait a bit for state to update, then select agent
          setTimeout(() => {
            handleSelectAgent(parseInt(agentId));
          }, 100);
        }
      }
      if (kbId) {
        if (kbId === 'new') {
          handleCreateNewKnowledgeBook();
        } else {
          setTimeout(() => {
            handleSelectKnowledgeBook(parseInt(kbId));
          }, 100);
        }
      }
    };
    loadData();
  }, [shop]);

  useEffect(() => {
    if (showForm || showKnowledgeBookForm) {
      setIsBulkSelecting(false);
      setSelectedAgentIds(new Set());
    }
  }, [showForm, showKnowledgeBookForm]);

  useEffect(() => {
    try {
      const stored = localStorage.getItem('playground_variable_books');
      if (stored) {
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed)) {
          setVariableBooks(parsed);
        }
      }
    } catch (error) {
      console.error('[Playground] Failed to load variable books from storage:', error);
    }
  }, []);

  useEffect(() => {
    try {
      localStorage.setItem('playground_variable_books', JSON.stringify(variableBooks));
    } catch (error) {
      console.error('[Playground] Failed to persist variable books:', error);
    }
  }, [variableBooks]);

  // Update script duration estimate
  useEffect(() => {
  }, [formData.content]);

  // Auto-save every 5 minutes if there are unsaved changes
  useEffect(() => {
    if (!currentAgentId || !hasUnsavedChanges) return;

    const autoSaveInterval = setInterval(async () => {
      try {
        console.log('[Playground] Auto-saving script...');
        // Use the same logic as handleSubmit but silently
        const frontendDisplayScript = (safeFormData?.content || formData?.content || '').trim();
        let fullContent = frontendDisplayScript;
        
        if (selectedKnowledgeBookIds.length > 0) {
          fullContent += '\n\n';
          for (const kbId of selectedKnowledgeBookIds) {
            const kb = knowledgeBooks.find(b => b.id === kbId);
            if (kb) {
              fullContent += `${kb.content}\n\n`;
            }
          }
        }

        const successCriteria = ((safeFormData?.successCriteria || formData?.successCriteria) || []).filter(c => c && c.trim() !== '');
        const otherCriteria = ((safeFormData?.otherCriteria || formData?.otherCriteria) || []).filter(c => c && c.trim() !== '');
        const maxRetries = (safeFormData?.maxRetries || formData?.maxRetries) && (safeFormData?.maxRetries || formData?.maxRetries).trim() !== '' 
          ? parseInt(safeFormData?.maxRetries || formData?.maxRetries) 
          : null;
        const retryIntervalMinutes = (safeFormData?.retryIntervalMinutes || formData?.retryIntervalMinutes) && (safeFormData?.retryIntervalMinutes || formData?.retryIntervalMinutes).trim() !== '' 
          ? parseInt(safeFormData?.retryIntervalMinutes || formData?.retryIntervalMinutes) 
          : null;

        const scriptData = {
          name: formData.name || '',
          description: formData.description || '',
          content: fullContent,
          frontendDisplayScript: frontendDisplayScript,
          voiceId: formData.voiceId || '',
          initialGreeting: formData.initialGreeting || '',
          prePhrase: formData.prePhrase ?? '',
          prePhraseArray: formData.prePhraseArray || [],
          useCustomAnalysis: formData.useCustomAnalysis || false,
          customAnalysisPrompt: formData.customAnalysisPrompt || '',
          disableUnder35Retries: formData.disableUnder35Retries || false,
          successCriteria: successCriteria,
          otherCriteria: otherCriteria,
          maxRetries: maxRetries,
          retryIntervalMinutes: retryIntervalMinutes,
          cancelOnRetry: safeFormData?.cancelOnRetry !== undefined ? safeFormData.cancelOnRetry : (formData?.cancelOnRetry !== undefined ? formData.cancelOnRetry : false),
          autoTaggingEnabled: safeFormData?.autoTaggingEnabled || formData?.autoTaggingEnabled || false,
          autoTaggingRules: safeFormData?.autoTaggingRules || formData?.autoTaggingRules || {
            successCriteria: {},
            otherCriteria: {},
            tagOnMaxRetries: false,
            maxRetriesTagName: ''
          },
          ttsProvider: safeFormData?.ttsProvider || formData?.ttsProvider || null,
          interruptions: safeFormData?.interruptions !== undefined ? safeFormData.interruptions : (formData?.interruptions !== undefined ? formData.interruptions : false),
          reasoning: safeFormData?.reasoning !== undefined ? safeFormData.reasoning : (formData?.reasoning !== undefined ? formData.reasoning : false),
          writeAIInstructions: safeFormData?.writeAIInstructions || formData?.writeAIInstructions || '',
          callFulfilledOrders: safeFormData?.callFulfilledOrders !== undefined ? safeFormData.callFulfilledOrders : (formData?.callFulfilledOrders !== undefined ? formData.callFulfilledOrders : true),
          callCancelledOrders: safeFormData?.callCancelledOrders !== undefined ? safeFormData.callCancelledOrders : (formData?.callCancelledOrders !== undefined ? formData.callCancelledOrders : true),
          maxCallDuration: safeFormData?.maxCallDuration !== undefined ? safeFormData.maxCallDuration : (formData?.maxCallDuration !== undefined ? formData.maxCallDuration : null),
          inactivityText: safeFormData?.inactivityText || formData?.inactivityText || null,
          temperature: temperature !== undefined && temperature !== null ? temperature : null,
          temperatureMode: temperatureMode || 'manual',
          scriptType: scriptType || 'simple',
          llmModel: llmModel || '',
          variableBookId: selectedVariableBookId || null,
          flowData: flowData && typeof flowData === 'object' ? flowData : null,
        };

        const response = await updateScript(currentAgentId, scriptData, shop);
        if (response.success) {
          console.log('[Playground] Auto-save successful');
          setLastSavedContent(JSON.stringify({
            content: scriptData.content,
            name: scriptData.name,
            description: scriptData.description,
            successCriteria: scriptData.successCriteria,
            otherCriteria: scriptData.otherCriteria
          }));
          setHasUnsavedChanges(false);
          // Reload versions after auto-save
          if (currentAgentId) {
            loadScriptVersions(currentAgentId);
          }
        }
      } catch (error) {
        console.error('[Playground] Auto-save failed:', error);
      }
    }, 5 * 60 * 1000); // 5 minutes

    return () => clearInterval(autoSaveInterval);
  }, [currentAgentId, hasUnsavedChanges, formData, safeFormData, selectedKnowledgeBookIds, knowledgeBooks, flowData, selectedVariableBookId, shop, temperature, temperatureMode, scriptType, llmModel]);

  // Track changes to detect unsaved edits
  useEffect(() => {
    if (!currentAgentId) {
      setHasUnsavedChanges(false);
      setLastSavedContent(null);
      return;
    }

    const currentContent = JSON.stringify({
      content: formData.content,
      name: formData.name,
      description: formData.description,
      successCriteria: formData.successCriteria,
      otherCriteria: formData.otherCriteria
    });

    if (lastSavedContent === null) {
      // First load, set as saved
      setLastSavedContent(currentContent);
      setHasUnsavedChanges(false);
    } else if (currentContent !== lastSavedContent) {
      setHasUnsavedChanges(true);
    }
  }, [formData.content, formData.name, formData.description, formData.successCriteria, formData.otherCriteria, currentAgentId, lastSavedContent]);

  // Auto-send initial greeting when chat tab is opened (either box2ActiveTab === 'chat' or activeTab === 'test-agent')
  useEffect(() => {
    if ((box2ActiveTab === 'chat' || activeTab === 'test-agent') && safeFormData?.content && scriptBox2ChatMessages.length === 0 && !scriptBox2ChatLoading) {
      const sendInitialGreeting = async () => {
        setScriptBox2ChatLoading(true);
        try {
          // Extract variables from script and create default test variables
          const extractedVars = extractVariables(safeFormData.content || '');
          const testVariables = {};
          extractedVars.forEach(varName => {
            const normalized = varName.toLowerCase().replace(/[{}]/g, '');
            // Set default test values
            if (normalized.includes('customer') && normalized.includes('name')) {
              testVariables[normalized] = 'Rahul';
            } else if (normalized.includes('order') && normalized.includes('number')) {
              testVariables[normalized] = 'ORD12345';
            } else if (normalized.includes('order') && (normalized.includes('total') || normalized.includes('amount'))) {
              testVariables[normalized] = '1499';
            } else if (normalized.includes('product') && normalized.includes('name')) {
              testVariables[normalized] = 'Test Product';
            } else if (normalized.includes('phone') || normalized.includes('number')) {
              testVariables[normalized] = '9876543210';
            } else if (normalized.includes('delivery') && normalized.includes('date')) {
              testVariables[normalized] = '3-4 days';
            } else if (normalized.includes('address') || normalized.includes('delivery')) {
              testVariables[normalized] = '123 Test Street, Mumbai';
            } else {
              testVariables[normalized] = 'Test Value';
            }
          });

          const response = await fetch('/api/test-agent', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
              scriptContent: safeFormData.content,
              messages: [],
              scriptId: currentAgentId,
              variables: testVariables,
              temperature: formData?.temperature !== undefined ? formData.temperature : (safeFormData?.temperature !== undefined ? safeFormData.temperature : 0.7),
              initialGreeting: safeFormData?.initialGreeting || formData?.initialGreeting || null
            })
          });

          const data = await response.json();

          if (data.success && data.message) {
            setScriptBox2ChatMessages([{ role: 'assistant', content: data.message }]);
          }
        } catch (error) {
          console.error('[Playground] Error sending initial greeting:', error);
        } finally {
          setScriptBox2ChatLoading(false);
        }
      };

      sendInitialGreeting();
    }
  }, [box2ActiveTab, activeTab, safeFormData?.content, scriptBox2ChatMessages.length, scriptBox2ChatLoading, currentAgentId, formData?.temperature, safeFormData?.temperature, safeFormData?.initialGreeting, formData?.initialGreeting]);

  const loadAgents = async () => {
    try {
      setLoading(true);
      console.log('[Playground] Loading agents for shop:', shop);
      const response = await getCallScripts(shop);
      // API returns { scripts: [...] }, extract the array
      const scripts = response?.scripts || response || [];
      const validAgents = Array.isArray(scripts) ? scripts.filter(agent => agent && agent.id) : [];
      console.log('[Playground] Loaded agents:', validAgents.length);
      
      // Log details of script 53 if it exists
      const script53 = validAgents.find(a => a.id === 53);
      if (script53) {
        console.log('[Playground] Script 53 in loaded agents:');
        console.log('  - Content length:', script53.content?.length);
        console.log('  - FrontendDisplayScript length:', script53.frontendDisplayScript?.length);
        console.log('  - Content preview:', script53.content?.substring(0, 150));
        console.log('  - Contains "aaaa":', script53.content?.includes('aaaa') || script53.frontendDisplayScript?.includes('aaaa'));
      }
      
      setAgents(validAgents);
      setSelectedAgentIds((prev) => {
        if (prev.size === 0) return prev;
        const validIds = new Set(validAgents.map((agent) => agent.id));
        const filtered = new Set();
        prev.forEach((id) => {
          if (validIds.has(id)) {
            filtered.add(id);
          }
        });
        if (filtered.size === prev.size) {
          return prev;
        }
        return filtered;
      });
      
      // Clear loading state immediately so UI appears fast
      setLoading(false);
      
      // Load stats in the background without blocking UI
      loadAgentStats(validAgents).catch(err => {
        console.error('[Playground] Error loading agent stats in background:', err);
      });
    } catch (error) {
      console.error('[Playground] Error loading agents:', error);
      setAgents([]);
      setLoading(false);
    }
  };

  // Load evaluation test cases when Evaluate tab is opened (only once)
  // Prompts are pre-filled in useState, so we only load test cases
  useEffect(() => {
    const loadEvaluationTestCases = async () => {
      if (activeTab === 'evaluate' && !evaluationDefaultsLoaded.current) {
        try {
          console.log('[Playground] Loading evaluation test cases...');
          const testCasesRes = await api.getEvaluationTestCases();
          console.log('[Playground] Test cases response:', testCasesRes);
          
          // Always set test cases on first load and select all by default
          if (testCasesRes && testCasesRes.success) {
            if (testCasesRes.testCases && testCasesRes.testCases.length > 0) {
              setTestCases(testCasesRes.testCases);
              // Select all test cases by default
              setSelectedTestCases(testCasesRes.testCases.map(tc => tc.id));
            }
          }
          
          evaluationDefaultsLoaded.current = true;
        } catch (error) {
          console.error('[Playground] Error loading evaluation test cases:', error);
        }
      }
    };
    loadEvaluationTestCases();
  }, [activeTab]);

  const loadAgentStats = async (agentsList) => {
    if (!shop || !agentsList || agentsList.length === 0) return;
    
    const statsMap = {};
    
    // Calculate talk time and language for all agents (no API calls needed)
    agentsList.forEach((agent) => {
      const scriptLength = (agent.frontendDisplayScript || agent.content || '').length;
      const estimatedMinutes = Math.ceil(scriptLength / 150);
      const talkTime = `${estimatedMinutes} min`;
      const language = 'Hindi, English';
      statsMap[agent.id] = { talkTime, language, conversionRate: 'NA' };
    });
    
    // Set initial stats immediately for fast UI update
    setAgentStats({ ...statsMap });
    
    // Batch load conversion rates in parallel (limit to 10 concurrent requests)
    const batchSize = 10;
    for (let i = 0; i < agentsList.length; i += batchSize) {
      const batch = agentsList.slice(i, i + batchSize);
      await Promise.all(
        batch.map(async (agent) => {
          try {
            const statsResponse = await fetch(`/api/agent-stats?scriptId=${agent.id}&shop=${encodeURIComponent(shop)}`, {
              credentials: 'include'
            });
            if (statsResponse.ok) {
              const statsData = await statsResponse.json();
              if (statsData.success && statsData.conversionRate !== undefined && statsData.conversionRate !== null) {
                statsMap[agent.id].conversionRate = `${statsData.conversionRate}%`;
              } else if (statsData.success && statsData.conversionRate === 0) {
                statsMap[agent.id].conversionRate = '0%';
              }
            }
          } catch (err) {
            console.error(`[Playground] Error loading stats for agent ${agent.id}:`, err);
          }
        })
      );
      // Update stats incrementally as batches complete
      setAgentStats({ ...statsMap });
    }
  };

  const loadKnowledgeBooks = async () => {
    try {
      console.log('[Playground] Loading knowledge books for shop:', shop);
      const response = await getKnowledgeBooks(shop);
      const books = response?.knowledgeBooks || response || [];
      const validBooks = Array.isArray(books) ? books.filter(book => book && book.id) : [];
      console.log('[Playground] Loaded knowledge books:', validBooks.length);
      setKnowledgeBooks(validBooks);
    } catch (error) {
      console.error('[Playground] Error loading knowledge books:', error);
      setKnowledgeBooks([]);
    }
  };

  const loadScriptVersions = async (scriptId) => {
    if (!scriptId) return;
    try {
      setLoadingVersions(true);
      const response = await fetch(`/api/scripts/${scriptId}/versions?shop=${encodeURIComponent(shop || '')}`, {
        credentials: 'include'
      });
      const data = await response.json();
      if (data.success) {
        setScriptVersions(data.versions || []);
      }
    } catch (error) {
      console.error('[Playground] Error loading script versions:', error);
    } finally {
      setLoadingVersions(false);
    }
  };

  const loadVersion = async (versionId) => {
    if (!currentAgentId) {
      console.error('[loadVersion] No currentAgentId');
      return;
    }
    
    console.log('[loadVersion] Loading version:', versionId, 'for agent:', currentAgentId);
    
    try {
      const response = await fetch(`/api/scripts/${currentAgentId}/versions/${versionId}?shop=${encodeURIComponent(shop || '')}`, {
        credentials: 'include'
      });
      const data = await response.json();
      
      console.log('[loadVersion] API response:', data);
      
      if (data.success && data.version) {
        const version = data.version;
        console.log('[loadVersion] Loading version data:', {
          versionName: version.versionName,
          contentLength: version.content?.length,
          voiceId: version.voiceId
        });
        
        // Load version data into form
        setFormData(prev => ({
          ...prev,
          content: version.frontendDisplayScript || version.content || '',
          description: version.description || prev.description,
          voiceId: version.voiceId || prev.voiceId,
          initialGreeting: version.initialGreeting || prev.initialGreeting,
          prePhrase: version.prePhrase || prev.prePhrase,
          prePhraseArray: version.prePhraseArray || prev.prePhraseArray,
          useCustomAnalysis: version.useCustomAnalysis !== undefined ? version.useCustomAnalysis : prev.useCustomAnalysis,
          customAnalysisPrompt: version.customAnalysisPrompt || prev.customAnalysisPrompt,
          disableUnder35Retries: version.disableUnder35Retries !== undefined ? version.disableUnder35Retries : prev.disableUnder35Retries,
          successCriteria: version.successCriteria || prev.successCriteria,
          otherCriteria: version.otherCriteria || prev.otherCriteria,
          maxRetries: version.maxRetries !== null && version.maxRetries !== undefined ? version.maxRetries.toString() : prev.maxRetries,
          retryIntervalMinutes: version.retryIntervalMinutes !== null && version.retryIntervalMinutes !== undefined ? version.retryIntervalMinutes.toString() : prev.retryIntervalMinutes,
          cancelOnRetry: version.cancelOnRetry !== undefined ? version.cancelOnRetry : prev.cancelOnRetry,
          autoTaggingEnabled: version.autoTaggingEnabled !== undefined ? version.autoTaggingEnabled : prev.autoTaggingEnabled,
          autoTaggingRules: version.autoTaggingRules && typeof version.autoTaggingRules === 'object' ? version.autoTaggingRules : prev.autoTaggingRules,
          ttsProvider: version.ttsProvider !== undefined ? version.ttsProvider : prev.ttsProvider,
          interruptions: version.interruptions !== undefined ? version.interruptions : prev.interruptions,
          reasoning: version.reasoning !== undefined ? version.reasoning : prev.reasoning,
          writeAIInstructions: version.writeAIInstructions || prev.writeAIInstructions,
          callFulfilledOrders: version.callFulfilledOrders !== undefined ? version.callFulfilledOrders : prev.callFulfilledOrders,
          callCancelledOrders: version.callCancelledOrders !== undefined ? version.callCancelledOrders : prev.callCancelledOrders,
          cancellationCriteria: Array.isArray(version.cancellationCriteria) ? version.cancellationCriteria : (prev.cancellationCriteria || []),
          retryCriteria: Array.isArray(version.retryCriteria) ? version.retryCriteria : (prev.retryCriteria || []),
          maxCallDuration: version.maxCallDuration !== undefined && version.maxCallDuration !== null ? version.maxCallDuration : prev.maxCallDuration,
        }));
        
        if (version.flowData) {
          console.log('[loadVersion] Setting flowData with', version.flowData.nodes?.length, 'nodes');
          setFlowData(version.flowData);
        }
        
        if (version.variableBookId) {
          console.log('[loadVersion] Setting variableBookId:', version.variableBookId);
          setSelectedVariableBookId(version.variableBookId);
        }
        
        setBox2ActiveTab('settings'); // Switch back to settings after loading
        
        // Show success notification
        alert(`âœ… Version ${version.versionName} loaded successfully!\n\nThe script content, voice settings, and all configurations have been restored.\n\nClick "Save Agent" to make this version permanent.`);
        
        console.log('[loadVersion] Version loaded successfully');
      } else {
        console.error('[loadVersion] Invalid response:', data);
        alert('Failed to load version: Invalid response from server');
      }
    } catch (error) {
      console.error('[Playground] Error loading version:', error);
      alert('Failed to load version: ' + error.message);
    }
  };

  const handleSelectAgent = async (agentId) => {
    try {
      if (isBulkSelecting) {
        exitBulkSelectionMode();
      }
      // Use cached agent first for faster loading, only fetch if not found
      let agent = agents.find((a) => a.id === agentId);
      
      // Only fetch from API if agent not in cache
      if (!agent) {
        console.log('[Playground] Agent not in cache, fetching from API:', agentId);
        try {
          const response = await getCallScripts(shop);
          const scripts = response?.scripts || response || [];
          const validAgents = Array.isArray(scripts) ? scripts.filter(a => a && a.id) : [];
          agent = validAgents.find((a) => a.id === agentId);
          
          if (agent) {
            // Update agents array with fresh data
            setAgents(prevAgents => {
              const updated = prevAgents.map(a => a.id === agentId ? agent : a);
              if (!updated.find(a => a.id === agentId)) {
                updated.push(agent);
              }
              return updated;
            });
          }
        } catch (error) {
          console.error('[Playground] Error fetching agent from API:', error);
        }
      }
      
      if (!agent) {
        console.error('[Playground] Agent not found:', agentId);
        alert('Agent not found. Please refresh the page and try again.');
        return;
      }

      const assignedVariableBookId = variableAssignments[agent.id] || agent.variableBookId || null;
      setSelectedVariableBookId(assignedVariableBookId || null);
      setPendingVariableBookId(null);

      console.log('[Playground] Selecting agent:', agentId, 'Content length:', agent.content?.length);
      console.log('[Playground] Frontend display script:', agent.frontendDisplayScript?.length);
      console.log('[Playground] Full agent object:', {
        id: agent.id,
        name: agent.name,
        hasContent: !!agent.content,
        contentLength: agent.content?.length,
        hasFrontendDisplayScript: !!agent.frontendDisplayScript,
        frontendDisplayScriptLength: agent.frontendDisplayScript?.length
      });
      
      // Use frontendDisplayScript if available, otherwise use content (for backward compatibility)
      const displayScript = agent.frontendDisplayScript || agent.content || '';
      const fullContent = agent.content || '';
      
      console.log('[Playground] Display script to use, length:', displayScript.length);
      console.log('[Playground] Display script preview (first 200 chars):', displayScript.substring(0, 200));
      console.log('[Playground] Full content length:', fullContent.length);
      console.log('[Playground] Full content preview (first 200 chars):', fullContent.substring(0, 200));
      
      // Validate that we have valid data
      if (!agent.name) {
        console.warn('[Playground] Agent missing name, using default');
      }
      
      // Determine which knowledge books are selected by comparing content with frontendDisplayScript
      let kbIds = [];
      let qnaIds = [];
      
      if (agent.frontendDisplayScript && fullContent && fullContent.length > displayScript.length) {
        // Extract the knowledge books section (everything after frontendDisplayScript)
        // Remove leading \n\n if present
        let kbSection = fullContent.substring(displayScript.length).trim();
        if (kbSection.startsWith('\n\n')) {
          kbSection = kbSection.substring(2).trim();
        }
        console.log('[Playground] Knowledge books section found, length:', kbSection.length);
        console.log('[Playground] KB section preview:', kbSection.substring(0, 100));
        
        // Extract QNA books first (they're marked with comments)
        const qnaBooksMatch = kbSection.match(/<!-- QNA_BOOKS_START -->([\s\S]*?)<!-- QNA_BOOKS_END -->/);
        if (qnaBooksMatch) {
          const qnaBooksContent = qnaBooksMatch[1];
          const qnaBookMatches = qnaBooksContent.matchAll(/<!-- QNA_BOOK:(\d+) -->/g);
          for (const match of qnaBookMatches) {
            const qnaBookId = parseInt(match[1]);
            if (!qnaIds.includes(qnaBookId)) {
              qnaIds.push(qnaBookId);
              console.log('[Playground] Found QNA book:', qnaBookId);
            }
          }
          // Remove QNA section from kbSection for regular book matching
          kbSection = kbSection.replace(/<!-- QNA_BOOKS_START -->[\s\S]*?<!-- QNA_BOOKS_END -->/, '').trim();
        }
        
        // Match against available knowledge books (regular books only)
        if (kbSection && knowledgeBooks.length > 0) {
          // Split by \n\n to get individual knowledge book sections
          const kbSections = kbSection.split(/\n\n+/).map(s => s.trim()).filter(s => s.length > 0);
          console.log('[Playground] Split into', kbSections.length, 'sections');
          
          for (const kb of knowledgeBooks) {
            // Skip QNA books
            try {
              if (kb.extraContent) {
                const parsed = JSON.parse(kb.extraContent);
                if (parsed.qnaPairs && Array.isArray(parsed.qnaPairs) && parsed.qnaPairs.length > 0) {
                  continue; // Skip QNA books
                }
              }
            } catch (e) {}
            
            const kbContentTrimmed = kb.content.trim();
            
            // Check if this knowledge book's content matches any section
            for (const section of kbSections) {
              // Normalize whitespace for comparison
              const kbContentNormalized = kbContentTrimmed.replace(/\s+/g, ' ').trim();
              const sectionNormalized = section.replace(/\s+/g, ' ').trim();
              
              // Check for exact match or if section contains the KB content
              if (sectionNormalized === kbContentNormalized || 
                  sectionNormalized.includes(kbContentNormalized) ||
                  kbContentNormalized.includes(sectionNormalized)) {
                if (!kbIds.includes(kb.id)) {
                  kbIds.push(kb.id);
                  console.log('[Playground] Found matching knowledge book:', kb.id, kb.name);
                }
                break; // Found match, move to next KB
              }
            }
          }
        }
      }

      console.log('[Playground] Display script length:', displayScript.length);
      console.log('[Playground] Full content length:', fullContent.length);
      console.log('[Playground] Knowledge book IDs from content:', kbIds);
      console.log('[Playground] QNA book IDs from content:', qnaIds);

      // Set currentAgentId FIRST to ensure it's available for saving
      setCurrentAgentId(agentId);
      // Force ScriptEditor to remount by updating key (even if same agent, to show fresh content)
      setScriptEditorKey(prev => prev + 1);
      console.log('[Playground] Set currentAgentId to:', agentId);
      console.log('[Playground] Updated scriptEditorKey to force remount');
      
      setShowForm(true);
      setShowKnowledgeBookForm(false);
      setSelectedKnowledgeBookIds(kbIds);
      setSelectedQnaBookIds(qnaIds);
      setActiveTab('script'); // Reset to Script tab when selecting an agent
      
      // Safely set form data with defaults - use a function to ensure state updates properly
      try {
        const newFormData = {
        name: agent.name || '',
        description: agent.description || '',
          content: displayScript || '', // Show frontendDisplayScript or content
        voiceId: agent.voiceId || '',
        initialGreeting: agent.initialGreeting || '',
        prePhrase: agent.prePhrase || 'ji',
        prePhraseArray: Array.isArray(agent.prePhraseArray) ? agent.prePhraseArray : [],
        useCustomAnalysis: agent.useCustomAnalysis || false,
        customAnalysisPrompt: agent.customAnalysisPrompt || '',
        disableUnder35Retries: agent.disableUnder35Retries || false,
          successCriteria: Array.isArray(agent.successCriteria) ? agent.successCriteria : [],
          otherCriteria: Array.isArray(agent.otherCriteria) ? agent.otherCriteria : [],
          maxRetries: agent.maxRetries !== null && agent.maxRetries !== undefined ? agent.maxRetries.toString() : '',
          retryIntervalMinutes: agent.retryIntervalMinutes !== null && agent.retryIntervalMinutes !== undefined ? agent.retryIntervalMinutes.toString() : '',
          cancelOnRetry: agent.cancelOnRetry !== undefined && agent.cancelOnRetry !== null ? agent.cancelOnRetry : false,
          successMetric: agent.successMetric || '',
          variableDefinitions: agent.variableDefinitions && typeof agent.variableDefinitions === 'object' ? agent.variableDefinitions : {},
          variableBookId: agent.variableBookId || '',
          autoTaggingEnabled: agent.autoTaggingEnabled || false,
          autoTaggingRules: agent.autoTaggingRules && typeof agent.autoTaggingRules === 'object' ? agent.autoTaggingRules : {
            successCriteria: {},
            otherCriteria: {},
            tagOnMaxRetries: false,
            maxRetriesTagName: ''
          },
          ttsProvider: agent.ttsProvider || null,
          interruptions: agent.interruptions !== undefined ? agent.interruptions : false,
          reasoning: agent.reasoning !== undefined ? agent.reasoning : false,
          writeAIInstructions: agent.writeAIInstructions || '',
          callFulfilledOrders: agent.callFulfilledOrders !== undefined ? agent.callFulfilledOrders : true,
          callCancelledOrders: agent.callCancelledOrders !== undefined ? agent.callCancelledOrders : true,
          cancellationCriteria: Array.isArray(agent.cancellationCriteria) ? agent.cancellationCriteria : [],
          retryCriteria: Array.isArray(agent.retryCriteria) ? agent.retryCriteria : [],
          // Convert seconds (from DB) to minutes (for frontend display)
          maxCallDuration: agent.maxCallDuration !== undefined && agent.maxCallDuration !== null ? agent.maxCallDuration : null, // Keep in seconds for storage, convert in UI
          inactivityText: agent.inactivityText || '',
          temperature: agent.temperature !== undefined && agent.temperature !== null ? agent.temperature : 0.7,
          volume: agent.volume !== undefined && agent.volume !== null ? agent.volume : 50,
          emotions: Array.isArray(agent.emotions) ? agent.emotions : [],
        };
        
        // Load memory settings
        if (agent.memorySettings) {
          setMemorySettings(agent.memorySettings);
        } else {
          // Default memory settings
          setMemorySettings({
            currentConversationMemory: true,
            crossSessionMemory: false,
            liveContextAwareness: true
          });
        }
        
        console.log('[Playground] Loading toggles from agent:', {
          callFulfilledOrders_raw: agent.callFulfilledOrders,
          callCancelledOrders_raw: agent.callCancelledOrders,
          callFulfilledOrders_loaded: agent.callFulfilledOrders !== undefined ? agent.callFulfilledOrders : true,
          callCancelledOrders_loaded: agent.callCancelledOrders !== undefined ? agent.callCancelledOrders : true,
        });
        
        // Load inactivity and silence settings
        if (agent.inactivityPeriod !== undefined && agent.inactivityPeriod !== null) {
          setInactivityPeriod(agent.inactivityPeriod);
        }
        if (agent.inactivityText !== undefined && agent.inactivityText !== null) {
          setInactivityText(agent.inactivityText);
        }
        if (agent.autoEndCallForSilence !== undefined) {
          setAutoEndCallForSilence(agent.autoEndCallForSilence);
        }
        if (agent.silenceDuration !== undefined && agent.silenceDuration !== null) {
          setSilenceDuration(agent.silenceDuration);
        }
        // Load temperature settings
        if (agent.temperature !== undefined && agent.temperature !== null) {
          setTemperature(agent.temperature);
        } else {
          setTemperature(0.7); // Default
        }
        // Load temperature mode and script type
        setTemperatureMode(agent.temperatureMode || 'manual');
        setScriptType(agent.scriptType || 'simple');
        // Load LLM model
        setLlmModel(agent.llmModel || '');
        if (agent.silenceDuration !== undefined && agent.silenceDuration !== null) {
          setSilenceDuration(agent.silenceDuration);
        }
        
        // Load flow data if it exists
        console.log('[Playground] Loading flowData from agent:', {
          hasFlowData: !!agent.flowData,
          flowDataType: typeof agent.flowData,
          nodeCount: agent.flowData?.nodes?.length || 0,
          edgeCount: agent.flowData?.edges?.length || 0,
          flowDataPreview: agent.flowData ? JSON.stringify(agent.flowData).substring(0, 200) : null
        });
        if (agent.flowData) {
          setFlowData(agent.flowData);
          console.log('[Playground] FlowData set successfully');
        } else {
          setFlowData(null);
          console.log('[Playground] No flowData found, set to null');
        }
        
        // Load script versions
        loadScriptVersions(agentId);
        
        console.log('[Playground] Setting form data:');
        console.log('  - Content length:', newFormData.content.length);
        console.log('  - Content preview (first 200 chars):', newFormData.content.substring(0, 200));
        console.log('  - Contains "aaaa":', newFormData.content.includes('aaaa'));
        setFormData(newFormData);
      } catch (formError) {
        console.error('[Playground] Error setting form data:', formError);
        // Set minimal form data to prevent white screen
        setFormData({
          name: agent.name || 'Untitled Agent',
          description: '',
          content: displayScript || '',
          voiceId: '',
          initialGreeting: '',
          prePhrase: 'ji',
          prePhraseArray: [],
          useCustomAnalysis: false,
          customAnalysisPrompt: '',
          disableUnder35Retries: false,
          successCriteria: [],
          successMetric: '',
          otherCriteria: [],
          maxRetries: '',
          retryIntervalMinutes: '',
          variableDefinitions: {},
          variableBookId: '',
          autoTaggingEnabled: false,
          autoTaggingRules: {
            successCriteria: {},
            otherCriteria: {},
            tagOnMaxRetries: false,
            maxRetriesTagName: ''
          },
          ttsProvider: null,
          interruptions: false,
          reasoning: false,
          writeAIInstructions: '',
          callFulfilledOrders: true,
          callCancelledOrders: true,
          maxCallDuration: null,
          volume: 50,
          emotions: [],
        });
      }

      // Update URL - ensure we always set the actual agent ID, never 'new' for existing agents
      try {
        const newParams = new URLSearchParams(searchParams);
        // Only update URL if we have a valid agent ID (not null, not undefined, not 'new')
        if (agentId && agentId !== 'new' && !isNaN(agentId)) {
          newParams.set('agent', agentId.toString());
          newParams.delete('knowledge-book');
          setSearchParams(newParams, { replace: true });
        }
      } catch (urlError) {
        console.error('[Playground] Error updating URL:', urlError);
        // Continue even if URL update fails
      }
    } catch (error) {
      console.error('[Playground] Error selecting agent:', error);
      console.error('[Playground] Error stack:', error.stack);
      alert('Error loading agent: ' + (error.message || 'Unknown error') + '. Please refresh the page and try again.');
      // Reset state to prevent white screen
      setShowForm(false);
      setCurrentAgentId(null);
    }
  };

  const clearAgentSelection = () => {
    setSelectedAgentIds(new Set());
  };

  const exitBulkSelectionMode = () => {
    setIsBulkSelecting(false);
    clearAgentSelection();
  };

  const resetVariableBookSelection = () => {
    setSelectedVariableBookId(null);
    setPendingVariableBookId(null);
  };

  const handleCreateNew = () => {
    console.log('[Playground] handleCreateNew called');
    // Cleanup selection states first
      resetVariableBookSelection();
      exitBulkSelectionMode();
    setCurrentAgentId(null);
    
    // Show agent type selection popup immediately - use functional update to ensure it works
    setShowAgentTypeSelection(prev => {
      console.log('[Playground] Setting showAgentTypeSelection to true, previous value:', prev);
      return true;
    });
    
    // Update URL to reflect 'new' agent state
    const newParams = new URLSearchParams(searchParams);
    newParams.set('agent', 'new');
    setSearchParams(newParams);
    
    // Force a re-render by updating a dummy state if needed
    console.log('[Playground] handleCreateNew completed');
  };

  const toggleSelectionMode = () => {
    setIsBulkSelecting((prev) => {
      const next = !prev;
      if (!next) {
        clearAgentSelection();
      }
      return next;
    });
  };

  const toggleAgentSelection = (agentId) => {
    setSelectedAgentIds((prev) => {
      const next = new Set(prev);
      if (next.has(agentId)) {
        next.delete(agentId);
      } else {
        next.add(agentId);
      }
      return next;
    });
  };

  const handleSelectAllAgents = () => {
    setSelectedAgentIds(new Set(agents.map((agent) => agent.id)));
  };

  const handleDeleteSelectedAgents = async () => {
    if (selectedAgentIds.size === 0 || isDeletingAgents) return;
    const confirmed = window.confirm(
      `Delete ${selectedAgentIds.size} script${selectedAgentIds.size > 1 ? 's' : ''}? This action cannot be undone.`
    );
    if (!confirmed) return;

    setIsDeletingAgents(true);
    const failedIds = [];
    try {
      const ids = Array.from(selectedAgentIds);
      for (const id of ids) {
        try {
          await deleteScript(id, shop);
        } catch (error) {
          console.error('[Playground] Error deleting script:', id, error);
          failedIds.push(id);
        }
      }

      if (failedIds.length > 0) {
        alert(`Failed to delete ${failedIds.length} script(s). Please check the console for details.`);
      }
      const successfulIds = ids.filter((id) => !failedIds.includes(id));
      if (successfulIds.length > 0) {
        const updatedAssignments = { ...variableAssignments };
        successfulIds.forEach((id) => {
          if (updatedAssignments[id]) {
            delete updatedAssignments[id];
          }
        });
        persistVariableAssignments(updatedAssignments);
        if (currentAgentId && successfulIds.includes(currentAgentId)) {
          setSelectedVariableBookId(null);
          setPendingVariableBookId(null);
        }
      }
      clearAgentSelection();
      setIsBulkSelecting(false);
      await loadAgents();
    } catch (error) {
      console.error('[Playground] Bulk delete error:', error);
      alert('Failed to delete scripts. Please try again.');
    } finally {
      setIsDeletingAgents(false);
    }
  };

  const secondaryButtonStyle = {
    padding: '8px 16px',
    background: '#FFFFFF',
    border: '1px solid #E5E7EB',
    borderRadius: '6px',
    fontSize: '13px',
    fontWeight: 600,
    cursor: 'pointer'
  };
  const selectedAgentCount = selectedAgentIds.size;
  const hasAgents = agents.length > 0;
  const isDeleteDisabled = selectedAgentCount === 0 || isDeletingAgents;

  const handleCreateNewWithTemplate = (templateType) => {
    resetVariableBookSelection();
    exitBulkSelectionMode();
    setCurrentAgentId(null);
    setShowForm(true);
    setActiveTab('script'); // Reset to Script tab when creating new agent
    
    // Try to find default script for voice
    let defaultScript = null;
    try {
      getCallScripts(shop).then(scripts => {
        const scriptsArray = scripts?.scripts || scripts || [];
        defaultScript = scriptsArray.find(s => {
          const nameLower = s.name.toLowerCase();
          return (nameLower.includes('address') && nameLower.includes('extraction')) ||
                 (nameLower.includes('house') && nameLower.includes('direction')) ||
                 nameLower.includes('house dir');
        });
        
        // Template data
        const templates = {
          'smart-address-recovery': {
            name: 'Smart Address Recovery',
            content: SMART_ADDRESS_SCRIPT,
            voiceId: '67331efb-7d7a-40ab-a3da-e42a0c85a2e1',
            initialGreeting: 'Hello {customer_name} ji se baat ho rahi hai?',
            prePhrase: 'Okay',
            successCriteria: ['address confirmed', 'address updated', 'complete address provided', 'missing details added'],
            otherCriteria: ['wrong number', 'not answering', 'unclear address']
          },
          'cod-thank-you-intent': {
            name: 'COD Thank You Call + Intent Capture',
            content: COD_THANK_YOU_SCRIPT,
            voiceId: '64fe23d4-6e44-4f92-8534-ae171ed0df3d',
            initialGreeting: 'Hello am I speaking with {customer_name}?',
            prePhrase: 'Okay',
            successCriteria: ['customer appreciated', 'intent captured', 'support offered', 'queries answered'],
            otherCriteria: ['cancellation requested', 'address change needed', 'customer upset']
          },
          'ndr-script': {
            name: 'NDR Script',
            content: `Namaste, main aapke order ke liye call kar raha hoon jo delivery mein issue aaya hai.

Order Details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Address: {customerAddress}

Aapka order delivery ke liye ready hai lekin kuch issue aaya hai. Kya aap available hain delivery ke liye? Agar haan, to kya address sahi hai? 

Automated NDR handling script that processes non-delivery reports, collects customer feedback, and submits actions with call recordings for review.`,
            successCriteria: ['delivery confirmed', 'address confirmed', 'available for delivery', 'action submitted'],
            otherCriteria: ['not available', 'wrong number', 'address issue', 'requires manual review']
          },
          'cod-confirmation': {
            name: 'COD Confirmation Call',
            content: `Namaste, main aapke order ke liye call kar raha hoon.

Order Details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Order Amount: {orderAmount}
- Payment Method: COD (Cash on Delivery)
- Address: {customerAddress}

AI Calls to thank customer for placing an order and confirms the order details, payment method, and delivery address to prevent RTO.

Pehle main aapko order ke liye dhanyawad deta hoon. Kya aap confirm karte hain ki:
1. Aapka order sahi hai?
2. Aap COD payment karenge?
3. Delivery address sahi hai?

Yeh confirmation RTO ko prevent karne ke liye zaroori hai.`,
            successCriteria: ['order confirmed', 'payment method confirmed', 'address confirmed', 'intent verified', 'rto prevented'],
            otherCriteria: ['order cancelled', 'wrong details', 'not responding', 'payment issue']
          },
          'address-update': {
            name: 'Address Update Agent',
            content: `Namaste, main aapke order ki delivery ke liye call kar raha hoon.

Order Details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Current Address: {customerAddress}

Kya aapka address sahi hai? Agar nahi, to please correct address bataiye.`,
            successCriteria: ['address confirmed', 'address updated', 'correct address provided'],
            otherCriteria: ['wrong number', 'not answering', 'unclear address']
          },
          'ndr-call': {
            name: 'NDR Call Agent',
            content: `Namaste, main aapke order ke liye call kar raha hoon.

Order Details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Address: {customerAddress}

Aapka order delivery ke liye ready hai. Kya aap available hain delivery ke liye? Agar haan, to kya address sahi hai?`,
            successCriteria: ['delivery confirmed', 'address confirmed', 'available for delivery'],
            otherCriteria: ['not available', 'wrong number', 'address issue']
          },
          'order-confirmation': {
            name: 'Order Confirmation Agent',
            content: `Hello, this is regarding your order.

Order Details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Order Amount: {orderAmount}

I'm calling to confirm your order details. Is everything correct?`,
            successCriteria: ['order confirmed', 'details correct', 'confirmed'],
            otherCriteria: ['order cancelled', 'wrong details', 'not responding']
          },
          'abandonment-checkout': {
            name: 'Abandonment Checkout',
            content: `Namaste, main aapke cart ke liye call kar raha hoon.

Cart Details:
- Items: {cartItems}
- Total Amount: {cartAmount}
- Customer Name: {customerName}

Maine notice kiya ki aapne cart mein items add kiye the lekin order complete nahi hua. Kya aap order complete karna chahte hain? Main aapki help kar sakta hoon.

AI calls customers who abandoned their cart to help them complete their purchase and recover lost sales.`,
            successCriteria: ['order completed', 'purchase intent confirmed', 'cart recovered', 'payment processed'],
            otherCriteria: ['not interested', 'price concern', 'wrong number', 'not responding']
          },
          'cod-to-prepaid': {
            name: 'COD to Prepaid',
            content: `Namaste, main aapke COD order ke liye call kar raha hoon.

Order Details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Order Amount: {orderAmount}
- Payment Method: COD (Cash on Delivery)

Aapka order confirm hai, lekin agar aap prepaid payment karte hain to aapko â‚¹100 ka discount milega. Kya aap prepaid payment karna chahenge?

AI calls COD customers to convert them to prepaid payment with attractive discounts, reducing cash handling and improving cash flow.`,
            successCriteria: ['converted to prepaid', 'payment link sent', 'payment confirmed', 'discount accepted'],
            otherCriteria: ['prefers COD', 'payment concern', 'not interested', 'wrong number']
          },
          'lead-qualifying': {
            name: 'Lead Qualifying',
            content: `Namaste, main {company_name} se call kar raha hoon.

Lead Details:
- Name: {customerName}
- Phone: {customerPhone}
- Source: {leadSource}

Main aapko {product/service} ke baare mein batana chahta hoon. Kya aap interested hain? Main aapke questions ka answer de sakta hoon.

AI calls to qualify leads, understand their needs, and determine their interest level in products or services.`,
            successCriteria: ['lead qualified', 'interest confirmed', 'appointment scheduled', 'information shared'],
            otherCriteria: ['not interested', 'wrong number', 'not available', 'callback requested']
          },
          'customer-support': {
            name: 'Customer Support',
            content: `Namaste, main {company_name} se call kar raha hoon. Aapne recently hamare saath contact kiya tha.

Customer Details:
- Name: {customerName}
- Phone: {customerPhone}
- Previous Query: {previousQuery}

Main aapki help ke liye call kar raha hoon. Aapka issue resolve ho gaya hai ya phir aapko aur help chahiye?

AI handles inbound customer support calls, addresses queries, resolves issues, and provides assistance.`,
            successCriteria: ['issue resolved', 'query answered', 'satisfaction confirmed', 'support provided'],
            otherCriteria: ['escalation needed', 'callback requested', 'wrong number', 'not available']
          }
        };
        
        const template = templates[templateType] || templates['smart-address-recovery'];
        
        setFormData({
          name: template.name,
          description: '',
          content: template.content,
          voiceId: template.voiceId || defaultScript?.voiceId || '',
          initialGreeting: template.initialGreeting || '',
          prePhrase: template.prePhrase || 'ji',
          prePhraseArray: Array.isArray(template.prePhraseArray) ? template.prePhraseArray : [],
          useCustomAnalysis: false,
          customAnalysisPrompt: '',
          disableUnder35Retries: false,
          successCriteria: template.successCriteria,
          otherCriteria: template.otherCriteria,
          maxRetries: '',
          retryIntervalMinutes: '',
          successMetric: '',
          variableDefinitions: template.variableDefinitions || {},
          variableBookId: template.variableBookId || '',
          ttsProvider: template.ttsProvider || null,
          interruptions: template.interruptions !== undefined ? template.interruptions : false,
        });

        // Update URL
        const newParams = new URLSearchParams(searchParams);
        newParams.set('agent', 'new');
        setSearchParams(newParams);
      }).catch(error => {
        console.error('[Playground] Error loading scripts for template:', error);
        // Set template data even if default script loading fails
        const templates = {
          'smart-address-recovery': {
            name: 'Smart Address Recovery',
                    content: SMART_ADDRESS_SCRIPT,
                    voiceId: '67331efb-7d7a-40ab-a3da-e42a0c85a2e1',
                    initialGreeting: 'Hello {customer_name} ji se baat ho rahi hai?',
                    prePhrase: 'Okay',
            successCriteria: ['address confirmed', 'address updated', 'complete address provided', 'missing details added'],
            otherCriteria: ['wrong number', 'not answering', 'unclear address']
          },
                  'cod-thank-you-intent': {
                    name: 'COD Thank You Call + Intent Capture',
                    content: COD_THANK_YOU_SCRIPT,
                    voiceId: '64fe23d4-6e44-4f92-8534-ae171ed0df3d',
                    initialGreeting: 'Hello am I speaking with {customer_name}?',
                    prePhrase: 'Okay',
                    successCriteria: ['customer appreciated', 'intent captured', 'support offered', 'queries answered'],
                    otherCriteria: ['cancellation requested', 'address change needed', 'customer upset']
          },
          'ndr-script': {
            name: 'NDR Script',
            content: `Namaste, main aapke order ke liye call kar raha hoon jo delivery mein issue aaya hai.

Order Details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Address: {customerAddress}

Aapka order delivery ke liye ready hai lekin kuch issue aaya hai. Kya aap available hain delivery ke liye? Agar haan, to kya address sahi hai? 

Automated NDR handling script that processes non-delivery reports, collects customer feedback, and submits actions with call recordings for review.`,
            successCriteria: ['delivery confirmed', 'address confirmed', 'available for delivery', 'action submitted'],
            otherCriteria: ['not available', 'wrong number', 'address issue', 'requires manual review']
          },
          'cod-confirmation': {
            name: 'COD Confirmation Call',
            content: `Namaste, main aapke order ke liye call kar raha hoon.

Order Details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Order Amount: {orderAmount}
- Payment Method: COD (Cash on Delivery)
- Address: {customerAddress}

AI Calls to thank customer for placing an order and confirms the order details, payment method, and delivery address to prevent RTO.

Pehle main aapko order ke liye dhanyawad deta hoon. Kya aap confirm karte hain ki:
1. Aapka order sahi hai?
2. Aap COD payment karenge?
3. Delivery address sahi hai?

Yeh confirmation RTO ko prevent karne ke liye zaroori hai.`,
            successCriteria: ['order confirmed', 'payment method confirmed', 'address confirmed', 'intent verified', 'rto prevented'],
            otherCriteria: ['order cancelled', 'wrong details', 'not responding', 'payment issue']
          },
          'address-update': {
            name: 'Address Update Agent',
            content: `Namaste, main aapke order ki delivery ke liye call kar raha hoon.

Order Details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Current Address: {customerAddress}

Kya aapka address sahi hai? Agar nahi, to please correct address bataiye.`,
            successCriteria: ['address confirmed', 'address updated', 'correct address provided'],
            otherCriteria: ['wrong number', 'not answering', 'unclear address']
          },
          'ndr-call': {
            name: 'NDR Call Agent',
            content: `Namaste, main aapke order ke liye call kar raha hoon.

Order Details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Address: {customerAddress}

Aapka order delivery ke liye ready hai. Kya aap available hain delivery ke liye? Agar haan, to kya address sahi hai?`,
            successCriteria: ['delivery confirmed', 'address confirmed', 'available for delivery'],
            otherCriteria: ['not available', 'wrong number', 'address issue']
          },
          'order-confirmation': {
            name: 'Order Confirmation Agent',
            content: `Hello, this is regarding your order.

Order Details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Order Amount: {orderAmount}

I'm calling to confirm your order details. Is everything correct?`,
            successCriteria: ['order confirmed', 'details correct', 'confirmed'],
            otherCriteria: ['order cancelled', 'wrong details', 'not responding']
          },
          'abandonment-checkout': {
            name: 'Abandonment Checkout',
            content: `Namaste, main aapke cart ke liye call kar raha hoon.

Cart Details:
- Items: {cartItems}
- Total Amount: {cartAmount}
- Customer Name: {customerName}

Maine notice kiya ki aapne cart mein items add kiye the lekin order complete nahi hua. Kya aap order complete karna chahte hain? Main aapki help kar sakta hoon.

AI calls customers who abandoned their cart to help them complete their purchase and recover lost sales.`,
            successCriteria: ['order completed', 'purchase intent confirmed', 'cart recovered', 'payment processed'],
            otherCriteria: ['not interested', 'price concern', 'wrong number', 'not responding']
          },
          'cod-to-prepaid': {
            name: 'COD to Prepaid',
            content: `Namaste, main aapke COD order ke liye call kar raha hoon.

Order Details:
- Order Number: {orderNumber}
- Customer Name: {customerName}
- Order Amount: {orderAmount}
- Payment Method: COD (Cash on Delivery)

Aapka order confirm hai, lekin agar aap prepaid payment karte hain to aapko â‚¹100 ka discount milega. Kya aap prepaid payment karna chahenge?

AI calls COD customers to convert them to prepaid payment with attractive discounts, reducing cash handling and improving cash flow.`,
            successCriteria: ['converted to prepaid', 'payment link sent', 'payment confirmed', 'discount accepted'],
            otherCriteria: ['prefers COD', 'payment concern', 'not interested', 'wrong number']
          },
          'lead-qualifying': {
            name: 'Lead Qualifying',
            content: `Namaste, main {company_name} se call kar raha hoon.

Lead Details:
- Name: {customerName}
- Phone: {customerPhone}
- Source: {leadSource}

Main aapko {product/service} ke baare mein batana chahta hoon. Kya aap interested hain? Main aapke questions ka answer de sakta hoon.

AI calls to qualify leads, understand their needs, and determine their interest level in products or services.`,
            successCriteria: ['lead qualified', 'interest confirmed', 'appointment scheduled', 'information shared'],
            otherCriteria: ['not interested', 'wrong number', 'not available', 'callback requested']
          },
          'customer-support': {
            name: 'Customer Support',
            content: `Namaste, main {company_name} se call kar raha hoon. Aapne recently hamare saath contact kiya tha.

Customer Details:
- Name: {customerName}
- Phone: {customerPhone}
- Previous Query: {previousQuery}

Main aapki help ke liye call kar raha hoon. Aapka issue resolve ho gaya hai ya phir aapko aur help chahiye?

AI handles inbound customer support calls, addresses queries, resolves issues, and provides assistance.`,
            successCriteria: ['issue resolved', 'query answered', 'satisfaction confirmed', 'support provided'],
            otherCriteria: ['escalation needed', 'callback requested', 'wrong number', 'not available']
          }
        };
        
        const template = templates[templateType] || templates['smart-address-recovery'];
        
        setFormData({
          name: template.name,
          description: '',
          content: template.content,
          voiceId: '',
          initialGreeting: '',
          prePhrase: 'ji',
          prePhraseArray: [],
          useCustomAnalysis: false,
          customAnalysisPrompt: '',
          disableUnder35Retries: false,
          successCriteria: template.successCriteria,
          otherCriteria: template.otherCriteria,
          maxRetries: '',
          retryIntervalMinutes: '',
          successMetric: '',
          ttsProvider: null,
          interruptions: false,
        });

        const newParams = new URLSearchParams(searchParams);
        newParams.set('agent', 'new');
        setSearchParams(newParams);
      });
    } catch (error) {
      console.error('[Playground] Error in handleCreateNewWithTemplate:', error);
    }
  };

  const handleCreateNewWithPrefill = async (prefillData) => {
    resetVariableBookSelection();
    exitBulkSelectionMode();
    setCurrentAgentId(null);
    setShowForm(true);
    setActiveTab('script'); // Reset to Script tab when creating new agent
    
    // Try to find default script for voice
    let defaultScript = null;
    try {
      const scripts = await getCallScripts(shop);
      const scriptsArray = scripts?.scripts || scripts || [];
      defaultScript = scriptsArray.find(s => {
        const nameLower = s.name.toLowerCase();
        return (nameLower.includes('address') && nameLower.includes('extraction')) ||
               (nameLower.includes('house') && nameLower.includes('direction')) ||
               nameLower.includes('house dir');
      });
    } catch (error) {
      console.error('[Playground] Error loading scripts for default:', error);
    }
    
    setFormData({
      name: prefillData.name || '',
      description: '',
      content: prefillData.script || '',
      voiceId: defaultScript?.voiceId || '',
      initialGreeting: '',
      prePhrase: 'ji',
      prePhraseArray: [],
      useCustomAnalysis: prefillData.useCustomAnalysis || false,
      customAnalysisPrompt: prefillData.customAnalysisPrompt || '',
      disableUnder35Retries: false,
      successCriteria: prefillData.successCriteria || [],
      otherCriteria: prefillData.otherCriteria || [],
      maxRetries: '',
      retryIntervalMinutes: '',
      successMetric: prefillData.successMetric || '',
      ttsProvider: null,
      interruptions: false,
    });

    // Update URL (keep prefill params for reference, but user can modify)
    const newParams = new URLSearchParams(searchParams);
    newParams.set('agent', 'new');
    setSearchParams(newParams);
  };

  const handleBackToList = () => {
    setShowForm(false);
    setShowKnowledgeBookForm(false);
    setCurrentAgentId(null);
    setCurrentKnowledgeBookId(null);
    exitBulkSelectionMode();
    resetVariableBookSelection();
    const newParams = new URLSearchParams(searchParams);
    newParams.delete('agent');
    newParams.delete('knowledge-book');
    setSearchParams(newParams);
  };

  // Knowledge Book management functions
  const handleSelectKnowledgeBook = (kbId) => {
    try {
      const kb = knowledgeBooks.find((b) => b.id === kbId);
      if (!kb) {
        console.error('[Playground] Knowledge book not found:', kbId);
        return;
      }

      setCurrentKnowledgeBookId(kbId);
      setShowKnowledgeBookForm(true);
      setShowForm(false);
      setKnowledgeBookFormData({
        name: kb.name || '',
        description: kb.description || '',
        content: kb.content || '',
      });

      const newParams = new URLSearchParams(searchParams);
      newParams.set('knowledge-book', kbId.toString());
      newParams.delete('agent');
      setSearchParams(newParams);
    } catch (error) {
      console.error('[Playground] Error selecting knowledge book:', error);
      alert('Error loading knowledge book. Please try again.');
    }
  };

  const handleCreateNewKnowledgeBook = () => {
    setCurrentKnowledgeBookId(null);
    setShowKnowledgeBookForm(true);
    setShowForm(false);
    setKnowledgeBookFormData({
      name: '',
      description: '',
      content: '',
    });

    const newParams = new URLSearchParams(searchParams);
    newParams.set('knowledge-book', 'new');
    newParams.delete('agent');
    setSearchParams(newParams);
  };

  const handleKnowledgeBookFormChange = (e) => {
    const { name, value } = e.target;
    setKnowledgeBookFormData((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleKnowledgeBookSubmit = async (e) => {
    e.preventDefault();

    try {
      let response;
      if (currentKnowledgeBookId) {
        response = await updateKnowledgeBook(currentKnowledgeBookId, shop, knowledgeBookFormData);
      } else {
        response = await createKnowledgeBook(shop, knowledgeBookFormData);
      }

      if (response.success) {
        alert('Knowledge book saved successfully!');
        await loadKnowledgeBooks();
        if (response.knowledgeBook) {
          handleSelectKnowledgeBook(response.knowledgeBook.id);
        }
      } else {
        alert(response.error || 'Failed to save knowledge book');
      }
    } catch (error) {
      console.error('[Playground] Error saving knowledge book:', error);
      alert('Error saving knowledge book');
    }
  };

  const handleDeleteKnowledgeBook = async (kbId) => {
    if (!window.confirm('Are you sure you want to delete this knowledge book?')) {
      return;
    }

    try {
      await deleteKnowledgeBook(kbId, shop);
      alert('Knowledge book deleted successfully!');
      await loadKnowledgeBooks();
      if (currentKnowledgeBookId === kbId) {
        handleBackToList();
      }
    } catch (error) {
      console.error('[Playground] Error deleting knowledge book:', error);
      alert('Error deleting knowledge book');
    }
  };

  const handleToggleKnowledgeBook = (kbId) => {
    setSelectedKnowledgeBookIds((prev) => {
      if (prev.includes(kbId)) {
        console.log('[Playground] Removing knowledge book:', kbId);
        return prev.filter(id => id !== kbId);
      } else {
        console.log('[Playground] Adding knowledge book:', kbId);
        return [...prev, kbId];
      }
    });
  };

  // Tab drag and drop handlers - requires double-click and hold
  const handleTabMouseDown = (e, index) => {
    // Only start drag on left mouse button
    if (e.button !== 0) return;
    
    const currentTime = Date.now();
    const timeSinceLastClick = currentTime - lastClickTime;
    
    // Check if this is a double-click (within 300ms of previous click)
    if (timeSinceLastClick < 300 && clickCount === 1) {
      // Double-click detected - start drag
      e.preventDefault();
      const rect = e.currentTarget.getBoundingClientRect();
      const navbar = document.querySelector('.agent-settings-navbar');
      const navbarRect = navbar ? navbar.getBoundingClientRect() : { left: 0, top: 0 };
      
      // Calculate the original position relative to the navbar
      const originalLeft = rect.left - navbarRect.left;
      const originalTop = rect.top - navbarRect.top;
      
      const startPageX = e.clientX;
      const startPageY = e.clientY;
      
      let currentDraggedIndex = index;
      let currentDragOverIndex = null;
      
      setDraggedTabIndex(index);
      setIsDragging(true);
      setIsReadyToDrag(true);
      setDragOffset({ x: 0, y: 0 });
      setDragStartPosition({ left: originalLeft, top: originalTop });
      setClickCount(0); // Reset click count

      const handleMouseMove = (moveEvent) => {
        const navbar = document.querySelector('.agent-settings-navbar');
        if (!navbar) return;
        
        // Calculate offset from initial mouse position
        const offsetX = moveEvent.clientX - startPageX;
        const offsetY = moveEvent.clientY - startPageY;
        
        // If mouse has moved significantly, we're actively dragging
        if (Math.abs(offsetX) > 3 || Math.abs(offsetY) > 3) {
          setIsReadyToDrag(false); // Switch from grab to grabbing cursor
        }
        
        setDragOffset({ x: offsetX, y: offsetY });
        
        const tabs = Array.from(navbar.querySelectorAll('.nav-tab'));
        if (tabs.length === 0) return;
        
        // Find which tab we're over (excluding the dragged tab)
        let newDragOverIndex = null;
        for (let i = 0; i < tabs.length; i++) {
          if (i === currentDraggedIndex) continue; // Skip the dragged tab itself
          
          const tabRect = tabs[i].getBoundingClientRect();
          const tabCenter = tabRect.left + tabRect.width / 2;
          
          if (moveEvent.clientX >= tabRect.left && moveEvent.clientX <= tabRect.right) {
            newDragOverIndex = moveEvent.clientX < tabCenter ? i : i + 1;
            break;
          } else if (moveEvent.clientX < tabRect.left && i === 0) {
            newDragOverIndex = 0;
            break;
          } else if (moveEvent.clientX > tabRect.right && i === tabs.length - 1) {
            newDragOverIndex = tabs.length;
            break;
          }
        }
        
        if (newDragOverIndex !== null && newDragOverIndex !== currentDragOverIndex) {
          currentDragOverIndex = newDragOverIndex;
          setDragOverIndex(newDragOverIndex);
        }
      };

      const handleMouseUp = () => {
        if (currentDraggedIndex !== null && currentDragOverIndex !== null && currentDraggedIndex !== currentDragOverIndex) {
          const newOrder = [...tabOrder];
          const [removed] = newOrder.splice(currentDraggedIndex, 1);
          const insertIndex = currentDragOverIndex > currentDraggedIndex ? currentDragOverIndex - 1 : currentDragOverIndex;
          newOrder.splice(insertIndex, 0, removed);
          setTabOrder(newOrder);
          
          // Save to localStorage
          try {
            localStorage.setItem('playgroundTabOrder', JSON.stringify(newOrder));
          } catch (e) {
            console.error('Error saving tab order:', e);
          }
        }
        
        // Reset with slight delay for smooth animation
        setTimeout(() => {
          setDraggedTabIndex(null);
          setDragOverIndex(null);
          setIsDragging(false);
          setIsReadyToDrag(false);
          setDragOffset({ x: 0, y: 0 });
          setDragStartPosition({ left: 0, top: 0 });
        }, 150);
        
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    } else {
      // Single click - track for potential double-click
      setLastClickTime(currentTime);
      setClickCount(1);
      
      // Reset click count after timeout
      setTimeout(() => {
        setClickCount(0);
      }, 300);
    }
  };

  const handleAddQnAPair = () => {
    setReplyQualityFormData({
      ...replyQualityFormData,
      qnaPairs: [...replyQualityFormData.qnaPairs, { question: '', answer: '' }]
    });
  };

  const handleRemoveQnAPair = (index) => {
    if (replyQualityFormData.qnaPairs.length > 1) {
      setReplyQualityFormData({
        ...replyQualityFormData,
        qnaPairs: replyQualityFormData.qnaPairs.filter((_, i) => i !== index)
      });
    }
  };

  const handleQnAPairChange = (index, field, value) => {
    const updatedPairs = [...replyQualityFormData.qnaPairs];
    updatedPairs[index][field] = value;
    setReplyQualityFormData({
      ...replyQualityFormData,
      qnaPairs: updatedPairs
    });
  };

  const handleReplyQualitySubmit = async (e) => {
    e.preventDefault();
    
    if (!replyQualityFormData.name) {
      alert('Please fill in the name field');
      return;
    }

    // Filter out empty pairs
    const validPairs = replyQualityFormData.qnaPairs.filter(
      pair => pair.question.trim() && pair.answer.trim()
    );

    if (validPairs.length === 0) {
      alert('Please add at least one Q&A pair');
      return;
    }

    if (!shop) {
      alert('Please connect a Shopify store first. Shop information is required to save reply quality books.');
      return;
    }

    try {
      const knowledgeBookData = {
        name: replyQualityFormData.name,
        description: replyQualityFormData.description || '',
        content: '', // Empty content, QnA stored in extraContent
        websiteLink: null,
        extraContent: JSON.stringify({ qnaPairs: validPairs })
      };

      let response;
      if (editingReplyQualityId) {
        // Update existing book
        response = await updateKnowledgeBook(editingReplyQualityId, shop, knowledgeBookData);
      } else {
        // Create new book
        response = await createKnowledgeBook(shop, knowledgeBookData);
      }
      
      if (response.success) {
        alert(editingReplyQualityId ? 'Reply Quality book updated successfully!' : 'Reply Quality book saved successfully!');
        await loadKnowledgeBooks();
        // Reset form
        setReplyQualityFormData({
          name: '',
          description: '',
          qnaPairs: [{ question: '', answer: '' }]
        });
        setShowReplyQualityForm(false);
        setEditingReplyQualityId(null);
        // Auto-select the newly created book
        if (response.knowledgeBook && !editingReplyQualityId) {
          setSelectedKnowledgeBookIds([...selectedKnowledgeBookIds, response.knowledgeBook.id]);
        }
      } else {
        const errorMsg = response.error || 'Failed to save reply quality book';
        alert(errorMsg);
      }
    } catch (error) {
      console.error('[Playground] Error saving reply quality book:', error);
      
      // Provide more helpful error messages
      let errorMessage = 'Error saving reply quality book';
      
      if (error.message) {
        errorMessage = error.message;
      } else if (error.response?.data?.error) {
        errorMessage = error.response.data.error;
      } else if (typeof error === 'string') {
        errorMessage = error;
      } else if (error.toString && error.toString() !== '[object Object]') {
        errorMessage = error.toString();
      }
      
      alert(errorMessage);
    }
  };

  const handleEditReplyQuality = (kb) => {
    try {
      let qnaPairs = [{ question: '', answer: '' }];
      if (kb.extraContent) {
        const parsed = JSON.parse(kb.extraContent);
        if (parsed.qnaPairs && Array.isArray(parsed.qnaPairs) && parsed.qnaPairs.length > 0) {
          qnaPairs = parsed.qnaPairs;
        }
      }
      
      setReplyQualityFormData({
        name: kb.name || '',
        description: kb.description || '',
        qnaPairs: qnaPairs
      });
      setEditingReplyQualityId(kb.id);
      setShowReplyQualityForm(true);
    } catch (error) {
      console.error('[Playground] Error parsing reply quality data:', error);
      alert('Error loading reply quality data');
    }
  };

  const handleFormChange = useCallback((e) => {
    const { name, value, type, checked } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value,
    }));
  }, []);

  const handleOpenAIModal = (mode) => {
    setAiModalMode(mode);
    // Reset generation mode to 'simple' when opening modal
    setAiGenerationMode('simple');
    // Reset gender selection when opening modal
    setAiGenderSelection(null);
    // Open AI modal directly for both 'write' and 'rewrite' modes
    if (noteTakerContent.trim()) {
      setAiPrompt(noteTakerContent.trim());
    } else {
      setAiPrompt('');
    }
      setShowAIModal(true);
  };

  const handleSelectAgentType = (type) => {
    setSelectedAgentType(type);
    setShowAgentTypeSelection(false);
    
    if (type === 'scratch') {
      // Manual: Scratch - Create blank script
      setCurrentAgentId(null);
      setShowForm(true);
      setActiveTab('script');
      setFormData({
        name: '',
        content: '',
        description: '',
        voiceId: '',
        initialGreeting: '',
        prePhrase: 'ji',
        prePhraseArray: [],
        useCustomAnalysis: false,
        customAnalysisPrompt: '',
        disableUnder35Retries: false,
        successCriteria: [],
        otherCriteria: [],
        maxRetries: '',
        retryIntervalMinutes: '',
        successMetric: '',
        ttsProvider: null,
        interruptions: false,
        reasoning: false,
        writeAIInstructions: '',
        variableBookId: null,
      });
      setNoteTakerContent('');
    } else if (type === 'simple-flow') {
      // Simple Flow - Create blank script for simple outbound calls
      setCurrentAgentId(null);
      setShowForm(true);
      setActiveTab('script');
      setAiGenerationMode('simple'); // Set default mode to simple
      setFormData({
        name: 'Simple Flow Script',
        content: '',
        description: '',
        voiceId: '',
        initialGreeting: '',
        prePhrase: 'ji',
        prePhraseArray: [],
        useCustomAnalysis: false,
        customAnalysisPrompt: '',
        disableUnder35Retries: false,
        successCriteria: [],
        otherCriteria: [],
        maxRetries: '',
        retryIntervalMinutes: '',
        successMetric: '',
        ttsProvider: null,
        interruptions: false,
        reasoning: false,
        writeAIInstructions: '',
        variableBookId: null,
      });
      setNoteTakerContent('');
    } else if (type === 'advanced-flow') {
      // Advanced Flow - Create blank script for complex outbound calls
      setCurrentAgentId(null);
      setShowForm(true);
      setActiveTab('script');
      setAiGenerationMode('advanced'); // Set default mode to advanced
      setFormData({
        name: 'Advanced Flow Script',
        content: '',
        description: '',
        voiceId: '',
        initialGreeting: '',
        prePhrase: 'ji',
        prePhraseArray: [],
        useCustomAnalysis: false,
        customAnalysisPrompt: '',
        disableUnder35Retries: false,
        successCriteria: [],
        otherCriteria: [],
        maxRetries: '',
        retryIntervalMinutes: '',
        successMetric: '',
        ttsProvider: null,
        interruptions: false,
        reasoning: false,
        writeAIInstructions: '',
        variableBookId: null,
      });
      setNoteTakerContent('');
    } else if (type === 'strict-flow') {
      const strictFlowTemplate = `Write objective:
e.g., I want to confirm COD order

Ask first:
e.g., "Sir, I am calling from [Company Name] regarding your recent order"

Ask second:
e.g., "Can you confirm your delivery address?"

Ask third:
e.g., "Would you like to proceed with the COD payment?"

Extra instructions? (Optional):
1. If customer talks about cancellation, transfer to support
2. If customer confirms, thank them and end call
3. If customer is unavailable, schedule callback`;
      
      // Create new script with template
      setCurrentAgentId(null);
      setShowForm(true);
      setActiveTab('script');
      setFormData({
        name: '',
        content: strictFlowTemplate,
        description: '',
        voiceId: '',
        initialGreeting: '',
        prePhrase: 'ji',
        prePhraseArray: [],
        useCustomAnalysis: false,
        customAnalysisPrompt: '',
        disableUnder35Retries: false,
        successCriteria: [],
        otherCriteria: [],
        maxRetries: '',
        retryIntervalMinutes: '',
        successMetric: '',
        ttsProvider: null,
        interruptions: false,
        reasoning: false,
        writeAIInstructions: '',
        variableBookId: null,
      });
      setNoteTakerContent('');
    } else if (type === 'flow-maker') {
      // Flow Maker - Open FlowMaker component
      setCurrentAgentId(null);
      setShowFlowMaker(true);
    } else if (type === 'free-flow') {
      // Free Flow - Create new blank script
      setCurrentAgentId(null);
      setShowForm(true);
      setActiveTab('script');
      setAiGenerationMode('free-flow'); // Set default mode to free-flow
      setFormData({
        name: 'Free Flow Script',
        content: '',
        description: '',
        voiceId: '',
        initialGreeting: '',
        prePhrase: 'ji',
        prePhraseArray: [],
        useCustomAnalysis: false,
        customAnalysisPrompt: '',
        disableUnder35Retries: false,
        successCriteria: [],
        otherCriteria: [],
        maxRetries: '',
        retryIntervalMinutes: '',
        successMetric: '',
        ttsProvider: null,
        interruptions: false,
        reasoning: false,
        writeAIInstructions: '',
        variableBookId: null,
      });
      setNoteTakerContent('');
    } else {
      // For other types (finetuned, etc), create new blank script
      setCurrentAgentId(null);
      setShowForm(true);
      setActiveTab('script');
      setFormData({
        name: '',
        content: '',
        description: '',
        voiceId: '',
        initialGreeting: '',
        prePhrase: 'ji',
        prePhraseArray: [],
        useCustomAnalysis: false,
        customAnalysisPrompt: '',
        disableUnder35Retries: false,
        successCriteria: [],
        otherCriteria: [],
        maxRetries: '',
        retryIntervalMinutes: '',
        successMetric: '',
        ttsProvider: null,
        interruptions: false,
        reasoning: false,
        writeAIInstructions: '',
        variableBookId: null,
      });
      setNoteTakerContent('');
    }
  };

  const handleConfirmWriteAISettings = () => {
    if (!writeAISettings.description.trim()) {
      alert('Please provide instructions or select a use case');
      return;
    }
    // Close settings popup and open AI modal with the description
    setShowWriteAISettings(false);
    // Build prompt with use case context if selected
    let prompt = writeAISettings.description.trim();
    
    // Add prompt structure if selected
    if (writeAISettings.style) {
      const styleLabels = {
        'strict-flow': 'Strict Flow',
        'free-flow': 'Free Flow',
        'standard': 'Standard'
      };
      const styleLabel = styleLabels[writeAISettings.style] || writeAISettings.style;
      prompt = `Prompt Structure: ${styleLabel}\n\n${prompt}`;
    }
    
    // Add agent name if provided
    if (writeAISettings.agentName.trim()) {
      prompt = `Agent Name: ${writeAISettings.agentName.trim()}\n\n${prompt}`;
    }
    
    // Add gender if selected
    if (writeAISettings.gender) {
      const genderLabels = {
        'male': 'Male',
        'female': 'Female',
        'neutral': 'Neutral'
      };
      const genderLabel = genderLabels[writeAISettings.gender] || writeAISettings.gender;
      prompt = `Gender: ${genderLabel}\n\n${prompt}`;
    }
    
    if (writeAISettings.useCase && writeAISettings.useCase !== 'custom') {
      const useCaseLabels = {
        'customer-support': 'Customer Support',
        'abandonment-checkout': 'Abandonment Checkout Recovery',
        'order-confirmation': 'Order Confirmation',
        'delivery-update': 'Delivery Update',
        'payment-reminder': 'Payment Reminder',
        'product-inquiry': 'Product Inquiry',
        'return-refund': 'Return & Refund',
        'upsell-cross-sell': 'Upsell & Cross-Sell',
        'feedback-survey': 'Feedback & Survey'
      };
      const useCaseLabel = useCaseLabels[writeAISettings.useCase] || writeAISettings.useCase;
      prompt = `Use Case: ${useCaseLabel}\n\n${prompt}`;
    }
    setAiPrompt(prompt);
    setShowAIModal(true);
  };

  const handleCloseAIModal = () => {
    // Close AI modal (both write and rewrite modes)
    setShowAIModal(false);
    setProposedScript(null);
    setShowEditDiffModal(false);
  };

  const handleChatSend = async () => {
    if (!chatInput.trim() || !safeFormData?.content || isChatLoading) return;

    const userMessage = chatInput.trim();
    setChatInput('');
    
    // Add user message to chat
    const newUserMessage = { role: 'user', content: userMessage };
    setChatMessages(prev => [...prev, newUserMessage]);
    setIsChatLoading(true);

    try {
      // Build messages array for API (all previous messages + new user message)
      const messagesForApi = [...chatMessages, newUserMessage].map(msg => ({
        role: msg.role,
        content: msg.content
      }));

      const response = await fetch('/api/groq/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          scriptContent: safeFormData.content,
          messages: messagesForApi
        })
      });

      const data = await response.json();

      if (data.success && data.message) {
        // Add assistant response to chat
        setChatMessages(prev => [...prev, { role: 'assistant', content: data.message }]);
      } else {
        throw new Error(data.error || 'Failed to get response');
      }
    } catch (error) {
      console.error('[Playground] Error sending chat message:', error);
      setChatMessages(prev => [...prev, { 
        role: 'assistant', 
        content: `Error: ${error.message || 'Failed to get response. Please try again.'}` 
      }]);
    } finally {
      setIsChatLoading(false);
    }
  };

  // Script Box 2 Chat handlers
  const handleScriptBox2ChatInputChange = (e) => {
    setScriptBox2ChatInput(e.target.value);
  };

  const handleScriptBox2ChatKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleScriptBox2ChatSend();
    }
  };

  const handleScriptBox2ChatSend = async () => {
    if (!scriptBox2ChatInput.trim() || !safeFormData?.content || scriptBox2ChatLoading) return;

    const userMessage = scriptBox2ChatInput.trim();
    setScriptBox2ChatInput('');
    
    const newUserMessage = { role: 'user', content: userMessage };
    setScriptBox2ChatMessages(prev => [...prev, newUserMessage]);
    setScriptBox2ChatLoading(true);

    try {
      const messagesForApi = [...scriptBox2ChatMessages, newUserMessage].map(msg => ({
        role: msg.role === 'assistant' ? 'assistant' : 'user',
        content: msg.content
      }));

      // Extract variables from script and create default test variables
      const extractedVars = extractVariables(safeFormData.content || '');
      const testVariables = {};
      extractedVars.forEach(varName => {
        const normalized = varName.toLowerCase().replace(/[{}]/g, '');
        // Set default test values
        if (normalized.includes('customer') && normalized.includes('name')) {
          testVariables[normalized] = 'Rahul';
        } else if (normalized.includes('order') && normalized.includes('number')) {
          testVariables[normalized] = 'ORD12345';
        } else if (normalized.includes('order') && (normalized.includes('total') || normalized.includes('amount'))) {
          testVariables[normalized] = '1499';
        } else if (normalized.includes('product') && normalized.includes('name')) {
          testVariables[normalized] = 'Test Product';
        } else if (normalized.includes('phone') || normalized.includes('number')) {
          testVariables[normalized] = '9876543210';
        } else if (normalized.includes('delivery') && normalized.includes('date')) {
          testVariables[normalized] = '3-4 days';
        } else if (normalized.includes('address') || normalized.includes('delivery')) {
          testVariables[normalized] = '123 Test Street, Mumbai';
        } else {
          testVariables[normalized] = 'Test Value';
        }
      });

      const response = await fetch('/api/test-agent', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          scriptContent: safeFormData.content,
          messages: messagesForApi,
          scriptId: currentAgentId,
          variables: testVariables,
          temperature: formData?.temperature !== undefined ? formData.temperature : (safeFormData?.temperature !== undefined ? safeFormData.temperature : 0.7),
          initialGreeting: safeFormData?.initialGreeting || formData?.initialGreeting || null
        })
      });

      const data = await response.json();

      if (data.success && data.message) {
        setScriptBox2ChatMessages(prev => [...prev, { role: 'assistant', content: data.message }]);
      } else {
        throw new Error(data.error || 'Failed to get response');
      }
    } catch (error) {
      console.error('[Playground] Error sending script box 2 chat message:', error);
      setScriptBox2ChatMessages(prev => [...prev, { 
        role: 'assistant', 
        content: `Error: ${error.message || 'Failed to get response. Please try again.'}` 
      }]);
    } finally {
      setScriptBox2ChatLoading(false);
    }
  };

  const handleScriptBox2ChatClear = () => {
    setScriptBox2ChatMessages([]);
    setScriptBox2ChatInput('');
  };

  const handleScriptBox2ChatCopy = (content) => {
    navigator.clipboard.writeText(content);
  };

  const handleScriptBox2ChatThumbsUp = () => {
    // Handle thumbs up action
    console.log('Thumbs up clicked');
  };

  const handleScriptBox2ChatThumbsDown = () => {
    // Handle thumbs down action
    console.log('Thumbs down clicked');
  };

  // Store original script when edit tab is opened (either box2ActiveTab === 'edit-script' or activeTab === 'edit-script')
  useEffect(() => {
    if ((box2ActiveTab === 'edit-script' || activeTab === 'edit-script') && safeFormData?.content && !originalScriptContent) {
      setOriginalScriptContent(safeFormData.content);
      setScriptEditHistory([{ content: safeFormData.content, timestamp: Date.now() }]);
    }
  }, [box2ActiveTab, activeTab, safeFormData?.content, originalScriptContent]);

  // Extract code from markdown code blocks
  const extractCodeFromMessage = (message) => {
    const codeBlockRegex = /```(?:\w+)?\n?([\s\S]*?)```/g;
    const matches = [];
    let match;
    while ((match = codeBlockRegex.exec(message)) !== null) {
      matches.push(match[1].trim());
    }
    return matches.length > 0 ? matches[0] : null;
  };

  // Apply typing effect to Monaco editor with change highlighting
  const applyTypingEffectToEditor = (newCode, currentCode) => {
    if (!monacoEditorRef.current) return;
    
    const editor = monacoEditorRef.current;
    const model = editor.getModel();
    if (!model) return;
    
    // Note: History is already stored in handleEditScriptSend before this is called
    
    // Calculate differences for highlighting
    const oldLines = currentCode.split('\n');
    const newLines = newCode.split('\n');
    
    // Type out the new code character by character
    let currentIndex = 0;
    const typingSpeed = 3; // milliseconds per character
    
    const typeNextChar = () => {
      if (currentIndex < newCode.length) {
        const textToShow = newCode.substring(0, currentIndex + 1);
        model.setValue(textToShow);
        
        // Highlight current line being typed
        const currentLine = textToShow.split('\n').length;
        editor.setPosition({ lineNumber: currentLine, column: 1 });
        editor.revealLineInCenter(currentLine);
        
        currentIndex++;
        setTimeout(typeNextChar, typingSpeed);
      } else {
        // Typing complete - highlight all changes
        highlightChanges(model, oldLines, newLines);
        
        // Update form data
        setFormData(prev => ({ ...prev, content: newCode }));
      }
    };
    
    typeNextChar();
  };

  // Highlight changes in the editor
  const highlightChanges = (model, oldLines, newLines) => {
    if (!monacoEditorRef.current) return;
    
    const editor = monacoEditorRef.current;
    const decorations = [];
    
    // Simple diff: highlight lines that are different
    const maxLines = Math.max(oldLines.length, newLines.length);
    
    for (let i = 0; i < maxLines; i++) {
      const oldLine = oldLines[i] || '';
      const newLine = newLines[i] || '';
      
      if (oldLine !== newLine && newLine) {
        // Highlight changed/added lines with green background
        decorations.push({
          range: {
            startLineNumber: i + 1,
            startColumn: 1,
            endLineNumber: i + 1,
            endColumn: newLine.length + 1
          },
          options: {
            isWholeLine: true,
            className: 'monaco-line-highlight-added',
            glyphMarginClassName: 'monaco-glyph-highlight-added',
            minimap: {
              color: { id: 'minimap.added' },
              position: 1
            },
            overviewRuler: {
              color: { id: 'editorOverviewRuler.addedForeground' },
              position: 3
            },
            stickiness: 1,
            after: {
              content: ' ',
              inlineClassName: 'monaco-inline-highlight-added'
            }
          }
        });
      }
    }
    
    // Apply decorations
    if (decorations.length > 0) {
      const decorationIds = editor.deltaDecorations([], decorations);
      
      // Remove highlights after 5 seconds
      setTimeout(() => {
        editor.deltaDecorations(decorationIds, []);
      }, 5000);
    }
  };

  // Diff utility function - computes line-by-line diff with better handling
  const computeDiff = (oldText, newText) => {
    const oldLines = oldText.split('\n');
    const newLines = newText.split('\n');
    const diff = [];
    
    // Create a map of old line positions
    const oldLineMap = new Map();
    oldLines.forEach((line, idx) => {
      if (!oldLineMap.has(line)) {
        oldLineMap.set(line, []);
      }
      oldLineMap.get(line).push(idx);
    });
    
    // Track which lines have been matched
    const oldMatched = new Set();
    const newMatched = new Set();
    
    // First pass: find exact matches
    newLines.forEach((newLine, newIdx) => {
      if (oldLineMap.has(newLine)) {
        const oldIndices = oldLineMap.get(newLine);
        for (const oldIdx of oldIndices) {
          if (!oldMatched.has(oldIdx) && !newMatched.has(newIdx)) {
            oldMatched.add(oldIdx);
            newMatched.add(newIdx);
            break;
          }
        }
      }
    });
    
    // Second pass: build diff with context
    let oldIdx = 0;
    let newIdx = 0;
    let lineNumber = 1;
    
    while (oldIdx < oldLines.length || newIdx < newLines.length) {
      const oldLine = oldLines[oldIdx];
      const newLine = newLines[newIdx];
      
      if (oldIdx >= oldLines.length) {
        // Only new lines left
        diff.push({ type: 'added', oldLine: '', newLine, lineNumber: null });
        newIdx++;
      } else if (newIdx >= newLines.length) {
        // Only old lines left
        diff.push({ type: 'removed', oldLine, newLine: '', lineNumber });
        oldIdx++;
        lineNumber++;
      } else if (oldMatched.has(oldIdx) && newMatched.has(newIdx)) {
        // Both matched - unchanged
        diff.push({ type: 'unchanged', oldLine, newLine, lineNumber });
        oldIdx++;
        newIdx++;
        lineNumber++;
      } else if (oldMatched.has(oldIdx)) {
        // Old line matched but new line didn't - new line is added
        diff.push({ type: 'added', oldLine: '', newLine, lineNumber: null });
        newIdx++;
      } else if (newMatched.has(newIdx)) {
        // New line matched but old line didn't - old line is removed
        diff.push({ type: 'removed', oldLine, newLine: '', lineNumber });
        oldIdx++;
        lineNumber++;
      } else {
        // Neither matched - modified
        diff.push({ type: 'modified', oldLine, newLine, lineNumber });
        oldIdx++;
        newIdx++;
        lineNumber++;
      }
    }
    
    return diff;
  };

  // Edit Script Chat handlers
  const handleEditScriptSend = async (messageContent) => {
    if (!messageContent || !safeFormData?.content || isEditScriptLoading) return;

    // Check if this is an edit request (contains words like "edit", "change", "update", "modify", "replace")
    const isEditRequest = /(edit|change|update|modify|replace|fix|adjust|revise|rewrite)/i.test(messageContent);

    // Store current version in history before making changes
    if (!originalScriptContent) {
      setOriginalScriptContent(safeFormData.content);
    }
    setScriptEditHistory(prev => [...prev, { content: safeFormData.content, timestamp: Date.now() }]);

    const userMsg = { role: 'user', content: messageContent };
    setEditScriptMessages(prev => [...prev, userMsg]);
    setEditScriptInput('');
    setPastedCodeReferences([]);
    setIsEditScriptLoading(true);

    try {
      const messagesForApi = [...editScriptMessages, userMsg].map(msg => ({
        role: msg.role,
        content: msg.content
      }));

      const response = await fetch('/api/groq/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          scriptContent: safeFormData.content,
          messages: messagesForApi
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        if (errorText.startsWith('<!DOCTYPE')) {
          throw new Error('Server returned HTML instead of JSON. Please make sure you are logged in.');
        }
        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
      }

      const data = await response.json();

      if (data.success && data.message) {
        // Show only conclusion in chat (no code blocks)
        const aiMsg = {
          role: 'assistant',
          content: data.message, // This is the conclusion only from backend
          hasCode: data.code && data.hasCode,
          proposedCode: data.code || null
        };
        setEditScriptMessages(prev => [...prev, aiMsg]);
        
        // If code was provided and it's an edit request, show diff instead of directly applying
        if (data.code && data.hasCode && isEditRequest) {
          const newCode = data.code;
          const currentCode = safeFormData?.content || '';
          
          // Store as proposed changes (don't apply directly)
          setProposedScriptChanges(newCode);
        } else if (data.code && data.hasCode && monacoEditorRef.current) {
          // For non-edit requests, apply directly (like before)
          const newCode = data.code;
          const currentCode = safeFormData?.content || '';
          setProposedScriptChanges(newCode);
          applyTypingEffectToEditor(newCode, currentCode);
        }
      } else {
        throw new Error(data.error || 'Failed to get response');
      }
    } catch (error) {
      console.error('[Playground] Error sending edit script message:', error);
      setEditScriptMessages(prev => [...prev, {
        role: 'assistant',
        content: `Error: ${error.message || 'Failed to get response. Please try again.'}`
      }]);
    } finally {
      setIsEditScriptLoading(false);
    }
  };

  // Accept Changes - Apply proposed changes to script
  const handleAcceptChanges = () => {
    if (proposedScriptChanges) {
      const newFormData = { ...safeFormData, content: proposedScriptChanges };
      setFormData(newFormData);
      setScriptEditHistory(prev => [...prev, { content: proposedScriptChanges, timestamp: Date.now() }]);
      setProposedScriptChanges(null);
      // Update the last assistant message to remove the diff view
      setEditScriptMessages(prev => prev.map((msg, idx) => 
        idx === prev.length - 1 && msg.role === 'assistant' 
          ? { ...msg, hasCode: false, proposedCode: null }
          : msg
      ));
    }
  };

  // Reject Changes - Discard proposed changes
  const handleRejectChanges = () => {
    setProposedScriptChanges(null);
    // Update the last assistant message to remove the diff view
    setEditScriptMessages(prev => prev.map((msg, idx) => 
      idx === prev.length - 1 && msg.role === 'assistant' 
        ? { ...msg, hasCode: false, proposedCode: null }
        : msg
    ));
  };

  // Undo All Changes - Revert to previous version in history
  const handleUndoAllChanges = () => {
    if (scriptEditHistory.length > 1) {
      const previousVersion = scriptEditHistory[scriptEditHistory.length - 2];
      const newFormData = { ...safeFormData, content: previousVersion.content };
      setFormData(newFormData);
      setScriptEditHistory(prev => prev.slice(0, -1));
      setProposedScriptChanges(null);
      alert('Changes have been undone.');
    } else if (originalScriptContent) {
      const newFormData = { ...safeFormData, content: originalScriptContent };
      setFormData(newFormData);
      setScriptEditHistory([{ content: originalScriptContent, timestamp: Date.now() }]);
      setProposedScriptChanges(null);
      alert('Reverted to original script.');
    }
  };

  // Revert to Original - Go back to the very first version
  const handleRevertToOriginal = () => {
    if (originalScriptContent) {
      const newFormData = { ...safeFormData, content: originalScriptContent };
      setFormData(newFormData);
      setScriptEditHistory([{ content: originalScriptContent, timestamp: Date.now() }]);
      setProposedScriptChanges(null);
      setEditScriptMessages([]);
      alert('Reverted to original script. All changes discarded.');
    }
  };

  // Load Chart.js dynamically for Analytics
  useEffect(() => {
    if (activeTab === 'transcript-analytics' && typeof window.Chart === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js';
      script.async = true;
      script.onload = () => {
        console.log('[Analytics] Chart.js loaded successfully');
      };
      script.onerror = () => {
        console.error('[Analytics] Failed to load Chart.js');
        setAnalyticsError('Failed to load Chart.js library');
      };
      document.head.appendChild(script);
    }
  }, [activeTab]);

  // Render charts when analytics data changes and tab is active
  useEffect(() => {
    // Only render if tab is active, Chart.js is loaded, and data exists
    if (activeTab !== 'transcript-analytics' || !analyticsData || typeof window.Chart === 'undefined') {
      return;
    }

    // Validate data structure
    if (!analyticsData.turnDropoff || !analyticsData.secondDropoff) {
      console.error('[Analytics] Invalid data structure:', analyticsData);
      return;
    }

    // Check if arrays are empty
    if (analyticsData.turnDropoff.length === 0 || analyticsData.secondDropoff.length === 0) {
      console.warn('[Analytics] Empty dropoff arrays');
      return;
    }

    console.log('[Analytics] Rendering charts with data:', {
      turnDropoffLength: analyticsData.turnDropoff.length,
      secondDropoffLength: analyticsData.secondDropoff.length,
      totalAnalyzed: analyticsData.totalAnalyzed
    });

    // Small delay to ensure DOM is ready
    const renderCharts = () => {
    // Render Turn Dropoff Chart
    if (turnChartRef.current) {
      const ctx = turnChartRef.current.getContext('2d');
        if (!ctx) {
          console.error('[Analytics] Failed to get 2d context for turn chart');
          return;
        }
      
      // Destroy existing chart
      if (turnChartInstance.current) {
        turnChartInstance.current.destroy();
          turnChartInstance.current = null;
        }

        const turnData = analyticsData.turnDropoff.slice(0, 30);
        if (turnData.length === 0) {
          console.warn('[Analytics] No turn dropoff data to render');
          return;
        }

        try {
      turnChartInstance.current = new window.Chart(ctx, {
        type: 'line',
        data: {
              labels: turnData.map(d => `Turn ${d.turn}`),
          datasets: [{
            label: 'Dropoff Rate (%)',
                data: turnData.map(d => d.dropoffRate),
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                      const dataPoint = turnData[context.dataIndex];
                      if (!dataPoint) return '';
                  return [
                    `Dropoff Rate: ${dataPoint.dropoffRate}%`,
                    `Remaining Calls: ${dataPoint.remainingCalls}`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Dropoff Rate (%)',
                font: {
                  size: 14,
                  weight: '600'
                }
              },
              grid: {
                color: '#f3f4f6'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Turn Number',
                font: {
                  size: 14,
                  weight: '600'
                }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
          console.log('[Analytics] Turn chart rendered successfully');
        } catch (error) {
          console.error('[Analytics] Error rendering turn chart:', error);
        }
      } else {
        console.warn('[Analytics] turnChartRef.current is null');
    }

    // Render Second Dropoff Chart
    if (secondChartRef.current) {
      const ctx = secondChartRef.current.getContext('2d');
        if (!ctx) {
          console.error('[Analytics] Failed to get 2d context for second chart');
          return;
        }
      
      // Destroy existing chart
      if (secondChartInstance.current) {
        secondChartInstance.current.destroy();
          secondChartInstance.current = null;
        }

        const secondData = analyticsData.secondDropoff.slice(0, 30);
        if (secondData.length === 0) {
          console.warn('[Analytics] No second dropoff data to render');
          return;
        }

        try {
      secondChartInstance.current = new window.Chart(ctx, {
        type: 'line',
        data: {
              labels: secondData.map(d => `${d.seconds}s`),
          datasets: [{
            label: 'Dropoff Rate (%)',
                data: secondData.map(d => d.dropoffRate),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                      const dataPoint = secondData[context.dataIndex];
                      if (!dataPoint) return '';
                  return [
                    `Dropoff Rate: ${dataPoint.dropoffRate}%`,
                    `Remaining Calls: ${dataPoint.remainingCalls}`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Dropoff Rate (%)',
                font: {
                  size: 14,
                  weight: '600'
                }
              },
              grid: {
                color: '#f3f4f6'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Duration (seconds)',
                font: {
                  size: 14,
                  weight: '600'
                }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
          console.log('[Analytics] Second chart rendered successfully');
        } catch (error) {
          console.error('[Analytics] Error rendering second chart:', error);
        }
      } else {
        console.warn('[Analytics] secondChartRef.current is null');
      }
    };

    // Use setTimeout to ensure DOM is ready
    const timeoutId = setTimeout(renderCharts, 100);

    // Cleanup function
    return () => {
      clearTimeout(timeoutId);
      if (turnChartInstance.current) {
        turnChartInstance.current.destroy();
        turnChartInstance.current = null;
      }
      if (secondChartInstance.current) {
        secondChartInstance.current.destroy();
        secondChartInstance.current = null;
      }
    };
  }, [analyticsData, activeTab]);

  // Load analytics data
  const loadAnalyticsData = async () => {
    console.log('[Analytics] Loading data with:', { shop, currentAgentId, analyticsLimit });
    
    setAnalyticsLoading(true);
    setAnalyticsError(null);
    
    try {
      // Don't filter by scriptId - analyze all transcripts (optionally filtered by shop)
      const response = await api.getTranscriptAnalytics(analyticsLimit, null, shop);
      console.log('[Analytics] Response:', response);
      
      if (response.success) {
        setAnalyticsData(response.data);
        if (response.data.totalAnalyzed === 0) {
          const message = shop 
            ? `No completed calls with transcripts found for shop "${shop}". Try analyzing without a shop filter or check your database.`
            : 'No completed calls with transcripts found in the database. Make sure you have calls with transcripts.';
          setAnalyticsError(message);
        }
      } else {
        setAnalyticsError(response.error || 'Failed to load analytics');
      }
    } catch (error) {
      console.error('[Analytics] Error loading analytics:', error);
      setAnalyticsError(error.message || 'Failed to load analytics');
    } finally {
      setAnalyticsLoading(false);
    }
  };

  const handleScriptBox2ChatSuggestion = async (suggestionText) => {
    if (!safeFormData?.content || scriptBox2ChatLoading) return;

    setScriptBox2ChatInput(suggestionText);
    
    const newUserMessage = { role: 'user', content: suggestionText };
    setScriptBox2ChatMessages(prev => [...prev, newUserMessage]);
    setScriptBox2ChatLoading(true);

    try {
      const messagesForApi = [...scriptBox2ChatMessages, newUserMessage].map(msg => ({
        role: msg.role,
        content: msg.content
      }));

      const response = await fetch('/api/groq/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          scriptContent: safeFormData.content,
          messages: messagesForApi
        })
      });

      const data = await response.json();

      if (data.success && data.message) {
        setScriptBox2ChatMessages(prev => [...prev, { role: 'assistant', content: data.message }]);
      } else {
        throw new Error(data.error || 'Failed to get response');
      }
    } catch (error) {
      console.error('[Playground] Error sending script box 2 chat suggestion:', error);
      setScriptBox2ChatMessages(prev => [...prev, { 
        role: 'assistant', 
        content: `Error: ${error.message || 'Failed to get response. Please try again.'}` 
      }]);
    } finally {
      setScriptBox2ChatLoading(false);
      setScriptBox2ChatInput('');
    }
  };

  // Tab scroll handlers
  const checkTabsScroll = () => {
    const container = tabsContainerRef.current;
    if (!container) return;

    const { scrollLeft, scrollWidth, clientWidth } = container;
    const isAtStart = scrollLeft <= 5;
    const isAtEnd = scrollLeft + clientWidth >= scrollWidth - 5;

    setShowLeftBlur(!isAtStart);
    setShowRightBlur(!isAtEnd);
  };

  const scrollTabsLeft = () => {
    if (tabsContainerRef.current) {
      tabsContainerRef.current.scrollBy({ left: -200, behavior: 'smooth' });
    }
  };

  const scrollTabsRight = () => {
    if (tabsContainerRef.current) {
      tabsContainerRef.current.scrollBy({ left: 200, behavior: 'smooth' });
    }
  };

  useEffect(() => {
    const container = tabsContainerRef.current;
    if (!container) return;

    // Initial check
    checkTabsScroll();

    // Add scroll listener
    container.addEventListener('scroll', checkTabsScroll);

    // Add resize observer to recheck on container size changes
    const resizeObserver = new ResizeObserver(checkTabsScroll);
    resizeObserver.observe(container);

    return () => {
      container.removeEventListener('scroll', checkTabsScroll);
      resizeObserver.disconnect();
    };
  }, []);

  const handleStopGenerating = () => {
    if (abortControllerRef.current) {
      abortControllerRef.current.abort();
      abortControllerRef.current = null;
    }
    setIsStreaming(false);
    setIsGeneratingScript(false);
  };

  const handleGenerateScript = async () => {
    if (!aiPrompt || !aiPrompt.trim()) {
      alert('Please enter a prompt');
      return;
    }

    // For "Write with AI" mode, always use streaming
    if (aiModalMode === 'write') {
      setIsStreaming(true);
    setIsGeneratingScript(true);
      
      // Create new AbortController for this request
      abortControllerRef.current = new AbortController();
      const abortSignal = abortControllerRef.current.signal;
      
      // Close modal immediately when generation starts
      handleCloseAIModal();
      
      // Clear existing content and start streaming
      setFormData(prev => ({ ...prev, content: '' }));
      
      try {
        const { api } = await import('../utils/api');
        let fullContent = '';
        
   // Build enhanced prompt with settings context
        let enhancedPrompt = aiPrompt.trim();

        // Create a structured system prompt section
        const systemPromptSections = [];

        // Voice and Language instructions
        if (aiGenderSelection) {
          const genderText = aiGenderSelection === 'female' ? 'Female' : 'Male';
          systemPromptSections.push(`the agent is a ${genderText}`);
        }

        // Primary language instruction
        if (writeAISettings.primaryLanguage && writeAISettings.primaryLanguage !== '') {
          systemPromptSections.push(`speak primarily in ${writeAISettings.primaryLanguage}`);
        }

        // Secondary languages instruction
        if (writeAISettings.secondaryLanguages && writeAISettings.secondaryLanguages.length > 0) {
          const secondaryLangText = writeAISettings.secondaryLanguages.map(l => l.charAt(0).toUpperCase() + l.slice(1)).join(', ');
          systemPromptSections.push(`also can speak in ${secondaryLangText}`);
        }

        // End call when instruction
        if (aiEndCallWhen && aiEndCallWhen.trim() !== '') {
          systemPromptSections.push(`end call when: ${aiEndCallWhen.trim()}`);
        }
        
        // Append sections to the prompt if any were added
        if (systemPromptSections.length > 0) {
          const systemPromptText = systemPromptSections.join('\n');
          console.log('[Write with AI] System Prompt Sections:', systemPromptSections);
          console.log('[Write with AI] System Prompt Text:', systemPromptText);
          enhancedPrompt = `${systemPromptText}\n\n---\n\nUser Request: ${enhancedPrompt}`;
        }

        // Log final enhanced prompt
        console.log('[Write with AI] Final Enhanced Prompt:', enhancedPrompt);
        
        // Add custom instructions from Settings if available
        if (safeFormData?.writeAIInstructions?.trim()) {
          enhancedPrompt = `Custom Instructions:\n${safeFormData.writeAIInstructions.trim()}\n\n---\n\nUser Request: ${enhancedPrompt}`;
        }
        
        if (writeAISettings.languages.length > 0) {
          const languagesText = writeAISettings.languages.map(l => l.charAt(0).toUpperCase() + l.slice(1)).join(', ');
          enhancedPrompt = `Language(s): ${languagesText}\n\n${enhancedPrompt}`;
        }
        if (writeAISettings.knowledgeBookIds.length > 0) {
          const selectedKBs = knowledgeBooks.filter(kb => writeAISettings.knowledgeBookIds.includes(kb.id));
          if (selectedKBs.length > 0) {
            enhancedPrompt = `${enhancedPrompt}\n\nUse knowledge from: ${selectedKBs.map(kb => kb.name).join(', ')}`;
          }
        }
        if (writeAISettings.replyQualityBookIds.length > 0) {
          const selectedRQBs = knowledgeBooks.filter(kb => writeAISettings.replyQualityBookIds.includes(kb.id));
          if (selectedRQBs.length > 0) {
            enhancedPrompt = `${enhancedPrompt}\n\nUse reply quality guidelines from: ${selectedRQBs.map(kb => kb.name).join(', ')}`;
          }
        }
        
        // Debug: Log the generation mode before API call
        console.log('[Frontend] Starting generation with mode:', aiGenerationMode, '| Type:', typeof aiGenerationMode);
        
        for await (const chunk of api.generateScriptWithClaudeStream(
          enhancedPrompt,
          null,
          aiGenerationMode, // Pass the generation mode (simple/advanced)
          abortSignal, // Pass abort signal
          (chunk) => {
            fullContent += chunk;
            // Update form data in real-time so it appears in ScriptEditor
            setFormData(prev => ({ ...prev, content: fullContent }));
          }
        )) {
          // Chunks are handled in the callback
          // Check if aborted
          if (abortSignal.aborted) {
            break;
          }
        }
        
        // Only update if not aborted
        if (!abortSignal.aborted) {
        // Final update with trimmed content
        setFormData(prev => ({ ...prev, content: fullContent.trim() }));
        }
        setIsStreaming(false);
        setIsGeneratingScript(false);
        abortControllerRef.current = null;
      } catch (error) {
        // Don't show error if it was aborted
        if (error.name === 'AbortError' || abortSignal.aborted) {
          console.log('[Playground] Generation stopped by user');
        } else {
        console.error('[Playground] Error generating script with Claude:', error);
        alert(error.message || 'Failed to generate script. Please try again.');
        }
        setIsStreaming(false);
        setIsGeneratingScript(false);
        abortControllerRef.current = null;
      }
    } else {
      // For "Rewrite" mode, use non-streaming
      const currentScript = safeFormData?.content || '';
      setIsGeneratingScript(true);
      try {
      const response = await generateScriptWithClaude(aiPrompt.trim(), currentScript);
      
      if (response.success && response.content) {
        setFormData(prev => ({ ...prev, content: response.content }));
        handleCloseAIModal();
      } else {
        alert(response.error || 'Failed to generate script');
      }
    } catch (error) {
      console.error('[Playground] Error generating script with Claude:', error);
      alert(error.message || 'Failed to generate script. Please try again.');
    } finally {
      setIsGeneratingScript(false);
      }
    }
  };

  // Handler for updating a criteria item
  const handleUpdateCriteria = (type, index, value) => {
    setFormData((prev) => {
      const updated = [...(prev[type] || [])];
      updated[index] = value;
      return {
        ...prev,
        [type]: updated,
      };
    });
  };

  // AI Writer chat handlers
  const handleAiWriterSend = async () => {
    if (!aiWriterInput.trim() || isAiWriterGenerating) return;

    const userMessage = aiWriterInput.trim();
    setAiWriterInput('');
    
    // Add user message to chat
    const newUserMessage = { role: 'user', content: userMessage, timestamp: new Date() };
    setAiWriterChatHistory(prev => [...prev, newUserMessage]);
    
    setIsAiWriterGenerating(true);
    
    try {
      const { api } = await import('../utils/api');
      const currentScript = safeFormData?.content || '';
      
      // Build conversation context from previous messages
      const conversationContext = aiWriterChatHistory
        .map(msg => `${msg.role === 'user' ? 'User' : 'Assistant'}: ${msg.content}`)
        .join('\n\n');
      
      // Create enhanced prompt with context
      const enhancedPrompt = `You are an AI assistant helping to improve a voice agent script.

 Current Script:
${currentScript || '(No script content yet)'}

${conversationContext ? `Previous Conversation:\n${conversationContext}\n\n` : ''}

User Request: ${userMessage}

Instructions:
- If the user asks you to edit/change/update the script, provide the COMPLETE updated script
- If answering questions, be helpful and concise
- Always maintain the script's structure and formatting
- Use markdown formatting (headings, bold, lists, etc.)`;

      let fullResponse = '';
      const assistantMessage = { role: 'assistant', content: '', timestamp: new Date() };
      setAiWriterChatHistory(prev => [...prev, assistantMessage]);
      
      for await (const chunk of api.generateScriptWithClaudeStream(
        enhancedPrompt,
        currentScript, // Pass current script as context
        'simple', // Generation mode doesn't affect rewrite, but pass for consistency
        null, // No abort signal for rewrite (for now)
        (chunk) => {
          fullResponse += chunk;
          // Update the last message in chat history
          setAiWriterChatHistory(prev => {
            const updated = [...prev];
            updated[updated.length - 1] = { ...updated[updated.length - 1], content: fullResponse };
            return updated;
          });
        }
      )) {
        // Chunks are handled in the callback
      }
      
      // Check if response looks like a script update (contains markdown headers or is substantial)
      const looksLikeScript = (fullResponse.includes('#') || fullResponse.includes('**') || fullResponse.length > 300) && 
                              (fullResponse.toLowerCase().includes('script') || fullResponse.includes('{') || fullResponse.includes('['));
      if (looksLikeScript) {
        setPendingScriptChanges(fullResponse.trim());
      }
      
    } catch (error) {
      console.error('[AI Writer] Error:', error);
      setAiWriterChatHistory(prev => [...prev, {
        role: 'assistant',
        content: `Error: ${error.message || 'Failed to generate response. Please try again.'}`,
        timestamp: new Date()
      }]);
    } finally {
      setIsAiWriterGenerating(false);
    }
   };

  // Handler for switching between default and custom call type
  const handleCallTypeChange = async (useCustom) => {
    if (!useCustom) {
      // Switch to default - load Address Extraction script (or House directions)
      try {
        const scripts = await getCallScripts(shop);
        const scriptsArray = scripts?.scripts || scripts || [];
        // Try to find "Address Extraction" or "House directions" or "house dir"
        const defaultScript = scriptsArray.find(s => {
          const nameLower = s.name.toLowerCase();
          return (nameLower.includes('address') && nameLower.includes('extraction')) ||
                 (nameLower.includes('house') && nameLower.includes('direction')) ||
                 nameLower.includes('house dir');
        });
        
        if (defaultScript) {
          setFormData((prev) => ({
            ...prev,
            useCustomAnalysis: false,
            customAnalysisPrompt: '',
            successCriteria: defaultScript.successCriteria || [],
            otherCriteria: defaultScript.otherCriteria || [],
          }));
        } else {
          // Fallback to empty arrays if script not found
          setFormData((prev) => ({
            ...prev,
            useCustomAnalysis: false,
            customAnalysisPrompt: '',
            successCriteria: [],
            otherCriteria: [],
          }));
        }
      } catch (error) {
        console.error('[Playground] Error loading default script:', error);
        setFormData((prev) => ({
          ...prev,
          useCustomAnalysis: false,
          customAnalysisPrompt: '',
          successCriteria: [],
          otherCriteria: [],
        }));
      }
    } else {
      // Switch to custom - clear criteria if not already set
      setFormData((prev) => ({
        ...prev,
        useCustomAnalysis: true,
        successCriteria: prev.successCriteria.length > 0 ? prev.successCriteria : [''],
        otherCriteria: prev.otherCriteria.length > 0 ? prev.otherCriteria : [''],
      }));
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    setIsSavingAgent(true);
    try {
      console.log('[Playground] Saving agent. Selected knowledge book IDs:', selectedKnowledgeBookIds);
      
      // frontendDisplayScript is what the user sees and edits
      const frontendDisplayScript = (safeFormData?.content || formData?.content || '').trim();
      
      // Build the full content by concatenating frontendDisplayScript + knowledge books
      let fullContent = frontendDisplayScript;
      
      // Append regular knowledge books
      if (selectedKnowledgeBookIds.length > 0) {
        fullContent += '\n\n';
        
        // Append each selected knowledge book (excluding QNA books)
        for (const kbId of selectedKnowledgeBookIds) {
          const kb = knowledgeBooks.find(b => {
            if (b.id !== kbId) return false;
            // Check if it's a QNA book - if so, skip it (QNA books are handled separately)
            try {
              if (b.extraContent) {
                const parsed = JSON.parse(b.extraContent);
                if (parsed.qnaPairs && Array.isArray(parsed.qnaPairs) && parsed.qnaPairs.length > 0) {
                  return false; // Skip QNA books here
                }
              }
            } catch (e) {}
            return true;
          });
          if (kb) {
            console.log('[Playground] Appending knowledge book:', kbId, kb.name);
            fullContent += `${kb.content}\n\n`;
          }
        }
      }
      
      // Append QNA books (as JSON in a special format)
      if (selectedQnaBookIds.length > 0) {
        fullContent += '\n\n<!-- QNA_BOOKS_START -->\n';
        for (const kbId of selectedQnaBookIds) {
          const kb = knowledgeBooks.find(b => b.id === kbId);
          if (kb && kb.extraContent) {
            try {
              const parsed = JSON.parse(kb.extraContent);
              if (parsed.qnaPairs && Array.isArray(parsed.qnaPairs)) {
                console.log('[Playground] Appending QNA book:', kbId, kb.name);
                fullContent += `<!-- QNA_BOOK:${kbId} -->\n${JSON.stringify(parsed.qnaPairs)}\n\n`;
              }
            } catch (e) {
              console.error('[Playground] Error parsing QNA book:', e);
            }
          }
        }
        fullContent += '<!-- QNA_BOOKS_END -->\n';
      }
      
      console.log('[Playground] Frontend display script length:', frontendDisplayScript.length);
      console.log('[Playground] Full content length:', fullContent.length);
      console.log('[Playground] Knowledge books section length:', fullContent.length - frontendDisplayScript.length);

      // Filter out empty criteria strings before saving
      const successCriteria = ((safeFormData?.successCriteria || formData?.successCriteria) || []).filter(c => c && c.trim() !== '');
      const otherCriteria = ((safeFormData?.otherCriteria || formData?.otherCriteria) || []).filter(c => c && c.trim() !== '');
      
      // Only include retry fields if user entered values, otherwise set to null
      const maxRetries = (safeFormData?.maxRetries || formData?.maxRetries) && (safeFormData?.maxRetries || formData?.maxRetries).trim() !== '' 
        ? parseInt(safeFormData?.maxRetries || formData?.maxRetries) 
        : null;
      const retryIntervalMinutes = (safeFormData?.retryIntervalMinutes || formData?.retryIntervalMinutes) && (safeFormData?.retryIntervalMinutes || formData?.retryIntervalMinutes).trim() !== '' 
        ? parseInt(safeFormData?.retryIntervalMinutes || formData?.retryIntervalMinutes) 
        : null;

      const scriptData = {
        name: formData.name || '',
        description: formData.description || '',
        content: fullContent,
        frontendDisplayScript: frontendDisplayScript,
        voiceId: formData.voiceId || '',
        initialGreeting: formData.initialGreeting || '',
        prePhrase: formData.prePhrase ?? '',
        prePhraseArray: formData.prePhraseArray || [],
        useCustomAnalysis: formData.useCustomAnalysis || false,
        customAnalysisPrompt: formData.customAnalysisPrompt || '',
        disableUnder35Retries: formData.disableUnder35Retries || false,
        successCriteria: successCriteria,
        otherCriteria: otherCriteria,
        maxRetries: maxRetries,
        retryIntervalMinutes: retryIntervalMinutes,
        cancelOnRetry: safeFormData?.cancelOnRetry !== undefined ? safeFormData.cancelOnRetry : (formData?.cancelOnRetry !== undefined ? formData.cancelOnRetry : false),
        autoTaggingEnabled: safeFormData?.autoTaggingEnabled || formData?.autoTaggingEnabled || false,
        autoTaggingRules: safeFormData?.autoTaggingRules || formData?.autoTaggingRules || {
          successCriteria: {},
          otherCriteria: {},
          tagOnMaxRetries: false,
          maxRetriesTagName: ''
        },
        ttsProvider: safeFormData?.ttsProvider || formData?.ttsProvider || null,
        interruptions: safeFormData?.interruptions !== undefined ? safeFormData.interruptions : (formData?.interruptions !== undefined ? formData.interruptions : false),
        reasoning: safeFormData?.reasoning !== undefined ? safeFormData.reasoning : (formData?.reasoning !== undefined ? formData.reasoning : false),
        writeAIInstructions: safeFormData?.writeAIInstructions || formData?.writeAIInstructions || '',
        callFulfilledOrders: safeFormData?.callFulfilledOrders !== undefined ? safeFormData.callFulfilledOrders : (formData?.callFulfilledOrders !== undefined ? formData.callFulfilledOrders : true),
        callCancelledOrders: safeFormData?.callCancelledOrders !== undefined ? safeFormData.callCancelledOrders : (formData?.callCancelledOrders !== undefined ? formData.callCancelledOrders : true),
        cancellationCriteria: Array.isArray(safeFormData?.cancellationCriteria) ? safeFormData.cancellationCriteria : (Array.isArray(formData?.cancellationCriteria) ? formData.cancellationCriteria : []),
        retryCriteria: Array.isArray(safeFormData?.retryCriteria) ? safeFormData.retryCriteria : (Array.isArray(formData?.retryCriteria) ? formData.retryCriteria : []),
        memorySettings: memorySettings,
        maxCallDuration: safeFormData?.maxCallDuration !== undefined ? safeFormData.maxCallDuration : (formData?.maxCallDuration !== undefined ? formData.maxCallDuration : null),
        inactivityPeriod: inactivityPeriod !== undefined && inactivityPeriod !== null ? inactivityPeriod : null,
        inactivityText: safeFormData?.inactivityText || formData?.inactivityText || null,
        autoEndCallForSilence: autoEndCallForSilence !== undefined ? autoEndCallForSilence : false,
        silenceDuration: silenceDuration !== undefined && silenceDuration !== null ? silenceDuration : null,
        temperature: temperature !== undefined && temperature !== null ? temperature : null,
    variableBookId: selectedVariableBookId || null,
        flowData: flowData && typeof flowData === 'object' ? flowData : null,
      };

      console.log('[Playground] About to save. currentAgentId:', currentAgentId);
      console.log('[Playground] Script name:', scriptData.name);
      console.log('[Playground] FlowData being saved:', {
        hasFlowData: !!scriptData.flowData,
        flowDataType: typeof scriptData.flowData,
        nodeCount: scriptData.flowData?.nodes?.length || 0,
        edgeCount: scriptData.flowData?.edges?.length || 0,
        flowDataPreview: scriptData.flowData ? JSON.stringify(scriptData.flowData).substring(0, 200) : null
      });
      console.log('[Playground] Script data being sent:', {
        name: scriptData.name,
        nameLength: scriptData.name?.length,
        contentLength: scriptData.content?.length,
        frontendDisplayScriptLength: scriptData.frontendDisplayScript?.length,
        hasContent: !!scriptData.content,
        hasFrontendDisplayScript: !!scriptData.frontendDisplayScript,
        hasFlowData: !!scriptData.flowData
      });
      
      // Check if we're editing an existing agent (by name match if currentAgentId is missing)
      let agentIdToUse = currentAgentId;
      if (!agentIdToUse && scriptData.name) {
        const existingAgent = agents.find(a => a.name === scriptData.name);
        if (existingAgent) {
          console.log('[Playground] Found existing agent with same name, using update instead of create:', existingAgent.id);
          agentIdToUse = existingAgent.id;
          setCurrentAgentId(existingAgent.id);
        }
      }

      let response;
      if (agentIdToUse) {
        console.log('[Playground] Updating existing script with ID:', agentIdToUse);
        response = await updateScript(agentIdToUse, scriptData, shop);
      } else {
        console.log('[Playground] Creating new script (no currentAgentId)');
        response = await createScript(scriptData, shop);
      }

      if (response.success) {
        const finalAgentId = agentIdToUse || response.script?.id;
        
        // Update last saved content
        setLastSavedContent(JSON.stringify({
          content: scriptData.content,
          name: scriptData.name,
          description: scriptData.description,
          successCriteria: scriptData.successCriteria,
          otherCriteria: scriptData.otherCriteria
        }));
        setHasUnsavedChanges(false);
        
        // Reload agents from API to get the latest data
        await loadAgents();
        
        // Reload versions after save
        if (finalAgentId) {
          loadScriptVersions(finalAgentId);
        }
        
        // Fetch the updated agent directly to ensure we have the latest flowData
        let updatedAgent = response.script;
        if (finalAgentId) {
          try {
            const freshResponse = await getCallScripts(shop);
            const freshScripts = freshResponse?.scripts || freshResponse || [];
            const freshAgent = freshScripts.find(a => a && a.id === finalAgentId);
            if (freshAgent) {
              console.log('[Playground] Fetched fresh agent with flowData:', {
                hasFlowData: !!freshAgent.flowData,
                nodeCount: freshAgent.flowData?.nodes?.length || 0
              });
              updatedAgent = freshAgent;
            }
          } catch (error) {
            console.error('[Playground] Error fetching fresh agent:', error);
            // Fall back to response.script
          }
        }
        
        // After reloading, update the current form data with the saved script
        if (updatedAgent) {
          const displayScript = updatedAgent.frontendDisplayScript || updatedAgent.content || '';
          
          console.log('[Playground] Response script flowData:', {
            hasFlowData: !!updatedAgent.flowData,
            flowDataType: typeof updatedAgent.flowData,
            nodeCount: updatedAgent.flowData?.nodes?.length || 0,
            flowDataString: updatedAgent.flowData ? JSON.stringify(updatedAgent.flowData).substring(0, 300) : null
          });
          
          // Update flowData from response - prioritize response over what we sent
          if (updatedAgent.flowData && typeof updatedAgent.flowData === 'object') {
            // Parse if it's a string (shouldn't happen but just in case)
            const parsedFlowData = typeof updatedAgent.flowData === 'string' 
              ? JSON.parse(updatedAgent.flowData) 
              : updatedAgent.flowData;
            setFlowData(parsedFlowData);
            console.log('[Playground] FlowData updated from response, node count:', parsedFlowData?.nodes?.length);
          } else if (scriptData.flowData) {
            // If response doesn't have flowData but we sent it, keep what we have
            console.log('[Playground] Response missing flowData, keeping current flowData from scriptData');
            setFlowData(scriptData.flowData);
          } else {
            setFlowData(null);
            console.log('[Playground] No flowData in response or scriptData, set to null');
          }
          
          // Update form data with the saved content
          setFormData(prev => ({
            ...prev,
            name: updatedAgent.name || prev.name,
            description: updatedAgent.description || prev.description,
            content: displayScript,
            voiceId: updatedAgent.voiceId || prev.voiceId,
            initialGreeting: updatedAgent.initialGreeting || prev.initialGreeting,
            prePhrase: updatedAgent.prePhrase || prev.prePhrase,
            useCustomAnalysis: updatedAgent.useCustomAnalysis !== undefined ? updatedAgent.useCustomAnalysis : prev.useCustomAnalysis,
            customAnalysisPrompt: updatedAgent.customAnalysisPrompt || prev.customAnalysisPrompt,
            disableUnder35Retries: updatedAgent.disableUnder35Retries !== undefined ? updatedAgent.disableUnder35Retries : prev.disableUnder35Retries,
            successCriteria: Array.isArray(updatedAgent.successCriteria) ? updatedAgent.successCriteria : prev.successCriteria,
            otherCriteria: Array.isArray(updatedAgent.otherCriteria) ? updatedAgent.otherCriteria : prev.otherCriteria,
            maxRetries: updatedAgent.maxRetries !== null && updatedAgent.maxRetries !== undefined ? updatedAgent.maxRetries.toString() : prev.maxRetries,
            retryIntervalMinutes: updatedAgent.retryIntervalMinutes !== null && updatedAgent.retryIntervalMinutes !== undefined ? updatedAgent.retryIntervalMinutes.toString() : prev.retryIntervalMinutes,
            successMetric: updatedAgent.successMetric || prev.successMetric,
            autoTaggingEnabled: updatedAgent.autoTaggingEnabled !== undefined ? updatedAgent.autoTaggingEnabled : prev.autoTaggingEnabled,
            autoTaggingRules: updatedAgent.autoTaggingRules && typeof updatedAgent.autoTaggingRules === 'object' ? updatedAgent.autoTaggingRules : prev.autoTaggingRules,
            ttsProvider: updatedAgent.ttsProvider !== undefined ? updatedAgent.ttsProvider : prev.ttsProvider,
            interruptions: updatedAgent.interruptions !== undefined ? updatedAgent.interruptions : prev.interruptions,
            reasoning: updatedAgent.reasoning !== undefined ? updatedAgent.reasoning : prev.reasoning,
          }));
          
          // Ensure currentAgentId is set if it wasn't before
          if (!currentAgentId && updatedAgent.id) {
            setCurrentAgentId(updatedAgent.id);
            console.log('[Playground] Set currentAgentId after save:', updatedAgent.id);
          }

          if (pendingVariableBookId && updatedAgent.id) {
            const updatedAssignments = { ...variableAssignments, [updatedAgent.id]: pendingVariableBookId };
            persistVariableAssignments(updatedAssignments);
            setSelectedVariableBookId(pendingVariableBookId);
            setPendingVariableBookId(null);
          }
          
          // Reload knowledge books to ensure we have the latest data
          await loadKnowledgeBooks();
          
          console.log('[Playground] Updated agent after save. Selected KB IDs preserved:', selectedKnowledgeBookIds);
          console.log('[Playground] Updated form data with content length:', displayScript.length);
        }
      } else {
        // Show user-friendly error message
        const errorMsg = response.error || 'Failed to save agent';
        let userFriendlyMsg = errorMsg;
        
        if (errorMsg.includes('Name and content are required')) {
          userFriendlyMsg = 'Please provide both an agent name and script content';
        } else if (errorMsg.includes('Name') && errorMsg.includes('required')) {
          userFriendlyMsg = 'Please provide an agent name';
        } else if (errorMsg.includes('Content') && errorMsg.includes('required')) {
          userFriendlyMsg = 'Please provide script content';
        } else if (errorMsg.includes('already exists')) {
          userFriendlyMsg = 'An agent with this name already exists. Please choose a different name';
        } else if (errorMsg.includes('No shop available')) {
          userFriendlyMsg = 'Please connect a Shopify store first';
        }
        
        alert(userFriendlyMsg);
      }
    } catch (error) {
      console.error('[Playground] Error saving agent:', error);
      
      // Extract error message from error object
      let errorMessage = 'Error saving agent';
      if (error.message) {
        errorMessage = error.message;
        
        // Convert to user-friendly messages
        if (errorMessage.includes('Name and content are required')) {
          errorMessage = 'Please provide both an agent name and script content';
        } else if (errorMessage.includes('Name') && errorMessage.includes('required')) {
          errorMessage = 'Please provide an agent name';
        } else if (errorMessage.includes('Content') && errorMessage.includes('required')) {
          errorMessage = 'Please provide script content';
        } else if (errorMessage.includes('already exists')) {
          errorMessage = 'An agent with this name already exists. Please choose a different name';
        } else if (errorMessage.includes('No shop available')) {
          errorMessage = 'Please connect a Shopify store first';
        }
      }
      
      alert(errorMessage);
    } finally {
      setIsSavingAgent(false);
    }
  };

  const updateScriptDurationEstimate = () => {
    const wordCount = (safeFormData?.content || formData?.content || '').trim().split(/\s+/).filter((w) => w).length;
    const wordsPerSecond = 2.3;
    const seconds = Math.ceil(wordCount / wordsPerSecond);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;

    const estElement = document.getElementById('scriptDurationEst');
    if (estElement) {
      if (seconds === 0) {
        estElement.textContent = 'Est. Call Duration: -';
      } else if (minutes === 0) {
        estElement.textContent = `Est. Call Duration ${remainingSeconds}s`;
      } else {
        estElement.textContent = `Est. Call Duration ${minutes} min ${remainingSeconds}s`;
      }
    }
  };

  const handleOpenTestCallModal = () => {
    if (!currentAgentId) {
      alert('Please select an agent first');
      return;
    }
    setShowTestCallModal(true);
    setTestCallTab('create');
    loadTestOrders();
  };

  const handleCloseTestCallModal = () => {
    setShowTestCallModal(false);
  };

  const handleTestOrderSubmit = async (e) => {
    e.preventDefault();

    if (!shop) {
      alert('Shop is required. Please connect a shop first.');
      return;
    }

    try {
      const orderData = {
        ...testOrderForm,
        customerEmail: testOrderForm.customerEmail || null,
        customerAddress: testOrderForm.customerAddress || null,
        totalPrice: testOrderForm.totalPrice || null,
        orderNumber: testOrderForm.orderNumber || null,
      };

      const response = await createTestOrder(orderData, shop);

      if (response.success && response.order) {
        await queueTestOrder(response.order.orderId, currentAgentId, shop);
        alert('Test order created and queued successfully!');
        setTestOrderForm({
          customerName: '',
          customerPhone: '',
          customerEmail: '',
          customerAddress: '',
          totalPrice: '',
          currency: 'INR',
          orderNumber: '',
        });
        loadTestOrders();
      } else {
        alert(response.error || 'Failed to create test order');
      }
    } catch (error) {
      console.error('Error creating test order:', error);
      alert('Error creating test order');
    }
  };

  const loadTestOrders = async () => {
    if (!shop) return;

    try {
      const response = await getTestOrders(shop);
      setTestOrders(response.orders || []);
    } catch (error) {
      console.error('Error loading test orders:', error);
      setTestOrders([]);
    }
  };

  const handleQueueTestOrder = async (orderId) => {
    if (!currentAgentId) {
      alert('Please select an agent first');
      return;
    }

    try {
      await queueTestOrder(orderId, currentAgentId, shop);
      alert('Order queued successfully!');
      loadTestOrders();
    } catch (error) {
      console.error('Error queueing test order:', error);
      alert('Error queueing test order');
    }
  };

  const handleOpenVoiceModal = () => {
    setShowVoiceModal(true);
    fetchVoices();
  };

  const handleCloseVoiceModal = () => {
    setShowVoiceModal(false);
  };

  // Get Sarvam voices - these are hardcoded since API doesn't support fetching them
  const getSarvamVoices = () => {
    const sarvamVoiceNames = ['anushka', 'abhilash', 'manisha', 'vidya', 'arya', 'karun', 'hitesh'];
    return sarvamVoiceNames.map(name => ({
      id: `sarvam_${name}`,
      name: name.charAt(0).toUpperCase() + name.slice(1),
      description: `Sarvam ${name.charAt(0).toUpperCase() + name.slice(1)} voice for Indian languages`,
      language: 'Hindi',
      source: 'sarvam',
      provider: 'sarvam',
      isSarvamVoice: true
    }));
  };

  // Get Cartesia voices - use existing voices from "other voices" category
  const getCartesiaVoices = () => {
    // Get voices that are not user voices, not Scalysis voices, and not default Indian
    const cartesiaVoices = voices.filter(v => !v.isUserVoice && !v.isScalysisVoice && !v.isDefaultIndian);
    // Return first 10 voices or all if less than 10
    return cartesiaVoices.slice(0, 10);
  };

  // Get Scalysis V1 voices - create sample voices for display (Inworld)
  const getScalysisV1Voices = () => {
    const v1VoiceNames = ['Aarav', 'Priya', 'Rohan', 'Kavya'];
    return v1VoiceNames.map(name => ({
      id: `scalysis_v1_${name.toLowerCase()}`,
      name: name,
      description: `Scalysis V1 ${name} voice - optimized for high volume calls`,
      language: 'Hindi',
      source: 'scalysis',
      provider: 'scalysis',
      isScalysisV1Voice: true
    }));
  };

  // Get ElevenLabs voices - create sample voices for display
  const getElevenLabsVoices = () => {
    const elevenLabsVoiceNames = ['Adam', 'Rachel', 'Domi'];
    return elevenLabsVoiceNames.map(name => ({
      id: `elevenlabs_${name.toLowerCase()}`,
      name: name,
      description: `ElevenLabs ${name} voice - professional studio quality`,
      language: 'English',
      source: 'elevenlabs',
      provider: 'elevenlabs',
      isElevenLabsVoice: true
    }));
  };

  // Get Rime voices - create sample voices for display
  const getRimeVoices = () => {
    const rimeVoiceNames = ['Luna', 'Kai', 'Zara'];
    return rimeVoiceNames.map(name => ({
      id: `rime_${name.toLowerCase()}`,
      name: name,
      description: `Rime ${name} voice - ultra realistic with emotions`,
      language: 'English',
      source: 'rime',
      provider: 'rime',
      isRimeVoice: true
    }));
  };

  // Get Hume voices - create sample voices for display
  const getHumeVoices = () => {
    const humeVoiceNames = ['Nova', 'Echo', 'Sage'];
    return humeVoiceNames.map(name => ({
      id: `hume_${name.toLowerCase()}`,
      name: name,
      description: `Hume ${name} voice - perfect for narration and storytelling`,
      language: 'English',
      source: 'hume',
      provider: 'hume',
      isHumeVoice: true
    }));
  };

  const fetchVoices = async (query = '') => {
    try {
      // Don't set main loading state - fetch silently in background
      const response = await getVoices(query, shop);
      // Include Sarvam voices in the voices list
      const allVoices = [...(response.voices || []), ...getSarvamVoices()];
      setVoices(allVoices);
    } catch (error) {
      console.error('Error fetching voices:', error);
      // Even on error, include Sarvam voices
      setVoices(getSarvamVoices());
    }
  };

  // Load voices when Voice tab is active or when Voice section in settings is opened
  useEffect(() => {
    if ((activeTab === 'voice' || openSettingsSections.voice) && voices.length === 0 && shop) {
      fetchVoices();
    }
  }, [activeTab, openSettingsSections.voice, shop]);

  const handleVoiceClick = (voice) => {
    // Set the voice ID in the form (just select, no popup)
    setFormData((prev) => ({ ...prev, voiceId: voice.id }));
  };

  // Gradient generation for voices (same as Voices.jsx)
  const generateUniqueGradients = () => {
    const gradients = [];
    const used = new Set();
    
    const colors = {
      reds: ['#FF6B6B', '#FF8A80', '#EF5350', '#E57373', '#F44336'],
      pinks: ['#F093FB', '#EC407A', '#E91E63', '#F48FB1', '#F06292'],
      oranges: ['#FFA726', '#FFB74D', '#FF9800', '#FF8F00', '#F57C00'],
      yellows: ['#FFD93D', '#FFCA28', '#FFC107', '#FFB300', '#FFA000'],
      greens: ['#66BB6A', '#81C784', '#4CAF50', '#43A047', '#388E3C'],
      teals: ['#26A69A', '#4DB6AC', '#009688', '#00897B', '#00796B'],
      blues: ['#42A5F5', '#64B5F6', '#1E88E5', '#1976D2', '#1565C0'],
      purples: ['#AB47BC', '#BA68C8', '#9C27B0', '#8E24AA', '#7B1FA2'],
      cyans: ['#26C6DA', '#4DD0E1', '#00BCD4', '#00ACC1', '#0097A7'],
    };
    
    const allColors = [
      ...colors.reds, ...colors.pinks, ...colors.oranges, ...colors.yellows,
      ...colors.greens, ...colors.teals, ...colors.blues, ...colors.purples, ...colors.cyans
    ];
    
    for (let i = 0; i < allColors.length; i++) {
      for (let j = i + 1; j < allColors.length; j++) {
        const gradient = [allColors[i], allColors[j]];
        const key = `${gradient[0]}-${gradient[1]}`;
        if (!used.has(key)) {
          gradients.push(gradient);
          used.add(key);
        }
      }
    }
    
    return gradients;
  };

  const GRADIENT_COLORS = generateUniqueGradients();
  const voiceGradientMap = new Map();

  const hashString = (str) => {
    let hash = 5381;
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) + hash) + str.charCodeAt(i);
      hash = hash & hash;
    }
    return Math.abs(hash);
  };

  const getVoiceGradient = (voiceId, voiceName = '') => {
    const uniqueKey = `${voiceId}-${(voiceName || '').toLowerCase()}`;
    if (voiceGradientMap.has(uniqueKey)) {
      return voiceGradientMap.get(uniqueKey);
    }
    const hash = hashString(uniqueKey);
    const index = hash % GRADIENT_COLORS.length;
    const gradient = GRADIENT_COLORS[index];
    voiceGradientMap.set(uniqueKey, gradient);
    return gradient;
  };

  const getVoiceMetadata = (voice) => {
    const name = (voice.name || '').toLowerCase();
    const description = (voice.description || '').toLowerCase();
    
    let gender = 'neutral';
    if (name.includes('female') || name.includes('woman') || description.includes('female') || description.includes('woman')) {
      gender = 'female';
    } else if (name.includes('male') || name.includes('man') || description.includes('male') || description.includes('man')) {
      gender = 'male';
    }
    
    const tags = [];
    if (description.includes('conversational') || name.includes('conversational')) tags.push({ label: 'Conversational', color: '#3B82F6' });
    if (description.includes('emotive') || description.includes('emotional')) tags.push({ label: 'Emotive', color: '#F59E0B' });
    if (description.includes('professional') || description.includes('business')) tags.push({ label: 'Professional', color: '#8B5CF6' });
    if (description.includes('warm') || description.includes('friendly')) tags.push({ label: 'Warm', color: '#EC4899' });
    
    const language = voice.language || 'English';
    let accent = 'Standard';
    if (description.includes('american') || name.includes('american')) accent = 'American';
    else if (description.includes('british') || name.includes('british')) accent = 'British';
    else if (description.includes('indian') || name.includes('indian') || language.toLowerCase().includes('hindi')) accent = 'Indian';
    
    return { gender, tags, language, accent };
  };

  // Get all unique languages from voices in a source
  const getAvailableLanguages = (voiceList) => {
    const languageSet = new Set();
    voiceList.forEach(voice => {
      const metadata = getVoiceMetadata(voice);
      const lang = metadata.language || 'English';
      if (lang && lang.trim()) {
        languageSet.add(lang.trim());
      }
    });
    return Array.from(languageSet).sort();
  };

  // Organize voices by source and gender, removing duplicates
  const organizeVoicesBySource = () => {
    // Remove duplicates based on voice ID and apply search filter if any
    const uniqueVoices = [];
    const seenIds = new Set();
    voices.forEach(voice => {
      if (!seenIds.has(voice.id)) {
        seenIds.add(voice.id);
        // Apply search filter if voiceSearchQuery exists
        if (!voiceSearchQuery || 
            (voice.name && voice.name.toLowerCase().includes(voiceSearchQuery.toLowerCase())) ||
            (voice.id && voice.id.toLowerCase().includes(voiceSearchQuery.toLowerCase())) ||
            (voice.description && voice.description.toLowerCase().includes(voiceSearchQuery.toLowerCase()))) {
          uniqueVoices.push(voice);
        }
      }
    });

    // Categorize by source
    const clonedVoices = uniqueVoices.filter(v => v.isUserVoice && !v.isScalysisVoice && !v.isDefaultIndian);
    // Scalysis voices: ONLY Ultra Realistic voices (isUltraRealistic === true)
    const scalysisVoices = uniqueVoices.filter(v => v.isUltraRealistic === true);
    const otherVoices = uniqueVoices.filter(v => !v.isUserVoice && !v.isScalysisVoice && !v.isDefaultIndian);

    // Organize each source by gender
    const organizeByGender = (voiceList) => {
      const male = [];
      const female = [];
      const neutral = [];

      voiceList.forEach(voice => {
        const metadata = getVoiceMetadata(voice);
        if (metadata.gender === 'male') {
          male.push(voice);
        } else if (metadata.gender === 'female') {
          female.push(voice);
        } else {
          neutral.push(voice);
        }
      });

      return { male, female, neutral };
    };

    return {
      cloned: organizeByGender(clonedVoices),
      scalysis: organizeByGender(scalysisVoices),
      other: organizeByGender(otherVoices)
    };
  };

  const formatPremiumVoiceName = (voice) => {
    const name = (voice.name || '').trim();
    if (!name) return 'Untitled Voice';
    if (name.length <= 20 && /^[A-Z][a-z]+(\s[A-Z][a-z]+)*$/.test(name)) {
      return name;
    }
    const words = name.split(/\s+/);
    const keyWords = words.filter(w => 
      !['female', 'male', 'yr', 'old', 'year', 'for', 'high', 'aov', 'products', 'tier', 'city', 'premium', 'ultra', 'the', 'a', 'an'].includes(w.toLowerCase())
    );
    if (keyWords.length > 0) {
      const premiumName = keyWords.slice(0, 2)
        .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
        .join(' ');
      return premiumName.length <= 20 ? premiumName : premiumName.substring(0, 17) + '...';
    }
    return words[0] ? words[0].charAt(0).toUpperCase() + words[0].slice(1).toLowerCase() : name;
  };

  // Categorize voices into different categories
  const categorizeVoice = (voice, allVoices, index) => {
    const name = (voice.name || '').toLowerCase();
    const metadata = getVoiceMetadata(voice);
    const categories = [];
    
    // Gender categories
    if (metadata.gender === 'female') categories.push('Female');
    if (metadata.gender === 'male' || name.includes('amrit') || name.includes('avinash')) {
      // Exclude arushi from Male category
      if (!name.includes('arushi')) {
        categories.push('Male');
      }
    }
    // Cat category - add logic here if needed
    if (name.includes('cat')) categories.push('Cat');
    
    // Style categories based on description/tags
    const desc = (voice.description || '').toLowerCase();
    if (desc.includes('sales') || desc.includes('selling') || name.includes('sales')) categories.push('Sales');
    if (metadata.tags.some(t => t.label === 'Conversational') || desc.includes('conversational')) categories.push('Conversational');
    if (desc.includes('authoritative') || desc.includes('authority') || desc.includes('commanding')) categories.push('Authoritative');
    if (desc.includes('trust') || desc.includes('trustworthy') || desc.includes('reliable')) categories.push('Trust');
    if (desc.includes('support') || desc.includes('helpful') || desc.includes('customer service')) categories.push('Support');
    
    // Ensure at least one voice in each category (distribute voices across categories)
    const categoryOrder = ['Female', 'Male', 'Sales', 'Conversational', 'Authoritative', 'Trust', 'Support'];
    if (categories.length === 0 || (categories.length === 1 && categories[0] === 'All')) {
      // Assign to category based on index to ensure distribution
      const categoryIndex = index % (categoryOrder.length - 1); // -1 to exclude 'All'
      categories.push(categoryOrder[categoryIndex]);
    }
    
    // All voices go in "All"
    categories.push('All');
    
    return categories;
  };

  // Get language character for a given language name
  const getLanguageCharacter = (languageName) => {
    const langLower = (languageName || '').toLowerCase().trim();
    const languageMap = {
      'hindi': 'à¤…',
      'english': 'A',
      'telugu': 'à°…',
      'tamil': 'à®…',
      'kannada': 'à²…',
      'malayalam': 'à´…',
      'bengali': 'à¦…',
      'gujarati': 'àª…',
      'marathi': 'à¤…',
      'punjabi': 'à¨…',
      'hinglish': 'à¤…', // Hinglish uses Hindi character
      'oriya': 'à¬…',
      'assamese': 'à¦…',
      'nepali': 'à¤…',
      'urdu': 'Ø§',
      'sanskrit': 'à¤…'
    };
    
    // Direct match
    if (languageMap[langLower]) {
      return languageMap[langLower];
    }
    
    // Partial match - check if language name contains any key
    for (const [key, char] of Object.entries(languageMap)) {
      if (langLower.includes(key) || key.includes(langLower)) {
        return char;
      }
    }
    
    // For non-English languages, try to match common variations
    if (langLower.includes('hindi')) return 'à¤…';
    if (langLower.includes('telugu')) return 'à°…';
    if (langLower.includes('tamil')) return 'à®…';
    if (langLower.includes('kannada')) return 'à²…';
    if (langLower.includes('malayalam')) return 'à´…';
    if (langLower.includes('bengali')) return 'à¦…';
    if (langLower.includes('gujarati')) return 'àª…';
    if (langLower.includes('marathi')) return 'à¤…';
    if (langLower.includes('punjabi')) return 'à¨…';
    if (langLower.includes('oriya')) return 'à¬…';
    if (langLower.includes('assamese')) return 'à¦…';
    if (langLower.includes('nepali')) return 'à¤…';
    if (langLower.includes('urdu')) return 'Ø§';
    if (langLower.includes('sanskrit')) return 'à¤…';
    
    // Only default to English letter if it's actually English
    if (langLower.includes('english')) {
      return 'A';
    }
    
    // For unknown languages, return first letter (but this should rarely happen)
    return (langLower.charAt(0) || 'A').toUpperCase();
  };

  // Get language first letters for display
  const getLanguageFirstLetters = (voice) => {
    let languages = voice.languages || [];
    // Fallback to voice.language if languages array is empty
    if (languages.length === 0 && voice.language) {
      languages = [voice.language];
    }
    
    const letters = [];
    languages.forEach(lang => {
      letters.push(getLanguageCharacter(lang));
    });
    
    // Always add English if not present
    if (!languages.some(l => l.toLowerCase().includes('english'))) {
      letters.push('A');
    }
    
    return letters.slice(0, 2); // Return max 2 letters
  };

  // Get language display text (e.g., "Hindi + 1")
  const getLanguageDisplayText = (voice) => {
    let languages = voice.languages || [];
    // Fallback to voice.language if languages array is empty
    if (languages.length === 0 && voice.language) {
      languages = [voice.language];
    }
    if (languages.length === 0) return 'English';
    if (languages.length === 1) return languages[0];
    const primary = languages[0];
    const more = languages.length - 1;
    return `${primary} + ${more}`;
  };

  // Get primary language and other languages count
  const getPrimaryAndOtherLanguages = (voice) => {
    let languages = voice.languages || [];
    if (languages.length === 0 && voice.language) {
      languages = [voice.language];
    }
    if (languages.length === 0) return { primary: 'English', others: 0 };
    const primary = languages[0];
    const others = languages.length - 1;
    return { primary, others };
  };

  // Get description tags for voice (e.g., "conversational & authoritative")
  const getVoiceDescriptionTags = (voice) => {
    const metadata = getVoiceMetadata(voice);
    const desc = (voice.description || '').toLowerCase();
    const tags = [];
    
    if (metadata.tags.some(t => t.label === 'Conversational') || desc.includes('conversational')) tags.push('Conversational');
    if (desc.includes('authoritative') || desc.includes('authority')) tags.push('Authoritative');
    if (desc.includes('trust') || desc.includes('trustworthy')) tags.push('Trust');
    if (desc.includes('support') || desc.includes('helpful')) tags.push('Support');
    if (desc.includes('sales') || desc.includes('selling')) tags.push('Sales');
    
    return tags.slice(0, 2).join(' & ') || 'Professional';
  };

  // Get random 1-2 word description for voice
  const getVoiceShortDescription = (voice) => {
    const descriptions = [
      'Professional', 'Sweet', 'Friendly', 'Warm', 'Clear', 'Confident',
      'Calm', 'Energetic', 'Gentle', 'Strong', 'Smooth', 'Crisp',
      'Professional & Sweet', 'Warm & Friendly', 'Clear & Confident',
      'Calm & Professional', 'Energetic & Clear', 'Gentle & Warm'
    ];
    
    // Use voice ID to consistently assign description
    const hash = voice.id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
    return descriptions[hash % descriptions.length];
  };

  // Get voice image path from /images/voice folder based on voice ID
  const getVoiceImagePath = (voice) => {
    // Available voice images (12 total)
    const voiceImages = [
      'blue.svg',
      'green.svg',
      'green2.svg',
      'green3.svg',
      'orange.svg',
      'pink.svg',
      'pink2.svg',
      'purple.svg',
      'purple2.svg',
      'red.svg',
      'silver.svg',
      'yellow.svg'
    ];
    
    // Use voice ID to consistently assign image
    const hash = voice.id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
    const imageName = voiceImages[hash % voiceImages.length];
    return `/images/voice/${imageName}`;
  };

  // Map language abbreviations to full names
  const getLanguageFullName = (lang) => {
    if (!lang) return 'English';
    const langLower = lang.toLowerCase().trim();
    
    const languageNameMap = {
      'en': 'English',
      'english': 'English',
      'hi': 'Hindi',
      'hindi': 'Hindi',
      'te': 'Telugu',
      'telugu': 'Telugu',
      'ta': 'Tamil',
      'tamil': 'Tamil',
      'kn': 'Kannada',
      'kannada': 'Kannada',
      'ml': 'Malayalam',
      'malayalam': 'Malayalam',
      'bn': 'Bengali',
      'bengali': 'Bengali',
      'gu': 'Gujarati',
      'gujarati': 'Gujarati',
      'mr': 'Marathi',
      'marathi': 'Marathi',
      'pa': 'Punjabi',
      'punjabi': 'Punjabi',
      'or': 'Oriya',
      'oriya': 'Oriya',
      'as': 'Assamese',
      'assamese': 'Assamese',
      'ne': 'Nepali',
      'nepali': 'Nepali',
      'ur': 'Urdu',
      'urdu': 'Urdu',
      'sa': 'Sanskrit',
      'sanskrit': 'Sanskrit',
      'hinglish': 'Hinglish',
      'es': 'Spanish',
      'spanish': 'Spanish',
      'fr': 'French',
      'french': 'French',
      'ja': 'Japanese',
      'japanese': 'Japanese',
      'ko': 'Korean',
      'korean': 'Korean',
      'pt': 'Portuguese',
      'portuguese': 'Portuguese',
      'de': 'German',
      'german': 'German',
      'it': 'Italian',
      'italian': 'Italian',
      'zh': 'Chinese',
      'chinese': 'Chinese',
      'ar': 'Arabic',
      'arabic': 'Arabic',
      'ru': 'Russian',
      'russian': 'Russian'
    };
    
    // Direct match
    if (languageNameMap[langLower]) {
      return languageNameMap[langLower];
    }
    
    // Partial match
    for (const [key, fullName] of Object.entries(languageNameMap)) {
      if (langLower.includes(key) || key.includes(langLower)) {
        return fullName;
      }
    }
    
    // Default: capitalize first letter
    return lang.charAt(0).toUpperCase() + lang.slice(1).toLowerCase();
  };

  // Get language display text with full names (e.g., "Hindi + 1", "English", "Telugu + 1")
  const getLanguageDisplayTextFull = (voice) => {
    let languages = voice.languages || [];
    // Fallback to voice.language if languages array is empty
    if (languages.length === 0 && voice.language) {
      languages = [voice.language];
    }
    if (languages.length === 0) return 'English';
    
    // Map to full names
    const fullNames = languages.map(lang => getLanguageFullName(lang));
    
    // Check if only English
    const isOnlyEnglish = fullNames.length === 1 && 
      (fullNames[0].toLowerCase() === 'english' || 
       languages[0].toLowerCase().includes('english'));
    
    if (isOnlyEnglish) {
      return 'English';
    }
    
    // For any other language, English is always included as second language
    // So if 1 language (non-English) â†’ show "Language + 1" (the +1 is English)
    // If 2+ languages â†’ show "Primary + (count-1)" (English is already in count)
    const primary = fullNames[0];
    const totalCount = fullNames.length;
    
    // If only 1 non-English language, English will be added â†’ total 2 â†’ show "+ 1"
    // If already has 2+ languages, show the actual count minus 1 (since English is included)
    if (totalCount === 1) {
      return `${primary} + 1`;
    } else {
      return `${primary} + ${totalCount - 1}`;
    }
  };

  // Get language icons with colors for display
  // Logic: If only English â†’ 1 icon, else add English as second language â†’ 2 icons
  const getLanguageIconsWithColors = (voice) => {
    let languages = voice.languages || [];
    if (languages.length === 0 && voice.language) {
      languages = [voice.language];
    }
    
    // Check if only English
    const isOnlyEnglish = languages.length === 1 && 
      (languages[0].toLowerCase().includes('english') || 
       languages[0].toLowerCase() === 'en');
    
    if (isOnlyEnglish) {
      // Only English â†’ 1 icon
      const lang = languages[0];
      const char = getLanguageCharacter(lang);
      const iconColors = ['#97C9FF', '#D0FF97', '#FFB397', '#FF97D0', '#D097FF'];
      const hash = (voice.id + lang).split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);
      const color = iconColors[hash % iconColors.length];
      return [{ char, color, lang }];
    }
    
    // For any other language, add English as second language
    // Take first language (non-English) and add English
    const primaryLang = languages[0];
    const languagesToShow = [primaryLang, 'English'];
    
    const icons = languagesToShow.map((lang, idx) => {
      const char = getLanguageCharacter(lang);
      // Use different shades for icons
      const iconColors = ['#97C9FF', '#D0FF97', '#FFB397', '#FF97D0', '#D097FF'];
      const hash = (voice.id + lang).split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);
      const color = iconColors[hash % iconColors.length];
      
      return { char, color, lang };
    });
    
    return icons;
  };

  // Map voice names to MP3 files for both English and Hinglish previews
  const getVoiceMp3Path = (voiceName, voiceId, language = 'english') => {
    if (!voiceName) return null;
    
    const normalizedName = voiceName.toLowerCase()
      .replace(/\s+/g, '')
      .replace(/[^a-z0-9]/g, '');
    
    const isHinglish = language === 'hinglish';
    
    // Map voice names to MP3 files (English and Hinglish)
    const voiceMp3Map = {
      'amrita': isHinglish ? '/mp3 audios/amrtiahinglish.wav' : '/mp3 audios/amritaenglish.wav',
      'amrit': isHinglish ? '/mp3 audios/amrtiahinglish.wav' : '/mp3 audios/amritaenglish.wav',
      'arushimature': isHinglish ? '/mp3 audios/arushimature.wav' : '/mp3 audios/arushimatureenglish.wav',
      'arushi': isHinglish ? '/mp3 audios/arushimature.wav' : '/mp3 audios/arushimatureenglish.wav',
      'arushimatureenglish': '/mp3 audios/arushimatureenglish.wav',
      'fatima': isHinglish ? '/mp3 audios/fatimahinglish.wav' : '/mp3 audios/fatimaenglish.wav',
      'fatimaenglish': '/mp3 audios/fatimaenglish.wav',
      'maya': isHinglish ? '/mp3 audios/mayahinglish.wav' : '/mp3 audios/mayaenglish.wav',
      'mayaenglish': '/mp3 audios/mayaenglish.wav',
      'ritika': isHinglish ? '/mp3 audios/ritikahinglish.wav' : '/mp3 audios/ritikaenglish.wav',
      'ritikaenglish': '/mp3 audios/ritikaenglish.wav',
      'shreya': isHinglish ? '/mp3 audios/shreyaclearhinglish.wav' : '/mp3 audios/shreyaclear.wav',
      'shreyaclear': isHinglish ? '/mp3 audios/shreyaclearhinglish.wav' : '/mp3 audios/shreyaclear.wav',
      'shreyaupgraded': isHinglish ? '/mp3 audios/shreyaclearhinglish.wav' : '/mp3 audios/shreyaclear.wav',
      'shreyaupgraded20': isHinglish ? '/mp3 audios/shreyaclearhinglish.wav' : '/mp3 audios/shreyaclear.wav',
      'shreyaclearenglish': '/mp3 audios/shreyaclear.wav',
      'amrtiahinglish': '/mp3 audios/amrtiahinglish.wav',
      'fatimahinglish': '/mp3 audios/fatimahinglish.wav',
      'mayahinglish': '/mp3 audios/mayahinglish.wav',
      'ritikahinglish': '/mp3 audios/ritikahinglish.wav',
      'shreyaclearhinglish': '/mp3 audios/shreyaclearhinglish.wav',
      // Sarvam voice mappings (use WAV files provided by user)
      'sarvam_anushka': '/mp3 audios/anushka.wav',
      'sarvam_abhilash': '/mp3 audios/abhilash.wav',
      'sarvam_manisha': '/mp3 audios/manisha.wav',
      'sarvam_vidya': '/mp3 audios/vidya.wav',
      'sarvam_arya': '/mp3 audios/arya.wav',
      'sarvam_karun': '/mp3 audios/karun.wav',
      'sarvam_hitesh': '/mp3 audios/hitesh.wav',
      'anushka': '/mp3 audios/anushka.wav',
      'abhilash': '/mp3 audios/abhilash.wav',
      'manisha': '/mp3 audios/manisha.wav',
      'vidya': '/mp3 audios/vidya.wav',
      'arya': '/mp3 audios/arya.wav',
      'karun': '/mp3 audios/karun.wav',
      'hitesh': '/mp3 audios/hitesh.wav',
      // Scalysis V1 voice mappings (use Sarvam voices)
      'scalysis_v1_aarav': '/mp3 audios/abhilash.wav',
      'scalysis_v1_priya': '/mp3 audios/vidya.wav',
      'scalysis_v1_rohan': '/mp3 audios/karun.wav',
      'scalysis_v1_kavya': '/mp3 audios/arya.wav',
      'aarav': '/mp3 audios/abhilash.wav',
      'priya': '/mp3 audios/vidya.wav',
      'rohan': '/mp3 audios/karun.wav',
      'kavya': '/mp3 audios/arya.wav',
      // Additional premium voices
      'simran': '/mp3 audios/simran.mp3',
      'rachel': '/mp3 audios/rachel.mp3',
      'monika': '/mp3 audios/monika.mp3',
      'aarush': '/mp3 audios/aarush.mp3'
    };
    
    // Check direct match
    if (voiceMp3Map[normalizedName]) {
      return voiceMp3Map[normalizedName];
    }
    
    // Check partial matches
    for (const [key, path] of Object.entries(voiceMp3Map)) {
      if (normalizedName.includes(key) || key.includes(normalizedName)) {
        return path;
      }
    }
    
    return null;
  };

  // Inline voice preview for voice tab (with icon button)
  const handleInlineVoicePreview = async (voiceId, e) => {
    e.stopPropagation(); // Prevent voice selection
    e.preventDefault(); // Prevent any form submission
    
    // If the same voice is playing, pause it
    if (playingVoiceId === voiceId && playingAudioRef.current && !playingAudioRef.current.paused) {
      playingAudioRef.current.pause();
      setPlayingVoiceId(null);
      playingAudioRef.current = null;
      return;
    }

    // If a different voice is playing, stop it first
    if (playingAudioRef.current && !playingAudioRef.current.paused) {
      playingAudioRef.current.pause();
      playingAudioRef.current.currentTime = 0;
      if (playingAudioRef.current.src && playingAudioRef.current.src.startsWith('blob:')) {
        URL.revokeObjectURL(playingAudioRef.current.src);
      }
    }

    setPlayingVoiceId(voiceId);
    try {
      // Get the selected language for this voice (default to 'english')
      const selectedLanguage = voiceLanguages[voiceId] || 'english';
      
      // Use MP3 for both English and Hinglish if available
      // Find the voice object to get its name (include Sarvam voices)
      const allVoicesWithSarvam = [...voices, ...getSarvamVoices()];
      const voice = allVoicesWithSarvam.find(v => v.id === voiceId);
      const voiceName = voice?.name || voiceId;
      const mp3Path = getVoiceMp3Path(voiceName, voiceId, selectedLanguage);
      
      if (mp3Path) {
        // Play MP3 file directly
        console.log(`ðŸŽµ [MP3 PLAYBACK] Playing pre-recorded MP3 for voice: ${voiceName} (${selectedLanguage})`, mp3Path);
        const audio = new Audio(mp3Path);
        playingAudioRef.current = audio;

        audio.onended = () => {
          console.log(`âœ… [MP3 PLAYBACK] Finished playing MP3 for: ${voiceName}`);
          setPlayingVoiceId(null);
          playingAudioRef.current = null;
        };

        audio.onerror = (e) => {
          console.error('âŒ [MP3 PLAYBACK] Error playing MP3, falling back to API generation:', e);
          setPlayingVoiceId(null);
          playingAudioRef.current = null;
          // Fallback to API generation
          handleInlineVoicePreviewWithAPI(voiceId);
          return;
        };

        await audio.play();
        return;
      }
      
      // Fallback to API generation if no MP3 found
      console.log(`ðŸ”„ [API GENERATION] No MP3 found for voice: ${voiceName} (${selectedLanguage}), using live generation`);
      handleInlineVoicePreviewWithAPI(voiceId);
    } catch (error) {
      console.error('Preview error:', error);
      setPlayingVoiceId(null);
      playingAudioRef.current = null;
      alert('Failed to generate preview: ' + (error.message || 'Unknown error'));
    }
  };

  const handleInlineVoicePreviewWithAPI = async (voiceId) => {
    try {
      // Get the selected language for this voice (default to 'english')
      const selectedLanguage = voiceLanguages[voiceId] || 'english';
      const previewText = selectedLanguage === 'hinglish' 
        ? 'Aapne Perfora toothpaste uhh order kiya tha, Bas address correct karna hai. uhh Aapka address Pretty Day Apartments ke paas  hai na? Aur uhh isme Landmark kya daalu?'
        : 'Did you order uhh perfora toothpaste right? [laughter] uhh I just wanted to confirm these, and your address is near pretty day apartments. umm what is the landmark for the same? ';
      
      const allVoicesWithSarvam = [...voices, ...getSarvamVoices(), ...getScalysisV1Voices()];
      const voice = allVoicesWithSarvam.find(v => v.id === voiceId);
      const voiceName = voice?.name || voiceId;
      const isSarvamVoice = voice?.isSarvamVoice || voiceId.startsWith('sarvam_');
      const isScalysisV1Voice = voice?.isScalysisV1Voice || voiceId.startsWith('scalysis_v1_');
      
      // For Scalysis V1 voices, map to Cartesia voice ID
      let previewVoiceId = voiceId;
      if (isScalysisV1Voice) {
        // Scalysis V1 voices are Cartesia voices with different names
        // Try to find a matching Cartesia voice by name, or use first available Cartesia voice
        const cartesiaVoice = voices.find(v => 
          !v.isUserVoice && 
          !v.isScalysisVoice && 
          !v.isDefaultIndian &&
          (v.name?.toLowerCase().includes(voiceName.toLowerCase()) || 
           v.originalName?.toLowerCase().includes(voiceName.toLowerCase()))
        );
        if (cartesiaVoice && cartesiaVoice.id) {
          previewVoiceId = cartesiaVoice.id;
          console.log(`ðŸ”„ [Scalysis V1] Mapped "${voiceName}" to Cartesia voice ID: ${previewVoiceId}`);
        } else {
          // Fallback: use first available Cartesia voice
          const fallbackVoice = voices.find(v => !v.isUserVoice && !v.isScalysisVoice && !v.isDefaultIndian);
          if (fallbackVoice && fallbackVoice.id) {
            previewVoiceId = fallbackVoice.id;
            console.log(`âš ï¸ [Scalysis V1] No match found for "${voiceName}", using fallback: ${previewVoiceId}`);
          } else {
            console.error(`âŒ [Scalysis V1] No Cartesia voices available for preview`);
          }
        }
      }
      
      console.log(`âš¡ [API GENERATION] Generating audio live for voice: ${voiceName} (${selectedLanguage})${isSarvamVoice ? ' [Sarvam]' : isScalysisV1Voice ? ' [Scalysis V1 â†’ Cartesia]' : ''}`);
      
      // Use Sarvam API for Sarvam voices, Cartesia for others (including Scalysis V1)
      const audioBlob = isSarvamVoice
        ? await previewSarvamVoice(voiceName.toLowerCase(), previewText, shop)
        : await previewVoice(previewVoiceId, previewText, shop);
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioUrl);
      playingAudioRef.current = audio;

      audio.onended = () => {
        URL.revokeObjectURL(audioUrl);
        setPlayingVoiceId(null);
        playingAudioRef.current = null;
      };

      audio.onerror = (e) => {
        console.error('Audio playback error:', e);
        URL.revokeObjectURL(audioUrl);
        setPlayingVoiceId(null);
        playingAudioRef.current = null;
        alert('Failed to play preview');
      };

      await audio.play();
    } catch (error) {
      console.error('Preview error:', error);
      setPlayingVoiceId(null);
      playingAudioRef.current = null;
      alert('Failed to generate preview: ' + (error.message || 'Unknown error'));
    }
  };

  const handleCloseVoicePreview = () => {
    setSelectedVoiceForPreview(null);
    setVoicePreviewText('');
    setIsPlayingVoice(false);
  };

  const handleSpeakVoice = async () => {
    if (!selectedVoiceForPreview || !voicePreviewText.trim()) {
      alert('Please enter some text to preview');
      return;
    }

    setIsPlayingVoice(true);
    try {
      const allVoicesWithSarvam = [...voices, ...getSarvamVoices()];
      const voice = allVoicesWithSarvam.find(v => v.id === selectedVoiceForPreview.id);
      const isSarvamVoice = voice?.isSarvamVoice || selectedVoiceForPreview.id?.startsWith('sarvam_');
      
      // Use Sarvam API for Sarvam voices, Cartesia for others
      const voiceIdToUse = isSarvamVoice ? (voice?.name || selectedVoiceForPreview.name).toLowerCase() : selectedVoiceForPreview.id;
      const audioBlob = isSarvamVoice
        ? await previewSarvamVoice(voiceIdToUse, voicePreviewText.trim(), shop)
        : await previewVoice(selectedVoiceForPreview.id, voicePreviewText.trim(), shop);
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioUrl);

      audio.onended = () => {
        URL.revokeObjectURL(audioUrl);
        setIsPlayingVoice(false);
      };

      audio.onerror = (e) => {
        console.error('Audio playback error:', e);
        URL.revokeObjectURL(audioUrl);
        setIsPlayingVoice(false);
        alert('Failed to play preview');
      };

      await audio.play();
    } catch (error) {
      console.error('Preview error:', error);
      setIsPlayingVoice(false);
      alert('Failed to generate preview: ' + (error.message || 'Unknown error'));
    }
  };

  const handleVoiceSearch = () => {
    fetchVoices(voiceSearchQuery);
  };

  const handleSelectVoice = (voiceId) => {
    setFormData((prev) => ({ ...prev, voiceId }));
    handleCloseVoiceModal();
  };

  const handlePreviewVoice = async (voiceId, btnElement) => {
    const originalText = btnElement.textContent;
    btnElement.textContent = 'Playing...';
    btnElement.disabled = true;

    try {
      // Try to use MP3 file for both English and Hinglish voices
      const allVoicesWithSarvam = [...voices, ...getSarvamVoices()];
      const voice = allVoicesWithSarvam.find(v => v.id === voiceId);
      const voiceName = voice?.name || voiceId;
      // Default to English for this preview function (no language selector)
      const mp3Path = getVoiceMp3Path(voiceName, voiceId, 'english');
      
      if (mp3Path) {
        // Play MP3 file directly
        console.log(`ðŸŽµ [MP3 PLAYBACK] Playing pre-recorded MP3 for voice: ${voiceName} (english)`, mp3Path);
        const audio = new Audio(mp3Path);

        audio.onended = () => {
          console.log(`âœ… [MP3 PLAYBACK] Finished playing MP3 for: ${voiceName}`);
          btnElement.textContent = originalText;
          btnElement.disabled = false;
        };

        audio.onerror = (e) => {
          console.error('âŒ [MP3 PLAYBACK] Error playing MP3, falling back to API generation:', e);
          // Fallback to API generation
          handlePreviewVoiceWithAPI(voiceId, btnElement, originalText);
          return;
        };

        await audio.play();
        return;
      }
      
      // Fallback to API generation if no MP3 found
      console.log(`ðŸ”„ [API GENERATION] No MP3 found for voice: ${voiceName} (english), using live generation`);
      handlePreviewVoiceWithAPI(voiceId, btnElement, originalText);
    } catch (error) {
      console.error('Preview error:', error);
      btnElement.textContent = originalText;
      btnElement.disabled = false;
      alert('Failed to generate preview: ' + (error.message || 'Unknown error'));
    }
  };

  const handlePreviewVoiceWithAPI = async (voiceId, btnElement, originalText) => {
    try {
      const allVoicesWithSarvam = [...voices, ...getSarvamVoices(), ...getScalysisV1Voices()];
      const voice = allVoicesWithSarvam.find(v => v.id === voiceId);
      const voiceName = voice?.name || voiceId;
      const isSarvamVoice = voice?.isSarvamVoice || voiceId.startsWith('sarvam_');
      const isScalysisV1Voice = voice?.isScalysisV1Voice || voiceId.startsWith('scalysis_v1_');
      
      // For Scalysis V1 voices, map to Cartesia voice ID
      let previewVoiceId = voiceId;
      if (isScalysisV1Voice) {
        // Scalysis V1 voices are Cartesia voices with different names
        // Try to find a matching Cartesia voice by name, or use first available Cartesia voice
        const cartesiaVoice = voices.find(v => 
          !v.isUserVoice && 
          !v.isScalysisVoice && 
          !v.isDefaultIndian &&
          (v.name?.toLowerCase().includes(voiceName.toLowerCase()) || 
           v.originalName?.toLowerCase().includes(voiceName.toLowerCase()))
        );
        if (cartesiaVoice && cartesiaVoice.id) {
          previewVoiceId = cartesiaVoice.id;
          console.log(`ðŸ”„ [Scalysis V1] Mapped "${voiceName}" to Cartesia voice ID: ${previewVoiceId}`);
        } else {
          // Fallback: use first available Cartesia voice
          const fallbackVoice = voices.find(v => !v.isUserVoice && !v.isScalysisVoice && !v.isDefaultIndian);
          if (fallbackVoice && fallbackVoice.id) {
            previewVoiceId = fallbackVoice.id;
            console.log(`âš ï¸ [Scalysis V1] No match found for "${voiceName}", using fallback: ${previewVoiceId}`);
          } else {
            console.error(`âŒ [Scalysis V1] No Cartesia voices available for preview`);
          }
        }
      }
      
      console.log(`âš¡ [API GENERATION] Generating audio live for voice: ${voiceName}${isSarvamVoice ? ' [Sarvam]' : isScalysisV1Voice ? ' [Scalysis V1 â†’ Cartesia]' : ''}`);
      
      // Use Sarvam API for Sarvam voices, Cartesia for others (including Scalysis V1)
      const audioBlob = isSarvamVoice
        ? await previewSarvamVoice(voiceName.toLowerCase(), 'This is a preview of this voice. How does it sound?', shop)
        : await previewVoice(previewVoiceId, 'This is a preview of this voice. How does it sound?', shop);
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioUrl);

      audio.onended = () => {
        URL.revokeObjectURL(audioUrl);
        btnElement.textContent = originalText;
        btnElement.disabled = false;
      };

      audio.onerror = (e) => {
        console.error('Audio playback error:', e);
        URL.revokeObjectURL(audioUrl);
        btnElement.textContent = originalText;
        btnElement.disabled = false;
        alert('Failed to play preview');
      };

      await audio.play();
    } catch (error) {
      console.error('Preview error:', error);
      btnElement.textContent = originalText;
      btnElement.disabled = false;
      alert('Failed to generate preview: ' + (error.message || 'Unknown error'));
    }
  };

  const handleCopyVoiceId = async (voiceId, btnElement) => {
    try {
      await navigator.clipboard.writeText(voiceId);
      const originalText = btnElement.textContent;
      btnElement.textContent = 'Copied!';
      btnElement.style.background = '#10b981';

      setTimeout(() => {
        btnElement.textContent = originalText;
        btnElement.style.background = '#0073e6';
      }, 2000);
    } catch (error) {
      const textarea = document.createElement('textarea');
      textarea.value = voiceId;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        const originalText = btnElement.textContent;
        btnElement.textContent = 'Copied!';
        btnElement.style.background = '#10b981';
        setTimeout(() => {
          btnElement.textContent = originalText;
          btnElement.style.background = '#0073e6';
        }, 2000);
      } catch (err) {
        alert('Failed to copy. Voice ID: ' + voiceId);
      }
      document.body.removeChild(textarea);
    }
  };

  // Loading dots animation state
  const [loadingDots, setLoadingDots] = useState('.');

  useEffect(() => {
    if (!loading) return;
    
    const interval = setInterval(() => {
      setLoadingDots(prev => {
        if (prev === '.') return '..';
        if (prev === '..') return '...';
        if (prev === '...') return '....';
        return '.';
      });
    }, 500); // Change every 500ms

    return () => clearInterval(interval);
  }, [loading]);

  // Skeleton Agent Card Component
  const SkeletonAgentCard = () => (
    <div className="agent-card" style={{ cursor: 'default', pointerEvents: 'none' }}>
      <SkeletonBox width="70%" height="20px" style={{ marginBottom: '12px' }} />
      <SkeletonText width="100%" lines={2} gap="6px" style={{ marginBottom: '12px' }} />
      <SkeletonBox width="90%" height="14px" style={{ marginBottom: '16px' }} />
      <div style={{
        display: 'flex',
        gap: '16px',
        marginTop: '12px',
        paddingTop: '12px',
        borderTop: '1px solid #E5E7EB'
      }}>
        <SkeletonBox width="80px" height="14px" />
        <SkeletonBox width="100px" height="14px" />
        <SkeletonBox width="90px" height="14px" />
      </div>
    </div>
  );

  // Don't return early if modal should show - allow modal to render even during loading
  if (loading && !showAgentTypeSelection) {
    return (
      <div className="playground-container">
        <div className="agent-selection-page">
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', gap: '12px', flexWrap: 'wrap' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flex: 1, minWidth: '200px' }}>
              <span style={{ fontSize: '14px', fontWeight: 500, color: '#6b7280' }}>Find:</span>
              <SkeletonBox width="100%" height="32px" style={{ borderRadius: '6px', maxWidth: '400px' }} />
            </div>
            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', justifyContent: 'flex-end' }}>
              <SkeletonBox width="100px" height="32px" style={{ borderRadius: '6px' }} />
              <SkeletonBox width="120px" height="32px" style={{ borderRadius: '6px' }} />
            </div>
          </div>
          <div className="agent-list">
            {Array.from({ length: 6 }).map((_, i) => (
              <SkeletonAgentCard key={i} />
            ))}
          </div>
        </div>
      </div>
    );
  }

  // Latency data
  const latencyData = [
    { name: 'LLM', value: 1.1, color: '#3b82f6', total: 2.3 },
    { name: 'STT', value: 0.3, color: '#10b981', total: 2.3 },
    { name: 'TTS', value: 0.3, color: '#f59e0b', total: 2.3 },
    { name: 'Connection', value: 0.6, color: '#8b5cf6', total: 2.3 },
  ];

  return (
    <div>
      {/* Agent Type Selection Modal - Render at root level so it always shows */}
      {showAgentTypeSelection && (
        <div
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10002,
            padding: '20px',
          }}
          onClick={() => {
            setShowAgentTypeSelection(false);
            setTemplateDirection(null);
          }}
        >
          <div
            style={{
              backgroundColor: 'white',
              borderRadius: '12px',
              width: '100%',
              maxWidth: '550px',
              padding: '24px',
              boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div style={{ marginBottom: '24px', textAlign: 'center' }}>
              <h2 style={{ margin: '0 0 8px 0', fontSize: '20px', fontWeight: '600', color: '#111827', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                <img 
                  src="/images/Raycons Icons Pack (Community)/setting-8532400.svg" 
                  alt="Settings" 
                  style={{ width: '20px', height: '20px' }}
                />
                Select Preference
              </h2>
            </div>

            {/* Tabs */}
            <div style={{ 
              display: 'flex', 
              justifyContent: 'flex-start',
              gap: '0',
              marginBottom: '24px',
              borderTop: '1px solid #e5e7eb',
              borderBottom: '1px solid #e5e7eb',
              background: '#f9fafb',
              padding: '4px',
              borderRadius: '8px',
              boxSizing: 'border-box',
            }}>
              <button
                onClick={() => {
                  setCreateNewActiveTab('new');
                  setTemplateDirection(null);
                }}
                style={{
                  padding: '8px 16px',
                  background: createNewActiveTab === 'new' ? '#ffffff' : 'transparent',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontSize: '13px',
                  fontWeight: createNewActiveTab === 'new' ? '600' : '500',
                  color: createNewActiveTab === 'new' ? '#111827' : '#6b7280',
                  whiteSpace: 'nowrap',
                  transition: 'all 0.15s ease',
                  position: 'relative',
                  letterSpacing: '-0.1px',
                  marginRight: '2px',
                  flexShrink: 0,
                  boxShadow: createNewActiveTab === 'new' ? '0 1px 3px rgba(0, 0, 0, 0.1)' : 'none',
                }}
                onMouseEnter={(e) => {
                  if (createNewActiveTab !== 'new') {
                    e.currentTarget.style.color = '#4b5563';
                  }
                }}
                onMouseLeave={(e) => {
                  if (createNewActiveTab !== 'new') {
                    e.currentTarget.style.color = '#6b7280';
                  }
                }}
              >
                New
              </button>
              <button
                onClick={() => {
                  setCreateNewActiveTab('templates');
                  setTemplateDirection(null);
                }}
                style={{
                  padding: '8px 16px',
                  background: createNewActiveTab === 'templates' ? '#ffffff' : 'transparent',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontSize: '13px',
                  fontWeight: createNewActiveTab === 'templates' ? '600' : '500',
                  color: createNewActiveTab === 'templates' ? '#111827' : '#6b7280',
                  whiteSpace: 'nowrap',
                  transition: 'all 0.15s ease',
                  position: 'relative',
                  letterSpacing: '-0.1px',
                  marginRight: '0',
                  flexShrink: 0,
                  boxShadow: createNewActiveTab === 'templates' ? '0 1px 3px rgba(0, 0, 0, 0.1)' : 'none',
                }}
                onMouseEnter={(e) => {
                  if (createNewActiveTab !== 'templates') {
                    e.currentTarget.style.color = '#4b5563';
                  }
                }}
                onMouseLeave={(e) => {
                  if (createNewActiveTab !== 'templates') {
                    e.currentTarget.style.color = '#6b7280';
                  }
                }}
              >
                Templates
              </button>
            </div>

            {/* Tab Content */}
            {createNewActiveTab === 'new' && (
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: '1fr 1fr', 
                gap: '16px',
                marginBottom: '0',
                width: '100%'
              }}>
                {/* Outbound: Simple Flow */}
                <button
                  onClick={() => handleSelectAgentType('simple-flow')}
                  style={{
                    width: '100%',
                    padding: '0',
                    border: 'none',
                    borderRadius: '8px',
                    background: 'transparent',
                    cursor: 'pointer',
                    textAlign: 'left',
                    transition: 'all 0.2s',
                    display: 'flex',
                    flexDirection: 'column',
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-2px)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                  }}
                >
                  <img 
                    src="/images/simpleflow.png" 
                    alt="Simple Flow" 
                    style={{ 
                      width: '100%', 
                      height: 'auto', 
                      borderRadius: '8px 8px 0 0',
                      objectFit: 'cover'
                    }} 
                  />
                  <div style={{ padding: '12px', background: 'white', borderRadius: '0 0 8px 8px' }}>
                    <h3 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: '600', color: '#111827' }}>
                      Outbound: Simple Flow
                    </h3>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                      <span 
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '3px',
                          padding: '2px 6px',
                          background: '#EFF6FF',
                          border: '1px solid #3B82F6',
                          borderRadius: '4px',
                          fontSize: '9px',
                          color: '#1E40AF',
                          fontWeight: '500',
                          height: '18px',
                          transition: 'background 0.2s',
                          cursor: 'default'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = 'transparent';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = '#EFF6FF';
                        }}
                      >
                        <img src="/images/Raycons Icons Pack (Community)/card-coin-8532167.svg" alt="COD" style={{ width: '10px', height: '10px', filter: 'brightness(0) saturate(100%) invert(24%) sepia(95%) saturate(2000%) hue-rotate(210deg) brightness(0.7) contrast(1.2)' }} />
                        COD conf
                      </span>
                      <span 
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '3px',
                          padding: '2px 6px',
                          background: '#EFF6FF',
                          border: '1px solid #3B82F6',
                          borderRadius: '4px',
                          fontSize: '9px',
                          color: '#1E40AF',
                          fontWeight: '500',
                          height: '18px',
                          transition: 'background 0.2s',
                          cursor: 'default'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = 'transparent';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = '#EFF6FF';
                        }}
                      >
                        <img src="/images/Raycons Icons Pack (Community)/user-search-8535325.svg" alt="Lead" style={{ width: '10px', height: '10px', filter: 'brightness(0) saturate(100%) invert(24%) sepia(95%) saturate(2000%) hue-rotate(210deg) brightness(0.7) contrast(1.2)' }} />
                        Lead qual
                      </span>
                      <span 
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '3px',
                          padding: '2px 6px',
                          background: '#EFF6FF',
                          border: '1px solid #3B82F6',
                          borderRadius: '4px',
                          fontSize: '9px',
                          color: '#1E40AF',
                          fontWeight: '500',
                          height: '18px',
                          transition: 'background 0.2s',
                          cursor: 'default'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = 'transparent';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = '#EFF6FF';
                        }}
                      >
                        <img src="/images/Raycons Icons Pack (Community)/routing-8532067.svg" alt="NDR" style={{ width: '10px', height: '10px', filter: 'brightness(0) saturate(100%) invert(24%) sepia(95%) saturate(2000%) hue-rotate(210deg) brightness(0.7) contrast(1.2)' }} />
                        NDR
                      </span>
                    </div>
                  </div>
                </button>

                {/* Outbound: Advanced Flow */}
                <button
                  onClick={() => handleSelectAgentType('advanced-flow')}
                  style={{
                    width: '100%',
                    padding: '0',
                    border: 'none',
                    borderRadius: '8px',
                    background: 'transparent',
                    cursor: 'pointer',
                    textAlign: 'left',
                    transition: 'all 0.2s',
                    display: 'flex',
                    flexDirection: 'column',
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-2px)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                  }}
                >
                  <img 
                    src="/images/advancedflow.png" 
                    alt="Advanced Flow" 
                    style={{ 
                      width: '100%', 
                      height: 'auto', 
                      borderRadius: '8px 8px 0 0',
                      objectFit: 'cover'
                    }} 
                  />
                  <div style={{ padding: '12px', background: 'white', borderRadius: '0 0 8px 8px' }}>
                    <h3 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: '600', color: '#111827' }}>
                      Outbound: Advanced Flow
                    </h3>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                      <span 
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '3px',
                          padding: '2px 6px',
                          background: '#EFF6FF',
                          border: '1px solid #3B82F6',
                          borderRadius: '4px',
                          fontSize: '9px',
                          color: '#1E40AF',
                          fontWeight: '500',
                          height: '18px',
                          transition: 'background 0.2s',
                          cursor: 'default'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = 'transparent';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = '#EFF6FF';
                        }}
                      >
                        <img src="/images/Raycons Icons Pack (Community)/money-tick-8532216.svg" alt="Sales" style={{ width: '10px', height: '10px', filter: 'brightness(0) saturate(100%) invert(24%) sepia(95%) saturate(2000%) hue-rotate(210deg) brightness(0.7) contrast(1.2)' }} />
                        Sales
                      </span>
                      <span 
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '3px',
                          padding: '2px 6px',
                          background: '#EFF6FF',
                          border: '1px solid #3B82F6',
                          borderRadius: '4px',
                          fontSize: '9px',
                          color: '#1E40AF',
                          fontWeight: '500',
                          height: '18px',
                          transition: 'background 0.2s',
                          cursor: 'default'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = 'transparent';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = '#EFF6FF';
                        }}
                      >
                        <img src="/images/Raycons Icons Pack (Community)/card-coin-8532167.svg" alt="COD" style={{ width: '10px', height: '10px', filter: 'brightness(0) saturate(100%) invert(24%) sepia(95%) saturate(2000%) hue-rotate(210deg) brightness(0.7) contrast(1.2)' }} />
                        CODâ†’Prepaid
                      </span>
                      <span 
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '3px',
                          padding: '2px 6px',
                          background: '#EFF6FF',
                          border: '1px solid #3B82F6',
                          borderRadius: '4px',
                          fontSize: '9px',
                          color: '#1E40AF',
                          fontWeight: '500',
                          height: '18px',
                          transition: 'background 0.2s',
                          cursor: 'default'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = 'transparent';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = '#EFF6FF';
                        }}
                      >
                        <img src="/images/Raycons Icons Pack (Community)/warning-8535592-1.svg" alt="Abandon" style={{ width: '10px', height: '10px', filter: 'brightness(0) saturate(100%) invert(24%) sepia(95%) saturate(2000%) hue-rotate(210deg) brightness(0.7) contrast(1.2)' }} />
                        Abandond Checkout
                      </span>
                    </div>
                  </div>
                </button>

                {/* Inbound: Free Flow */}
                <button
                  onClick={() => handleSelectAgentType('free-flow')}
                  style={{
                    width: '100%',
                    padding: '0',
                    border: 'none',
                    borderRadius: '8px',
                    background: 'transparent',
                    cursor: 'pointer',
                    textAlign: 'left',
                    transition: 'all 0.2s',
                    display: 'flex',
                    flexDirection: 'column',
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-2px)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                  }}
                >
                  <img 
                    src="/images/freeflow.png" 
                    alt="Free Flow" 
                    style={{ 
                      width: '100%', 
                      height: 'auto', 
                      borderRadius: '8px 8px 0 0',
                      objectFit: 'cover'
                    }} 
                  />
                  <div style={{ padding: '12px', background: 'white', borderRadius: '0 0 8px 8px' }}>
                    <h3 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: '600', color: '#111827' }}>
                      Inbound: Free Flow
                    </h3>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                      <span 
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '3px',
                          padding: '2px 6px',
                          background: '#EFF6FF',
                          border: '1px solid #3B82F6',
                          borderRadius: '4px',
                          fontSize: '9px',
                          color: '#1E40AF',
                          fontWeight: '500',
                          height: '18px',
                          transition: 'background 0.2s',
                          cursor: 'default'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = 'transparent';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = '#EFF6FF';
                        }}
                      >
                        <img src="/images/Raycons Icons Pack (Community)/message-2198428.svg" alt="Support" style={{ width: '10px', height: '10px', filter: 'brightness(0) saturate(100%) invert(24%) sepia(95%) saturate(2000%) hue-rotate(210deg) brightness(0.7) contrast(1.2)' }} />
                        Customer support
                      </span>
                      <span 
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '3px',
                          padding: '2px 6px',
                          background: '#EFF6FF',
                          border: '1px solid #3B82F6',
                          borderRadius: '4px',
                          fontSize: '9px',
                          color: '#1E40AF',
                          fontWeight: '500',
                          height: '18px',
                          transition: 'background 0.2s',
                          cursor: 'default'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = 'transparent';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = '#EFF6FF';
                        }}
                      >
                        <img src="/images/Raycons Icons Pack (Community)/call-2198440.svg" alt="Call" style={{ width: '10px', height: '10px', filter: 'brightness(0) saturate(100%) invert(24%) sepia(95%) saturate(2000%) hue-rotate(210deg) brightness(0.7) contrast(1.2)' }} />
                        Call widget
                      </span>
                      <span 
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '3px',
                          padding: '2px 6px',
                          background: '#EFF6FF',
                          border: '1px solid #3B82F6',
                          borderRadius: '4px',
                          fontSize: '9px',
                          color: '#1E40AF',
                          fontWeight: '500',
                          height: '18px',
                          transition: 'background 0.2s',
                          cursor: 'default'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = 'transparent';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = '#EFF6FF';
                        }}
                      >
                        <img src="/images/Raycons Icons Pack (Community)/wallet-remove-8532253.svg" alt="Refund" style={{ width: '10px', height: '10px', filter: 'brightness(0) saturate(100%) invert(24%) sepia(95%) saturate(2000%) hue-rotate(210deg) brightness(0.7) contrast(1.2)' }} />
                        Refund
                      </span>
                      <span 
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '3px',
                          padding: '2px 6px',
                          background: '#EFF6FF',
                          border: '1px solid #3B82F6',
                          borderRadius: '4px',
                          fontSize: '9px',
                          color: '#1E40AF',
                          fontWeight: '500',
                          height: '18px',
                          transition: 'background 0.2s',
                          cursor: 'default'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = 'transparent';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = '#EFF6FF';
                        }}
                      >
                        <img src="/images/Raycons Icons Pack (Community)/message-question-8535294.svg" alt="FAQ" style={{ width: '10px', height: '10px', filter: 'brightness(0) saturate(100%) invert(24%) sepia(95%) saturate(2000%) hue-rotate(210deg) brightness(0.7) contrast(1.2)' }} />
                        FAQs
                      </span>
                    </div>
                  </div>
                </button>

                {/* Custom Flow- Scratch */}
                <button
                  onClick={() => handleSelectAgentType('scratch')}
                  style={{
                    width: '100%',
                    padding: '0',
                    border: 'none',
                    borderRadius: '8px',
                    background: 'transparent',
                    cursor: 'pointer',
                    textAlign: 'left',
                    transition: 'all 0.2s',
                    display: 'flex',
                    flexDirection: 'column',
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.transform = 'translateY(-2px)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                  }}
                >
                  <div style={{ position: 'relative', width: '100%' }}>
                    <img 
                      src="/images/custom.png" 
                      alt="Custom Flow" 
                      style={{ 
                        width: '100%', 
                        height: 'auto', 
                        borderRadius: '8px 8px 0 0',
                        objectFit: 'cover',
                        filter: 'blur(4px)'
                      }} 
                    />
                    <div style={{
                      position: 'absolute',
                      top: '50%',
                      left: '50%',
                      transform: 'translate(-50%, -50%)',
                      padding: '6px 12px',
                      background: '#F9FAFB',
                      borderRadius: '6px',
                      border: 'none',
                      fontSize: '12px',
                      color: '#111827',
                      fontWeight: '500',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px',
                      pointerEvents: 'none'
                    }}>
                      <span>&lt; &gt;</span>
                      <span>Edit</span>
                    </div>
                  </div>
                  <div style={{ padding: '12px', background: 'white', borderRadius: '0 0 8px 8px' }}>
                    <h3 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: '600', color: '#111827' }}>
                      Custom Flow- Scratch
                    </h3>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                      <span 
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '3px',
                          padding: '2px 6px',
                          background: '#EFF6FF',
                          border: '1px solid #3B82F6',
                          borderRadius: '4px',
                          fontSize: '9px',
                          color: '#1E40AF',
                          fontWeight: '500',
                          height: '18px',
                          transition: 'background 0.2s',
                          cursor: 'default'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = 'transparent';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = '#EFF6FF';
                        }}
                      >
                        <img src="/images/Raycons Icons Pack (Community)/setting-8532400.svg" alt="Custom" style={{ width: '10px', height: '10px', filter: 'brightness(0) saturate(100%) invert(24%) sepia(95%) saturate(2000%) hue-rotate(210deg) brightness(0.7) contrast(1.2)' }} />
                        Completely modifiable
                      </span>
                    </div>
                  </div>
                </button>
              </div>
            )}

            {createNewActiveTab === 'templates' && (
              <div>
                {!templateDirection ? (
                  // Show Outbound/Inbound selection
                  <div style={{ 
                    display: 'flex', 
                    flexDirection: 'column',
                    gap: '16px'
                  }}>
                    <h3 style={{ 
                      margin: '0 0 16px 0', 
                      fontSize: '16px', 
                      fontWeight: '600', 
                      color: '#111827',
                      textAlign: 'center'
                    }}>
                      Select Call Type
                    </h3>
                    <button
                      onClick={() => setTemplateDirection('outbound')}
                      style={{
                        padding: '20px',
                        border: '2px solid #E5E7EB',
                        borderRadius: '8px',
                        background: 'white',
                        cursor: 'pointer',
                        textAlign: 'left',
                        fontSize: '16px',
                        fontWeight: 500,
                        color: '#111827',
                        transition: 'all 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.borderColor = '#4B5CFF';
                        e.currentTarget.style.background = '#F5F7FF';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.borderColor = '#E5E7EB';
                        e.currentTarget.style.background = 'white';
                      }}
                    >
                      <img 
                        src="/images/Raycons Icons Pack (Community)/call-2198440.svg" 
                        alt="Outbound" 
                        style={{ width: '24px', height: '24px' }}
                      />
                      <div>
                        <div style={{ fontWeight: 600, marginBottom: '4px' }}>Outbound</div>
                        <div style={{ fontSize: '13px', color: '#6b7280' }}>Call customers proactively</div>
                      </div>
                    </button>
                    <button
                      onClick={() => setTemplateDirection('inbound')}
                      style={{
                        padding: '20px',
                        border: '2px solid #E5E7EB',
                        borderRadius: '8px',
                        background: 'white',
                        cursor: 'pointer',
                        textAlign: 'left',
                        fontSize: '16px',
                        fontWeight: 500,
                        color: '#111827',
                        transition: 'all 0.2s',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.borderColor = '#4B5CFF';
                        e.currentTarget.style.background = '#F5F7FF';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.borderColor = '#E5E7EB';
                        e.currentTarget.style.background = 'white';
                      }}
                    >
                      <img 
                        src="/images/Raycons Icons Pack (Community)/message-2198428.svg" 
                        alt="Inbound" 
                        style={{ width: '24px', height: '24px' }}
                      />
                      <div>
                        <div style={{ fontWeight: 600, marginBottom: '4px' }}>Inbound</div>
                        <div style={{ fontSize: '13px', color: '#6b7280' }}>Handle incoming customer calls</div>
                      </div>
                    </button>
                  </div>
                ) : templateDirection === 'outbound' ? (
                  // Show Outbound templates with animation
                  <div>
                    <div style={{ 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '12px',
                      marginBottom: '20px'
                    }}>
                      <button
                        onClick={() => setTemplateDirection(null)}
                        style={{
                          padding: '6px 12px',
                          border: '1px solid #E5E7EB',
                          borderRadius: '6px',
                          background: 'white',
                          cursor: 'pointer',
                          fontSize: '13px',
                          color: '#6b7280',
                          transition: 'all 0.2s',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '6px'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.borderColor = '#9ca3af';
                          e.currentTarget.style.background = '#f9fafb';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.borderColor = '#E5E7EB';
                          e.currentTarget.style.background = 'white';
                        }}
                      >
                        â† Back
                      </button>
                      <h3 style={{ 
                        margin: 0, 
                        fontSize: '16px', 
                        fontWeight: '600', 
                        color: '#111827'
                      }}>
                        Outbound Templates
                      </h3>
                    </div>
                    <div style={{ 
                      display: 'grid', 
                      gridTemplateColumns: '1fr', 
                      gap: '12px'
                    }}>
                      {[
                        { key: 'cod-confirmation', name: 'COD Confirmation' },
                        { key: 'ndr-script', name: 'NDR' },
                        { key: 'abandonment-checkout', name: 'Abandonment Checkout' },
                        { key: 'cod-to-prepaid', name: 'COD to Prepaid' },
                        { key: 'smart-address-recovery', name: 'Address Recovery' },
                        { key: 'lead-qualifying', name: 'Lead Qualifying' }
                      ].map((template, index) => (
                        <button
                          key={template.key}
                          onClick={() => {
                            setShowAgentTypeSelection(false);
                            handleCreateNewWithTemplate(template.key);
                          }}
                          style={{
                            padding: '16px',
                            border: '2px solid #E5E7EB',
                            borderRadius: '8px',
                            background: 'white',
                            cursor: 'pointer',
                            textAlign: 'left',
                            fontSize: '15px',
                            fontWeight: 500,
                            color: '#111827',
                            transition: 'all 0.2s',
                            opacity: 0,
                            animation: `fadeInUp 0.3s ease-out ${index * 0.05}s forwards`
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.borderColor = '#4B5CFF';
                            e.currentTarget.style.background = '#F5F7FF';
                            e.currentTarget.style.transform = 'translateY(-2px)';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.borderColor = '#E5E7EB';
                            e.currentTarget.style.background = 'white';
                            e.currentTarget.style.transform = 'translateY(0)';
                          }}
                        >
                          {template.name}
                        </button>
                      ))}
                    </div>
                    <style>{`
                      @keyframes fadeInUp {
                        from {
                          opacity: 0;
                          transform: translateY(10px);
                        }
                        to {
                          opacity: 1;
                          transform: translateY(0);
                        }
                      }
                    `}</style>
                  </div>
                ) : (
                  // Show Inbound templates with animation
                  <div>
                    <div style={{ 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '12px',
                      marginBottom: '20px'
                    }}>
                      <button
                        onClick={() => setTemplateDirection(null)}
                        style={{
                          padding: '6px 12px',
                          border: '1px solid #E5E7EB',
                          borderRadius: '6px',
                          background: 'white',
                          cursor: 'pointer',
                          fontSize: '13px',
                          color: '#6b7280',
                          transition: 'all 0.2s',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '6px'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.borderColor = '#9ca3af';
                          e.currentTarget.style.background = '#f9fafb';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.borderColor = '#E5E7EB';
                          e.currentTarget.style.background = 'white';
                        }}
                      >
                        â† Back
                      </button>
                      <h3 style={{ 
                        margin: 0, 
                        fontSize: '16px', 
                        fontWeight: '600', 
                        color: '#111827'
                      }}>
                        Inbound Templates
                      </h3>
                    </div>
                    <div style={{ 
                      display: 'grid', 
                      gridTemplateColumns: '1fr', 
                      gap: '12px'
                    }}>
                      {[
                        { key: 'customer-support', name: 'Customer Support' }
                      ].map((template, index) => (
                        <button
                          key={template.key}
                          onClick={() => {
                            setShowAgentTypeSelection(false);
                            handleCreateNewWithTemplate(template.key);
                          }}
                          style={{
                            padding: '16px',
                            border: '2px solid #E5E7EB',
                            borderRadius: '8px',
                            background: 'white',
                            cursor: 'pointer',
                            textAlign: 'left',
                            fontSize: '15px',
                            fontWeight: 500,
                            color: '#111827',
                            transition: 'all 0.2s',
                            opacity: 0,
                            animation: `fadeInUp 0.3s ease-out ${index * 0.05}s forwards`
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.borderColor = '#4B5CFF';
                            e.currentTarget.style.background = '#F5F7FF';
                            e.currentTarget.style.transform = 'translateY(-2px)';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.borderColor = '#E5E7EB';
                            e.currentTarget.style.background = 'white';
                            e.currentTarget.style.transform = 'translateY(0)';
                          }}
                        >
                          {template.name}
                        </button>
                      ))}
                    </div>
                    <style>{`
                      @keyframes fadeInUp {
                        from {
                          opacity: 0;
                          transform: translateY(10px);
                        }
                        to {
                          opacity: 1;
                          transform: translateY(0);
                        }
                      }
                    `}</style>
                  </div>
                )}
              </div>
            )}

            {/* Cancel Button */}
            <div style={{ display: 'flex', justifyContent: 'center' }}>
              <button
                onClick={() => {
                  setShowAgentTypeSelection(false);
                  setTemplateDirection(null);
                }}
                style={{
                  padding: '12px 32px',
                  background: '#F3F4F6',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '500',
                  color: '#374151',
                  transition: 'all 0.2s',
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = '#E5E7EB';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = '#F3F4F6';
                }}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Agent and Knowledge Book Selection Page */}
      {!showForm && !showKnowledgeBookForm && (
        <div className="agent-selection-page">
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', gap: '12px', flexWrap: 'wrap' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flex: 1, minWidth: '200px' }}>
              <span style={{ fontSize: '14px', fontWeight: 500, color: '#6b7280' }}>Find:</span>
              <input
                type="text"
                placeholder="Search scripts..."
                value={scriptSearchQuery}
                onChange={(e) => setScriptSearchQuery(e.target.value)}
                style={{
                  flex: 1,
                  maxWidth: '400px',
                  padding: '6px 12px',
                  border: '1px solid #D1D5DB',
                  borderRadius: '6px',
                  fontSize: '14px',
                  fontFamily: 'inherit',
                  color: '#111827',
                  background: '#FFFFFF',
                  outline: 'none',
                  transition: 'border-color 0.2s'
                }}
                onFocus={(e) => e.target.style.borderColor = '#4B5CFF'}
                onBlur={(e) => e.target.style.borderColor = '#D1D5DB'}
              />
            </div>
            <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', justifyContent: 'flex-end' }}>
              {isBulkSelecting ? (
                <>
              <button
                    onClick={handleSelectAllAgents}
                    style={secondaryButtonStyle}
                    disabled={!hasAgents}
                  >
                    Select All
              </button>
                  <button
                    onClick={handleDeleteSelectedAgents}
                style={{
                      ...secondaryButtonStyle,
                      background: isDeleteDisabled ? '#F3F4F6' : '#FEE2E2',
                      borderColor: isDeleteDisabled ? '#E5E7EB' : '#FCA5A5',
                      color: isDeleteDisabled ? '#9CA3AF' : '#B91C1C'
                    }}
                    disabled={isDeleteDisabled}
                  >
                    {isDeletingAgents ? 'Deletingâ€¦' : `Delete Selected (${selectedAgentCount})`}
                  </button>
                  <button
                    onClick={toggleSelectionMode}
                    style={secondaryButtonStyle}
                  >
                    Cancel
                  </button>
                </>
              ) : (
                <button
                  onClick={toggleSelectionMode}
                  style={secondaryButtonStyle}
                  disabled={!hasAgents}
                >
                  Select Scripts
                </button>
              )}
            <button
              type="button"
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                handleCreateNew();
              }}
                            style={{
                padding: '8px 16px',
                background: '#4B5CFF',
                              color: 'white',
                border: 'none',
                              borderRadius: '6px',
                fontSize: '13px',
                fontWeight: 600,
                cursor: 'pointer',
                transition: 'background 0.2s'
              }}
              onMouseEnter={(e) => e.target.style.background = '#4338ca'}
              onMouseLeave={(e) => e.target.style.background = '#4B5CFF'}
            >
              Create New
            </button>
                          </div>
                      </div>
              <div className="agent-list">
                {/* Pre-built Scripts */}
                <div className="agent-card prebuilt-script" onClick={() => handleCreateNewWithTemplate('smart-address-recovery')}>
                  <div className="agent-name">Smart Address Recovery</div>
                  <div className="agent-tags" style={{ display: 'flex', gap: '6px', marginTop: '8px', marginBottom: '8px' }}>
                    <span style={{ padding: '4px 8px', background: '#EFF6FF', color: '#1E40AF', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>Self Identify</span>
                    <span style={{ padding: '4px 8px', background: '#F0FDF4', color: '#166534', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>Auto Update</span>
                </div>
                  <div className="agent-description" style={{ fontSize: '13px', color: '#6b7280', lineHeight: '1.5' }}>
                    AI Smartly reads the address, identifies missing parts like house number, landmark,... then calls and automatically asks for the missing address & automatically adds to the current address.
              </div>
                </div>

                <div className="agent-card prebuilt-script" onClick={() => handleCreateNewWithTemplate('ndr-script')}>
                  <div className="agent-name">NDR Script</div>
                  <div className="agent-tags" style={{ display: 'flex', gap: '6px', marginTop: '8px', marginBottom: '8px' }}>
                    <span style={{ padding: '4px 8px', background: '#FEF3C7', color: '#92400E', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>Submit Action</span>
                    <span style={{ padding: '4px 8px', background: '#FDF2F8', color: '#BE185D', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>Submit with Recording</span>
                  </div>
                  <div className="agent-description" style={{ fontSize: '13px', color: '#6b7280', lineHeight: '1.5' }}>
                    Automated NDR handling script that processes non-delivery reports, collects customer feedback, and submits actions with call recordings for review.
        </div>
      </div>

                <div className="agent-card prebuilt-script" onClick={() => handleCreateNewWithTemplate('cod-confirmation')}>
                  <div className="agent-name">COD Confirmation Call</div>
                  <div className="agent-tags" style={{ display: 'flex', gap: '6px', marginTop: '8px', marginBottom: '8px' }}>
                    <span style={{ padding: '4px 8px', background: '#EFF6FF', color: '#1E40AF', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>Intent Verification</span>
                    <span style={{ padding: '4px 8px', background: '#FEF2F2', color: '#991B1B', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>RTO Fix</span>
                </div>
                  <div className="agent-description" style={{ fontSize: '13px', color: '#6b7280', lineHeight: '1.5' }}>
                    AI Calls to thank customer for placing an order and confirms the order details, payment method, and delivery address to prevent RTO.
                  </div>
                </div>

              <div className="agent-card prebuilt-script" onClick={() => handleCreateNewWithTemplate('cod-thank-you-intent')}>
                <div className="agent-name">COD Thank You Call + Intent Capture</div>
                <div className="agent-tags" style={{ display: 'flex', gap: '6px', marginTop: '8px', marginBottom: '8px' }}>
                  <span style={{ padding: '4px 8px', background: '#ECFDF5', color: '#065F46', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>Gratitude</span>
                  <span style={{ padding: '4px 8px', background: '#EFF6FF', color: '#1E3A8A', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>Intent Capture</span>
                </div>
                <div className="agent-description" style={{ fontSize: '13px', color: '#6b7280', lineHeight: '1.5' }}>
                  Quick 20-second call to thank COD customers, offer help, and reinforce commitment to reduce cancellations.
                  </div>
                </div>

                {agents
                  .filter((agent) => {
                    if (!scriptSearchQuery.trim()) return true;
                    const query = scriptSearchQuery.toLowerCase();
                    return (
                      agent.name?.toLowerCase().includes(query) ||
                      agent.description?.toLowerCase().includes(query) ||
                      agent.content?.toLowerCase().includes(query) ||
                      agent.frontendDisplayScript?.toLowerCase().includes(query)
                    );
                  })
                  .map((agent) => {
                  const stats = agentStats[agent.id] || { talkTime: 'N/A', language: 'Hindi, English', conversionRate: 'NA' };
                  const isSelected = selectedAgentIds.has(agent.id);
                  const cardStyles = {
                    position: 'relative',
                    ...(isBulkSelecting && isSelected
                      ? { borderColor: '#4B5CFF', boxShadow: '0 0 0 1px rgba(75, 92, 255, 0.2)' }
                      : {})
                  };
                  const handleCardClick = () => {
                    if (isBulkSelecting) {
                      toggleAgentSelection(agent.id);
                    } else {
                      handleSelectAgent(agent.id);
                    }
                  };
                  return (
                    <div
                      key={agent.id}
                      className="agent-card"
                      style={cardStyles}
                      onClick={handleCardClick}
                    >
                      {isBulkSelecting && (
                        <div
                          style={{
                            position: 'absolute',
                            top: '12px',
                            right: '12px',
                            background: '#FFFFFF',
                            borderRadius: '999px',
                            padding: '4px',
                            boxShadow: '0 2px 6px rgba(0,0,0,0.08)'
                          }}
                          onClick={(e) => e.stopPropagation()}
                        >
                          <input
                            type="checkbox"
                            checked={isSelected}
                            onChange={() => toggleAgentSelection(agent.id)}
                          />
                        </div>
                      )}
                      <div className="agent-name">{escapeHtml(agent.name)}</div>
                      {agent.description && (
                        <div className="agent-description">{escapeHtml(agent.description)}</div>
                      )}
                      <div className="agent-preview">
                        {escapeHtml((agent.frontendDisplayScript || agent.content || '').substring(0, 100))}
                        {(agent.frontendDisplayScript || agent.content || '').length > 100 ? '...' : ''}
                      </div>
                      {/* Agent Stats */}
                      <div style={{
                        display: 'flex',
                        gap: '16px',
                        marginTop: '12px',
                        paddingTop: '12px',
                        borderTop: '1px solid #E5E7EB',
                        fontSize: '12px',
                        color: '#6B7280'
                      }}>
                        <div style={{ position: 'relative' }}>
                          <span style={{ fontWeight: 500 }}>Talk Time: </span>
                          <span>{stats.talkTime}</span>
                        </div>
                        <div style={{ position: 'relative' }}>
                          <span style={{ fontWeight: 500 }}>Language: </span>
                          <span
                            style={{ cursor: 'help', textDecoration: 'underline dotted' }}
                            title="Hindi and English"
                          >
                            {stats.language}
                          </span>
                        </div>
                        <div>
                          <span style={{ fontWeight: 500 }}>Conversion: </span>
                          <span>{stats.conversionRate}</span>
                        </div>
                      </div>
                    </div>
                  );
                })}
          </div>
        </div>
      )}

      {/* Playground Form */}
      {showForm && (
        <>
            {/* Agent Header with Name, Test, and Save buttons */}
          <div className="agent-header-top">
              <div className="agent-header-top-row">
                {/* Back Button */}
                  <button
                    type="button"
                    className="btn-back-agent"
                    onClick={handleBackToList}
                    title="Back to agent list"
                  >
                  <ArrowLeft size={18} />
                  </button>
                {/* Tabs Navbar */}
                <div className="agent-settings-navbar" style={{ position: 'relative', display: 'flex' }}>
                  {tabOrder.map((tab, index) => {
                    const isDragged = draggedTabIndex === index;
                    const showLeftIndicator = dragOverIndex === index && draggedTabIndex !== null && draggedTabIndex > index;
                    const showRightIndicator = dragOverIndex === index + 1 && draggedTabIndex !== null && draggedTabIndex < index;
                    
                    return (
                      <button
                        key={tab.id}
                        type="button"
                        className={`nav-tab ${activeTab === tab.id ? 'active' : ''} ${isDragged ? 'dragging' : ''}`}
                        onClick={(e) => {
                          if (!isDragging) {
                            setActiveTab(tab.id);
                          }
                        }}
                        onMouseDown={(e) => handleTabMouseDown(e, index)}
                        style={{
                          cursor: isDragged && isReadyToDrag ? 'grab' : (isDragged ? 'grabbing' : 'pointer'),
                          userSelect: 'none',
                          transition: isDragged ? 'none' : 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                          transform: isDragged ? `translate(${dragOffset.x}px, ${dragOffset.y}px) scale(1.05)` : 'translate(0, 0) scale(1)',
                          opacity: isDragged ? 0.8 : 1,
                          zIndex: isDragged ? 1000 : 1,
                          position: isDragged ? 'absolute' : 'relative',
                          left: isDragged ? `${dragStartPosition.left}px` : 'auto',
                          top: isDragged ? `${dragStartPosition.top}px` : 'auto',
                          pointerEvents: isDragged ? 'none' : 'auto',
                          boxShadow: isDragged ? '0 8px 16px rgba(0, 0, 0, 0.2)' : 'none',
                          ...(showLeftIndicator ? {
                            borderLeft: '3px solid #4B5CFF',
                            marginLeft: '-2px',
                            paddingLeft: '2px'
                          } : {}),
                          ...(showRightIndicator ? {
                            borderRight: '3px solid #4B5CFF',
                            marginRight: '-2px',
                            paddingRight: '2px'
                          } : {})
                        }}
                      >
                        {tab.label}
                      </button>
                    );
                  })}
                </div>
                <div className="agent-header-actions">
                <button
                  type="button"
                  className="btn btn-download-agent"
                  onClick={() => {
                    // Download current script as JSON
                    if (currentAgentId) {
                      const currentAgent = agents.find(a => a.id === currentAgentId);
                      if (currentAgent) {
                        // Get knowledge books if any (from content)
                        const displayScript = currentAgent.frontendDisplayScript || currentAgent.content || '';
                        const kbIds = getKnowledgeBookIdsFromContent(currentAgent.content || '', displayScript);
                        const knowledgeBooksData = kbIds.map(kbId => {
                          const kb = knowledgeBooks.find(b => b.id === kbId);
                          return kb ? { id: kb.id, name: kb.name, content: kb.content } : null;
                        }).filter(Boolean);
                        
                        // Get variable book if any
                        const variableBookId = variableAssignments[currentAgent.id] || currentAgent.variableBookId || null;
                        const variableBook = variableBookId ? variableBooks.find(vb => vb.id === variableBookId) : null;
                        
                        // Prepare export data
                        const exportData = {
                          name: currentAgent.name,
                          description: currentAgent.description || '',
                          content: currentAgent.content || '',
                          frontendDisplayScript: currentAgent.frontendDisplayScript || currentAgent.content || '',
                          voiceId: currentAgent.voiceId || '',
                          initialGreeting: currentAgent.initialGreeting || '',
                          prePhrase: currentAgent.prePhrase || 'ji',
                          prePhraseArray: currentAgent.prePhraseArray || [],
                          useCustomAnalysis: currentAgent.useCustomAnalysis || false,
                          customAnalysisPrompt: currentAgent.customAnalysisPrompt || '',
                          disableUnder35Retries: currentAgent.disableUnder35Retries || false,
                          successCriteria: currentAgent.successCriteria || [],
                          otherCriteria: currentAgent.otherCriteria || [],
                          maxRetries: currentAgent.maxRetries || null,
                          retryIntervalMinutes: currentAgent.retryIntervalMinutes || null,
                          successMetric: currentAgent.successMetric || '',
                          autoTaggingEnabled: currentAgent.autoTaggingEnabled || false,
                          autoTaggingRules: currentAgent.autoTaggingRules || {
                            successCriteria: {},
                            otherCriteria: {},
                            tagOnMaxRetries: false,
                            maxRetriesTagName: ''
                          },
                          ttsProvider: currentAgent.ttsProvider || null,
                          interruptions: currentAgent.interruptions !== undefined ? currentAgent.interruptions : false,
                          variableBookId: variableBookId,
                          variableBook: variableBook ? {
                            id: variableBook.id,
                            name: variableBook.name,
                            variables: variableBook.variables || {}
                          } : null,
                          knowledgeBooks: knowledgeBooksData,
                          exportedAt: new Date().toISOString(),
                          exportedFrom: 'Scalysis Playground'
                        };
                        
                        // Create and download JSON file
                        const jsonStr = JSON.stringify(exportData, null, 2);
                        const blob = new Blob([jsonStr], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `${currentAgent.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_script.json`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                      }
                    } else {
                      alert('Please select a script to download');
                    }
                  }}
                  disabled={!currentAgentId}
                  title="Download"
                >
                  <Download size={14} />
                </button>
                <button
                  type="button"
                  className="btn btn-duplicate-agent"
                  onClick={async () => {
                    // Duplicate current agent - actually create a new script
                    if (currentAgentId) {
                      const currentAgent = agents.find(a => a.id === currentAgentId);
                      if (currentAgent) {
                        try {
                          setIsSavingAgent(true);
                          
                          // Get the full content (including knowledge books if any)
                          const displayScript = currentAgent.frontendDisplayScript || currentAgent.content || '';
                          let fullContent = displayScript;
                          
                          // Get knowledge books for this agent if any (from content)
                          const kbIds = getKnowledgeBookIdsFromContent(currentAgent.content || '', displayScript);
                          if (kbIds.length > 0) {
                            fullContent += '\n\n';
                            for (const kbId of kbIds) {
                              const kb = knowledgeBooks.find(b => b.id === kbId);
                              if (kb) {
                                fullContent += `${kb.content}\n\n`;
                              }
                            }
                          }
                          
                          // Filter out empty criteria
                          const successCriteria = (currentAgent.successCriteria || []).filter(c => c && c.trim() !== '');
                          const otherCriteria = (currentAgent.otherCriteria || []).filter(c => c && c.trim() !== '');
                          
                          const scriptData = {
                          name: `${currentAgent.name} (copy)`,
                          description: currentAgent.description || '',
                            content: fullContent,
                            frontendDisplayScript: displayScript,
                          voiceId: currentAgent.voiceId || '',
                          initialGreeting: currentAgent.initialGreeting || '',
                          prePhrase: currentAgent.prePhrase || 'ji',
                            prePhraseArray: currentAgent.prePhraseArray || [],
                          useCustomAnalysis: currentAgent.useCustomAnalysis || false,
                          customAnalysisPrompt: currentAgent.customAnalysisPrompt || '',
                          disableUnder35Retries: currentAgent.disableUnder35Retries || false,
                            successCriteria: successCriteria,
                            otherCriteria: otherCriteria,
                            maxRetries: currentAgent.maxRetries || null,
                            retryIntervalMinutes: currentAgent.retryIntervalMinutes || null,
                          successMetric: currentAgent.successMetric || '',
                            autoTaggingEnabled: currentAgent.autoTaggingEnabled || false,
                            autoTaggingRules: currentAgent.autoTaggingRules || {
                              successCriteria: {},
                              otherCriteria: {},
                              tagOnMaxRetries: false,
                              maxRetriesTagName: ''
                            },
                          ttsProvider: currentAgent.ttsProvider || null,
                          interruptions: currentAgent.interruptions !== undefined ? currentAgent.interruptions : false,
                            variableBookId: variableAssignments[currentAgent.id] || currentAgent.variableBookId || null,
                          callFulfilledOrders: currentAgent.callFulfilledOrders !== undefined ? currentAgent.callFulfilledOrders : true,
                          callCancelledOrders: currentAgent.callCancelledOrders !== undefined ? currentAgent.callCancelledOrders : true,
                          };
                          
                          const response = await createScript(scriptData, shop);
                          
                          if (response.success && response.script) {
                            // Reload agents
                            await loadAgents();
                            
                            // Set the new script as current
                            const newScriptId = response.script.id;
                            setCurrentAgentId(newScriptId);
                            
                            // Copy knowledge book assignments if any (they're already in the content)
                            if (kbIds.length > 0) {
                              setSelectedKnowledgeBookIds(kbIds);
                            }
                            
                            // Copy variable book assignment if any
                        const copiedVariableBookId = variableAssignments[currentAgent.id] || currentAgent.variableBookId || null;
                            if (copiedVariableBookId) {
                              const updatedVarAssignments = { ...variableAssignments, [newScriptId]: copiedVariableBookId };
                              persistVariableAssignments(updatedVarAssignments);
                              setSelectedVariableBookId(copiedVariableBookId);
                            }
                            
                            // Update URL
                        const newParams = new URLSearchParams(searchParams);
                            newParams.set('agent', newScriptId);
                        setSearchParams(newParams);
                            
                            // Update form data
                            setFormData({
                              name: response.script.name,
                              description: response.script.description || '',
                              content: displayScript,
                              voiceId: response.script.voiceId || '',
                              initialGreeting: response.script.initialGreeting || '',
                              prePhrase: response.script.prePhrase || 'ji',
                              prePhraseArray: response.script.prePhraseArray || [],
                              useCustomAnalysis: response.script.useCustomAnalysis || false,
                              customAnalysisPrompt: response.script.customAnalysisPrompt || '',
                              disableUnder35Retries: response.script.disableUnder35Retries || false,
                              successCriteria: response.script.successCriteria || [],
                              otherCriteria: response.script.otherCriteria || [],
                              maxRetries: response.script.maxRetries ? response.script.maxRetries.toString() : '',
                              retryIntervalMinutes: response.script.retryIntervalMinutes ? response.script.retryIntervalMinutes.toString() : '',
                              successMetric: response.script.successMetric || '',
                              variableDefinitions: response.script.variableDefinitions || {},
                              variableBookId: copiedVariableBookId,
                              ttsProvider: response.script.ttsProvider || null,
                              interruptions: response.script.interruptions !== undefined ? response.script.interruptions : false,
                            });
                            
                            alert('Script duplicated successfully!');
                          } else {
                            alert(response.error || 'Failed to duplicate script');
                          }
                        } catch (error) {
                          console.error('[Playground] Error duplicating script:', error);
                          alert('Error duplicating script: ' + (error.message || 'Unknown error'));
                        } finally {
                          setIsSavingAgent(false);
                        }
                      }
                    }
                  }}
                  disabled={!currentAgentId || isSavingAgent}
                  title={isSavingAgent ? 'Duplicating...' : 'Duplicate'}
                >
                  <Copy size={14} />
                  <span>Duplicate</span>
                </button>
                <div ref={testButtonRef} style={{ position: 'relative', zIndex: 10000 }}>
                <button
                  type="button"
                  className="btn btn-test-agent"
                    onClick={(e) => {
                      e.stopPropagation();
                      setShowTestPopup(!showTestPopup);
                  }}
                >
                  <Play size={14} />
                  <span>Test</span>
                </button>
                  {showTestPopup && (
                    <div
                      ref={testPopupRef}
                      onClick={(e) => e.stopPropagation()}
                      style={{
                        position: 'fixed',
                        top: testButtonRef.current ? `${testButtonRef.current.getBoundingClientRect().bottom + window.scrollY + 8}px` : 'auto',
                        right: testButtonRef.current ? `${window.innerWidth - testButtonRef.current.getBoundingClientRect().right}px` : 'auto',
                        backgroundColor: '#FFFFFF',
                        border: '1px solid #D1D5DB',
                        borderRadius: '8px',
                        boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                        zIndex: 10000,
                        minWidth: '120px',
                        padding: '4px'
                      }}
                    >
                      <button
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          setShowTestPopup(false);
                          setActiveTab('test-agent');
                        }}
                        style={{
                          width: '100%',
                          padding: '8px 12px',
                          textAlign: 'left',
                          background: 'transparent',
                          border: 'none',
                          borderRadius: '4px',
                          cursor: 'pointer',
                          fontSize: '14px',
                          color: '#111827',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#F9FAFB'}
                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                      >
                        <span>Chat</span>
                      </button>
                      <button
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          setShowTestPopup(false);
                          const shopParam = shop ? `?shop=${encodeURIComponent(shop)}&agent=${currentAgentId || 'new'}` : `?agent=${currentAgentId || 'new'}`;
                          navigate(`/test-call${shopParam}`);
                        }}
                        style={{
                          width: '100%',
                          padding: '8px 12px',
                          textAlign: 'left',
                          background: 'transparent',
                          border: 'none',
                          borderRadius: '4px',
                          cursor: 'pointer',
                          fontSize: '14px',
                          color: '#111827',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#F9FAFB'}
                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                      >
                        <span>Web</span>
                      </button>
                      <button
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          setShowTestPopup(false);
                          // Open the FloatingTestCallButton modal (same as widget)
                          const floatingButton = document.querySelector('.floating-test-call-btn');
                          if (floatingButton) {
                            floatingButton.click();
                          } else {
                            // Fallback: navigate to test-call page
                            const shopParam = shop ? `?shop=${encodeURIComponent(shop)}&agent=${currentAgentId || 'new'}` : `?agent=${currentAgentId || 'new'}`;
                            navigate(`/test-call${shopParam}`);
                          }
                        }}
                        style={{
                          width: '100%',
                          padding: '8px 12px',
                          textAlign: 'left',
                          background: 'transparent',
                          border: 'none',
                          borderRadius: '4px',
                          cursor: 'pointer',
                          fontSize: '14px',
                          color: '#111827',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#F9FAFB'}
                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                      >
                        <span>Call</span>
                      </button>
                    </div>
                  )}
                </div>
                <button
                  type="button"
                  className="btn btn-save-agent"
                  onClick={handleSubmit}
                  disabled={isSavingAgent}
                >
                  {isSavingAgent ? (
                    <>
                      <Loading inline size="small" text="Saving..." />
                    </>
                  ) : (
                    <>
                      <Save size={14} />
                      <span>Save Agent</span>
                    </>
                  )}
                </button>
              </div>
              </div>
            </div>

            {/* Script Tab Content */}
            {activeTab === 'script' && (
              <div className="tab-content tab-content--script">
                <div 
                  className="script-tab-grid"
                  style={{
                    display: 'flex',
                    width: '100%',
                    height: 'calc(100vh - 131px)',
                    overflow: 'hidden',
                    position: 'relative',
                  }}
                >
                  {/* Box 1: Script Content and other fields */}
                  <div 
                    className="script-tab-box-1"
                    style={{
                      width: `${leftPanelWidth}%`,
                      background: 'transparent',
                      padding: 0,
                      margin: 0,
                      position: 'relative',
                      display: 'flex',
                      flexDirection: 'column',
                      height: '100%',
                      overflow: 'hidden',
                      transition: isResizing ? 'none' : 'width 0.2s ease',
                    }}
                  >
                    <div className="script-editor-container">
                      {flowData && (
                        <div style={{ padding: '12px 24px', borderBottom: '1px solid #e5e7eb', background: '#f9fafb' }}>
                          <span style={{ fontSize: '12px', color: '#6b7280', fontStyle: 'italic' }}>
                            Flow-based script (edit in Flow Maker)
                          </span>
                        </div>
                      )}
                      {safeFormData ? (
                        <>
                          <div className="monaco-editor-direct">
                            <Editor
                              key={`monaco-editor-${currentAgentId || 'new'}-${scriptEditorKey}`}
                              height="100%"
                              language="plaintext"
                            value={safeFormData.content || ''}
                            onChange={(newValue) => {
                              try {
                                  setFormData(prev => ({ ...prev, content: newValue || '' }));
                              } catch (error) {
                                console.error('[Playground] Error updating content:', error);
                              }
                            }}
                              onMount={(editor, monaco) => {
                                // Store editor reference for typing effect
                                monacoEditorRef.current = editor;
                                
                                // White theme
                                monaco.editor.defineTheme('white-theme', {
                                  base: 'vs',
                                  inherit: true,
                                  rules: [],
                                  colors: {
                                    'editor.background': '#ffffff',
                                    'editor.foreground': '#111827',
                                    'editor.lineHighlightBackground': '#f9fafb',
                                    'editor.selectionBackground': '#dbeafe',
                                    'editorCursor.foreground': '#111827',
                                    'editorLineNumber.foreground': '#9ca3af',
                                    'editorLineNumber.activeForeground': '#111827',
                                    'editorGutter.background': '#ffffff',
                                    'scrollbar.shadow': '#00000000',
                                    'scrollbarSlider.background': '#0000001a',
                                    'editorSuggestWidget.background': '#ffffff',
                                    'editorSuggestWidget.border': '#E5E7EB',
                                    'editorSuggestWidget.selectedBackground': '#F3F4F6',
                                    'editorSuggestWidget.highlightForeground': '#4B5CFF',
                                    'scrollbarSlider.hoverBackground': '#00000033',
                                    'scrollbarSlider.activeBackground': '#0000004d',
                                  },
                                });
                                monaco.editor.setTheme('white-theme');
                                
                                // Pre-built variables for autocomplete
                                const preBuiltVariables = [
                                  { label: 'customerName', insertText: '{customerName}', detail: 'Customer Name', example: 'John Doe' },
                                  { label: 'orderNumber', insertText: '{orderNumber}', detail: 'Order Number', example: 'NK/23611' },
                                  { label: 'orderTotal', insertText: '{orderTotal}', detail: 'Order Total', example: '599' },
                                  { label: 'orderAmount', insertText: '{orderAmount}', detail: 'Order Amount', example: '599' },
                                  { label: 'deliveryAddress', insertText: '{deliveryAddress}', detail: 'Delivery Address', example: '123 Main St, City, State' },
                                  { label: 'address', insertText: '{address}', detail: 'Address', example: '123 Main St, City, State' },
                                  { label: 'city', insertText: '{city}', detail: 'City', example: 'Mumbai' },
                                  { label: 'orderDate', insertText: '{orderDate}', detail: 'Order Date', example: '2024-12-13' },
                                  { label: 'orderId', insertText: '{orderId}', detail: 'Order ID', example: '12345' },
                                  { label: 'productName', insertText: '{productName}', detail: 'Product Name', example: 'Product Name aur Another Product' },
                                  { label: 'repeat_order_dates', insertText: '{repeat_order_dates}', detail: 'Repeat Order Dates', example: '2024-12-01, 2024-12-05' },
                                  { label: 'repeat_order_count', insertText: '{repeat_order_count}', detail: 'Repeat Order Count', example: '3' }
                                ];

                                // Register completion provider for variable suggestions
                                monaco.languages.registerCompletionItemProvider('plaintext', {
                                  provideCompletionItems: (model, position, context) => {
                                    const textUntilPosition = model.getValueInRange({
                                      startLineNumber: position.lineNumber,
                                      startColumn: 1,
                                      endLineNumber: position.lineNumber,
                                      endColumn: position.column
                                    });
                                    
                                    // Check for single or double braces
                                    const lastSingleBrace = textUntilPosition.lastIndexOf('{');
                                    const lastDoubleBrace = textUntilPosition.lastIndexOf('{{');
                                    const lastCloseBrace = textUntilPosition.lastIndexOf('}');
                                    const lastDoubleCloseBrace = textUntilPosition.lastIndexOf('}}');
                                    
                                    // Determine if we're in single or double braces
                                    let isDoubleBrace = false;
                                    let openBracePos = lastSingleBrace;
                                    
                                    if (lastDoubleBrace > lastSingleBrace && lastDoubleBrace !== -1) {
                                      // Check if we're actually in double braces (not just two single braces)
                                      const textAfterDoubleBrace = textUntilPosition.substring(lastDoubleBrace + 2);
                                      // If there's no closing brace or we're before the closing brace, we're in double braces
                                      if (lastDoubleCloseBrace < lastDoubleBrace || textAfterDoubleBrace.length > 0) {
                                        isDoubleBrace = true;
                                        openBracePos = lastDoubleBrace;
                                      }
                                    }
                                    
                                    // Show suggestions if:
                                    // 1. User just typed { or {{ (triggered by trigger character)
                                    // 2. User is typing inside braces (even if } exists, as long as we're after the opening brace)
                                    // 3. Always show when trigger character is {
                                    const justTypedBrace = textUntilPosition.endsWith('{') || textUntilPosition.endsWith('{{');
                                    const isInsideBraces = openBracePos !== -1 && (
                                      openBracePos > lastCloseBrace || 
                                      (isDoubleBrace && (openBracePos > lastDoubleCloseBrace || lastDoubleCloseBrace === -1)) ||
                                      justTypedBrace
                                    );
                                    
                                    // Always show suggestions when { is typed or if we're inside braces
                                    if (context.triggerCharacter === '{' || isInsideBraces || justTypedBrace) {
                                      const textAfterBrace = openBracePos !== -1 
                                        ? textUntilPosition.substring(openBracePos + (isDoubleBrace ? 2 : 1))
                                        : '';
                                      
                                      // Remove any closing braces from the filter text
                                      const filterText = textAfterBrace.replace(/}.*$/, '').trim();
                                      
                                      // Filter variables based on what user has typed
                                      const filteredVars = preBuiltVariables.filter(variable => 
                                        filterText.length === 0 || variable.label.toLowerCase().includes(filterText.toLowerCase())
                                      );
                                      
                                      // Use all variables if no filter text, otherwise use filtered
                                      const varsToShow = filterText.length > 0 ? filteredVars : preBuiltVariables;
                                      
                                      const suggestions = varsToShow.map(variable => {
                                        const insertText = isDoubleBrace ? `{{${variable.label}}}` : `{${variable.label}}`;
                                        return {
                                          label: variable.label,
                                          kind: monaco.languages.CompletionItemKind.Variable,
                                          insertText: insertText,
                                          detail: variable.detail,
                                          documentation: `Example: ${variable.example}`,
                                          range: {
                                            startLineNumber: position.lineNumber,
                                            startColumn: openBracePos !== -1 ? (openBracePos + (isDoubleBrace ? 2 : 1)) : position.column,
                                            endLineNumber: position.lineNumber,
                                            endColumn: position.column
                                          }
                                        };
                                      });
                                      
                                      return { suggestions };
                                    }
                                    
                                    return { suggestions: [] };
                                  },
                                  triggerCharacters: ['{']
                                });
                                
                                // Enable variable suggestions but disable other code features
                                editor.updateOptions({
                                  minimap: { enabled: true },
                                  fontSize: 14,
                                  lineNumbers: 'on',
                                  wordWrap: 'on',
                                  automaticLayout: true,
                                  scrollBeyondLastLine: true,
                                  readOnly: false,
                                  domReadOnly: false,
                                  quickSuggestions: { other: true, comments: false, strings: false },
                                  suggestOnTriggerCharacters: true,
                                  acceptSuggestionOnEnter: 'on',
                                  acceptSuggestionOnCommitCharacter: true,
                                  wordBasedSuggestions: false,
                                  renderValidationDecorations: 'off',
                                  hover: { enabled: false },
                                  formatOnPaste: false,
                                  formatOnType: false,
                                  fontFamily: "'SF Mono', 'Monaco', 'Menlo', 'Courier New', monospace",
                                  scrollbar: {
                                    vertical: 'visible',
                                    horizontal: 'visible',
                                    verticalScrollbarSize: 10,
                                    horizontalScrollbarSize: 10,
                                  },
                                });
                                
                                // Ensure editor is editable
                                editor.updateOptions({ readOnly: false });
                                
                                // Focus editor
                                setTimeout(() => {
                                  editor.focus();
                                  editor.layout();
                                }, 100);
                              }}
                              options={{
                                minimap: { enabled: true },
                                fontSize: 14,
                                lineNumbers: 'on',
                                wordWrap: 'on',
                                automaticLayout: true,
                                scrollBeyondLastLine: true,
                                readOnly: false,
                                domReadOnly: false,
                                quickSuggestions: { other: true, comments: false, strings: false },
                                suggestOnTriggerCharacters: true,
                                acceptSuggestionOnEnter: 'on',
                                acceptSuggestionOnCommitCharacter: true,
                                wordBasedSuggestions: false,
                                renderValidationDecorations: 'off',
                                hover: { enabled: false },
                                formatOnPaste: false,
                                formatOnType: false,
                                theme: 'white-theme',
                                scrollbar: {
                                  vertical: 'visible',
                                  horizontal: 'visible',
                                  verticalScrollbarSize: 10,
                                  horizontalScrollbarSize: 10,
                                },
                              }}
                              theme="white-theme"
                            />
                          </div>
                          {isStreaming && (
                            <div style={{
                              position: 'absolute',
                              bottom: '16px',
                              right: '16px',
                              padding: '8px 12px',
                              background: '#4B5CFF',
                              color: 'white',
                              borderRadius: '6px',
                              fontSize: '12px',
                              fontWeight: '500',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '8px',
                              boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
                              zIndex: 10,
                              pointerEvents: 'none'
                            }}>
                              <svg className="animate-spin" width="14" height="14" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" opacity="0.25" />
                                <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" opacity="0.75" />
                              </svg>
                              Generating...
                            </div>
                          )}
                        </>
                      ) : (
                        <textarea
                          id="scriptContent"
                          name="content"
                          value={safeFormData?.content || ''}
                          onChange={handleFormChange}
                          required
                          placeholder="Write your call script here. Use template variables like {ORDER_NUMBER}, {CUSTOMER_NAME}, {ORDER_AMOUNT}, {CUSTOMER_ADDRESS}, and {DELIVERY_DATE} to personalize the conversation..."
                          style={{ 
                            width: '100%',
                            height: '100%',
                            border: 'none',
                            outline: 'none',
                            resize: 'none',
                            fontFamily: 'inherit',
                            fontSize: '14px',
                            lineHeight: '1.6',
                            padding: '24px',
                            boxSizing: 'border-box'
                          }}
                        />
                      )}
                    </div>
                {/* Bottom Sticky Bar with AI Tools */}
                <div className="script-box-bottom-bar">
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    {currentAgentMemoji && (
                      <div 
                        className="agent-memoji"
                        style={{ 
                          backgroundColor: currentAgentMemoji.background,
                          width: '1.25em',
                          height: '1.25em',
                          borderRadius: '6px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          flexShrink: 0,
                          overflow: 'hidden'
                        }}
                      >
                        <img 
                          src={currentAgentMemoji.memoji} 
                          alt="" 
                          style={{
                            width: '100%',
                            height: '100%',
                            objectFit: 'cover'
                          }}
                        />
                      </div>
                    )}
                    <div className="agent-name-editable">
                      {isEditingAgentName ? (
                        <input
                          type="text"
                          value={safeFormData?.name || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                          onBlur={() => setIsEditingAgentName(false)}
                          onKeyDown={(e) => {
                            if (e.key === 'Enter') {
                              e.preventDefault();
                              setIsEditingAgentName(false);
                            }
                            if (e.key === 'Escape') {
                              setIsEditingAgentName(false);
                            }
                          }}
                          autoFocus
                          className="agent-name-input"
                          placeholder="Agent Name"
                          required
                        />
                      ) : (
                        <div 
                          className="agent-name-display"
                          onClick={() => setIsEditingAgentName(true)}
                          title="Click to edit agent name"
                        >
                          <span>{safeFormData?.name || 'Untitled Agent'}</span>
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ marginLeft: '6px', opacity: 0.6 }}>
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                          </svg>
                        </div>
                      )}
                    </div>
                  <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      setShowSupportTicketModal(true);
                      setSupportTicketDescription('I need help with ...');
                      setSupportTicketSuccess(false);
                      setSupportTicketId('');
                    }}
                    style={{
                      padding: '4px 10px',
                      background: '#f5f5f7',
                      color: '#1d1d1f',
                      border: '1px solid #d2d2d7',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontSize: '11px',
                      fontWeight: '500',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px',
                      transition: 'all 0.2s',
                      whiteSpace: 'nowrap'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.background = '#e5e5e7';
                      e.currentTarget.style.borderColor = '#a1a1a6';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.background = '#f5f5f7';
                      e.currentTarget.style.borderColor = '#d2d2d7';
                    }}
                    title="Create support ticket for scripting help"
                  >
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      <path d="M9 9h6M9 13h6" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
                    </svg>
                    {(() => {
                      // Determine script type based on content
                      const scriptContent = safeFormData?.content || formData?.content || '';
                      let scriptType = 'Freeflow';
                      
                      // Check for Advanced: contains "##personality" OR "##environment"
                      const hasPersonality = scriptContent.includes('##personality');
                      const hasEnvironment = scriptContent.includes('##environment');
                      if (hasPersonality || hasEnvironment) {
                        scriptType = 'Advanced';
                      } else {
                        // Check for Simple: contains "## 1. PERSONALITY & IDENTITY" OR "## 2. OBJECTIVE & GOAL"
                        const hasPersonalitySection = scriptContent.includes('## 1. PERSONALITY & IDENTITY');
                        const hasObjectiveSection = scriptContent.includes('## 2. OBJECTIVE & GOAL');
                        if (hasPersonalitySection || hasObjectiveSection) {
                          scriptType = 'Simple';
                        }
                      }
                      
                      return scriptType;
                    })()}
                  </button>
                </div>
                  <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                  {/* HIDDEN: Flow Maker button - See HIDDEN_FEATURES.md for details */}
                  {/* <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      setShowFlowMaker(true);
                    }}
                      className="btn-flow-maker"
                  >
                    <img 
                      src="/images/Raycons Icons Pack (Community)/routing-8532067.svg" 
                      alt="Flow Maker" 
                      style={{ width: '16px', height: '16px' }}
                    />
                    Flow Maker
                  </button> */}
                  {/* Pricing Tag - shown based on selected voice provider (updates live) */}
                  {(() => {
                    // First check if a provider is selected in Voice & Interruptions tab - this takes priority
                    if (selectedVoiceProvider) {
                      let price = '5rs/minute'; // Default
                      if (selectedVoiceProvider === 'scalysis') {
                        price = '5rs/minute';
                      } else if (selectedVoiceProvider === 'sarvam') {
                        price = '3.8rs/minute';
                      } else if (selectedVoiceProvider === 'cartesia') {
                        price = '7rs/minute';
                      } else if (selectedVoiceProvider === 'elevenlabs') {
                        price = '13rs/minute';
                      }
                      
                      return (
                        <div
                          style={{
                            display: 'inline-flex',
                            alignItems: 'center',
                            padding: '4px 10px',
                            borderRadius: '12px',
                            fontSize: '11px',
                            fontWeight: '600',
                            color: '#111827',
                            background: '#F3F4F6',
                            border: '1px solid #E5E7EB',
                            whiteSpace: 'nowrap',
                            marginRight: '8px',
                            height: '24px'
                          }}
                        >
                          {price}
                        </div>
                      );
                    }
                    
                    // Fallback to voice-based pricing if no provider is selected
                    const currentVoiceId = safeFormData?.voiceId || formData?.voiceId;
                    if (!currentVoiceId) return null;
                    
                    const allVoicesWithSarvam = [...voices, ...getSarvamVoices()];
                    const currentVoice = allVoicesWithSarvam.find(v => v.id === currentVoiceId);
                    
                    // Determine provider based on voice properties, default to Scalysis
                    let price = '5rs/minute'; // Default to Scalysis
                    
                    if (currentVoice) {
                      const voiceName = (currentVoice.name || '').toLowerCase();
                      const voiceId = (currentVoice.id || '').toLowerCase();
                      
                      // Check for Sarvam
                      if (currentVoice.isSarvamVoice || currentVoice.source === 'sarvam' || currentVoice.provider === 'sarvam' || voiceId.startsWith('sarvam_') || voiceName.includes('sarvam')) {
                        price = '3.8rs/minute';
                      } 
                      // Check for Cartesia
                      else if (!currentVoice.isScalysisVoice && !currentVoice.isUltraRealistic && !currentVoice.isSarvamVoice && 
                               currentVoice.source !== 'sarvam' && currentVoice.provider !== 'sarvam' && 
                               !currentVoice.id?.startsWith('sarvam_') && 
                               currentVoice.source !== 'elevenlabs' && currentVoice.provider !== 'elevenlabs' &&
                               !currentVoice.id?.toLowerCase().includes('eleven') &&
                               !voiceName.includes('eleven')) {
                        price = '7rs/minute';
                      } 
                      // Check for Eleven Labs
                      else if (currentVoice.source === 'elevenlabs' || currentVoice.provider === 'elevenlabs' || voiceId.includes('eleven') || voiceName.includes('eleven')) {
                        price = '13rs/minute';
                      }
                      // Scalysis (default) - isScalysisVoice, isUltraRealistic, or fallback
                      else if (currentVoice.isScalysisVoice || currentVoice.isUltraRealistic === true) {
                        price = '5rs/minute';
                      }
                      // If we can't determine, default to Scalysis (already set)
                    }
                    
                    return (
                      <div
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          padding: '4px 10px',
                          borderRadius: '12px',
                          fontSize: '11px',
                          fontWeight: '600',
                          color: '#111827',
                          background: '#F3F4F6',
                          border: '1px solid #E5E7EB',
                          whiteSpace: 'nowrap',
                          marginRight: '8px',
                          height: '24px'
                        }}
                      >
                        {price}
                      </div>
                    );
                  })()}
                  <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      if (isGeneratingScript) {
                        handleStopGenerating();
                      } else {
                      handleOpenAIModal('write');
                      }
                    }}
                      className="btn-write-with-ai"
                      style={isGeneratingScript ? {
                        background: '#ef4444 !important',
                        border: '1px solid #dc2626 !important',
                        borderColor: '#dc2626 !important',
                        color: 'white !important',
                        boxShadow: '0 2px 0 #dc2626 !important',
                      } : {}}
                      onMouseEnter={isGeneratingScript ? (e) => {
                        e.currentTarget.style.setProperty('background', '#dc2626', 'important');
                        e.currentTarget.style.setProperty('border-color', '#b91c1c', 'important');
                      } : undefined}
                      onMouseLeave={isGeneratingScript ? (e) => {
                        e.currentTarget.style.setProperty('background', '#ef4444', 'important');
                        e.currentTarget.style.setProperty('border-color', '#dc2626', 'important');
                      } : undefined}
                  >
                    {isGeneratingScript ? (
                      <>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
                          <rect x="6" y="6" width="12" height="12" rx="1" fill="currentColor" />
                        </svg>
                        Stop Generating
                      </>
                    ) : (
                      <>
                    <img 
                      src="/images/Raycons Icons Pack (Community)/edit-2198435.svg" 
                      alt="Write with AI" 
                      style={{ width: '16px', height: '16px' }}
                    />
                    Write with AI
                      </>
                    )}
                  </button>
                  {/* HIDDEN: Edit with AI button - See HIDDEN_FEATURES.md for details */}
                  {/* <button
                    type="button"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      handleOpenAIModal('rewrite');
                    }}
                      className="btn-rewrite-with-claude"
                  >
                    <img 
                      src="/images/Raycons Icons Pack (Community)/edit-8535505.svg" 
                      alt="Edit with AI" 
                      style={{ width: '16px', height: '16px', filter: 'brightness(0) invert(1)' }}
                    />
                    Edit with AI
                  </button> */}
                </div>
              </div>
                </div>

                  {/* Resizable Divider */}
                  <div
                    onMouseDown={(e) => {
                      e.preventDefault();
                      setIsResizing(true);
                    }}
                    style={{
                      width: '4px',
                      background: isResizing ? '#4B5CFF' : '#e5e7eb',
                      cursor: 'col-resize',
                      flexShrink: 0,
                      position: 'relative',
                      zIndex: 10,
                      transition: 'background 0.2s',
                    }}
                    onMouseEnter={(e) => {
                      if (!isResizing) {
                        e.currentTarget.style.background = '#d1d5db';
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (!isResizing) {
                        e.currentTarget.style.background = '#e5e7eb';
                      }
                    }}
                  />

                  {/* Box 2: Note Taker, Description, and Initial Greeting */}
                  <div 
                    className="script-tab-box-2"
                    style={{
                      width: `${100 - leftPanelWidth}%`,
                      background: (box2ActiveTab === 'chat' || box2ActiveTab === 'edit-script')
                        ? `url('/images/Chat Bot UI.png')` 
                        : 'transparent',
                      backgroundSize: (box2ActiveTab === 'chat' || box2ActiveTab === 'edit-script') ? 'cover' : 'auto',
                      backgroundPosition: (box2ActiveTab === 'chat' || box2ActiveTab === 'edit-script') ? 'center' : 'initial',
                      backgroundRepeat: (box2ActiveTab === 'chat' || box2ActiveTab === 'edit-script') ? 'no-repeat' : 'repeat',
                      padding: 0,
                      height: '100%',
                      overflow: 'hidden',
                      display: 'flex',
                      flexDirection: 'column',
                      borderLeft: 'none',
                      transition: isResizing ? 'none' : 'width 0.2s ease, background 0.3s ease',
                    }}
                  >
                    <div 
                      className="script-box-2-content"
                      style={{
                        background: (box2ActiveTab === 'chat' || box2ActiveTab === 'edit-script') ? 'transparent' : '#fafbfc'
                      }}
                    >
                      {/* Box2 Tabs with Scroll */}
                      <div style={{ position: 'relative', marginBottom: '16px', borderBottom: '1px solid #e5e7eb' }}>
                        {/* Left Arrow */}
                        <button
                          type="button"
                          onClick={scrollTabsLeft}
                          disabled={!showLeftBlur}
                          style={{
                            position: 'absolute',
                            left: 0,
                            top: '50%',
                            transform: 'translateY(-50%)',
                            zIndex: 3,
                            background: !showLeftBlur ? '#f9fafb' : '#ffffff',
                            border: '1px solid #e5e7eb',
                            borderRadius: '4px',
                            width: '28px',
                            height: '28px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            cursor: showLeftBlur ? 'pointer' : 'not-allowed',
                            boxShadow: showLeftBlur ? '0 2px 4px rgba(0,0,0,0.1)' : 'none',
                            opacity: showLeftBlur ? 1 : 0.4,
                            transition: 'all 0.2s'
                          }}
                          onMouseEnter={(e) => {
                            if (showLeftBlur) e.currentTarget.style.background = '#f9fafb';
                          }}
                          onMouseLeave={(e) => {
                            if (showLeftBlur) e.currentTarget.style.background = '#ffffff';
                          }}
                        >
                          <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                            <path d="M7.5 9L4.5 6L7.5 3" stroke="#4B5CFF" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                          </svg>
                        </button>

                        {/* Left Blur Gradient */}
                        {showLeftBlur && (
                          <div
                            style={{
                              position: 'absolute',
                              left: 0,
                              top: 0,
                              bottom: 0,
                              width: '60px',
                              background: 'linear-gradient(to right, #fafbfc 0%, rgba(250, 251, 252, 0.8) 50%, transparent 100%)',
                              pointerEvents: 'none',
                              zIndex: 2
                            }}
                          />
                        )}

                        {/* Scrollable Tabs Container */}
                        <div
                          ref={tabsContainerRef}
                          style={{
                            display: 'flex',
                            gap: '8px',
                            overflowX: 'auto',
                            scrollbarWidth: 'none',
                            msOverflowStyle: 'none',
                            padding: '0 40px'
                          }}
                          onScroll={checkTabsScroll}
                        >
                        <button
                          type="button"
                          onClick={() => setBox2ActiveTab('settings')}
                          style={{
                            padding: '8px 16px',
                            background: 'transparent',
                            border: 'none',
                            borderBottom: box2ActiveTab === 'settings' ? '1px solid #4B5CFF' : '1px solid transparent',
                            color: box2ActiveTab === 'settings' ? '#4B5CFF' : '#6b7280',
                            fontSize: '14px',
                            fontWeight: box2ActiveTab === 'settings' ? '500' : '400',
                            cursor: 'pointer',
                              transition: 'all 0.2s',
                              whiteSpace: 'nowrap',
                              flexShrink: 0
                          }}
                        >
                          Settings
                        </button>
                          <button
                            type="button"
                            onClick={() => setBox2ActiveTab('edit-script')}
                          style={{ 
                              padding: '8px 16px',
                              background: 'transparent',
                              border: 'none',
                              borderBottom: box2ActiveTab === 'edit-script' ? '1px solid #4B5CFF' : '1px solid transparent',
                              color: box2ActiveTab === 'edit-script' ? '#4B5CFF' : '#6b7280',
                            fontSize: '14px',
                              fontWeight: box2ActiveTab === 'edit-script' ? '500' : '400',
                              cursor: 'pointer',
                              transition: 'all 0.2s',
                              whiteSpace: 'nowrap',
                              flexShrink: 0
                            }}
                          >
                            Edit Script
                        </button>
                          <button
                            type="button"
                            onClick={() => setBox2ActiveTab('chat')}
                            style={{ 
                              padding: '8px 16px',
                              background: 'transparent',
                              border: 'none',
                              borderBottom: box2ActiveTab === 'chat' ? '1px solid #4B5CFF' : '1px solid transparent',
                              color: box2ActiveTab === 'chat' ? '#4B5CFF' : '#6b7280',
                              fontSize: '14px',
                              fontWeight: box2ActiveTab === 'chat' ? '500' : '400',
                              cursor: 'pointer',
                              transition: 'all 0.2s',
                              whiteSpace: 'nowrap',
                              flexShrink: 0
                            }}
                          >
                            Test Agent
                          </button>
                        <button
                          type="button"
                          onClick={() => setBox2ActiveTab('variables')}
                  style={{ 
                            padding: '8px 16px',
                            background: 'transparent',
                            border: 'none',
                            borderBottom: box2ActiveTab === 'variables' ? '1px solid #4B5CFF' : '1px solid transparent',
                            color: box2ActiveTab === 'variables' ? '#4B5CFF' : '#6b7280',
                            fontSize: '14px',
                            fontWeight: box2ActiveTab === 'variables' ? '500' : '400',
                            cursor: 'pointer',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                              gap: '6px',
                              whiteSpace: 'nowrap',
                              flexShrink: 0
                          }}
                        >
                          Variables
                          {hasInvalidVariables && (
                            <span style={{
                              color: '#DC2626',
                              fontSize: '16px',
                              fontWeight: 'bold',
                              lineHeight: '1'
                            }}>!</span>
                          )}
                        </button>
                          <button
                            type="button"
                            onClick={() => {
                              setBox2ActiveTab('versions');
                              if (currentAgentId) {
                                loadScriptVersions(currentAgentId);
                              }
                            }}
                            style={{ 
                              padding: '8px 16px',
                              background: 'transparent',
                              border: 'none',
                              borderBottom: box2ActiveTab === 'versions' ? '1px solid #4B5CFF' : '1px solid transparent',
                              color: box2ActiveTab === 'versions' ? '#4B5CFF' : '#6b7280',
                              fontSize: '14px',
                              fontWeight: box2ActiveTab === 'versions' ? '500' : '400',
                              cursor: 'pointer',
                              transition: 'all 0.2s',
                              position: 'relative',
                              whiteSpace: 'nowrap',
                              flexShrink: 0
                            }}
                          >
                            Versions
                            {hasUnsavedChanges && (
                              <span style={{
                                position: 'absolute',
                                top: '4px',
                                right: '4px',
                                width: '6px',
                                height: '6px',
                                borderRadius: '50%',
                                background: '#ef4444',
                                border: '1px solid white'
                              }} />
                            )}
                          </button>
                        <button
                          type="button"
                          onClick={() => setBox2ActiveTab('viewer')}
                          style={{ 
                            padding: '8px 16px',
                            background: 'transparent',
                            border: 'none',
                            borderBottom: box2ActiveTab === 'viewer' ? '1px solid #4B5CFF' : '1px solid transparent',
                            color: box2ActiveTab === 'viewer' ? '#4B5CFF' : '#6b7280',
                            fontSize: '14px',
                            fontWeight: box2ActiveTab === 'viewer' ? '500' : '400',
                            cursor: 'pointer',
                              transition: 'all 0.2s',
                              whiteSpace: 'nowrap',
                              flexShrink: 0
                          }}
                        >
                          Viewer
                          </button>
                        </div>

                        {/* Right Blur Gradient */}
                        {showRightBlur && (
                          <div
                            style={{
                              position: 'absolute',
                              right: 0,
                              top: 0,
                              bottom: 0,
                              width: '60px',
                              background: 'linear-gradient(to left, #fafbfc 0%, rgba(250, 251, 252, 0.8) 50%, transparent 100%)',
                              pointerEvents: 'none',
                              zIndex: 2
                            }}
                          />
                        )}

                        {/* Right Arrow */}
                        <button
                          type="button"
                          onClick={scrollTabsRight}
                          disabled={!showRightBlur}
                          style={{
                            position: 'absolute',
                            right: 0,
                            top: '50%',
                            transform: 'translateY(-50%)',
                            zIndex: 3,
                            background: !showRightBlur ? '#f9fafb' : '#ffffff',
                            border: '1px solid #e5e7eb',
                            borderRadius: '4px',
                            width: '28px',
                            height: '28px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            cursor: showRightBlur ? 'pointer' : 'not-allowed',
                            boxShadow: showRightBlur ? '0 2px 4px rgba(0,0,0,0.1)' : 'none',
                            opacity: showRightBlur ? 1 : 0.4,
                            transition: 'all 0.2s'
                          }}
                          onMouseEnter={(e) => {
                            if (showRightBlur) e.currentTarget.style.background = '#f9fafb';
                          }}
                          onMouseLeave={(e) => {
                            if (showRightBlur) e.currentTarget.style.background = '#ffffff';
                          }}
                        >
                          <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                            <path d="M4.5 3L7.5 6L4.5 9" stroke="#4B5CFF" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                          </svg>
                        </button>
                  </div>

                      {/* Settings Tab Content */}
                      <div className="box2-tab-content-wrapper">
                      {box2ActiveTab === 'settings' && (
                        <div className="box2-tab-content" style={{ overflowY: 'auto', height: '100%' }}>
                        <>
                    {/* Note Taker Section - Collapsible */}
                    {!showNoteTakerInBox2 ? (
                      <div style={{ marginBottom: '24px' }}>
                        <button
                          type="button"
                          onClick={() => setShowNoteTakerInBox2(true)}
                          style={{
                            width: '100%',
                            padding: '12px 16px',
                            background: '#F9FAFB',
                            border: '1px solid #E5E7EB',
                            borderRadius: '8px',
                            fontSize: '14px',
                            fontWeight: '500',
                            color: '#111827',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px',
                            transition: 'all 0.2s'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.background = '#F3F4F6';
                            e.currentTarget.style.borderColor = '#D1D5DB';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.background = '#F9FAFB';
                            e.currentTarget.style.borderColor = '#E5E7EB';
                          }}
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <path d="M14 2v6h6" />
                            <path d="M16 13H8" />
                            <path d="M16 17H8" />
                            <path d="M10 9H8" />
                          </svg>
                          Note Taker
                        </button>
                      </div>
                    ) : (
                      <div style={{ marginBottom: '24px', padding: '16px', background: '#FFFFFF', border: '1px solid #E5E7EB', borderRadius: '10px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                          <h3 style={{ margin: 0, fontSize: '16px', fontWeight: '600', color: '#111827' }}>
                            Note Taker
                          </h3>
                          <button
                            type="button"
                            onClick={() => setShowNoteTakerInBox2(false)}
                            style={{
                              background: 'none',
                              border: 'none',
                              fontSize: '24px',
                              color: '#6b7280',
                              cursor: 'pointer',
                              padding: '0',
                              width: '24px',
                              height: '24px',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              lineHeight: '1'
                            }}
                          >
                            Ã—
                          </button>
                        </div>
                        <p style={{ margin: '0 0 16px 0', fontSize: '13px', color: '#6b7280' }}>
                          Track changes to your script. Use + to add notes, - to remove. Click "Make Changes" to use these notes with Write with AI.
                        </p>
                        <div style={{ marginBottom: '16px' }}>
                          <textarea
                            value={noteTakerContent}
                            onChange={(e) => setNoteTakerContent(e.target.value)}
                            placeholder="Add your notes here...&#10;Use + for additions, - for removals&#10;Example:&#10;+ Add greeting section&#10;- Remove old pricing info&#10;+ Update delivery timeline"
                            style={{
                              width: '100%',
                              minHeight: '150px',
                              padding: '12px',
                              border: '1px solid #d1d5db',
                              borderRadius: '8px',
                              fontSize: '14px',
                              fontFamily: 'monospace',
                              resize: 'vertical',
                              lineHeight: '1.6'
                            }}
                          />
                        </div>
                        {/* Git-like diff preview */}
                        {noteTakerContent.trim() && (
                          <div style={{ 
                            marginBottom: '16px', 
                            padding: '12px', 
                            background: '#F9FAFB', 
                            border: '1px solid #E5E7EB',
                            borderRadius: '8px',
                            fontSize: '12px',
                            fontFamily: 'monospace',
                            maxHeight: '150px',
                            overflow: 'auto'
                          }}>
                            {noteTakerContent.split('\n').map((line, idx) => {
                              const trimmed = line.trim();
                              if (!trimmed) return <div key={idx} style={{ height: '4px' }} />;
                              
                              const isAdd = trimmed.startsWith('+');
                              const isRemove = trimmed.startsWith('-');
                              
                              return (
                                <div
                                  key={idx}
                                  style={{
                                    display: 'flex',
                                    alignItems: 'flex-start',
                                    padding: '2px 0',
                                    color: isAdd ? '#059669' : isRemove ? '#DC2626' : '#374151',
                                    background: isAdd ? '#ECFDF5' : isRemove ? '#FEF2F2' : 'transparent',
                                    paddingLeft: '8px',
                                    paddingRight: '8px',
                                    borderLeft: isAdd ? '3px solid #10b981' : isRemove ? '3px solid #EF4444' : 'none'
                                  }}
                                >
                                  <span style={{ 
                                    marginRight: '8px', 
                                    fontWeight: '600',
                                    color: isAdd ? '#059669' : isRemove ? '#DC2626' : '#9CA3AF',
                                    minWidth: '20px',
                                    textAlign: 'right'
                                  }}>
                                    {isAdd ? '+' : isRemove ? '-' : ' '}
                                  </span>
                                  <span style={{ flex: 1, wordBreak: 'break-word' }}>
                                    {isAdd || isRemove ? trimmed.substring(1).trim() : trimmed}
                                  </span>
                                </div>
                              );
                            })}
                          </div>
                        )}
                        <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end', flexWrap: 'wrap' }}>
                          <button
                            type="button"
                            onClick={() => {
                              setNoteTakerContent('');
                            }}
                            style={{
                              padding: '8px 16px',
                              border: '1px solid #d1d5db',
                              borderRadius: '6px',
                              background: 'white',
                              color: '#374151',
                              cursor: 'pointer',
                              fontSize: '13px',
                              fontWeight: '500'
                            }}
                          >
                            Clear
                          </button>
                          <button
                            type="button"
                            onClick={() => {
                              setShowNoteTakerInBox2(false);
                            }}
                            style={{
                              padding: '8px 16px',
                              border: '1px solid #d1d5db',
                              borderRadius: '6px',
                              background: 'white',
                              color: '#374151',
                              cursor: 'pointer',
                              fontSize: '13px',
                              fontWeight: '500'
                            }}
                          >
                            Close
                          </button>
                          <button
                            type="button"
                            onClick={() => {
                              if (noteTakerContent.trim()) {
                                handleOpenAIModal('write');
                                setShowNoteTakerInBox2(false);
                              } else {
                                alert('Please add some notes first');
                              }
                            }}
                            disabled={!noteTakerContent.trim()}
                            style={{
                              padding: '8px 16px',
                              border: 'none',
                              borderRadius: '6px',
                              background: '#10b981',
                              color: 'white',
                              cursor: noteTakerContent.trim() ? 'pointer' : 'not-allowed',
                              fontSize: '13px',
                              fontWeight: '500',
                              opacity: noteTakerContent.trim() ? 1 : 0.5
                            }}
                          >
                            Make Changes
                          </button>
                        </div>
                      </div>
                    )}

                    {/* Voice & Interruptions Section - Collapsible */}
                    <CollapsibleSection 
                      title="Voice & Interruptions" 
                      sectionKey="voice" 
                      isOpen={openSettingsSections.voice ?? false}
                      onToggle={toggleSettingsSection}
                      icon={
                        <img 
                          src="/images/Raycons Icons Pack (Community)/call-2198440.svg" 
                          alt="Voice" 
                          style={{ width: '18px', height: '18px' }}
                        />
                      }
                    >
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        {/* Currently Selected Voice */}
                        <div className="form-group">
                          <label style={{ marginBottom: '8px', display: 'block', fontSize: '14px', fontWeight: '500', color: '#111827' }}>
                            Current Voice
                      </label>
                          <div style={{
                            padding: '10px 12px',
                            border: '1px solid #D1D5DB',
                            borderRadius: '8px',
                            fontSize: '14px',
                            color: safeFormData?.voiceId ? '#111827' : '#9CA3AF',
                            background: '#F9FAFB',
                            minHeight: '40px',
                            display: 'flex',
                            alignItems: 'center'
                          }}>
                            {(() => {
                              const currentVoiceId = safeFormData?.voiceId;
                              if (!currentVoiceId) {
                                return 'No voice selected';
                              }
                              const allVoicesWithSarvam = [...voices, ...getSarvamVoices()];
                              const currentVoice = allVoicesWithSarvam.find(v => v.id === currentVoiceId);
                              if (!currentVoice) {
                                return currentVoiceId;
                              }
                              return formatPremiumVoiceName(currentVoice) || currentVoice.name || currentVoiceId;
                            })()}
                          </div>
                        </div>

                        {/* Voice Provider Buckets */}
                        <div className="form-group">
                          <label style={{ marginBottom: '8px', display: 'block', fontSize: '14px', fontWeight: '500', color: '#111827' }}>
                            Select Provider
                          </label>
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '12px' }}>
                            {/* Scalysis */}
                            <button
                              type="button"
                              onClick={() => {
                                const newProvider = selectedVoiceProvider === 'scalysis' ? '' : 'scalysis';
                                setSelectedVoiceProvider(newProvider);
                                // Load voices when provider is selected
                                if (newProvider === 'scalysis') {
                                  fetchVoices('');
                                }
                              }}
                              style={{
                                padding: '10px 12px',
                                border: `2px solid ${selectedVoiceProvider === 'scalysis' ? '#111827' : '#D1D5DB'}`,
                                borderRadius: '8px',
                                fontSize: '13px',
                                fontWeight: selectedVoiceProvider === 'scalysis' ? '600' : '400',
                                color: selectedVoiceProvider === 'scalysis' ? '#111827' : '#6B7280',
                                background: selectedVoiceProvider === 'scalysis' ? '#F9FAFB' : '#FFFFFF',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                gap: '4px'
                              }}
                            >
                              <span>Scalysis</span>
                              <span style={{ fontSize: '11px', color: '#6B7280', fontWeight: '400' }}>5rs/minute</span>
                            </button>
                            
                            {/* Sarvam */}
                            <button
                              type="button"
                              onClick={() => {
                                const newProvider = selectedVoiceProvider === 'sarvam' ? '' : 'sarvam';
                                setSelectedVoiceProvider(newProvider);
                                // Load voices when provider is selected
                                if (newProvider === 'sarvam') {
                                  fetchVoices('');
                                }
                              }}
                              style={{
                                padding: '10px 12px',
                                border: `2px solid ${selectedVoiceProvider === 'sarvam' ? '#111827' : '#D1D5DB'}`,
                                borderRadius: '8px',
                                fontSize: '13px',
                                fontWeight: selectedVoiceProvider === 'sarvam' ? '600' : '400',
                                color: selectedVoiceProvider === 'sarvam' ? '#111827' : '#6B7280',
                                background: selectedVoiceProvider === 'sarvam' ? '#F9FAFB' : '#FFFFFF',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                gap: '4px'
                              }}
                            >
                              <span>Sarvam</span>
                              <span style={{ fontSize: '11px', color: '#6B7280', fontWeight: '400' }}>3.8rs/minute</span>
                            </button>
                            
                            {/* Cartesia */}
                            <button
                              type="button"
                              onClick={() => {
                                const newProvider = selectedVoiceProvider === 'cartesia' ? '' : 'cartesia';
                                setSelectedVoiceProvider(newProvider);
                                // Load voices when provider is selected
                                if (newProvider === 'cartesia') {
                                  fetchVoices('');
                                }
                              }}
                              style={{
                                padding: '10px 12px',
                                border: `2px solid ${selectedVoiceProvider === 'cartesia' ? '#111827' : '#D1D5DB'}`,
                                borderRadius: '8px',
                                fontSize: '13px',
                                fontWeight: selectedVoiceProvider === 'cartesia' ? '600' : '400',
                                color: selectedVoiceProvider === 'cartesia' ? '#111827' : '#6B7280',
                                background: selectedVoiceProvider === 'cartesia' ? '#F9FAFB' : '#FFFFFF',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                gap: '4px'
                              }}
                            >
                              <span>Cartesia</span>
                              <span style={{ fontSize: '11px', color: '#6B7280', fontWeight: '400' }}>7rs/minute</span>
                            </button>
                            
                            {/* Eleven Labs */}
                            <button
                              type="button"
                              onClick={() => {
                                const newProvider = selectedVoiceProvider === 'elevenlabs' ? '' : 'elevenlabs';
                                setSelectedVoiceProvider(newProvider);
                                // Load voices when provider is selected
                                if (newProvider === 'elevenlabs') {
                                  fetchVoices('');
                                }
                              }}
                              style={{
                                padding: '10px 12px',
                                border: `2px solid ${selectedVoiceProvider === 'elevenlabs' ? '#111827' : '#D1D5DB'}`,
                                borderRadius: '8px',
                                fontSize: '13px',
                                fontWeight: selectedVoiceProvider === 'elevenlabs' ? '600' : '400',
                                color: selectedVoiceProvider === 'elevenlabs' ? '#111827' : '#6B7280',
                                background: selectedVoiceProvider === 'elevenlabs' ? '#F9FAFB' : '#FFFFFF',
                                cursor: 'pointer',
                                transition: 'all 0.2s',
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                gap: '4px'
                              }}
                            >
                              <span>Eleven Labs</span>
                              <span style={{ fontSize: '11px', color: '#6B7280', fontWeight: '400' }}>13rs/minute</span>
                            </button>
                          </div>
                        </div>

                        {/* Voice Search */}
                        <div className="form-group">
                          <label style={{ marginBottom: '8px', display: 'block', fontSize: '14px', fontWeight: '500', color: '#111827' }}>
                            Search Voices
                          </label>
                      <input
                        type="text"
                            placeholder="Search by name or language..."
                            value={voiceSearchInSettings}
                            onChange={(e) => {
                              setVoiceSearchInSettings(e.target.value);
                              // Load voices if not already loaded
                              if (voices.length === 0) {
                                fetchVoices('');
                              }
                            }}
                        style={{
                          width: '100%',
                          padding: '10px 12px',
                          border: '1px solid #D1D5DB',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontFamily: 'inherit',
                          color: '#111827',
                          background: '#FFFFFF'
                        }}
                      />
                    </div>

                        {/* Voice Results List - Show when provider is selected OR search query exists */}
                        {(selectedVoiceProvider || voiceSearchInSettings.trim()) && (
                          <div style={{
                            maxHeight: '300px',
                            overflowY: 'auto',
                            border: '1px solid #E5E7EB',
                            borderRadius: '8px',
                            padding: '8px',
                            background: '#FFFFFF'
                          }}>
                            {(() => {
                              const searchLower = (voiceSearchInSettings || '').toLowerCase();
                              
                              // Filter by provider first - include ALL voice types (Sarvam, Cartesia, Scalysis v1, etc.)
                              const allVoicesWithAllProviders = [
                                ...voices, 
                                ...getSarvamVoices(), 
                                ...getCartesiaVoices(), 
                                ...getScalysisV1Voices(), 
                                ...getElevenLabsVoices(),
                                ...getRimeVoices(),
                                ...getHumeVoices()
                              ];
                              let providerFilteredVoices = allVoicesWithAllProviders;
                              if (selectedVoiceProvider) {
                                providerFilteredVoices = allVoicesWithAllProviders.filter(v => {
                                  if (selectedVoiceProvider === 'scalysis') {
                                    // Scalysis includes: Scalysis V1 (Inworld), Scalysis V3 (Ultra Realistic), and default Scalysis voices
                                    return v.isScalysisVoice || v.isUltraRealistic === true || v.isScalysisV1Voice || v.id?.startsWith('scalysis_v1_');
                                  } else if (selectedVoiceProvider === 'sarvam') {
                                    return v.isSarvamVoice || v.source === 'sarvam' || v.provider === 'sarvam' || (v.id && v.id.startsWith('sarvam_')) || (v.name && v.name.toLowerCase().includes('sarvam'));
                                  } else if (selectedVoiceProvider === 'cartesia') {
                                    // Cartesia voices: all Cartesia voices (not Scalysis, not Sarvam, not ElevenLabs, etc.)
                                    return !v.isScalysisVoice && !v.isUltraRealistic && !v.isSarvamVoice && !v.isScalysisV1Voice &&
                                           v.source !== 'sarvam' && v.provider !== 'sarvam' && 
                                           !v.id?.startsWith('sarvam_') && !v.id?.startsWith('scalysis_v1_') &&
                                           v.source !== 'elevenlabs' && v.provider !== 'elevenlabs' &&
                                           !v.id?.toLowerCase().includes('eleven') &&
                                           !v.name?.toLowerCase().includes('eleven') &&
                                           v.source !== 'rime' && v.provider !== 'rime' &&
                                           v.source !== 'hume' && v.provider !== 'hume';
                                  } else if (selectedVoiceProvider === 'elevenlabs') {
                                    return v.isElevenLabsVoice || v.source === 'elevenlabs' || v.provider === 'elevenlabs' || (v.name && v.name.toLowerCase().includes('eleven')) || (v.id && v.id.toLowerCase().includes('eleven'));
                                  } else if (selectedVoiceProvider === 'rime') {
                                    return v.isRimeVoice || v.source === 'rime' || v.provider === 'rime' || (v.id && v.id.startsWith('rime_'));
                                  } else if (selectedVoiceProvider === 'hume') {
                                    return v.isHumeVoice || v.source === 'hume' || v.provider === 'hume' || (v.id && v.id.startsWith('hume_'));
                                  }
                                  return true;
                                });
                              }
                              
                              // Then filter by search query (name, ID, description, or language) if search query exists
                              let filteredVoices = providerFilteredVoices;
                              if (searchLower.trim()) {
                                filteredVoices = providerFilteredVoices.filter(v => {
                                  const nameMatch = v.name && v.name.toLowerCase().includes(searchLower);
                                  const idMatch = v.id && v.id.toLowerCase().includes(searchLower);
                                  const descMatch = v.description && v.description.toLowerCase().includes(searchLower);
                                  const langInfo = getPrimaryAndOtherLanguages(v);
                                  const langMatch = langInfo.primary && langInfo.primary.toLowerCase().includes(searchLower);
                                  return nameMatch || idMatch || descMatch || langMatch;
                                });
                              }
                              filteredVoices = filteredVoices.slice(0, 50); // Limit to 50 results

                              if (filteredVoices.length === 0) {
                                return (
                                  <div style={{ padding: '12px', textAlign: 'center', color: '#9CA3AF', fontSize: '13px' }}>
                                    No voices found
                                  </div>
                                );
                              }

                              return (
                                <>
                                  <div style={{ padding: '8px 12px', fontSize: '12px', color: '#6B7280', borderBottom: '1px solid #E5E7EB', marginBottom: '8px' }}>
                                    {filteredVoices.length} result{filteredVoices.length !== 1 ? 's' : ''}
                                  </div>
                                  {filteredVoices.map((voice) => {
                                const isSelected = safeFormData?.voiceId === voice.id;
                                const voiceName = formatPremiumVoiceName(voice) || voice.name || voice.id;
                                    const langInfo = getPrimaryAndOtherLanguages(voice);
                                    const langText = langInfo.others > 0 ? `${langInfo.primary} + ${langInfo.others} other${langInfo.others !== 1 ? 's' : ''}` : langInfo.primary;
                                    
                                return (
                                  <div
                                    key={voice.id}
                                    onClick={() => {
                                      setFormData(prev => ({ ...prev, voiceId: voice.id }));
                                    }}
                                    style={{
                                      padding: '10px 12px',
                                      borderRadius: '6px',
                                      cursor: 'pointer',
                                      marginBottom: '4px',
                                      background: isSelected ? '#F0F4FF' : 'transparent',
                                      border: `1px solid ${isSelected ? '#4B5CFF' : '#E5E7EB'}`,
                                          transition: 'all 0.2s',
                                          display: 'flex',
                                          alignItems: 'center',
                                          justifyContent: 'space-between',
                                          gap: '12px'
                                    }}
                                    onMouseEnter={(e) => {
                                      if (!isSelected) {
                                        e.currentTarget.style.background = '#F9FAFB';
                                        e.currentTarget.style.borderColor = '#D1D5DB';
                                      }
                                    }}
                                    onMouseLeave={(e) => {
                                      if (!isSelected) {
                                        e.currentTarget.style.background = 'transparent';
                                        e.currentTarget.style.borderColor = '#E5E7EB';
                                      }
                                    }}
                                  >
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                    <div style={{ 
                                      fontSize: '14px', 
                                      fontWeight: isSelected ? '600' : '500',
                                      color: isSelected ? '#4B5CFF' : '#111827',
                                      marginBottom: '2px'
                                    }}>
                                      {voiceName}
                                    </div>
                                      <div style={{ fontSize: '12px', color: '#6B7280' }}>
                                            {langText}
                                      </div>
                                        </div>
                                        <button
                                          type="button"
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            handleInlineVoicePreview(voice.id, e);
                                          }}
                                          style={{
                                            padding: '6px',
                                            border: 'none',
                                            background: 'transparent',
                                            cursor: 'pointer',
                                            borderRadius: '4px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            transition: 'background 0.2s',
                                            color: playingVoiceId === voice.id ? '#4B5CFF' : '#6B7280'
                                          }}
                                          onMouseEnter={(e) => {
                                            e.currentTarget.style.background = '#F3F4F6';
                                          }}
                                          onMouseLeave={(e) => {
                                            e.currentTarget.style.background = 'transparent';
                                          }}
                                        >
                                          {playingVoiceId === voice.id ? (
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                              <rect x="6" y="4" width="4" height="16" fill="currentColor" />
                                              <rect x="14" y="4" width="4" height="16" fill="currentColor" />
                                            </svg>
                                          ) : (
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                              <polygon points="5 3 19 12 5 21 5 3" fill="currentColor" />
                                            </svg>
                                          )}
                                        </button>
                                  </div>
                                );
                                  })}
                                </>
                              );
                            })()}
                          </div>
                        )}

                        {/* Interruptions Settings */}
                        <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px solid #E5E7EB' }}>
                          <div className="form-group">
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                              <label style={{ fontSize: '14px', fontWeight: '500', color: '#111827' }}>
                                Enable Interruptions
                              </label>
                              <label className="profile-toggle-switch" style={{ margin: 0 }}>
                                <input
                                  type="checkbox"
                                  checked={safeFormData?.interruptions || formData?.interruptions || false}
                                  onChange={(e) => {
                                    setFormData(prev => ({ ...prev, interruptions: e.target.checked }));
                                  }}
                                />
                                <span className="profile-toggle-slider"></span>
                              </label>
                            </div>
                            {(safeFormData?.interruptions || formData?.interruptions) && (
                              <div style={{ marginTop: '12px', opacity: 0.5, pointerEvents: 'none' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                                  <label style={{ fontSize: '13px', fontWeight: '500', color: '#9CA3AF' }}>
                                    Interruption Duration (seconds)
                                  </label>
                                  <span style={{ fontSize: '13px', fontWeight: '600', color: '#9CA3AF', minWidth: '50px', textAlign: 'right' }}>
                                    {(safeFormData?.interruptionDuration || formData?.interruptionDuration || 1).toFixed(1)}
                                  </span>
                                </div>
                                <div style={{ position: 'relative', padding: '8px 0' }}>
                                  <div style={{ 
                                    display: 'flex', 
                                    justifyContent: 'space-between', 
                                    alignItems: 'center',
                                    marginBottom: '8px'
                                  }}>
                                    <span style={{ fontSize: '12px', color: '#9CA3AF' }}>0.5</span>
                                    <span style={{ fontSize: '12px', color: '#9CA3AF' }}>3</span>
                                  </div>
                                  <div
                                    style={{
                                      position: 'relative',
                                      width: '100%',
                                      height: '4px',
                                      background: '#E5E7EB',
                                      borderRadius: '2px',
                                      cursor: 'not-allowed'
                                    }}
                                    onMouseDown={(e) => {
                                      e.preventDefault();
                                      const slider = e.currentTarget;
                                      const rect = slider.getBoundingClientRect();
                                      
                                      const currentValue = safeFormData?.interruptionDuration || formData?.interruptionDuration || 1;
                                      
                                      const updateDuration = (clientX) => {
                                        const x = clientX - rect.left;
                                        const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
                                        // Map 0-100% to 0.5-3 seconds
                                        const newValue = 0.5 + (percentage / 100) * 2.5;
                                        // Round to nearest 0.1
                                        const roundedValue = Math.round(newValue * 10) / 10;
                                        setFormData(prev => ({ ...prev, interruptionDuration: roundedValue }));
                                      };
                                      
                                      updateDuration(e.clientX);
                                      
                                      const handleMouseMove = (moveEvent) => {
                                        const newRect = slider.getBoundingClientRect();
                                        const x = moveEvent.clientX - newRect.left;
                                        const percentage = Math.max(0, Math.min(100, (x / newRect.width) * 100));
                                        const newValue = 0.5 + (percentage / 100) * 2.5;
                                        const roundedValue = Math.round(newValue * 10) / 10;
                                        setFormData(prev => ({ ...prev, interruptionDuration: roundedValue }));
                                      };
                                      
                                      const handleMouseUp = () => {
                                        document.removeEventListener('mousemove', handleMouseMove);
                                        document.removeEventListener('mouseup', handleMouseUp);
                                      };
                                      
                                      document.addEventListener('mousemove', handleMouseMove);
                                      document.addEventListener('mouseup', handleMouseUp);
                                    }}
                                  >
                                    <div
                                      style={{
                                        position: 'absolute',
                                        left: 0,
                                        top: 0,
                                        width: `${((safeFormData?.interruptionDuration || formData?.interruptionDuration || 1) - 0.5) / 2.5 * 100}%`,
                                        height: '100%',
                                        background: '#9CA3AF',
                                        borderRadius: '2px',
                                        transition: 'width 0.1s ease'
                                      }}
                                    />
                                    <div
                                      style={{
                                        position: 'absolute',
                                        left: `${((safeFormData?.interruptionDuration || formData?.interruptionDuration || 1) - 0.5) / 2.5 * 100}%`,
                                        top: '50%',
                                        transform: 'translate(-50%, -50%)',
                                        width: '16px',
                                        height: '16px',
                                        background: '#9CA3AF',
                                        borderRadius: '50%',
                                        cursor: 'not-allowed',
                                        boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)'
                                      }}
                                    />
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </CollapsibleSection>

                    {/* Intro Message Section - Collapsible */}
                    <CollapsibleSection 
                      title="Intro Message" 
                      sectionKey="callSettings" 
                      isOpen={openSettingsSections.callSettings ?? false}
                      onToggle={toggleSettingsSection}
                      icon={
                        <img 
                          src="/images/Raycons Icons Pack (Community)/message-2198428.svg" 
                          alt="Intro Message" 
                          style={{ width: '18px', height: '18px' }}
                        />
                      }
                    >
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    {/* First Message (After Pickup) Field */}
                    <div className="form-group">
                      <label htmlFor="initialGreeting" style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#111827', marginBottom: '8px' }}>
                          First Message (After Pickup)
                        </label>
                      
                      <textarea
                        key="initialGreeting-textarea"
                        id="initialGreeting"
                        name="initialGreeting"
                        value={formData?.initialGreeting || ''}
                        onChange={handleFormChange}
                        placeholder="Hello [CUSTOMER_NAME] ji se baat ho rahi hai?"
                        style={{
                          width: '100%',
                          minHeight: '100px',
                          maxHeight: '200px',
                          padding: '12px',
                          border: '1px solid #D1D5DB',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontFamily: 'inherit',
                          resize: 'vertical',
                          lineHeight: '1.5',
                          color: '#111827',
                          background: '#FFFFFF',
                          marginBottom: '16px'
                        }}
                      />
                        </div>

                    {/* Description Field */}
                        <div className="form-group">
                      <label htmlFor="description" style={{ marginBottom: '8px', display: 'block', fontSize: '14px', fontWeight: '500', color: '#111827' }}>
                        Description
                      </label>
                      
                      <input
                        type="text"
                        id="description"
                        name="description"
                        value={safeFormData?.description || ''}
                        onChange={handleFormChange}
                        placeholder="Enter description..."
                        style={{
                          width: '100%',
                          padding: '10px 12px',
                          border: '1px solid #D1D5DB',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontFamily: 'inherit',
                          lineHeight: '1.5',
                          color: '#111827',
                          background: '#FFFFFF'
                        }}
                      />
                        </div>
                      </div>
                    </CollapsibleSection>

                    {/* Call Settings Section - Collapsible */}
                    <CollapsibleSection 
                      title="Time Limit Settings" 
                      sectionKey="callSettingsAdvanced" 
                      isOpen={openSettingsSections.callSettingsAdvanced ?? false}
                      onToggle={toggleSettingsSection}
                      icon={
                        <img 
                          src="/images/Raycons Icons Pack (Community)/setting-8532400.svg" 
                          alt="Call Settings" 
                          style={{ width: '18px', height: '18px' }}
                        />
                      }
                    >
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        {/* Maximum Call Duration */}
                        <div>
                          <label htmlFor="maxCallDuration" style={{ display: 'block', fontSize: '12px', fontWeight: '500', color: '#6b7280', marginBottom: '6px' }}>
                            Maximum Call Duration (seconds)
                          </label>
                          <input
                            key="maxCallDuration-input"
                            type="number"
                            id="maxCallDuration"
                            name="maxCallDuration"
                            min="0"
                            step="1"
                            value={formData?.maxCallDuration !== undefined && formData?.maxCallDuration !== null ? formData.maxCallDuration : (safeFormData?.maxCallDuration !== undefined && safeFormData?.maxCallDuration !== null ? safeFormData.maxCallDuration : '')}
                            onChange={(e) => {
                              const value = e.target.value === '' ? null : parseInt(e.target.value);
                              setFormData(prev => ({ ...prev, maxCallDuration: value }));
                            }}
                            placeholder="No limit"
                            style={{
                              width: '100%',
                              padding: '8px 12px',
                              border: '1px solid #D1D5DB',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontFamily: 'inherit',
                              color: '#111827',
                              background: '#FFFFFF',
                              transition: 'all 0.4s ease'
                            }}
                          />
                        </div>

                        {/* Inactivity Period */}
                        <div>
                          <label htmlFor="inactivityPeriod" style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px', fontWeight: '500', color: '#6b7280', marginBottom: '6px' }}>
                            Inactivity Period
                            <span
                              title="Auto cut the call after how many seconds"
                              style={{ cursor: 'help', display: 'inline-flex', alignItems: 'center' }}
                            >
                              <HelpCircle size={14} color="#9CA3AF" />
                            </span>
                          </label>
                          <select
                            id="inactivityPeriod"
                            value={inactivityPeriod}
                            onChange={(e) => setInactivityPeriod(Number(e.target.value))}
                              style={{
                                width: '100%',
                              padding: '8px 12px',
                              border: '1px solid #D1D5DB',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontFamily: 'inherit',
                              color: '#111827',
                              background: '#FFFFFF',
                              cursor: 'pointer',
                              marginBottom: '8px',
                              transition: 'all 0.4s ease'
                            }}
                          >
                            <option value="10">10 seconds</option>
                            <option value="15">15 seconds</option>
                            <option value="20">20 seconds</option>
                            <option value="30">30 seconds</option>
                            <option value="45">45 seconds</option>
                            <option value="60">60 seconds</option>
                            <option value="90">90 seconds</option>
                            <option value="120">2 minutes</option>
                          </select>
                          <label htmlFor="inactivityText" style={{ display: 'block', fontSize: '12px', fontWeight: '500', color: '#6b7280', marginBottom: '6px', marginTop: '8px' }}>
                            Custom Text (when inactive)
                          </label>
                          <textarea
                            ref={inactivityTextRef}
                            key="inactivityText-textarea"
                            id="inactivityText"
                            name="inactivityText"
                            value={inactivityText || ''}
                            onChange={(e) => {
                              const value = e.target.value;
                              setInactivityText(value);
                              // Update formData as well
                              setFormData((prev) => ({
                                ...prev,
                                inactivityText: value,
                              }));
                            }}
                            placeholder="Enter text to say when user is inactive..."
                              style={{
                                width: '100%',
                              padding: '8px 12px',
                              border: '1px solid #D1D5DB',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontFamily: 'inherit',
                              color: '#111827',
                              background: '#FFFFFF',
                              minHeight: '60px',
                              resize: 'vertical'
                            }}
                          />
                          </div>

                        {/* Auto End Call for Silence - Disabled/Greyed Out */}
                        <div>
                          <div
                            style={{
                              display: 'flex', 
                              alignItems: 'center',
                              justifyContent: 'space-between',
                              gap: '12px',
                              padding: '12px',
                              borderRadius: '8px',
                              transition: 'background-color 0.2s',
                              marginBottom: autoEndCallForSilence ? '12px' : '0',
                              background: '#F9FAFB',
                              opacity: 0.6,
                              pointerEvents: 'none'
                            }}
                          >
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: '600', marginBottom: '4px', fontSize: '14px', color: '#9CA3AF' }}>Auto end call for silence if...</div>
                              <div style={{ fontSize: '12px', color: '#9CA3AF' }}>Automatically end the call after a period of silence</div>
                            </div>
                            <button
                              type="button"
                              disabled
                              style={{
                                width: '44px',
                                height: '24px',
                                borderRadius: '12px',
                                border: 'none',
                                background: '#E5E7EB',
                                cursor: 'not-allowed',
                                position: 'relative',
                                transition: 'background-color 0.4s ease',
                                flexShrink: 0,
                                padding: '2px',
                                opacity: 0.6
                              }}
                            >
                              <div
                                style={{
                                  width: '20px',
                                  height: '20px',
                                  borderRadius: '50%',
                                  background: '#FFFFFF',
                                  transform: 'translateX(0)',
                                  transition: 'transform 0.4s ease',
                                  boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)'
                                }}
                              />
                            </button>
                          </div>
                          {autoEndCallForSilence && (
                            <div style={{ marginTop: '8px' }}>
                              <label htmlFor="silenceDuration" style={{ display: 'block', fontSize: '12px', fontWeight: '500', color: '#6b7280', marginBottom: '6px' }}>
                                Silence Duration (seconds)
                              </label>
                              <select
                                id="silenceDuration"
                                value={silenceDuration}
                                onChange={(e) => setSilenceDuration(Number(e.target.value))}
                                style={{
                                width: '100%',
                                  padding: '8px 12px',
                                  border: '1px solid #D1D5DB',
                                  borderRadius: '6px',
                                  fontSize: '13px',
                                  fontFamily: 'inherit',
                                  color: '#111827',
                                  background: '#FFFFFF',
                                cursor: 'pointer',
                                transition: 'all 0.4s ease'
                              }}
                              >
                                <option value="10">10 seconds</option>
                                <option value="15">15 seconds</option>
                                <option value="20">20 seconds</option>
                                <option value="30">30 seconds</option>
                                <option value="45">45 seconds</option>
                                <option value="60">60 seconds</option>
                                <option value="90">90 seconds</option>
                                <option value="120">2 minutes</option>
                              </select>
                            </div>
                          )}
                        </div>

                        {/* Voice Mail Detection */}
                        <div>
                          <div
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'space-between',
                              gap: '12px',
                              padding: '12px',
                              borderRadius: '8px',
                              transition: 'background-color 0.2s',
                              opacity: 0.5,
                              cursor: 'not-allowed',
                              background: '#F9FAFB'
                            }}
                          >
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: '600', marginBottom: '4px', fontSize: '14px', color: '#111827' }}>Voice Mail Detection</div>
                              <div style={{ fontSize: '12px', color: '#6b7280' }}>Automatically detect and handle voice mail responses</div>
                            </div>
                            <button
                              type="button"
                              disabled={true}
                              onClick={() => {}}
                                style={{
                                width: '44px',
                                height: '24px',
                                borderRadius: '12px',
                                border: 'none',
                                background: '#E5E7EB',
                                cursor: 'not-allowed',
                                position: 'relative',
                                transition: 'background-color 0.4s ease',
                                flexShrink: 0,
                                padding: '2px'
                              }}
                            >
                              <div
                                style={{
                                  width: '20px',
                                  height: '20px',
                                  borderRadius: '50%',
                                  background: '#FFFFFF',
                                  transform: 'translateX(0)',
                                  transition: 'transform 0.4s ease',
                                  boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)'
                                }}
                              />
                            </button>
                          </div>
                          </div>
                        </div>

                    </CollapsibleSection>

                    {/* Inbound Settings - Collapsible - Redirects to Settings page */}
                    <CollapsibleSection 
                      title="Inbound Settings"
                      sectionKey="inbound"
                      isOpen={openSettingsSections.inbound ?? false}
                      onToggle={toggleSettingsSection}
                      icon={
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                      }
                    >
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        <div style={{ padding: '12px', background: '#F0F9FF', borderRadius: '8px', border: '1px solid #BAE6FD' }}>
                          <div style={{ fontSize: '14px', fontWeight: '600', color: '#0369A1', marginBottom: '8px' }}>
                            Configure Inbound Call Settings
                          </div>
                          <div style={{ fontSize: '13px', color: '#0C4A6E', marginBottom: '12px' }}>
                            Manage inbound call configuration, phone numbers, and routing settings.
                          </div>
                          <button
                            type="button"
                            onClick={() => {
                              const settingsUrl = shop 
                                ? `/settings?shop=${encodeURIComponent(shop)}`
                                : '/settings';
                              navigate(settingsUrl);
                            }}
                            style={{
                              width: '100%',
                              padding: '10px 16px',
                              background: '#4B5CFF',
                              color: '#FFFFFF',
                              border: 'none',
                              borderRadius: '6px',
                              fontSize: '14px',
                              fontWeight: '500',
                              cursor: 'pointer',
                              transition: 'background 0.2s',
                              textAlign: 'center'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.background = '#3B4ED9';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.background = '#4B5CFF';
                            }}
                          >
                            Go to Inbound Settings
                          </button>
                        </div>
                      </div>
                    </CollapsibleSection>

                    {/* Language Section - Collapsible */}
                    <CollapsibleSection 
                      title="Language" 
                      sectionKey="language" 
                      isOpen={openSettingsSections.language ?? false}
                      onToggle={toggleSettingsSection}
                      icon={
                        <img 
                          src="/images/Raycons Icons Pack (Community)/global-2198431.svg" 
                          alt="Language" 
                          style={{ width: '18px', height: '18px' }}
                        />
                      }
                    >
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        {/* Primary Language - Single Select */}
                        <div>
                          <label htmlFor="primaryLanguage" style={{ display: 'block', fontSize: '12px', fontWeight: '500', color: '#6b7280', marginBottom: '6px' }}>
                            Primary Language
                          </label>
                          <select
                            id="primaryLanguage"
                            value={primaryLanguage}
                            onChange={(e) => {
                              const selectedLang = e.target.value;
                              setPrimaryLanguage(selectedLang);
                              
                              // Append "speak in {language}" to script content
                              if (selectedLang) {
                                const currentContent = formData?.content || '';
                                // Remove any existing "speak in" instruction
                                const cleanedContent = currentContent.replace(/\n\s*speak\s+in\s+[^\n]+/gi, '').trim();
                                const languageInstruction = `\n\nspeak in ${selectedLang}`;
                                const newContent = cleanedContent + languageInstruction;
                                
                                setFormData(prev => ({
                                  ...prev,
                                  content: newContent
                                }));
                              }
                            }}
                            style={{
                              width: '100%',
                              padding: '8px 12px',
                              border: '1px solid #D1D5DB',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontFamily: 'inherit',
                              color: '#111827',
                              background: '#FFFFFF',
                              cursor: 'pointer'
                            }}
                          >
                            <option value="">Select primary language</option>
                            <option value="hinglish">Hinglish</option>
                            <option value="english">English</option>
                            <option value="hindi">Hindi</option>
                            <option value="telugu">Telugu</option>
                            <option value="tamil">Tamil</option>
                            <option value="kannada">Kannada</option>
                            <option value="malayalam">Malayalam</option>
                            <option value="gujarati">Gujarati</option>
                            <option value="marathi">Marathi</option>
                            <option value="punjabi">Punjabi</option>
                            <option value="bengali">Bengali</option>
                            <option value="oriya">Oriya</option>
                          </select>
                        </div>

                        {/* Secondary Languages - Multi-Select */}
                        <div>
                          <label style={{ display: 'block', fontSize: '12px', fontWeight: '500', color: '#6b7280', marginBottom: '6px' }}>
                            Secondary Languages (Optional)
                          </label>
                          <div ref={languageDropdownRef} style={{ position: 'relative' }}>
                            {/* Selected Languages as Tags */}
                            <div
                              onClick={() => setShowLanguageDropdown(!showLanguageDropdown)}
                              style={{
                                width: '100%',
                                minHeight: '40px',
                              padding: '8px 12px',
                              border: '1px solid #D1D5DB',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontFamily: 'inherit',
                              color: '#111827',
                              background: '#FFFFFF',
                                cursor: 'pointer',
                                display: 'flex',
                                flexWrap: 'wrap',
                                gap: '6px',
                                alignItems: 'center'
                              }}
                            >
                              {secondaryLanguages.length > 0 ? (
                                secondaryLanguages.map((lang) => (
                                  <span
                                    key={lang}
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      setSecondaryLanguages(prev => prev.filter(l => l !== lang));
                                    }}
                                    style={{
                                      display: 'inline-flex',
                                      alignItems: 'center',
                                      gap: '4px',
                                      padding: '4px 8px',
                                      backgroundColor: '#EFF6FF',
                                      color: '#1E40AF',
                                      borderRadius: '4px',
                                      fontSize: '12px',
                                      fontWeight: '500',
                              cursor: 'pointer'
                            }}
                          >
                                    {lang.charAt(0).toUpperCase() + lang.slice(1)}
                                    <span
                                      style={{
                                        fontSize: '14px',
                                        color: '#1E40AF',
                                        fontWeight: 'bold',
                                        marginLeft: '2px'
                                      }}
                                    >
                                      Ã—
                                    </span>
                                  </span>
                                ))
                              ) : (
                                <span style={{ color: '#9CA3AF' }}>Select secondary languages</span>
                              )}
                        </div>

                            {/* Dropdown Menu */}
                            {showLanguageDropdown && (
                              <div
                                style={{
                                  position: 'absolute',
                                  top: '100%',
                                  left: 0,
                                  right: 0,
                                  marginTop: '4px',
                                  backgroundColor: '#FFFFFF',
                                  border: '1px solid #D1D5DB',
                                  borderRadius: '6px',
                                  boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                                  zIndex: 1000,
                                  maxHeight: '300px',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  overflow: 'hidden'
                                }}
                              >
                                {/* Search Input */}
                                <div style={{ padding: '8px', borderBottom: '1px solid #E5E7EB' }}>
                                  <input
                                    type="text"
                                    placeholder="Search languages (e.g., hi, en, tel)"
                                    value={languageSearchQuery}
                                    onChange={(e) => {
                                      e.stopPropagation();
                                      setLanguageSearchQuery(e.target.value);
                                    }}
                                    onClick={(e) => e.stopPropagation()}
                                    style={{
                                      width: '100%',
                                      padding: '8px 12px',
                                      border: '1px solid #D1D5DB',
                                      borderRadius: '6px',
                                      fontSize: '13px',
                                      fontFamily: 'inherit',
                                      color: '#111827',
                                      background: '#FFFFFF'
                                    }}
                                    autoFocus
                                  />
                                </div>
                                
                                {/* Filtered Languages List */}
                                <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                                  {['hinglish', 'english', 'telugu', 'hindi', 'tamil', 'kannada', 'malayalam', 'gujarati', 'marathi', 'punjabi', 'bengali', 'oriya']
                                    .filter((lang) => lang !== primaryLanguage)
                                    .filter((lang) => {
                                      if (!languageSearchQuery.trim()) return true;
                                      const query = languageSearchQuery.toLowerCase();
                                      return lang.toLowerCase().includes(query) || 
                                             lang.toLowerCase().startsWith(query);
                                    })
                                    .map((lang) => (
                                  <label
                                    key={lang}
                                    style={{
                                      display: 'flex',
                                      alignItems: 'center',
                                      padding: '8px 12px',
                                      cursor: 'pointer',
                                      fontSize: '13px',
                                      color: '#111827',
                                      backgroundColor: secondaryLanguages.includes(lang) ? '#F3F4F6' : 'transparent',
                                      transition: 'background-color 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                      if (!secondaryLanguages.includes(lang)) {
                                        e.currentTarget.style.backgroundColor = '#F9FAFB';
                                      }
                                    }}
                                    onMouseLeave={(e) => {
                                      if (!secondaryLanguages.includes(lang)) {
                                        e.currentTarget.style.backgroundColor = 'transparent';
                                      }
                                    }}
                                  >
                                    <input
                                      type="checkbox"
                                      checked={secondaryLanguages.includes(lang)}
                                      onChange={(e) => {
                                        if (e.target.checked) {
                                          setSecondaryLanguages(prev => [...prev, lang]);
                                        } else {
                                          setSecondaryLanguages(prev => prev.filter(l => l !== lang));
                                        }
                                      }}
                                      style={{
                                        width: '16px',
                                        height: '16px',
                                        marginRight: '8px',
                                        cursor: 'pointer',
                                        accentColor: '#4B5CFF'
                                      }}
                                    />
                                    <span>{lang.charAt(0).toUpperCase() + lang.slice(1)}</span>
                                  </label>
                                    ))}
                                  {['hinglish', 'english', 'telugu', 'hindi', 'tamil', 'kannada', 'malayalam', 'gujarati', 'marathi', 'punjabi', 'bengali', 'oriya']
                                      .filter((lang) => {
                                        if (!languageSearchQuery.trim()) return false;
                                        const query = languageSearchQuery.toLowerCase();
                                        return lang.toLowerCase().includes(query) || 
                                               lang.toLowerCase().startsWith(query);
                                      }).length === 0 && languageSearchQuery.trim() && (
                                        <div style={{ padding: '12px', textAlign: 'center', color: '#9CA3AF', fontSize: '13px' }}>
                                          No languages found
                                        </div>
                                      )}
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </CollapsibleSection>

                    {/* LLM Settings Section - Collapsible */}
                    <CollapsibleSection 
                      title="LLM Settings" 
                      sectionKey="llm"
                      isOpen={openSettingsSections.llm ?? false}
                      onToggle={toggleSettingsSection}
                      icon={
                        <img 
                          src="/images/Raycons Icons Pack (Community)/cpu-8535551-1.svg" 
                          alt="LLM Settings" 
                          style={{ width: '18px', height: '18px' }}
                        />
                      }
                    >
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                        {/* LLM Model Selection */}
                        <div style={{ opacity: 0.5, pointerEvents: 'none' }}>
                          <label htmlFor="llmModel" style={{ fontSize: '13px', fontWeight: '500', color: '#9CA3AF', marginBottom: '8px', display: 'block' }}>
                            LLM Model
                          </label>
                          <select
                            id="llmModel"
                            value={llmModel}
                            onChange={(e) => setLlmModel(e.target.value)}
                            disabled
                            style={{
                              width: '100%',
                              padding: '8px 12px',
                              border: '1px solid #D1D5DB',
                              borderRadius: '6px',
                              fontSize: '14px',
                              color: '#9CA3AF',
                              background: '#F3F4F6',
                              cursor: 'not-allowed'
                            }}
                          >
                            <option value="">Select LLM Model</option>
                            <option value="Scalysis 190B Finetuned (Finetuned For Latency)">Scalysis 190B Finetuned (Finetuned For Latency)</option>
                            <option value="Open AI 20B">Open AI 20B</option>
                            <option value="Open AI Safeguard 20B">Open AI Safeguard 20B</option>
                          </select>
                          <div style={{ marginTop: '6px', fontSize: '12px', color: '#9CA3AF', fontStyle: 'italic' }}>
                            Expect 100-200ms faster response on 20B models, snappier
                          </div>
                        </div>

                        {/* Temperature Mode Toggle */}
                        <div>
                          <label style={{ fontSize: '13px', fontWeight: '500', color: '#111827', marginBottom: '8px', display: 'block' }}>
                            Temperature Setting
                          </label>
                          <div style={{ display: 'flex', gap: '12px', alignItems: 'center', marginBottom: '12px' }}>
                            <button
                              type="button"
                              onClick={() => setTemperatureMode('manual')}
                              style={{
                                flex: 1,
                                padding: '8px 12px',
                                border: `2px solid ${temperatureMode === 'manual' ? '#4B5CFF' : '#D1D5DB'}`,
                                borderRadius: '6px',
                                fontSize: '13px',
                                fontWeight: temperatureMode === 'manual' ? '600' : '400',
                                color: temperatureMode === 'manual' ? '#4B5CFF' : '#6B7280',
                                background: temperatureMode === 'manual' ? '#F0F4FF' : '#FFFFFF',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                              }}
                            >
                              Manually
                            </button>
                            <button
                              type="button"
                              onClick={() => setTemperatureMode('script')}
                              style={{
                                flex: 1,
                                padding: '8px 12px',
                                border: `2px solid ${temperatureMode === 'script' ? '#4B5CFF' : '#D1D5DB'}`,
                                borderRadius: '6px',
                                fontSize: '13px',
                                fontWeight: temperatureMode === 'script' ? '600' : '400',
                                color: temperatureMode === 'script' ? '#4B5CFF' : '#6B7280',
                                background: temperatureMode === 'script' ? '#F0F4FF' : '#FFFFFF',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                              }}
                            >
                              Set according to script
                            </button>
                          </div>
                        </div>

                        {/* Script Type Dropdown (when script mode is selected) */}
                        {temperatureMode === 'script' && (
                          <div>
                            <label htmlFor="scriptType" style={{ fontSize: '13px', fontWeight: '500', color: '#111827', marginBottom: '8px', display: 'block' }}>
                              Script Type
                            </label>
                            <select
                              id="scriptType"
                              value={scriptType}
                              onChange={(e) => {
                                const newType = e.target.value;
                                setScriptType(newType);
                                // Set temperature based on script type
                                const tempMap = {
                                  'simple': 0.3,
                                  'advanced': 0.45,
                                  'freeFlow': 0.65
                                };
                                setTemperature(tempMap[newType] || 0.7);
                              }}
                              style={{
                                width: '100%',
                                padding: '8px 12px',
                                border: '1px solid #D1D5DB',
                                borderRadius: '6px',
                                fontSize: '14px',
                                color: '#111827',
                                background: '#FFFFFF',
                                cursor: 'pointer'
                              }}
                            >
                              <option value="simple">Simple (Temperature: 0.3)</option>
                              <option value="advanced">Advanced (Temperature: 0.45)</option>
                              <option value="freeFlow">Free Flow (Temperature: 0.65)</option>
                            </select>
                            <div style={{ marginTop: '6px', fontSize: '12px', color: '#6B7280' }}>
                              Temperature automatically set to {scriptType === 'simple' ? '0.3' : scriptType === 'advanced' ? '0.45' : '0.65'}
                            </div>
                          </div>
                        )}

                        {/* Temperature Slider (when manual mode is selected) */}
                        {temperatureMode === 'manual' && (
                        <div>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                              <label htmlFor="temperature" style={{ fontSize: '13px', fontWeight: '500', color: '#111827' }}>
                              Temperature
                          </label>
                              <span style={{ fontSize: '13px', fontWeight: '600', color: '#111827', minWidth: '50px', textAlign: 'right' }}>
                              {temperature.toFixed(2)}
                            </span>
                          </div>
                          <div style={{ position: 'relative', padding: '8px 0' }}>
                            <div style={{ 
                              display: 'flex', 
                              justifyContent: 'space-between', 
                              alignItems: 'center',
                              marginBottom: '8px'
                            }}>
                              <span style={{ fontSize: '12px', color: '#6B7280' }}>0</span>
                              <span style={{ fontSize: '12px', color: '#6B7280' }}>1</span>
                            </div>
                            <div
                            style={{
                                position: 'relative',
                              width: '100%',
                                height: '4px',
                                background: '#E5E7EB',
                                borderRadius: '2px',
                                cursor: 'pointer'
                              }}
                              onMouseDown={(e) => {
                                e.preventDefault();
                                const slider = e.currentTarget;
                                const rect = slider.getBoundingClientRect();
                                
                                const updateTemperature = (clientX) => {
                                  const x = clientX - rect.left;
                                  const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
                                  setTemperature(percentage / 100);
                                };
                                
                                updateTemperature(e.clientX);
                                
                                const handleMouseMove = (moveEvent) => {
                                  const newRect = slider.getBoundingClientRect();
                                  const x = moveEvent.clientX - newRect.left;
                                  const percentage = Math.max(0, Math.min(100, (x / newRect.width) * 100));
                                  setTemperature(percentage / 100);
                                };
                                
                                const handleMouseUp = () => {
                                  document.removeEventListener('mousemove', handleMouseMove);
                                  document.removeEventListener('mouseup', handleMouseUp);
                                };
                                
                                document.addEventListener('mousemove', handleMouseMove);
                                document.addEventListener('mouseup', handleMouseUp);
                              }}
                            >
                              <div
                                style={{
                                  position: 'absolute',
                                  left: 0,
                                  top: 0,
                                  width: `${temperature * 100}%`,
                                  height: '100%',
                                  background: '#374151',
                                  borderRadius: '2px',
                                  transition: 'width 0.1s ease'
                                }}
                              />
                              <div
                                style={{
                                  position: 'absolute',
                                  left: `${temperature * 100}%`,
                                  top: '50%',
                                  transform: 'translate(-50%, -50%)',
                                  width: '16px',
                                  height: '16px',
                                  borderRadius: '50%',
                                  background: '#374151',
                                  cursor: 'grab',
                                  boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)'
                                }}
                              />
                          </div>
                          </div>
                        </div>
                        )}

                      </div>
                    </CollapsibleSection>

                    {/* Context Section - Collapsible */}
                    <CollapsibleSection 
                      title="Context" 
                      sectionKey="memory"
                      isOpen={openSettingsSections.memory ?? false}
                      onToggle={toggleSettingsSection}
                      icon={
                        <img 
                          src="/images/Raycons Icons Pack (Community)/bookmark-8535535.svg" 
                          alt="Context" 
                          style={{ width: '18px', height: '18px' }}
                        />
                      }
                    >
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                        <div>
                          <div
                            style={{
                              display: 'flex',
                              alignItems: 'flex-start',
                              justifyContent: 'space-between',
                              gap: '12px',
                              padding: '12px',
                              borderRadius: '8px',
                              transition: 'background-color 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#F9FAFB'}
                            onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                          >
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: '600', marginBottom: '4px', fontSize: '14px', color: '#111827' }}>Current conversation memory</div>
                              <div style={{ fontSize: '12px', color: '#6b7280' }}>Full context retention throughout the call</div>
                            </div>
                            <button
                              type="button"
                              onClick={() => setMemorySettings(prev => ({ ...prev, currentConversationMemory: !prev.currentConversationMemory }))}
                              style={{
                                width: '44px',
                                height: '24px',
                                borderRadius: '12px',
                                border: 'none',
                                background: memorySettings.currentConversationMemory ? '#4B5CFF' : '#D1D5DB',
                                cursor: 'pointer',
                                position: 'relative',
                                transition: 'background-color 0.4s ease',
                                flexShrink: 0,
                                padding: '2px'
                              }}
                            >
                              <div
                                style={{
                                  width: '20px',
                                  height: '20px',
                                  borderRadius: '50%',
                              background: '#FFFFFF',
                                  transform: memorySettings.currentConversationMemory ? 'translateX(20px)' : 'translateX(0)',
                                  transition: 'transform 0.4s ease',
                                  boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)'
                                }}
                              />
                            </button>
                          </div>
                        </div>

                        <div style={{ opacity: 0.5, pointerEvents: 'none' }}>
                          <div
                            style={{
                              display: 'flex',
                              alignItems: 'flex-start',
                              justifyContent: 'space-between',
                              gap: '12px',
                              padding: '12px',
                              borderRadius: '8px',
                              transition: 'background-color 0.2s'
                            }}
                          >
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: '600', marginBottom: '4px', fontSize: '14px', color: '#9CA3AF' }}>Previous Call Memory</div>
                              <div style={{ fontSize: '12px', color: '#9CA3AF' }}>Just stored as context, not actively disrupting current conversation</div>
                            </div>
                            <button
                              type="button"
                              disabled
                              style={{
                                width: '44px',
                                height: '24px',
                                borderRadius: '12px',
                                border: 'none',
                                background: '#E5E7EB',
                                cursor: 'not-allowed',
                                position: 'relative',
                                transition: 'background-color 0.4s ease',
                                flexShrink: 0,
                                padding: '2px',
                                opacity: 0.5
                              }}
                            >
                              <div
                            style={{
                                  width: '20px',
                                  height: '20px',
                                  borderRadius: '50%',
                              background: '#FFFFFF',
                                  transform: 'translateX(0)',
                                  transition: 'transform 0.2s',
                                  boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)'
                            }}
                          />
                            </button>
                          </div>
                        </div>

                        <div style={{ opacity: 0.5, pointerEvents: 'none' }}>
                          <div
                            style={{
                              display: 'flex',
                              alignItems: 'flex-start',
                              justifyContent: 'space-between',
                              gap: '12px',
                              padding: '12px',
                              borderRadius: '8px',
                              transition: 'background-color 0.2s'
                            }}
                          >
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: '600', marginBottom: '4px', fontSize: '14px', color: '#9CA3AF' }}>Time & Calendar Access</div>
                              <div style={{ fontSize: '12px', color: '#9CA3AF' }}>Pulls up live calendar, festival season, exact time of call....</div>
                            </div>
                            <button
                              type="button"
                              disabled
                              onClick={() => setMemorySettings(prev => ({ ...prev, liveContextAwareness: !prev.liveContextAwareness }))}
                              style={{
                                width: '44px',
                                height: '24px',
                                borderRadius: '12px',
                                border: 'none',
                                background: memorySettings.liveContextAwareness ? '#9CA3AF' : '#E5E7EB',
                                cursor: 'not-allowed',
                                position: 'relative',
                                transition: 'background-color 0.4s ease',
                                flexShrink: 0,
                                padding: '2px'
                              }}
                            >
                              <div
                                style={{
                                  width: '20px',
                                  height: '20px',
                                  borderRadius: '50%',
                                  background: '#FFFFFF',
                                  transform: memorySettings.liveContextAwareness ? 'translateX(20px)' : 'translateX(0)',
                                  transition: 'transform 0.2s',
                                  boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)'
                                }}
                              />
                            </button>
                          </div>
                        </div>
                      </div>
                    </CollapsibleSection>

                    <CollapsibleSection 
                      title="Knowledge & QNA" 
                      sectionKey="knowledge"
                      isOpen={openSettingsSections.knowledge ?? false}
                      onToggle={toggleSettingsSection}
                      icon={
                        <img 
                          src="/images/Raycons Icons Pack (Community)/message-question-8535294.svg" 
                          alt="Knowledge & QNA" 
                          style={{ width: '18px', height: '18px' }}
                        />
                      }
                    >
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                        {/* Knowledge Book Multi-Select with Tags */}
                        <div>
                          <label style={{ 
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            fontSize: '12px', 
                            fontWeight: '500', 
                            color: '#6b7280', 
                            marginBottom: '8px' 
                          }}>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ color: '#6b7280' }}>
                              <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
                              <path d="M9 10h6" />
                              <path d="M9 14h6" />
                            </svg>
                            Knowledge Book
                          </label>
                          <div ref={knowledgeBookDropdownRef} style={{ position: 'relative' }}>
                            {/* Selected Knowledge Books as Tags */}
                            <div
                              onClick={() => setShowKnowledgeBookDropdown(!showKnowledgeBookDropdown)}
                            style={{
                              width: '100%',
                                minHeight: '40px',
                              padding: '8px 12px',
                              border: '1px solid #D1D5DB',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontFamily: 'inherit',
                              color: '#111827',
                              background: '#FFFFFF',
                                cursor: 'pointer',
                                display: 'flex',
                                flexWrap: 'wrap',
                                gap: '6px',
                                alignItems: 'center'
                              }}
                            >
                              {selectedKnowledgeBookIds.length > 0 ? (
                                selectedKnowledgeBookIds.map((kbId) => {
                                  // Filter out QNA books from knowledge books
                                  const kb = knowledgeBooks.find(b => {
                                    if (b.id !== kbId) return false;
                                    // Check if it's a QNA book
                                    try {
                                      if (b.extraContent) {
                                        const parsed = JSON.parse(b.extraContent);
                                        return !(parsed.qnaPairs && Array.isArray(parsed.qnaPairs) && parsed.qnaPairs.length > 0);
                                      }
                                    } catch (e) {}
                                    return true; // Not a QNA book
                                  });
                                  return kb ? (
                                    <span
                                      key={kbId}
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setSelectedKnowledgeBookIds(prev => prev.filter(id => id !== kbId));
                                      }}
                                      style={{
                                        display: 'inline-flex',
                                        alignItems: 'center',
                                        gap: '4px',
                                        padding: '4px 8px',
                                        backgroundColor: '#EFF6FF',
                                        color: '#1E40AF',
                                        borderRadius: '4px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                              cursor: 'pointer'
                            }}
                          >
                                      {kb.name}
                                      <span
                                        style={{
                                          fontSize: '14px',
                                          color: '#1E40AF',
                                          fontWeight: 'bold',
                                          marginLeft: '2px'
                                        }}
                                      >
                                        Ã—
                                      </span>
                                    </span>
                                  ) : null;
                                })
                              ) : (
                                <span style={{ color: '#9CA3AF' }}>Select knowledge books</span>
                              )}
                            </div>
                            
                            {/* Dropdown Menu */}
                            {showKnowledgeBookDropdown && (
                              <div
                                style={{
                                  position: 'absolute',
                                  top: '100%',
                                  left: 0,
                                  right: 0,
                                  marginTop: '4px',
                                  backgroundColor: '#FFFFFF',
                                  border: '1px solid #D1D5DB',
                                  borderRadius: '6px',
                                  boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                                  zIndex: 1000,
                                  maxHeight: '200px',
                                  overflowY: 'auto'
                                }}
                              >
                                {/* Create New Option */}
                                <button
                                  type="button"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setShowKnowledgeBookDropdown(false);
                                    const shopParam = shop ? `?shop=${encodeURIComponent(shop)}&card=knowledge-books&new=true` : `?card=knowledge-books&new=true`;
                                    navigate(`/settings${shopParam}`);
                                  }}
                                  style={{
                                    width: '100%',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '8px 12px',
                                    background: 'transparent',
                                    border: 'none',
                                    borderBottom: '1px solid #E5E7EB',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    color: '#4B5CFF',
                                    fontWeight: '500',
                                    transition: 'background-color 0.2s'
                                  }}
                                  onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#F0F4FF'}
                                  onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                >
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                  </svg>
                                  <span>Create new</span>
                                </button>
                                
                                {(() => {
                                  // Filter out QNA books - only show regular knowledge books
                                  const regularKnowledgeBooks = knowledgeBooks.filter(kb => {
                                    try {
                                      if (kb.extraContent) {
                                        const parsed = JSON.parse(kb.extraContent);
                                        return !(parsed.qnaPairs && Array.isArray(parsed.qnaPairs) && parsed.qnaPairs.length > 0);
                                      }
                                    } catch (e) {}
                                    return true; // Not a QNA book
                                  });

                                  return regularKnowledgeBooks.length === 0 ? (
                                  <div style={{ padding: '12px', color: '#9CA3AF', fontSize: '12px', textAlign: 'center' }}>
                                    No knowledge books available
                                  </div>
                                ) : (
                                    regularKnowledgeBooks.map((kb) => (
                                    <label
                                      key={kb.id}
                                      style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        padding: '8px 12px',
                                        cursor: 'pointer',
                                        transition: 'background-color 0.2s'
                                      }}
                                      onMouseEnter={(e) => {
                                        if (!selectedKnowledgeBookIds.includes(kb.id)) {
                                          e.currentTarget.style.backgroundColor = '#F9FAFB';
                                        }
                                      }}
                                      onMouseLeave={(e) => {
                                        if (!selectedKnowledgeBookIds.includes(kb.id)) {
                                          e.currentTarget.style.backgroundColor = 'transparent';
                                        }
                                      }}
                                    >
                                      <input
                                        type="checkbox"
                                        checked={selectedKnowledgeBookIds.includes(kb.id)}
                                        onChange={(e) => {
                                          if (e.target.checked) {
                                            setSelectedKnowledgeBookIds(prev => [...prev, kb.id]);
                                          } else {
                                            setSelectedKnowledgeBookIds(prev => prev.filter(id => id !== kb.id));
                                          }
                                        }}
                                        style={{
                                          width: '16px',
                                          height: '16px',
                                          marginRight: '8px',
                                          cursor: 'pointer',
                                          accentColor: '#4B5CFF'
                                        }}
                                      />
                                      <span>{kb.name}</span>
                                    </label>
                                  ))
                                  );
                                })()}
                              </div>
                            )}
                          </div>
                        </div>

                        {/* QNA Book Multi-Select with Tags */}
                        <div>
                          <label style={{ 
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            fontSize: '12px', 
                            fontWeight: '500', 
                            color: '#6b7280', 
                            marginBottom: '8px' 
                          }}>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ color: '#6b7280' }}>
                              <circle cx="12" cy="12" r="10" />
                              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                              <path d="M12 17h.01" />
                            </svg>
                            QNA Book
                          </label>
                          <div ref={qnaBookDropdownRef} style={{ position: 'relative' }}>
                            {/* Selected QNA Books as Tags */}
                            <div
                              onClick={() => setShowQnaBookDropdown(!showQnaBookDropdown)}
                            style={{
                              width: '100%',
                                minHeight: '40px',
                              padding: '8px 12px',
                              border: '1px solid #D1D5DB',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontFamily: 'inherit',
                                color: '#111827',
                                background: '#FFFFFF',
                                cursor: 'pointer',
                                display: 'flex',
                                flexWrap: 'wrap',
                                gap: '6px',
                                alignItems: 'center'
                              }}
                            >
                              {selectedQnaBookIds.length > 0 ? (
                                selectedQnaBookIds.map((kbId) => {
                                  const kb = knowledgeBooks.find(b => b.id === kbId);
                                  return kb ? (
                                    <span
                                      key={kbId}
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setSelectedQnaBookIds(prev => prev.filter(id => id !== kbId));
                                      }}
                                      style={{
                                        display: 'inline-flex',
                                        alignItems: 'center',
                                        gap: '4px',
                                        padding: '4px 8px',
                                        backgroundColor: '#EFF6FF',
                                        color: '#1E40AF',
                                        borderRadius: '4px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        cursor: 'pointer'
                                      }}
                                    >
                                      {kb.name}
                                      <span
                                        style={{
                                          fontSize: '14px',
                                          color: '#1E40AF',
                                          fontWeight: 'bold',
                                          marginLeft: '2px'
                                        }}
                                      >
                                        Ã—
                                      </span>
                                    </span>
                                  ) : null;
                                })
                              ) : (
                                <span style={{ color: '#9CA3AF' }}>Select QNA books</span>
                              )}
                        </div>

                            {/* Dropdown Menu */}
                            {showQnaBookDropdown && (
                              <div
                            style={{
                                  position: 'absolute',
                                  top: '100%',
                                  left: 0,
                                  right: 0,
                                  marginTop: '4px',
                                  backgroundColor: '#FFFFFF',
                                  border: '1px solid #D1D5DB',
                                  borderRadius: '6px',
                                  boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                                  zIndex: 1000,
                                  maxHeight: '200px',
                                  overflowY: 'auto'
                                }}
                              >
                                {/* Create New Option */}
                                <button
                                  type="button"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setShowQnaBookDropdown(false);
                                    const shopParam = shop ? `?shop=${encodeURIComponent(shop)}&card=knowledge-books&new=true` : `?card=knowledge-books&new=true`;
                                    navigate(`/settings${shopParam}`);
                                  }}
                                  style={{
                                    width: '100%',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '8px',
                                    padding: '8px 12px',
                                    background: 'transparent',
                                    border: 'none',
                                    borderBottom: '1px solid #E5E7EB',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    color: '#4B5CFF',
                              fontWeight: '500',
                                    transition: 'background-color 0.2s'
                                  }}
                                  onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#F0F4FF'}
                                  onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                                >
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                  </svg>
                                  <span>Create new</span>
                                </button>
                                
                                {(() => {
                                  // Filter only QNA books
                                  const qnaBooks = knowledgeBooks.filter(kb => {
                                    try {
                                      if (kb.extraContent) {
                                        const parsed = JSON.parse(kb.extraContent);
                                        return parsed.qnaPairs && Array.isArray(parsed.qnaPairs) && parsed.qnaPairs.length > 0;
                                      }
                                    } catch (e) {}
                                    return false;
                                  });

                                  return qnaBooks.length === 0 ? (
                                    <div style={{ padding: '12px', color: '#9CA3AF', fontSize: '12px', textAlign: 'center' }}>
                                      No QNA books available
                                    </div>
                                  ) : (
                                    qnaBooks.map((kb) => (
                                      <label
                                        key={kb.id}
                                        style={{
                                          display: 'flex',
                                          alignItems: 'center',
                                          padding: '8px 12px',
                                          cursor: 'pointer',
                                          transition: 'background-color 0.2s'
                                        }}
                                        onMouseEnter={(e) => {
                                          if (!selectedQnaBookIds.includes(kb.id)) {
                                            e.currentTarget.style.backgroundColor = '#F9FAFB';
                                          }
                                        }}
                                        onMouseLeave={(e) => {
                                          if (!selectedQnaBookIds.includes(kb.id)) {
                                            e.currentTarget.style.backgroundColor = 'transparent';
                                          }
                            }}
                          >
                            <input
                              type="checkbox"
                                          checked={selectedQnaBookIds.includes(kb.id)}
                                          onChange={(e) => {
                                            if (e.target.checked) {
                                              setSelectedQnaBookIds(prev => [...prev, kb.id]);
                                            } else {
                                              setSelectedQnaBookIds(prev => prev.filter(id => id !== kb.id));
                                            }
                                          }}
                              style={{
                                width: '16px',
                                height: '16px',
                                            marginRight: '8px',
                                cursor: 'pointer',
                                accentColor: '#4B5CFF'
                              }}
                            />
                                        <span>{kb.name}</span>
                          </label>
                                    ))
                                  );
                                })()}
                      </div>
                            )}
                    </div>
                  </div>

                      </div>
                    </CollapsibleSection>
                        </>
                        </div>
                      )}

                      {/* Variables Tab Content */}
                      {box2ActiveTab === 'variables' && (
                        <div className="box2-tab-content">
                        <>
                    {/* Variables Used Section */}
                    <div style={{ 
                      marginBottom: '24px',
                      padding: '14px 16px',
                      background: '#F9FAFB',
                      border: '1px solid #E5E7EB',
                      borderRadius: '10px'
                    }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px', gap: '12px', flexWrap: 'wrap' }}>
                        <div>
                          <div style={{ fontSize: '12px', fontWeight: 600, color: '#111827', textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                            Variables Used ({variablesUsed.length})
                          </div>
                          <div style={{ fontSize: '12px', color: '#6B7280' }}>
                            Auto {autoVariableCount} â€¢ Manual {manualVariableCount}
                          </div>
                        </div>
                        <button
                          type="button"
                          style={{
                            padding: '6px 14px',
                            fontSize: '12px',
                            borderRadius: '999px',
                            border: '1px solid #4B5CFF',
                            background: '#EEF2FF',
                            color: '#4338CA',
                            cursor: 'pointer',
                            fontWeight: 600
                          }}
                          onClick={handleDefineVariablesClick}
                        >
                          Define Variables
                        </button>
                      </div>
                      {variablesUsed.length === 0 ? (
                        <div style={{ fontSize: '12px', color: '#6B7280' }}>No template variables detected.</div>
                      ) : (
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                          {variableStatus.map((variable) => {
                            // Green for valid variables, red for invalid
                            const isValid = variable.isValid;
                            const isDefined = variable.defined;
                            return (
                            <div
                              key={variable.name}
                              style={{
                                border: '1px solid',
                                  borderColor: isValid ? '#BBF7D0' : '#FECACA',
                                  background: isValid ? '#ECFDF5' : '#FEF2F2',
                                  color: isValid ? '#166534' : '#B91C1C',
                                padding: '6px 12px',
                                borderRadius: '999px',
                                fontSize: '12px',
                                fontWeight: 600,
                                display: 'inline-flex',
                                alignItems: 'center',
                                gap: '6px',
                                minHeight: '30px'
                              }}
                            >
                                <span>{`{${variable.name}}`}</span>
                              <span style={{ fontSize: '11px', fontWeight: 500 }}>
                                  {isValid ? (isDefined ? 'auto' : 'valid') : 'invalid'}
                              </span>
                            </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                        </>
                        </div>
                      )}

                      {/* Versions Tab Content */}
                      {/* Viewer Tab Content */}
                      {box2ActiveTab === 'viewer' && (
                        <div className="box2-tab-content">
                          <div style={{
                            padding: '24px',
                            background: '#ffffff',
                            borderRadius: '8px',
                            border: '1px solid #e5e7eb',
                            minHeight: '400px',
                            maxHeight: 'calc(100vh - 200px)',
                            overflowY: 'auto'
                          }}>
                            {safeFormData?.content ? (
                              <div className="markdown-viewer">
                                <ReactMarkdown
                                  components={{
                                    h1: ({node, ...props}) => <h1 style={{ fontSize: '28px', fontWeight: '700', color: '#111827', marginTop: '24px', marginBottom: '16px', lineHeight: '1.2' }} {...props} />,
                                    h2: ({node, ...props}) => <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#111827', marginTop: '20px', marginBottom: '12px', lineHeight: '1.3' }} {...props} />,
                                    h3: ({node, ...props}) => <h3 style={{ fontSize: '20px', fontWeight: '600', color: '#111827', marginTop: '16px', marginBottom: '10px', lineHeight: '1.4' }} {...props} />,
                                    h4: ({node, ...props}) => <h4 style={{ fontSize: '18px', fontWeight: '600', color: '#111827', marginTop: '14px', marginBottom: '8px', lineHeight: '1.4' }} {...props} />,
                                    h5: ({node, ...props}) => <h5 style={{ fontSize: '16px', fontWeight: '600', color: '#111827', marginTop: '12px', marginBottom: '6px', lineHeight: '1.5' }} {...props} />,
                                    h6: ({node, ...props}) => <h6 style={{ fontSize: '14px', fontWeight: '600', color: '#111827', marginTop: '10px', marginBottom: '6px', lineHeight: '1.5' }} {...props} />,
                                    p: ({node, ...props}) => <p style={{ fontSize: '14px', color: '#374151', lineHeight: '1.7', marginBottom: '12px' }} {...props} />,
                                    strong: ({node, ...props}) => <strong style={{ fontWeight: '600', color: '#111827' }} {...props} />,
                                    em: ({node, ...props}) => <em style={{ fontStyle: 'italic', color: '#374151' }} {...props} />,
                                    ul: ({node, ...props}) => <ul style={{ marginLeft: '20px', marginBottom: '12px', listStyleType: 'disc' }} {...props} />,
                                    ol: ({node, ...props}) => <ol style={{ marginLeft: '20px', marginBottom: '12px', listStyleType: 'decimal' }} {...props} />,
                                    li: ({node, ...props}) => <li style={{ fontSize: '14px', color: '#374151', lineHeight: '1.6', marginBottom: '6px' }} {...props} />,
                                    code: ({node, inline, ...props}) => inline 
                                      ? <code style={{ background: '#f3f4f6', padding: '2px 6px', borderRadius: '4px', fontSize: '13px', fontFamily: "'SF Mono', 'Monaco', 'Menlo', monospace", color: '#dc2626' }} {...props} />
                                      : <code style={{ display: 'block', background: '#f9fafb', padding: '12px', borderRadius: '6px', fontSize: '13px', fontFamily: "'SF Mono', 'Monaco', 'Menlo', monospace", color: '#111827', overflowX: 'auto', marginBottom: '12px', border: '1px solid #e5e7eb' }} {...props} />,
                                    blockquote: ({node, ...props}) => <blockquote style={{ borderLeft: '4px solid #4B5CFF', paddingLeft: '16px', marginLeft: '0', marginBottom: '12px', color: '#6b7280', fontStyle: 'italic' }} {...props} />,
                                    hr: ({node, ...props}) => <hr style={{ border: 'none', borderTop: '1px solid #e5e7eb', margin: '20px 0' }} {...props} />,
                                  }}
                                >
                                  {safeFormData.content}
                                </ReactMarkdown>
                      </div>
                            ) : (
                              <div style={{ 
                                textAlign: 'center', 
                                padding: '40px 20px', 
                                color: '#9ca3af',
                                fontSize: '14px'
                              }}>
                                No script content to display. Start writing in the script editor to see the formatted view here.
                    </div>
                            )}
                          </div>
                        </div>
                      )}

                      {/* Script Box 2 Chat Tab Content */}
                      {box2ActiveTab === 'chat' && (
                        <div className="script-box-2-chat-content-wrapper">
                          <div className="script-box-2-chat-content" style={{ 
                            display: 'flex', 
                            flexDirection: 'column', 
                            height: '100%', 
                            minHeight: '400px'
                          }}>
                            {!safeFormData?.content ? (
                              <div style={{ 
                                padding: '40px 20px', 
                                textAlign: 'center', 
                                color: '#6B7280', 
                                fontSize: '14px' 
                              }}>
                                Please add script content to start chatting
                      </div>
                            ) : (
                              <>
                                <div style={{ 
                                  flex: 1, 
                                  overflowY: 'auto', 
                                  padding: '16px', 
                                  display: 'flex', 
                                  flexDirection: 'column', 
                                  gap: '12px' 
                                }}>
                                  {scriptBox2ChatMessages.length === 0 ? (
                                    <div style={{ 
                                      display: 'flex',
                                      flexDirection: 'column',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      textAlign: 'center', 
                                      color: '#160211', 
                                      fontSize: '14px', 
                                      padding: '40px 20px',
                                      gap: '16px'
                                    }}>
                                      <img 
                                        src="/images/chatstar.svg" 
                                        alt="Chat star icon" 
                                        style={{ width: '36px', height: '38px' }}
                                      />
                                      <div style={{ fontWeight: '500' }}>
                                        Start Conversion with your Script:
                    </div>
                  </div>
                                  ) : (
                                    <>
                                      {(() => {
                                        // Find the last assistant message index (calculate once before mapping)
                                        let lastAssistantIndex = -1;
                                        for (let i = scriptBox2ChatMessages.length - 1; i >= 0; i--) {
                                          if (scriptBox2ChatMessages[i].role === 'assistant') {
                                            lastAssistantIndex = i;
                                            break;
                                          }
                                        }
                                        
                                        return scriptBox2ChatMessages.map((msg, idx) => {
                                          const isLastAssistantMessage = msg.role === 'assistant' && idx === lastAssistantIndex && lastAssistantIndex !== -1;

                                          return (
                                        <div
                                          key={idx}
                                          style={{
                                            display: 'flex',
                                              flexDirection: 'column',
                                              alignItems: msg.role === 'user' ? 'flex-end' : 'flex-start',
                                            marginBottom: '8px',
                                              width: '100%'
                                            }}
                                          >
                                            <div
                                              style={{
                                                display: 'flex',
                                                justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start',
                                            width: '100%'
                                          }}
                                        >
                                          {msg.role === 'user' ? (
                                            <div
                                              style={{
                                                display: 'flex',
                                                padding: '6px 10px',
                                                justifyContent: 'center',
                                                alignItems: 'center',
                                                gap: '10px',
                                                alignSelf: 'stretch',
                                                borderRadius: '8px',
                                                border: '1px solid rgba(255, 255, 255, 0.3)',
                                                background: 'rgba(79, 70, 229, 0.6)',
                                                backdropFilter: 'blur(10px)',
                                                WebkitBackdropFilter: 'blur(10px)',
                                                color: '#FFFFFF',
                                                fontSize: '14px',
                                                fontWeight: '400',
                                                lineHeight: '1.5',
                                                wordBreak: 'break-word',
                                                maxWidth: '80%'
                                              }}
                                            >
                                              {msg.content}
                                            </div>
                                          ) : (
                                            <div
                                              style={{
                                                display: 'flex',
                                                minHeight: '50px',
                                                padding: '10px',
                                                alignItems: 'center',
                                                gap: '10px',
                                                alignSelf: 'stretch',
                                                borderRadius: '8px',
                                                border: '1px solid #FFF',
                                                background: 'linear-gradient(90deg, rgba(218, 162, 255, 0.25) 0%, rgba(252, 246, 255, 0.40) 100%)',
                                                color: '#160211',
                                                fontSize: '14px',
                                                fontWeight: '400',
                                                lineHeight: '1.5',
                                                wordBreak: 'break-word',
                                                maxWidth: '80%'
                                              }}
                                            >
                                              <img 
                                                src="/images/chatlogoagent.svg" 
                                                alt="Agent icon" 
                                                style={{ width: '25px', height: '26px', flexShrink: 0, alignSelf: 'flex-start', marginTop: '2px' }}
                                              />
                                              <div style={{ flex: 1 }}>
                                                {msg.content}
                                              </div>
                                            </div>
                                          )}
                                        </div>
                                            {isLastAssistantMessage && (
                                              <div
                                                style={{
                                                  display: 'flex',
                                                  alignItems: 'center',
                                                  gap: '12px',
                                                  marginTop: '6px',
                                                  marginLeft: '35px',
                                                  padding: '4px 0',
                                                  visibility: 'visible',
                                                  opacity: 1
                                                }}
                                              >
                                                <button
                                                  onClick={() => handleScriptBox2ChatCopy(msg.content)}
                                                  style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    width: '24px',
                                                    height: '24px',
                                                    border: 'none',
                                                    background: 'transparent',
                                                    cursor: 'pointer',
                                                    color: '#6b7280',
                                                    padding: '0',
                                                    transition: 'color 0.2s',
                                                    opacity: 0.7
                                                  }}
                                                  onMouseEnter={(e) => {
                                                    e.currentTarget.style.color = '#374151';
                                                    e.currentTarget.style.opacity = '1';
                                                  }}
                                                  onMouseLeave={(e) => {
                                                    e.currentTarget.style.color = '#6b7280';
                                                    e.currentTarget.style.opacity = '0.7';
                                                  }}
                                                  aria-label="Copy message"
                                                  tabIndex={0}
                                                  onKeyDown={(e) => {
                                                    if (e.key === 'Enter' || e.key === ' ') {
                                                      e.preventDefault();
                                                      handleScriptBox2ChatCopy(msg.content);
                                                    }
                                                  }}
                                                >
                                                  <Copy size={18} />
                                                </button>
                                                <button
                                                  onClick={handleScriptBox2ChatThumbsUp}
                                                  style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    width: '24px',
                                                    height: '24px',
                                                    border: 'none',
                                                    background: 'transparent',
                                                    cursor: 'pointer',
                                                    color: '#6b7280',
                                                    padding: '0',
                                                    transition: 'color 0.2s',
                                                    opacity: 0.7
                                                  }}
                                                  onMouseEnter={(e) => {
                                                    e.currentTarget.style.color = '#374151';
                                                    e.currentTarget.style.opacity = '1';
                                                  }}
                                                  onMouseLeave={(e) => {
                                                    e.currentTarget.style.color = '#6b7280';
                                                    e.currentTarget.style.opacity = '0.7';
                                                  }}
                                                  aria-label="Thumbs up"
                                                  tabIndex={0}
                                                  onKeyDown={(e) => {
                                                    if (e.key === 'Enter' || e.key === ' ') {
                                                      e.preventDefault();
                                                      handleScriptBox2ChatThumbsUp();
                                                    }
                                                  }}
                                                >
                                                  <ThumbsUp size={18} />
                                                </button>
                                                <button
                                                  onClick={handleScriptBox2ChatThumbsDown}
                                                  style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    width: '24px',
                                                    height: '24px',
                                                    border: 'none',
                                                    background: 'transparent',
                                                    cursor: 'pointer',
                                                    color: '#6b7280',
                                                    padding: '0',
                                                    transition: 'color 0.2s',
                                                    opacity: 0.7
                                                  }}
                                                  onMouseEnter={(e) => {
                                                    e.currentTarget.style.color = '#374151';
                                                    e.currentTarget.style.opacity = '1';
                                                  }}
                                                  onMouseLeave={(e) => {
                                                    e.currentTarget.style.color = '#6b7280';
                                                    e.currentTarget.style.opacity = '0.7';
                                                  }}
                                                  aria-label="Thumbs down"
                                                  tabIndex={0}
                                                  onKeyDown={(e) => {
                                                    if (e.key === 'Enter' || e.key === ' ') {
                                                      e.preventDefault();
                                                      handleScriptBox2ChatThumbsDown();
                                                    }
                                                  }}
                                                >
                                                  <ThumbsDown size={18} />
                                                </button>
                                              </div>
                                            )}
                                          </div>
                                        );
                                      });
                                      })()}
                                    </>
                                  )}
                                  {scriptBox2ChatLoading && (
                                    <div style={{ display: 'flex', justifyContent: 'flex-start', marginBottom: '8px', width: '100%' }}>
                                      <div
                                        style={{
                                          display: 'flex',
                                          height: '50px',
                                          padding: '10px',
                                          alignItems: 'center',
                                          gap: '10px',
                                          alignSelf: 'stretch',
                                          borderRadius: '8px',
                                          border: '1px solid #FFF',
                                          background: 'linear-gradient(90deg, rgba(218, 162, 255, 0.25) 0%, rgba(252, 246, 255, 0.40) 100%)',
                                          color: '#160211',
                                          fontSize: '14px',
                                          fontWeight: '400',
                                          maxWidth: '80%'
                                        }}
                                      >
                                        <img 
                                          src="/images/chatlogoagent.svg" 
                                          alt="Agent icon" 
                                          style={{ width: '25px', height: '26px', flexShrink: 0 }}
                                        />
                                        <GeneratingText />
                                      </div>
                                    </div>
                                  )}
                                </div>
                                {/* Suggestions Section */}
                                {scriptBox2ChatMessages.length === 0 && !scriptBox2ChatLoading && safeFormData?.content && (
                                  <div style={{
                                    padding: '0 16px 12px 16px',
                                    display: 'flex',
                                    flexDirection: 'column',
                                    gap: '12px'
                                  }}>
                                    <button
                                      type="button"
                                      onClick={() => setShowPersonalityPopup(true)}
                                      disabled={scriptBox2ChatLoading || !safeFormData?.content}
                                      style={{
                                        display: 'inline-flex',
                                        padding: '12px 20px',
                                        justifyContent: 'center',
                                        alignItems: 'center',
                                        gap: '8px',
                                        borderRadius: '8px',
                                        border: '1px solid #FFF',
                                        background: 'rgba(255, 255, 255, 0.50)',
                                        color: '#160211',
                                        fontSize: '14px',
                                        fontWeight: '600',
                                        cursor: scriptBox2ChatLoading || !safeFormData?.content ? 'not-allowed' : 'pointer',
                                        transition: 'all 0.2s',
                                        fontFamily: 'inherit'
                                      }}
                                      onMouseEnter={(e) => {
                                        if (!scriptBox2ChatLoading && safeFormData?.content) {
                                          e.currentTarget.style.background = 'rgba(255, 255, 255, 0.80)';
                                          e.currentTarget.style.transform = 'translateY(-1px)';
                                        }
                                      }}
                                      onMouseLeave={(e) => {
                                        if (!scriptBox2ChatLoading && safeFormData?.content) {
                                          e.currentTarget.style.background = 'rgba(255, 255, 255, 0.50)';
                                          e.currentTarget.style.transform = 'translateY(0)';
                                        }
                                      }}
                                    >
                                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                                      </svg>
                                      Run Simulation
                                    </button>
                                  </div>
                                )}
                                <div style={{ 
                                  padding: '16px', 
                                  borderTop: '1px solid #e5e7eb', 
                                  display: 'flex', 
                                  gap: '8px',
                                  alignItems: 'flex-end'
                                }}>
                                  {/* Chat box with send button inside */}
                                  <div style={{
                                    flex: 1,
                                    position: 'relative',
                                    display: 'flex',
                                    alignItems: 'center'
                                  }}>
                                    <textarea
                                      value={scriptBox2ChatInput}
                                      onChange={handleScriptBox2ChatInputChange}
                                      onKeyDown={handleScriptBox2ChatKeyDown}
                                      placeholder="Ask me anything about your projects"
                                      disabled={scriptBox2ChatLoading || !safeFormData?.content}
                                      tabIndex={0}
                                      aria-label="Chat input"
                                      style={{
                                        width: '100%',
                                        minHeight: '40px',
                                        maxHeight: '120px',
                                        padding: '10px 50px 10px 12px',
                                        border: '1px solid #d1d5db',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'none',
                                        outline: 'none',
                                        background: scriptBox2ChatLoading || !safeFormData?.content ? '#f9fafb' : '#ffffff',
                                        color: scriptBox2ChatLoading || !safeFormData?.content ? '#9ca3af' : '#111827',
                                        cursor: scriptBox2ChatLoading || !safeFormData?.content ? 'not-allowed' : 'text',
                                        lineHeight: '1.5'
                                      }}
                                    />
                                    <button
                                      type="button"
                                      onClick={handleScriptBox2ChatSend}
                                      disabled={scriptBox2ChatLoading || !scriptBox2ChatInput.trim() || !safeFormData?.content}
                                      tabIndex={0}
                                      aria-label="Send message"
                                      onKeyDown={(e) => {
                                        if (e.key === 'Enter' || e.key === ' ') {
                                          e.preventDefault();
                                          handleScriptBox2ChatSend();
                                        }
                                      }}
                                      style={{
                                        position: 'absolute',
                                        right: '8px',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        background: 'transparent',
                                        border: 'none',
                                        padding: '8px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        cursor: scriptBox2ChatLoading || !scriptBox2ChatInput.trim() || !safeFormData?.content ? 'not-allowed' : 'pointer',
                                        opacity: scriptBox2ChatLoading || !scriptBox2ChatInput.trim() || !safeFormData?.content ? 0.4 : 1,
                                        transition: 'opacity 0.2s'
                                      }}
                                    >
                                      <svg 
                                        width="16" 
                                        height="14" 
                                        viewBox="0 0 16 14" 
                                        fill="none" 
                                        xmlns="http://www.w3.org/2000/svg"
                                      >
                                        <path 
                                          fillRule="evenodd" 
                                          clipRule="evenodd" 
                                          d="M2.25 13.603L11.606 8.20096C12.606 7.62396 12.606 6.18096 11.606 5.60296L2.25 0.200962C2.0219 0.0692686 1.76315 -4.21667e-05 1.49976 1.92458e-08C1.23637 4.22052e-05 0.977641 0.0694359 0.749584 0.201202C0.521526 0.332969 0.332185 0.522462 0.200601 0.750625C0.0690178 0.978788 -0.000168623 1.23758 3.08616e-07 1.50096V12.304C-0.000168623 12.5673 0.0690178 12.8261 0.200601 13.0543C0.332185 13.2825 0.521526 13.472 0.749584 13.6037C0.977641 13.7355 1.23637 13.8049 1.49976 13.8049C1.76315 13.805 2.0219 13.7357 2.25 13.604V13.603ZM4.197 7.38496L3.08616e-07 8.50996V5.29496L4.197 6.41796C4.691 6.55096 4.691 7.25196 4.197 7.38396V7.38496Z" 
                                          fill="#334BFA"
                                        />
                                      </svg>
                                    </button>
                                  </div>
                                  <button
                                    type="button"
                                    onClick={handleScriptBox2ChatClear}
                                    disabled={scriptBox2ChatMessages.length === 0}
                                    tabIndex={0}
                                    aria-label="Clear chat"
                                    onKeyDown={(e) => {
                                      if (e.key === 'Enter' || e.key === ' ') {
                                        e.preventDefault();
                                        handleScriptBox2ChatClear();
                                      }
                                    }}
                                    style={{
                                      padding: '10px 16px',
                                      background: '#F3F4F6',
                                      color: '#6B7280',
                                      border: 'none',
                                      borderRadius: '8px',
                                      fontSize: '14px',
                                      fontWeight: '500',
                                      cursor: scriptBox2ChatMessages.length === 0 ? 'not-allowed' : 'pointer',
                                      opacity: scriptBox2ChatMessages.length === 0 ? 0.5 : 1,
                                      transition: 'all 0.2s'
                                    }}
                                  >
                                    Clear
                                  </button>
                                </div>
                              </>
                            )}
                          </div>
                        </div>
                      )}

                      {/* Versions Tab Content */}
                      {box2ActiveTab === 'versions' && (
                        <div className="versions-tab-content-wrapper" style={{ 
                          display: 'flex', 
                          flexDirection: 'column', 
                          height: '100%', 
                          minHeight: '500px',
                          background: '#ffffff',
                          borderRadius: '12px',
                          border: '1px solid #e5e7eb',
                          overflow: 'hidden',
                          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)'
                        }}>
                          {/* Search Bar */}
                          <div style={{
                            padding: '16px',
                            borderBottom: '1px solid #e5e7eb',
                            background: '#f9fafb'
                          }}>
                            <div style={{
                              position: 'relative',
                              display: 'flex',
                              alignItems: 'center'
                            }}>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" strokeWidth="2" style={{
                                position: 'absolute',
                                left: '12px',
                                pointerEvents: 'none'
                              }}>
                                <circle cx="11" cy="11" r="8" />
                                <path d="m21 21-4.35-4.35" />
                              </svg>
                              <input
                                type="text"
                                placeholder="Search versions..."
                                value={versionSearchQuery}
                                onChange={(e) => setVersionSearchQuery(e.target.value)}
                                style={{
                                  width: '100%',
                                  padding: '10px 12px 10px 36px',
                                  border: '1px solid #e5e7eb',
                                  borderRadius: '8px',
                                  fontSize: '14px',
                                  background: '#ffffff',
                                  color: '#111827',
                                  outline: 'none',
                                  transition: 'all 0.2s'
                                }}
                                onFocus={(e) => e.target.style.borderColor = '#4B5CFF'}
                                onBlur={(e) => e.target.style.borderColor = '#e5e7eb'}
                              />
                            </div>
                          </div>

                          {/* Versions List */}
                          <div style={{
                            flex: 1,
                            overflowY: 'auto',
                            padding: '16px'
                          }}>
                            {loadingVersions ? (
                              <div style={{
                                display: 'flex',
                                justifyContent: 'center',
                                alignItems: 'center',
                                padding: '40px',
                                color: '#6b7280',
                                fontSize: '14px'
                              }}>
                                Loading versions...
                              </div>
                            ) : scriptVersions.length === 0 ? (
                              <div style={{
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                justifyContent: 'center',
                                padding: '40px',
                                color: '#9ca3af',
                                fontSize: '14px',
                                textAlign: 'center'
                              }}>
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" style={{ marginBottom: '16px', opacity: 0.5 }}>
                                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                  <polyline points="14 2 14 8 20 8" />
                                  <line x1="16" y1="13" x2="8" y2="13" />
                                  <line x1="16" y1="17" x2="8" y2="17" />
                                  <polyline points="10 9 9 9 8 9" />
                                </svg>
                                No versions found
                                <div style={{ marginTop: '8px', fontSize: '12px', opacity: 0.7 }}>
                                  Versions are automatically created when you save changes
                                </div>
                              </div>
                            ) : (
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {scriptVersions
                                  .filter(version => {
                                    if (!versionSearchQuery.trim()) return true;
                                    const query = versionSearchQuery.toLowerCase();
                                    return version.versionName.toLowerCase().includes(query) ||
                                           (version.description || '').toLowerCase().includes(query) ||
                                           (version.content || '').toLowerCase().includes(query);
                                  })
                                  .map((version, index) => (
                                    <div
                                      key={version.id}
                                      onClick={() => loadVersion(version.id)}
                                      style={{
                                        padding: '16px',
                                        border: '1px solid #e5e7eb',
                                        borderRadius: '10px',
                                        background: '#ffffff',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                      }}
                                      onMouseEnter={(e) => {
                                        e.currentTarget.style.borderColor = '#4B5CFF';
                                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(75, 92, 255, 0.1)';
                                      }}
                                      onMouseLeave={(e) => {
                                        e.currentTarget.style.borderColor = '#e5e7eb';
                                        e.currentTarget.style.boxShadow = 'none';
                                      }}
                                    >
                                      <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'flex-start',
                                        marginBottom: '8px'
                                      }}>
                                        <div style={{
                                          fontSize: '14px',
                                          fontWeight: '600',
                                          color: '#111827'
                                        }}>
                                          {version.versionName}
                                        </div>
                                        <div style={{
                                          fontSize: '12px',
                                          color: '#9ca3af'
                                        }}>
                                          {new Date(version.createdAt).toLocaleDateString('en-GB', {
                                            day: 'numeric',
                                            month: 'short',
                                            year: 'numeric',
                                            hour: 'numeric',
                                            minute: '2-digit'
                                          })}
                                        </div>
                                      </div>
                                      {version.description && (
                                        <div style={{
                                          fontSize: '13px',
                                          color: '#6b7280',
                                          marginBottom: '8px',
                                          overflow: 'hidden',
                                          textOverflow: 'ellipsis',
                                          whiteSpace: 'nowrap'
                                        }}>
                                          {version.description}
                                        </div>
                                      )}
                                      <div style={{
                                        fontSize: '12px',
                                        color: '#9ca3af',
                                        display: 'flex',
                                        gap: '12px',
                                        alignItems: 'center'
                                      }}>
                                        <span>{(version.content || '').length} chars</span>
                                        {version.flowData && (
                                          <span style={{
                                            padding: '2px 8px',
                                            background: '#f3f4f6',
                                            borderRadius: '4px',
                                            fontSize: '11px'
                                          }}>
                                            Flow
                                          </span>
                                        )}
                                      </div>
                                    </div>
                                  ))}
                              </div>
                            )}
                          </div>
                        </div>
                      )}

                      {/* Edit Script Tab Content - Premium Clean Design */}
                      {box2ActiveTab === 'edit-script' && (
                        <div className="edit-script-tab-content-wrapper" style={{ 
                          display: 'flex', 
                          flexDirection: 'column', 
                          height: '100%', 
                          minHeight: '500px',
                          background: '#ffffff',
                          borderRadius: '12px',
                          border: '1px solid #e5e7eb',
                          overflow: 'hidden',
                          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)'
                        }}>
                          {/* Messages Container */}
                          <div style={{ 
                            flex: 1, 
                            overflowY: 'auto', 
                            padding: '16px', 
                            display: 'flex', 
                            flexDirection: 'column', 
                            gap: '16px',
                            background: '#fafbfc'
                          }}>
                            {editScriptMessages.length === 0 ? (
                              <div style={{ 
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                justifyContent: 'center',
                                textAlign: 'center', 
                                color: '#160211', 
                                fontSize: '14px', 
                                padding: '40px 20px',
                                gap: '16px'
                              }}>
                                <img 
                                  src="/images/chatstar.svg" 
                                  alt="Chat star icon" 
                                  style={{ width: '36px', height: '38px' }}
                                />
                                <div style={{ fontWeight: '500' }}>
                                  Edit your script with AI
                                </div>
                              </div>
                            ) : (
                              <>
                                {editScriptMessages.map((msg, idx) => (
                                  <div
                                    key={idx}
                                    style={{
                                      width: '100%',
                                      marginBottom: '16px'
                                    }}
                                  >
                                    {msg.role === 'user' ? (
                                      <div
                                        style={{
                                          width: '100%',
                                          padding: '10px 14px',
                                          borderRadius: '10px',
                                          background: '#ffffff',
                                          border: '1px solid #e5e7eb',
                                          color: '#111827',
                                          fontSize: '14px',
                                          fontWeight: '400',
                                          lineHeight: '1.6',
                                          wordBreak: 'break-word',
                                          whiteSpace: 'pre-wrap',
                                          boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)'
                                        }}
                                      >
                                        {msg.content}
                                      </div>
                                    ) : (
                                      <div
                                        style={{
                                          width: '100%',
                                          padding: '0',
                                          color: '#111827',
                                          fontSize: '14px',
                                          fontWeight: '400',
                                          lineHeight: '1.6',
                                          wordBreak: 'break-word'
                                        }}
                                      >
                                        {/* Message content */}
                                        <div 
                                          style={{ 
                                            width: '100%',
                                            color: '#374151',
                                            marginBottom: msg.hasCode && msg.proposedCode ? '16px' : '0'
                                          }}
                                          dangerouslySetInnerHTML={{
                                            __html: msg.content
                                              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                              .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                              .replace(/`([^`]+)`/g, '<code style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 13px;">$1</code>')
                                              .replace(/\n/g, '<br/>')
                                          }}
                                        />

                                        {/* Diff View for proposed changes */}
                                        {msg.hasCode && msg.proposedCode && proposedScriptChanges === msg.proposedCode && (
                                          <div style={{
                                            marginTop: '16px',
                                            border: '1px solid #e5e7eb',
                                            borderRadius: '8px',
                                            overflow: 'hidden',
                                            background: '#ffffff'
                                          }}>
                                            {/* Header */}
                                            <div style={{
                                              padding: '12px 16px',
                                              background: '#f9fafb',
                                              borderBottom: '1px solid #e5e7eb',
                                              display: 'flex',
                                              justifyContent: 'space-between',
                                              alignItems: 'center'
                                            }}>
                                              <span style={{ fontSize: '13px', fontWeight: '500', color: '#374151' }}>
                                                Proposed Changes
                                              </span>
                                              <div style={{ display: 'flex', gap: '8px' }}>
                                                <button
                                                  onClick={handleAcceptChanges}
                                                  style={{
                                                    padding: '6px 12px',
                                                    background: '#10b981',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    fontSize: '12px',
                                                    fontWeight: '500',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.2s'
                                                  }}
                                                  onMouseEnter={(e) => e.currentTarget.style.background = '#059669'}
                                                  onMouseLeave={(e) => e.currentTarget.style.background = '#10b981'}
                                                >
                                                  Accept
                                                </button>
                                                <button
                                                  onClick={handleRejectChanges}
                                                  style={{
                                                    padding: '6px 12px',
                                                    background: '#ef4444',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    fontSize: '12px',
                                                    fontWeight: '500',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.2s'
                                                  }}
                                                  onMouseEnter={(e) => e.currentTarget.style.background = '#dc2626'}
                                                  onMouseLeave={(e) => e.currentTarget.style.background = '#ef4444'}
                                                >
                                                  Reject
                                                </button>
                                              </div>
                                            </div>

                                            {/* Diff Content */}
                                            <div style={{
                                              maxHeight: '400px',
                                              overflowY: 'auto',
                                              fontFamily: 'monospace',
                                              fontSize: '13px',
                                              lineHeight: '1.6'
                                            }}>
                                              {computeDiff(safeFormData?.content || '', msg.proposedCode).map((diffLine, lineIdx) => {
                                                if (diffLine.type === 'unchanged') {
                                                  return (
                                                    <div key={lineIdx} style={{
                                                      padding: '4px 16px',
                                                      background: '#ffffff',
                                                      color: '#374151',
                                                      borderLeft: '3px solid transparent',
                                                      whiteSpace: 'pre-wrap'
                                                    }}>
                                                      <span style={{ color: '#9ca3af', marginRight: '12px', display: 'inline-block', width: '40px', textAlign: 'right' }}>
                                                        {diffLine.lineNumber}
                                                      </span>
                                                      {diffLine.oldLine}
                                                    </div>
                                                  );
                                                } else if (diffLine.type === 'removed') {
                                                  return (
                                                    <div key={lineIdx} style={{
                                                      padding: '4px 16px',
                                                      background: '#fef2f2',
                                                      color: '#991b1b',
                                                      borderLeft: '3px solid #ef4444',
                                                      whiteSpace: 'pre-wrap',
                                                      textDecoration: 'line-through'
                                                    }}>
                                                      <span style={{ color: '#9ca3af', marginRight: '12px', display: 'inline-block', width: '40px', textAlign: 'right' }}>
                                                        {diffLine.lineNumber}
                                                      </span>
                                                      {diffLine.oldLine}
                                                    </div>
                                                  );
                                                } else if (diffLine.type === 'added') {
                                                  return (
                                                    <div key={lineIdx} style={{
                                                      padding: '4px 16px',
                                                      background: '#f0fdf4',
                                                      color: '#166534',
                                                      borderLeft: '3px solid #10b981',
                                                      whiteSpace: 'pre-wrap'
                                                    }}>
                                                      <span style={{ color: '#9ca3af', marginRight: '12px', display: 'inline-block', width: '40px', textAlign: 'right' }}>
                                                        +
                                                      </span>
                                                      {diffLine.newLine}
                                                    </div>
                                                  );
                                                } else if (diffLine.type === 'modified') {
                                                  return (
                                                    <React.Fragment key={lineIdx}>
                                                      <div style={{
                                                        padding: '4px 16px',
                                                        background: '#fef2f2',
                                                        color: '#991b1b',
                                                        borderLeft: '3px solid #ef4444',
                                                        whiteSpace: 'pre-wrap',
                                                        textDecoration: 'line-through'
                                                      }}>
                                                        <span style={{ color: '#9ca3af', marginRight: '12px', display: 'inline-block', width: '40px', textAlign: 'right' }}>
                                                          {diffLine.lineNumber}
                                                        </span>
                                                        {diffLine.oldLine}
                                                      </div>
                                                      <div style={{
                                                        padding: '4px 16px',
                                                        background: '#f0fdf4',
                                                        color: '#166534',
                                                        borderLeft: '3px solid #10b981',
                                                        whiteSpace: 'pre-wrap'
                                                      }}>
                                                        <span style={{ color: '#9ca3af', marginRight: '12px', display: 'inline-block', width: '40px', textAlign: 'right' }}>
                                                          +
                                                        </span>
                                                        {diffLine.newLine}
                                                      </div>
                                                    </React.Fragment>
                                                  );
                                                }
                                                return null;
                                              })}
                                            </div>
                                          </div>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                ))}
                                
                                {/* Loading State */}
                                {isEditScriptLoading && (
                                  <div style={{ width: '100%', marginBottom: '16px' }}>
                                    <div
                                      style={{
                                        width: '100%',
                                        padding: '0',
                                        color: '#6b7280',
                                        fontSize: '14px',
                                        fontWeight: '400',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        gap: '8px'
                                      }}
                                    >
                                      <span style={{ color: '#374151', fontWeight: '400' }}>Thinking through the process...</span>
                                      <div style={{ display: 'flex', gap: '4px' }}>
                                        <div style={{ width: '6px', height: '6px', borderRadius: '50%', background: '#9ca3af', animation: 'pulse 1.4s ease-in-out infinite' }}></div>
                                        <div style={{ width: '6px', height: '6px', borderRadius: '50%', background: '#9ca3af', animation: 'pulse 1.4s ease-in-out infinite 0.2s' }}></div>
                                        <div style={{ width: '6px', height: '6px', borderRadius: '50%', background: '#9ca3af', animation: 'pulse 1.4s ease-in-out infinite 0.4s' }}></div>
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </>
                            )}
                            {/* Scroll anchor for auto-scroll */}
                            <div ref={editScriptMessagesEndRef} />
                          </div>

                          {/* Premium Chat Input Bar */}
                          <div style={{
                            position: 'relative',
                            width: '100%',
                            background: '#F3F4F6',
                            flexShrink: 0
                          }}>
                            {/* Header Bar */}
                            <div style={{
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'space-between',
                            padding: '12px 16px',
                              borderBottom: '1px solid #E5E7EB'
                            }}>
                              <div style={{
                                fontSize: '13px',
                                fontWeight: '500',
                                color: '#374151'
                              }}>
                                490 Credits Remaining
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                <button
                                  type="button"
                                  onClick={() => {
                                    // Handle upgrade
                                    console.log('Upgrade clicked');
                                  }}
                                  style={{
                                    background: '#111827',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    padding: '6px 16px',
                                    fontSize: '13px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.background = '#374151';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.background = '#111827';
                                  }}
                                >
                                  Upgrade
                                </button>
                                <button
                                  type="button"
                                  onClick={() => {
                                    // Handle close
                                    console.log('Close clicked');
                                  }}
                                  style={{
                                    background: 'transparent',
                                    border: 'none',
                                    color: '#111827',
                                    cursor: 'pointer',
                                    padding: '4px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    transition: 'all 0.2s'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.opacity = '0.7';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.opacity = '1';
                                  }}
                                >
                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                  </svg>
                                </button>
                              </div>
                            </div>

                            {/* Input Area */}
                            <div style={{
                              position: 'relative',
                              background: 'white',
                              padding: '12px 16px',
                            }}>
                              {/* Pasted Code References */}
                            {pastedCodeReferences.length > 0 && (
                              <div style={{
                                  marginBottom: '12px',
                                display: 'flex',
                                gap: '8px',
                                flexWrap: 'wrap'
                              }}>
                                {pastedCodeReferences.map((ref) => (
                                  <div
                                    key={ref.id}
                                    style={{
                                        padding: '6px 12px',
                                      background: '#f3f4f6',
                                      border: '1px solid #e5e7eb',
                                        borderRadius: '16px',
                                        fontSize: '12px',
                                      color: '#374151',
                                      display: 'flex',
                                      alignItems: 'center',
                                        gap: '6px',
                                        fontWeight: '500'
                                      }}
                                    >
                                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ color: '#6b7280' }}>
                                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                      <polyline points="14 2 14 8 20 8" />
                                    </svg>
                                      <span>{ref.fileName} ({ref.startLine}-{ref.endLine})</span>
                                    <button
                                      type="button"
                                      onClick={() => setPastedCodeReferences(prev => prev.filter(r => r.id !== ref.id))}
                                      style={{
                                        background: 'none',
                                        border: 'none',
                                        cursor: 'pointer',
                                          padding: '0',
                                        color: '#9ca3af',
                                          fontSize: '14px',
                                        lineHeight: '1',
                                        display: 'flex',
                                          alignItems: 'center'
                                      }}
                                    >
                                      Ã—
                                    </button>
                                  </div>
                                ))}
                              </div>
                            )}
                            
                              <input
                                type="text"
                                placeholder="What do wanna do today?"
                                value={editScriptInput || ''}
                                onChange={(e) => {
                                  setEditScriptInput(e.target.value);
                                }}
                                onPaste={(e) => {
                                  const pastedText = e.clipboardData.getData('text');
                                  if (pastedText.trim() && safeFormData?.content) {
                                    const scriptLines = safeFormData.content.split('\n');
                                    const pastedLines = pastedText.split('\n');
                                    let startLine = 1;
                                    let endLine = pastedLines.length;
                                    for (let i = 0; i <= scriptLines.length - pastedLines.length; i++) {
                                      let match = true;
                                      for (let j = 0; j < pastedLines.length; j++) {
                                        if (scriptLines[i + j] !== pastedLines[j]) {
                                          match = false;
                                          break;
                                        }
                                      }
                                      if (match) {
                                        startLine = i + 1;
                                        endLine = i + pastedLines.length;
                                        break;
                                      }
                                    }
                                    const reference = {
                                      id: Date.now(),
                                      fileName: 'Script Content',
                                      startLine,
                                      endLine,
                                      content: pastedText
                                    };
                                    setPastedCodeReferences(prev => [...prev, reference]);
                                  }
                                }}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter' && !e.shiftKey) {
                                    e.preventDefault();
                                    if (editScriptInput.trim()) {
                                      let messageContent = editScriptInput;
                                      if (pastedCodeReferences.length > 0) {
                                        messageContent += '\n\nReferenced code:\n' + pastedCodeReferences.map(ref => 
                                          `[${ref.fileName} (${ref.startLine}-${ref.endLine})]\n${ref.content}`
                                        ).join('\n\n');
                                      }
                                      handleEditScriptSend(messageContent);
                                      setEditScriptInput('');
                                    }
                                  }
                                }}
                                disabled={isEditScriptLoading || !safeFormData?.content}
                                style={{
                                  width: '100%',
                                  border: 'none',
                                  outline: 'none',
                                  fontSize: '15px',
                                  padding: '8px 0',
                                  color: '#111827',
                                  background: 'transparent',
                                  fontFamily: 'inherit'
                                }}
                              />
                              
                              {/* Action Icons */}
                              <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '16px',
                                marginTop: '12px',
                                paddingTop: '12px',
                                borderTop: '1px solid #f3f4f6'
                              }}>
                                {/* Microphone */}
                                <button
                                  type="button"
                                  style={{
                                    background: 'transparent',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '4px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: '#6b7280',
                                    transition: 'all 0.2s'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.color = '#374151';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.color = '#6b7280';
                                  }}
                                >
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                    <line x1="12" y1="19" x2="12" y2="23"></line>
                                    <line x1="8" y1="23" x2="16" y2="23"></line>
                                  </svg>
                                </button>
                                
                                {/* Cursor/Pointer */}
                                <button
                                  type="button"
                                  style={{
                                    background: 'transparent',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '4px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: '#6b7280',
                                    transition: 'all 0.2s'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.color = '#374151';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.color = '#6b7280';
                                  }}
                                >
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path>
                                  </svg>
                                </button>

                                {/* Sparkle 1 */}
                                <button
                                  type="button"
                                  style={{
                                    background: 'transparent',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '4px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: '#6b7280',
                                    transition: 'all 0.2s'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.color = '#374151';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.color = '#6b7280';
                                  }}
                                >
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                  </svg>
                                </button>

                                {/* Sparkle 2 */}
                                <button
                                  type="button"
                                  style={{
                                    background: 'transparent',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '4px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: '#6b7280',
                                    transition: 'all 0.2s'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.color = '#374151';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.color = '#6b7280';
                                  }}
                                >
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                  </svg>
                                </button>

                                {/* Paperclip */}
                                <button
                                  type="button"
                                  onClick={() => {
                                    const input = document.createElement('input');
                                    input.type = 'file';
                                    input.multiple = true;
                                    input.accept = '.txt,.pdf,.doc,.docx';
                                    input.onchange = (e) => {
                                      const files = Array.from(e.target.files);
                                      setUploadedFiles(prev => [...prev, ...files.map(f => f.name)]);
                                    };
                                    input.click();
                                  }}
                                  style={{
                                    background: 'transparent',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '4px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: '#6b7280',
                                    transition: 'all 0.2s'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.color = '#374151';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.color = '#6b7280';
                                  }}
                                >
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                  </svg>
                                </button>
                                
                                {/* Upload/Share */}
                                <button
                                  type="button"
                                  style={{
                                    background: 'transparent',
                                    border: 'none',
                                    cursor: 'pointer',
                                    padding: '4px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: '#6b7280',
                                    transition: 'all 0.2s'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.color = '#374151';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.color = '#6b7280';
                                  }}
                                >
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                  </svg>
                                </button>
                              </div>

                              {/* Send Button */}
                              <button
                                type="button"
                                onClick={() => {
                                  if (editScriptInput.trim()) {
                                      let messageContent = editScriptInput;
                                      if (pastedCodeReferences.length > 0) {
                                        messageContent += '\n\nReferenced code:\n' + pastedCodeReferences.map(ref => 
                                          `[${ref.fileName} (${ref.startLine}-${ref.endLine})]\n${ref.content}`
                                        ).join('\n\n');
                                      }
                                      handleEditScriptSend(messageContent);
                                    setEditScriptInput('');
                                    }
                                  }}
                                disabled={!editScriptInput.trim() || isEditScriptLoading || !safeFormData?.content}
                                  style={{
                                  position: 'absolute',
                                  bottom: '20px',
                                  right: '16px',
                                    width: '36px',
                                    height: '36px',
                                    borderRadius: '50%',
                                  background: editScriptInput.trim() && !isEditScriptLoading && safeFormData?.content ? '#111827' : '#d1d5db',
                                  border: 'none',
                                  cursor: editScriptInput.trim() && !isEditScriptLoading && safeFormData?.content ? 'pointer' : 'not-allowed',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                  boxShadow: editScriptInput.trim() && !isEditScriptLoading && safeFormData?.content ? '0 2px 8px rgba(17, 24, 39, 0.2)' : 'none',
                                    transition: 'all 0.2s',
                                  opacity: editScriptInput.trim() && !isEditScriptLoading && safeFormData?.content ? 1 : 0.6
                                  }}
                                  onMouseEnter={(e) => {
                                  if (editScriptInput.trim() && !isEditScriptLoading && safeFormData?.content) {
                                    e.currentTarget.style.background = '#374151';
                                    e.currentTarget.style.transform = 'scale(1.05)';
                                    }
                                  }}
                                  onMouseLeave={(e) => {
                                  if (editScriptInput.trim() && !isEditScriptLoading && safeFormData?.content) {
                                    e.currentTarget.style.background = '#111827';
                                    e.currentTarget.style.transform = 'scale(1)';
                                  }
                                }}
                              >
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                  <line x1="22" y1="2" x2="11" y2="13"></line>
                                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                              </div>
                            </div>

                            {/* Uploaded Files */}
                            {uploadedFiles.length > 0 && (
                              <div style={{
                                marginTop: '12px',
                                display: 'flex',
                                gap: '8px',
                                flexWrap: 'wrap'
                              }}>
                                {uploadedFiles.map((file, idx) => (
                                  <div
                                    key={idx}
                                    style={{
                                    padding: '6px 12px',
                                      background: '#f3f4f6',
                                      border: '1px solid #e5e7eb',
                                    borderRadius: '16px',
                                      fontSize: '12px',
                                      color: '#374151',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '6px'
                                    }}
                                  >
                                  <span>{file}</span>
                                    <button
                                      type="button"
                                      onClick={() => setUploadedFiles(prev => prev.filter((_, i) => i !== idx))}
                                      style={{
                                        background: 'none',
                                        border: 'none',
                                        cursor: 'pointer',
                                        padding: '0',
                                        color: '#9ca3af',
                                      fontSize: '14px'
                                      }}
                                    >
                                      Ã—
                                    </button>
                                  </div>
                                ))}
                              </div>
                            )}
                        </div>
                      )}

                      {/* Analytics Tab Content */}
                      {box2ActiveTab === 'analytics' && (
                        <div style={{
                          padding: '24px',
                          height: '100%',
                          overflowY: 'auto',
                          background: '#ffffff'
                        }}>
                          <div style={{ marginBottom: '24px' }}>
                            <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#111827', marginBottom: '8px' }}>
                              Transcript Analytics
                            </h3>
                          </div>
                        </div>
                      )}

                      {/* Analytics Tab Content */}
                      {box2ActiveTab === 'analytics' && (
                        <div style={{
                          padding: '24px',
                          height: '100%',
                          overflowY: 'auto',
                          background: '#ffffff'
                        }}>
                          <div style={{ marginBottom: '24px' }}>
                            <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#111827', marginBottom: '8px' }}>
                              Transcript Analytics
                            </h3>
                          </div>
                        </div>
                      )}

                      {/* Analytics Tab Content */}
                      {box2ActiveTab === 'analytics' && (
                        <div style={{
                          padding: '24px',
                          height: '100%',
                          overflowY: 'auto',
                          background: '#ffffff'
                        }}>
                          <div style={{ marginBottom: '24px' }}>
                            <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#111827', marginBottom: '8px' }}>
                              Transcript Analytics
                            </h3>
                            <p style={{ fontSize: '14px', color: '#6b7280' }}>
                              Analyze dropoff rates by turn and duration
                            </p>
                      </div>

                          {/* Controls */}
                          <div style={{
                            display: 'flex',
                            gap: '16px',
                            marginBottom: '24px',
                            alignItems: 'center',
                            padding: '16px',
                            background: '#f9fafb',
                            borderRadius: '8px',
                            border: '1px solid #e5e7eb'
                          }}>
                            <div style={{ flex: 1 }}>
                              <label style={{ fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px', display: 'block' }}>
                                Number of Calls to Analyze
                              </label>
                              <input
                                type="number"
                                value={analyticsLimit}
                                onChange={(e) => setAnalyticsLimit(parseInt(e.target.value) || 100)}
                                min="10"
                                max="1000"
                                step="10"
                                style={{
                                  width: '100%',
                                  padding: '8px 12px',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '6px',
                                  fontSize: '14px'
                                }}
                              />
                              {analyticsData && (
                                <div style={{ marginTop: '4px', fontSize: '12px', color: '#6b7280' }}>
                                  Total Lifetime: {analyticsData.totalLifetime} calls
                    </div>
                              )}
                  </div>
                            <div style={{ paddingTop: '24px' }}>
                              <button
                                onClick={loadAnalyticsData}
                                disabled={analyticsLoading}
                                style={{
                                  padding: '10px 24px',
                                  background: analyticsLoading ? '#e5e7eb' : '#4B5CFF',
                                  color: analyticsLoading ? '#9ca3af' : '#ffffff',
                                  border: 'none',
                                  borderRadius: '8px',
                                  fontSize: '14px',
                                  fontWeight: '500',
                                  cursor: analyticsLoading ? 'not-allowed' : 'pointer',
                                  transition: 'all 0.2s'
                                }}
                                onMouseEnter={(e) => {
                                  if (!analyticsLoading) e.currentTarget.style.background = '#3d4ecc';
                                }}
                                onMouseLeave={(e) => {
                                  if (!analyticsLoading) e.currentTarget.style.background = '#4B5CFF';
                                }}
                              >
                                {analyticsLoading ? 'Loading...' : 'Analyze'}
                              </button>
                            </div>
                          </div>

                          {/* Error */}
                          {analyticsError && (
                            <div style={{
                              padding: '16px',
                              background: '#fef2f2',
                              border: '1px solid #fecaca',
                              borderRadius: '8px',
                              color: '#dc2626',
                              fontSize: '14px',
                              marginBottom: '24px'
                            }}>
                              {analyticsError}
                            </div>
                          )}

                          {/* Loading State */}
                          {analyticsLoading && (
                            <div style={{
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              padding: '60px 20px',
                              fontSize: '14px',
                              color: '#6b7280'
                            }}>
                              Processing {analyticsLimit} calls...
                            </div>
                          )}

                          {/* Results */}
                          {!analyticsLoading && analyticsData && (
                            <>
                              {/* Statistics */}
                              <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                                gap: '16px',
                                marginBottom: '32px'
                              }}>
                                <div style={{
                                  padding: '16px',
                                  background: '#f9fafb',
                                  borderRadius: '8px',
                                  border: '1px solid #e5e7eb'
                                }}>
                                  <div style={{ fontSize: '12px', color: '#6b7280', marginBottom: '4px' }}>Calls Analyzed</div>
                                  <div style={{ fontSize: '24px', fontWeight: '600', color: '#111827' }}>
                                    {analyticsData.totalAnalyzed}
                                  </div>
                                </div>
                                <div style={{
                                  padding: '16px',
                                  background: '#f9fafb',
                                  borderRadius: '8px',
                                  border: '1px solid #e5e7eb'
                                }}>
                                  <div style={{ fontSize: '12px', color: '#6b7280', marginBottom: '4px' }}>Avg Turns</div>
                                  <div style={{ fontSize: '24px', fontWeight: '600', color: '#111827' }}>
                                    {analyticsData.statistics.avgTurns}
                                  </div>
                                </div>
                                <div style={{
                                  padding: '16px',
                                  background: '#f9fafb',
                                  borderRadius: '8px',
                                  border: '1px solid #e5e7eb'
                                }}>
                                  <div style={{ fontSize: '12px', color: '#6b7280', marginBottom: '4px' }}>Avg Duration</div>
                                  <div style={{ fontSize: '24px', fontWeight: '600', color: '#111827' }}>
                                    {analyticsData.statistics.avgDuration}s
                                  </div>
                                </div>
                              </div>

                              {/* Dropoff by Turn Graph */}
                              <div style={{
                                marginBottom: '32px',
                                padding: '20px',
                                background: '#ffffff',
                                borderRadius: '8px',
                                border: '1px solid #e5e7eb'
                              }}>
                                <h4 style={{ fontSize: '16px', fontWeight: '600', color: '#111827', marginBottom: '16px' }}>
                                  Dropoff Rate by Turn
                                </h4>
                                <canvas
                                  ref={(el) => {
                                    if (el && analyticsData) {
                                      const ctx = el.getContext('2d');
                                      if (window.turnChart) {
                                        window.turnChart.destroy();
                                      }
                                      window.turnChart = new window.Chart(ctx, {
                                        type: 'line',
                                        data: {
                                          labels: analyticsData.turnDropoff.slice(0, 20).map(d => `Turn ${d.turn}`),
                                          datasets: [{
                                            label: 'Dropoff Rate (%)',
                                            data: analyticsData.turnDropoff.slice(0, 20).map(d => d.dropoffRate),
                                            borderColor: '#ef4444',
                                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                            borderWidth: 2,
                                            tension: 0.4,
                                            fill: true
                                          }]
                                        },
                                        options: {
                                          responsive: true,
                                          maintainAspectRatio: true,
                                          aspectRatio: 2,
                                          plugins: {
                                            legend: {
                                              display: false
                                            },
                                            tooltip: {
                                              callbacks: {
                                                label: function(context) {
                                                  const dataPoint = analyticsData.turnDropoff[context.dataIndex];
                                                  return [
                                                    `Dropoff Rate: ${dataPoint.dropoffRate}%`,
                                                    `Remaining Calls: ${dataPoint.remainingCalls}`
                                                  ];
                                                }
                                              }
                                            }
                                          },
                                          scales: {
                                            y: {
                                              beginAtZero: true,
                                              title: {
                                                display: true,
                                                text: 'Dropoff Rate (%)'
                                              }
                                            },
                                            x: {
                                              title: {
                                                display: true,
                                                text: 'Turn Number'
                                              }
                                            }
                                          }
                                        }
                                      });
                                    }
                                  }}
                                  style={{ maxHeight: '300px' }}
                                />
                              </div>

                              {/* Dropoff by Second Graph */}
                              <div style={{
                                padding: '20px',
                                background: '#ffffff',
                                borderRadius: '8px',
                                border: '1px solid #e5e7eb'
                              }}>
                                <h4 style={{ fontSize: '16px', fontWeight: '600', color: '#111827', marginBottom: '16px' }}>
                                  Dropoff Rate by Duration
                                </h4>
                                <canvas
                                  ref={(el) => {
                                    if (el && analyticsData) {
                                      const ctx = el.getContext('2d');
                                      if (window.secondChart) {
                                        window.secondChart.destroy();
                                      }
                                      window.secondChart = new window.Chart(ctx, {
                                        type: 'line',
                                        data: {
                                          labels: analyticsData.secondDropoff.slice(0, 20).map(d => `${d.seconds}s`),
                                          datasets: [{
                                            label: 'Dropoff Rate (%)',
                                            data: analyticsData.secondDropoff.slice(0, 20).map(d => d.dropoffRate),
                                            borderColor: '#3b82f6',
                                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                            borderWidth: 2,
                                            tension: 0.4,
                                            fill: true
                                          }]
                                        },
                                        options: {
                                          responsive: true,
                                          maintainAspectRatio: true,
                                          aspectRatio: 2,
                                          plugins: {
                                            legend: {
                                              display: false
                                            },
                                            tooltip: {
                                              callbacks: {
                                                label: function(context) {
                                                  const dataPoint = analyticsData.secondDropoff[context.dataIndex];
                                                  return [
                                                    `Dropoff Rate: ${dataPoint.dropoffRate}%`,
                                                    `Remaining Calls: ${dataPoint.remainingCalls}`
                                                  ];
                                                }
                                              }
                                            }
                                          },
                                          scales: {
                                            y: {
                                              beginAtZero: true,
                                              title: {
                                                display: true,
                                                text: 'Dropoff Rate (%)'
                                              }
                                            },
                                            x: {
                                              title: {
                                                display: true,
                                                text: 'Duration (seconds)'
                                              }
                                            }
                                          }
                                        }
                                      });
                                    }
                                  }}
                                  style={{ maxHeight: '300px' }}
                                />
                              </div>
                            </>
                          )}
                        </div>
                      )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Voice Tab Content */}
            {activeTab === 'variables' && (
              <div className="tab-content" style={{ display: 'flex', gap: '24px', flexWrap: 'wrap' }}>
                <div style={{ flex: '0 0 260px', border: '1px solid #E5E7EB', borderRadius: '10px', padding: '16px', background: '#fff' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                    <div>
                      <div style={{ fontSize: '14px', fontWeight: 600, color: '#111827' }}>Variable Books</div>
                      <div style={{ fontSize: '12px', color: '#6B7280' }}>{variableBooks.length} book(s)</div>
                    </div>
                    <button
                      type="button"
                      onClick={handleCreateVariableBook}
                      style={{
                        padding: '6px 10px',
                        fontSize: '12px',
                        borderRadius: '6px',
                        border: '1px solid #D1D5DB',
                        background: '#F9FAFB',
                        cursor: 'pointer'
                      }}
                    >
                      + New
                    </button>
                  </div>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {/* Pre Built Variables - Permanent Book */}
                    <button
                      onClick={() => {
                        if (selectedVariableBookId === 'PRE_BUILT_VARIABLES') {
                          setSelectedVariableBookId(null);
                        } else {
                          setSelectedVariableBookId('PRE_BUILT_VARIABLES');
                        }
                      }}
                      style={{
                        textAlign: 'left',
                        borderRadius: '8px',
                        padding: '10px 12px',
                        border: selectedVariableBookId === 'PRE_BUILT_VARIABLES' ? '1.5px solid #4B5CFF' : '1px solid #E5E7EB',
                        background: selectedVariableBookId === 'PRE_BUILT_VARIABLES' ? '#EEF2FF' : '#FFFFFF',
                        cursor: 'pointer'
                      }}
                    >
                      <div style={{ fontSize: '13px', fontWeight: 600, color: '#111827', marginBottom: '4px' }}>Pre Built Variables</div>
                      <div style={{ fontSize: '11px', color: '#6B7280' }}>
                        View all available variables
                      </div>
                    </button>
                    {variableBooks.length === 0 && (
                      <div style={{ fontSize: '12px', color: '#6B7280', padding: '8px 0' }}>
                        No variable books yet. Create one to start defining answers.
                      </div>
                    )}
                    {variableBooks.map((book) => {
                      const definedCount = manualVariables.filter((name) => {
                        const value = book.definitions?.[name] || '';
                        return value.trim().length > 0;
                      }).length;
                      const manualTotal = manualVariables.length;
                      const isActive = selectedVariableBookId === book.id;
                      return (
                        <button
                          key={book.id}
                          onClick={() => attachVariableBookToCurrent(book.id)}
                          style={{
                            textAlign: 'left',
                            borderRadius: '8px',
                            padding: '10px 12px',
                            border: isActive ? '1.5px solid #4B5CFF' : '1px solid #E5E7EB',
                            background: isActive ? '#EEF2FF' : '#FFFFFF',
                            cursor: 'pointer'
                          }}
                        >
                          <div style={{ fontSize: '13px', fontWeight: 600, color: '#111827', marginBottom: '4px' }}>{book.name}</div>
                          <div style={{ fontSize: '11px', color: '#6B7280' }}>
                            {manualTotal === 0 ? 'No manual variables required' : `${definedCount}/${manualTotal} manual vars defined`}
                          </div>
                        </button>
                      );
                    })}
                  </div>
                </div>
                <div style={{ flex: 1, minWidth: '280px', border: '1px solid #E5E7EB', borderRadius: '10px', padding: '20px', background: '#fff', display: 'flex', flexDirection: 'column', minHeight: 0, overflow: 'hidden' }}>
                  {selectedVariableBookId === 'PRE_BUILT_VARIABLES' ? (
                    <div style={{ flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0, overflow: 'hidden' }}>
                      {/* Format Info */}
                      <div style={{ padding: '16px', borderBottom: '1px solid #E5E7EB', background: '#F9FAFB' }}>
                        <div style={{ fontSize: '13px', fontWeight: 600, color: '#111827', marginBottom: '8px' }}>Format</div>
                        <div style={{ fontSize: '12px', color: '#6B7280', display: 'flex', gap: '16px' }}>
                          <span>Single: <code style={{ background: '#E5E7EB', padding: '2px 6px', borderRadius: '4px', fontSize: '11px', fontFamily: 'monospace' }}>{'{variable}'}</code></span>
                          <span>Double: <code style={{ background: '#E5E7EB', padding: '2px 6px', borderRadius: '4px', fontSize: '11px', fontFamily: 'monospace' }}>{'{{variable}}'}</code></span>
                        </div>
                      </div>
                      
                      {/* Search Bar */}
                      <div style={{ padding: '12px 16px', borderBottom: '1px solid #E5E7EB' }}>
                        <div style={{ position: 'relative' }}>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#9CA3AF' }}>
                            <circle cx="11" cy="11" r="8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                            <path d="M21 21L16.65 16.65" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                          </svg>
                          <input
                            type="text"
                            placeholder="Search variables..."
                            value={variableSearchQuery}
                            onChange={(e) => setVariableSearchQuery(e.target.value)}
                            style={{
                              width: '100%',
                              padding: '8px 12px 8px 36px',
                              border: '1px solid #D1D5DB',
                              borderRadius: '6px',
                              fontSize: '13px',
                              outline: 'none',
                              transition: 'border-color 0.2s'
                            }}
                            onFocus={(e) => e.target.style.borderColor = '#4B5CFF'}
                            onBlur={(e) => e.target.style.borderColor = '#D1D5DB'}
                          />
                        </div>
                      </div>
                      
                      {/* Variables List */}
                      <div style={{ flex: 1, overflowY: 'auto', padding: '12px' }}>
                        {(() => {
                          const variables = [
                            { name: 'customerName', formats: ['{customerName}', '{{customerName}}', '{customer_name}', '{{customer_name}}'], example: 'John Doe' },
                            { name: 'orderNumber', formats: ['{orderNumber}', '{{orderNumber}}', '{order_number}', '{{order_number}}'], example: 'NK/23611' },
                            { name: 'orderTotal', formats: ['{orderTotal}', '{{orderTotal}}', '{order_total}', '{{order_total}}', '{totalPrice}', '{{totalPrice}}'], example: '599' },
                            { name: 'orderAmount', formats: ['{orderAmount}', '{{orderAmount}}', '{order_amount}', '{{order_amount}}'], example: '599' },
                            { name: 'deliveryAddress', formats: ['{deliveryAddress}', '{{deliveryAddress}}', '{delivery_address}', '{{delivery_address}}', '{address}', '{{address}}'], example: '123 Main St, City, State, 12345, India' },
                            { name: 'city', formats: ['{city}', '{{city}}', '{City}', '{{City}}'], example: 'Mumbai' },
                            { name: 'orderDate', formats: ['{orderDate}', '{{orderDate}}', '{order_date}', '{{order_date}}'], example: '2024-12-13' },
                            { name: 'orderId', formats: ['{orderId}', '{{orderId}}', '{order_id}', '{{order_id}}'], example: '12345' },
                            { name: 'productName', formats: ['{productName}', '{{productName}}', '{product_name}', '{{product_name}}'], example: 'Product Name aur Another Product' },
                            { name: 'repeatOrderDates', formats: ['{repeat_order_dates}', '{{repeat_order_dates}}'], example: '2024-12-01, 2024-12-05, 2024-12-10' },
                            { name: 'repeatOrderCount', formats: ['{repeat_order_count}', '{{repeat_order_count}}'], example: '3' }
                          ];
                          
                          const filteredVariables = variables.filter(v => 
                            v.name.toLowerCase().includes(variableSearchQuery.toLowerCase()) ||
                            v.formats.some(f => f.toLowerCase().includes(variableSearchQuery.toLowerCase())) ||
                            v.example.toLowerCase().includes(variableSearchQuery.toLowerCase())
                          );
                          
                          return filteredVariables.length > 0 ? (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                              {filteredVariables.map((variable, index) => (
                                <div
                                  key={index}
                                  style={{
                                    padding: '12px',
                                    border: '1px solid #E5E7EB',
                                    borderRadius: '8px',
                                    background: '#FFFFFF',
                                    transition: 'all 0.2s'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.borderColor = '#4B5CFF';
                                    e.currentTarget.style.boxShadow = '0 2px 4px rgba(75, 92, 255, 0.1)';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.borderColor = '#E5E7EB';
                                    e.currentTarget.style.boxShadow = 'none';
                                  }}
                                >
                                  <div style={{ fontSize: '13px', fontWeight: 600, color: '#111827', marginBottom: '8px' }}>
                                    {variable.name.charAt(0).toUpperCase() + variable.name.slice(1).replace(/([A-Z])/g, ' $1')}
                                  </div>
                                  <div style={{ fontSize: '12px', color: '#6B7280', marginBottom: '8px' }}>
                                    <div style={{ marginBottom: '4px' }}>Format:</div>
                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                                      {variable.formats.slice(0, 2).map((format, idx) => (
                                        <code
                                          key={idx}
                                          style={{
                                            background: '#F3F4F6',
                                            padding: '4px 8px',
                                            borderRadius: '4px',
                                            fontSize: '11px',
                                            fontFamily: 'monospace',
                                            color: '#DC2626',
                                            cursor: 'pointer'
                                          }}
                                          onClick={() => {
                                            navigator.clipboard.writeText(format);
                                          }}
                                          title="Click to copy"
                                        >
                                          {format}
                                        </code>
                                      ))}
                                      {variable.formats.length > 2 && (
                                        <span style={{ fontSize: '11px', color: '#9CA3AF' }}>+{variable.formats.length - 2} more</span>
                                      )}
                                    </div>
                                  </div>
                                  <div style={{ fontSize: '12px', color: '#6B7280' }}>
                                    <div style={{ marginBottom: '4px' }}>Example:</div>
                                    <div style={{ color: '#111827', fontWeight: 500 }}>{variable.example}</div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          ) : (
                            <div style={{ padding: '40px 20px', textAlign: 'center', color: '#6B7280', fontSize: '14px' }}>
                              No variables found matching "{variableSearchQuery}"
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                  ) : variablesUsed.length === 0 ? (
                    <div style={{ fontSize: '14px', color: '#6B7280' }}>
                      No template variables detected in this script. Add placeholders like {'{customer_name}'} to see them here.
                    </div>
                  ) : manualVariables.length === 0 ? (
                    <div style={{ fontSize: '14px', color: '#059669', background: '#ECFDF5', border: '1px solid #BBF7D0', borderRadius: '8px', padding: '16px' }}>
                      All variables in this script are auto-filled from the order. No manual entries required.
                    </div>
                  ) : selectedVariableBookId ? (
                    <>
                      <div className="form-group" style={{ marginBottom: '16px' }}>
                        <label style={{ fontSize: '13px', fontWeight: 600, color: '#111827' }}>Variable Book Name</label>
                        <input
                          type="text"
                          value={variableBookNameDraft || ''}
                          onChange={(e) => setVariableBookNameDraft(e.target.value)}
                          placeholder="Enter a name for this variable book"
                          style={{
                            width: '100%',
                            padding: '10px 12px',
                            border: '1px solid #D1D5DB',
                            borderRadius: '6px',
                            fontSize: '14px'
                          }}
                        />
                      </div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        {manualVariables.map((variable) => (
                          <div key={variable} style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                            <label style={{ fontSize: '12px', fontWeight: 600, color: '#111827' }}>{variable}</label>
                            <textarea
                              value={variableInputs[variable] || ''}
                              onChange={(e) => handleVariableInputChange(variable, e.target.value)}
                              placeholder={`Enter value for ${variable}`}
                              style={{
                                width: '100%',
                                minHeight: '60px',
                                border: '1px solid #D1D5DB',
                                borderRadius: '8px',
                                padding: '10px 12px',
                                fontSize: '13px'
                              }}
                            />
                          </div>
                        ))}
                      </div>
                      <div style={{ marginTop: '16px', display: 'flex', gap: '12px' }}>
                        <button
                          type="button"
                          onClick={handleSaveVariableDefinitions}
                          disabled={isVariableSaving}
                          style={{
                            padding: '10px 18px',
                            background: '#4B5CFF',
                            color: '#fff',
                            border: 'none',
                            borderRadius: '8px',
                            fontWeight: 600,
                            cursor: 'pointer'
                          }}
                        >
                          {isVariableSaving ? 'Savingâ€¦' : 'Save & Attach'}
                        </button>
                      </div>
                    </>
                  ) : (
                    <div style={{ fontSize: '14px', color: '#6B7280' }}>
                      Select or create a variable book on the left to start defining values.
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Chat Tab Content */}
            {box2ActiveTab === 'chat' && (
              <div className="chat-tab-content-wrapper">
                <div className="chat-tab-content" style={{ display: 'flex', flexDirection: 'column', height: '100%', minHeight: '400px' }}>
                {!safeFormData?.content ? (
                  <div style={{ padding: '40px 20px', textAlign: 'center', color: '#6B7280', fontSize: '14px' }}>
                    Please add script content to start chatting
                  </div>
                ) : (
                  <>
                    <div style={{ flex: 1, overflowY: 'auto', padding: '16px', display: 'flex', flexDirection: 'column', gap: '12px' }}>
                      {chatMessages.length === 0 ? (
                        <div style={{ textAlign: 'center', color: '#9CA3AF', fontSize: '14px', padding: '40px 20px' }}>
                          Start a conversation with your script
                        </div>
                      ) : (
                        chatMessages.map((msg, idx) => (
                          <div
                            key={idx}
                            style={{
                              display: 'flex',
                              justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start',
                              marginBottom: '8px'
                            }}
                          >
                            <div
                              style={{
                                maxWidth: '80%',
                                padding: '10px 14px',
                                borderRadius: '12px',
                                background: msg.role === 'user' ? '#4B5CFF' : '#F3F4F6',
                                color: msg.role === 'user' ? '#FFFFFF' : '#111827',
                                fontSize: '14px',
                                lineHeight: '1.5',
                                wordBreak: 'break-word'
                              }}
                            >
                              {msg.content}
                            </div>
                          </div>
                        ))
                      )}
                      {isChatLoading && (
                        <div style={{ display: 'flex', justifyContent: 'flex-start' }}>
                          <div
                            style={{
                              padding: '10px 14px',
                              borderRadius: '12px',
                              background: '#F3F4F6',
                              color: '#111827',
                              fontSize: '14px'
                            }}
                          >
                            Thinking...
                          </div>
                        </div>
                      )}
                    </div>
                    <div style={{ padding: '16px', borderTop: '1px solid #E5E7EB', display: 'flex', gap: '8px' }}>
                      <input
                        type="text"
                        value={chatInput}
                        onChange={(e) => setChatInput(e.target.value)}
                        onKeyPress={(e) => {
                          if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            handleChatSend();
                          }
                        }}
                        placeholder="Type your message..."
                        disabled={isChatLoading || !safeFormData?.content}
                        style={{
                          flex: 1,
                          padding: '10px 14px',
                          border: '1px solid #D1D5DB',
                          borderRadius: '8px',
                          fontSize: '14px'
                        }}
                      />
                      <button
                        type="button"
                        onClick={handleChatSend}
                        disabled={isChatLoading || !chatInput.trim() || !safeFormData?.content}
                        style={{
                          padding: '10px 20px',
                          background: '#4B5CFF',
                          color: '#FFFFFF',
                          border: 'none',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontWeight: '500',
                          cursor: isChatLoading || !chatInput.trim() || !safeFormData?.content ? 'not-allowed' : 'pointer',
                          opacity: isChatLoading || !chatInput.trim() || !safeFormData?.content ? 0.5 : 1
                        }}
                      >
                        Send
                      </button>
                      <button
                        type="button"
                        onClick={() => {
                          setChatMessages([]);
                          setChatInput('');
                        }}
                        disabled={chatMessages.length === 0}
                        style={{
                          padding: '10px 16px',
                          background: '#F3F4F6',
                          color: '#6B7280',
                          border: 'none',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontWeight: '500',
                          cursor: chatMessages.length === 0 ? 'not-allowed' : 'pointer',
                          opacity: chatMessages.length === 0 ? 0.5 : 1
                        }}
                      >
                        Clear
                      </button>
                    </div>
                  </>
                )}
                </div>
              </div>
            )}

            {/* Voice Tab Content */}
            {activeTab === 'voice' && (
              <div className="tab-content tab-content--voice">
                <div className="voice-tab-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '0px', width: '100%', height: '100%' }}>
                  {/* Left Box: Voice */}
                  <div className="form-section" style={{ gridColumn: 'span 2' }}>
                    <h4>Voice</h4>
                    {/* Search and Filter */}
                    <div style={{ display: 'flex', gap: '12px', width: '100%', marginTop: '16px', marginBottom: '16px' }}>
                      {/* Search Box */}
                      <div style={{ 
                        flex: 1, 
                        position: 'relative', 
                        display: 'flex', 
                        alignItems: 'center',
                        height: '33px'
                      }}>
                        <div style={{ 
                          position: 'absolute', 
                          left: '18px', 
                          display: 'flex', 
                          alignItems: 'center',
                          pointerEvents: 'none'
                        }}>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path fillRule="evenodd" clipRule="evenodd" d="M9.82264 10.8833C8.89957 11.5841 7.74835 12 6.5 12C3.46243 12 1 9.53757 1 6.5C1 3.46243 3.46243 1 6.5 1C9.53757 1 12 3.46243 12 6.5C12 7.74835 11.5841 8.89957 10.8833 9.82264L14.7803 13.7197C15.0732 14.0126 15.0732 14.4874 14.7803 14.7803C14.4874 15.0732 14.0126 15.0732 13.7197 14.7803L9.82264 10.8833ZM10.5 6.5C10.5 8.70914 8.70914 10.5 6.5 10.5C4.29086 10.5 2.5 8.70914 2.5 6.5C2.5 4.29086 4.29086 2.5 6.5 2.5C8.70914 2.5 10.5 4.29086 10.5 6.5Z" fill="#939496"/>
                          </svg>
                        </div>
                        <input
                          type="text"
                          placeholder="Search Voices here..."
                          value={voiceSearchQuery}
                          onChange={(e) => setVoiceSearchQuery(e.target.value)}
                          onFocus={() => setIsSearchFocused(true)}
                          onBlur={() => setIsSearchFocused(false)}
                          style={{
                            width: '100%',
                            height: '33px',
                            paddingLeft: '46px',
                            paddingRight: '12px',
                            paddingTop: '4px',
                            paddingBottom: '4px',
                            border: `1px solid ${isSearchFocused ? '#4B5CFF' : '#e5e7eb'}`,
                            borderRadius: '8px',
                            fontSize: '14px',
                            outline: 'none',
                            transition: 'border-color 0.2s ease',
                          }}
                        />
                      </div>
                      {/* Filter Icon */}
                      <div
                        onClick={() => setIsFilterPanelOpen(!isFilterPanelOpen)}
                        onMouseEnter={() => setIsFilterHovered(true)}
                        onMouseLeave={() => setIsFilterHovered(false)}
                          style={{ 
                            display: 'flex',
                            alignItems: 'center',
                          justifyContent: 'center',
                          cursor: 'pointer',
                          height: '33px',
                          width: '33px',
                          borderRadius: '8px',
                          border: `1px solid ${isFilterPanelOpen ? '#4B5CFF' : (isFilterHovered ? '#d1d5db' : '#e5e7eb')}`,
                          background: isFilterPanelOpen ? '#F0F4FF' : 'white',
                          transition: 'all 0.2s ease'
                          }}
                        >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16" fill="none">
                          <path fillRule="evenodd" clipRule="evenodd" d="M14.25 3C14.4489 3 14.6397 3.07902 14.7803 3.21967C14.921 3.36032 15 3.55109 15 3.75C15 3.94891 14.921 4.13968 14.7803 4.28033C14.6397 4.42098 14.4489 4.5 14.25 4.5H1.75C1.55109 4.5 1.36032 4.42098 1.21967 4.28033C1.07902 4.13968 1 3.94891 1 3.75C1 3.55109 1.07902 3.36032 1.21967 3.21967C1.36032 3.07902 1.55109 3 1.75 3H14.25ZM4 8C4 7.80109 4.07902 7.61032 4.21967 7.46967C4.36032 7.32902 4.55109 7.25 4.75 7.25H11.25C11.4489 7.25 11.6397 7.32902 11.7803 7.46967C11.921 7.61032 12 7.80109 12 8C12 8.19891 11.921 8.38968 11.7803 8.53033C11.6397 8.67098 11.4489 8.75 11.25 8.75H4.75C4.55109 8.75 4.36032 8.67098 4.21967 8.53033C4.07902 8.38968 4 8.19891 4 8ZM6.75 11.5C6.55109 11.5 6.36032 11.579 6.21967 11.7197C6.07902 11.8603 6 12.0511 6 12.25C6 12.4489 6.07902 12.6397 6.21967 12.7803C6.36032 12.921 6.55109 13 6.75 13H9.25C9.44891 13 9.63968 12.921 9.78033 12.7803C9.92098 12.6397 10 12.4489 10 12.25C10 12.0511 9.92098 11.8603 9.78033 11.7197C9.63968 11.579 9.44891 11.5 9.25 11.5H6.75Z" fill={isFilterPanelOpen ? '#4B5CFF' : '#959699'}/>
                          </svg>
                      </div>
                    </div>

                    {/* Filter Panel */}
                    {isFilterPanelOpen && (
                      <div style={{
                        marginTop: '16px',
                        marginBottom: '16px',
                        padding: '16px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        background: 'white'
                      }}>
                        {/* Filters Grid */}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                          {/* Left Grid: Language and Gender Dropdowns */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            {/* Language Dropdown */}
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                              <div style={{ fontSize: '13px', fontWeight: '600', color: '#111827' }}>Language</div>
                              <div style={{ position: 'relative', width: '100%' }} ref={filterLanguageDropdownRef}>
                                <div
                                  onClick={() => setIsLanguageDropdownOpen(!isLanguageDropdownOpen)}
                          style={{
                            display: 'flex',
                            alignItems: 'center',
                                    justifyContent: 'space-between',
                                    padding: '4px 10px',
                                    height: '28px',
                                    border: '1px solid #e5e7eb',
                            borderRadius: '8px',
                                    cursor: 'pointer',
                                    background: 'white',
                                    fontSize: '12px',
                                    color: selectedLanguage || '#6b7280'
                                  }}
                                >
                                  <span>{selectedLanguage || 'Select Language'}</span>
                                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 4.5L6 7.5L9 4.5" stroke="#6b7280" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                                  </svg>
                                </div>
                                {isLanguageDropdownOpen && (
                                  <div style={{
                                    position: 'absolute',
                                    top: '100%',
                                    left: 0,
                                    right: 0,
                                    marginTop: '4px',
                                    background: 'white',
                                    border: '1px solid #e5e7eb',
                                    borderRadius: '6px',
                                    boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
                                    zIndex: 1000,
                                    maxHeight: '200px',
                                    overflowY: 'auto'
                                  }}>
                                    {['Hindi', 'English', 'Telugu', 'Tamil', 'Kannada', 'Malayalam', 'Marathi', 'Gujarati', 'Bengali', 'Punjabi', 'Urdu', 'Odia', 'Assamese'].map((lang) => (
                                      <div
                                        key={lang}
                                        onClick={() => {
                                          setSelectedLanguage(lang);
                                          setIsLanguageDropdownOpen(false);
                            }}
                            style={{
                                          padding: '8px 12px',
                            cursor: 'pointer',
                                          fontSize: '13px',
                                          color: '#111827',
                                          background: selectedLanguage === lang ? '#F0F4FF' : 'white',
                                          borderBottom: '1px solid #f3f4f6'
                                        }}
                                        onMouseEnter={(e) => {
                                          if (selectedLanguage !== lang) {
                                            e.currentTarget.style.background = '#f9fafb';
                                          }
                                        }}
                                        onMouseLeave={(e) => {
                                          if (selectedLanguage !== lang) {
                                            e.currentTarget.style.background = 'white';
                                          }
                                        }}
                                      >
                                        {lang}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            </div>
                            {/* Gender Dropdown */}
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                              <div style={{ fontSize: '13px', fontWeight: '600', color: '#111827' }}>Gender</div>
                              <div style={{ position: 'relative', width: '100%' }} ref={filterGenderDropdownRef}>
                                <div
                                  onClick={() => setIsGenderDropdownOpen(!isGenderDropdownOpen)}
                          style={{
                            display: 'flex',
                            alignItems: 'center',
                                    justifyContent: 'space-between',
                                    padding: '4px 10px',
                                    height: '28px',
                                    border: '1px solid #e5e7eb',
                            borderRadius: '8px',
                                    cursor: 'pointer',
                                    background: 'white',
                                    fontSize: '12px',
                                    color: selectedGender || '#6b7280'
                                  }}
                                >
                                  <span>{selectedGender || 'Select Gender'}</span>
                                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 4.5L6 7.5L9 4.5" stroke="#6b7280" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                                  </svg>
                                </div>
                                {isGenderDropdownOpen && (
                                  <div style={{
                                    position: 'absolute',
                                    top: '100%',
                                    left: 0,
                                    right: 0,
                                    marginTop: '4px',
                                    background: 'white',
                                    border: '1px solid #e5e7eb',
                                    borderRadius: '6px',
                                    boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
                                    zIndex: 1000
                                  }}>
                                    {['Male', 'Female'].map((gender) => (
                                      <div
                                        key={gender}
                                        onClick={() => {
                                          setSelectedGender(gender);
                                          setIsGenderDropdownOpen(false);
                            }}
                            style={{
                                          padding: '8px 12px',
                            cursor: 'pointer',
                                          fontSize: '13px',
                                          color: '#111827',
                                          background: selectedGender === gender ? '#F0F4FF' : 'white',
                                          borderBottom: '1px solid #f3f4f6'
                                        }}
                                        onMouseEnter={(e) => {
                                          if (selectedGender !== gender) {
                                            e.currentTarget.style.background = '#f9fafb';
                                          }
                                        }}
                                        onMouseLeave={(e) => {
                                          if (selectedGender !== gender) {
                                            e.currentTarget.style.background = 'white';
                                          }
                                        }}
                                      >
                                        {gender}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>

                          {/* Right Grid: Category and Buttons */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                            <div style={{ fontSize: '13px', fontWeight: '600', color: '#111827' }}>Category</div>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                              {['Clear', 'Premium', 'Sales', 'Conversational', 'Authoritative', 'Trust', 'Support'].map((category) => {
                                const isSelected = selectedCategories.includes(category);
                                return (
                                  <button
                                    key={category}
                                    type="button"
                                    onClick={() => {
                                      if (isSelected) {
                                        setSelectedCategories(selectedCategories.filter(c => c !== category));
                                      } else {
                                        setSelectedCategories([...selectedCategories, category]);
                                      }
                                    }}
                          style={{
                            display: 'flex',
                            alignItems: 'center',
                                      padding: '4px 10px',
                                      height: '28px',
                            borderRadius: '8px',
                                      border: '1.5px solid',
                                      borderColor: isSelected 
                                        ? '#9CA3AF' 
                                        : '#D1D5DB',
                                      background: isSelected
                                        ? 'linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%)'
                                        : '#FFFFFF',
                                      boxShadow: isSelected
                                        ? 'inset 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 1px 2px rgba(107, 114, 128, 0.2), inset 0 0 3px rgba(139, 92, 246, 0.15)'
                                        : 'none',
                                      cursor: 'pointer',
                                      transition: 'all 0.2s ease',
                                      fontSize: '12px',
                                      fontWeight: '500',
                                      color: '#111827',
                                      outline: 'none',
                                      position: 'relative'
                                    }}
                                    onMouseEnter={(e) => {
                                      if (!isSelected) {
                                        e.currentTarget.style.borderColor = '#9CA3AF';
                                        e.currentTarget.style.background = 'linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%)';
                                      }
                                    }}
                                    onMouseLeave={(e) => {
                                      if (!isSelected) {
                                        e.currentTarget.style.borderColor = '#D1D5DB';
                                        e.currentTarget.style.background = '#FFFFFF';
                                      }
                                    }}
                                  >
                                    {category}
                                  </button>
                                );
                              })}
                      </div>
                          </div>
                    </div>

                        {/* Clear and Apply Buttons - Outside Grid */}
                        <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
                          <button
                            type="button"
                            onClick={() => {
                              setSelectedLanguage('');
                              setSelectedGender('');
                              setSelectedCategories([]);
                            }}
                        style={{
                              padding: '6px 16px',
                              fontSize: '13px',
                              fontWeight: '500',
                              border: '1px solid #e5e7eb',
                              borderRadius: '6px',
                              background: 'white',
                              color: '#6b7280',
                          cursor: 'pointer',
                          transition: 'all 0.2s'
                        }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.borderColor = '#d1d5db';
                              e.currentTarget.style.background = '#f9fafb';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.borderColor = '#e5e7eb';
                              e.currentTarget.style.background = 'white';
                            }}
                          >
                            Clear
                          </button>
                          <button
                            type="button"
                            onClick={() => {
                              // Apply filters logic here
                              setIsFilterPanelOpen(false);
                            }}
                          style={{
                              padding: '6px 16px',
                              fontSize: '13px',
                              fontWeight: '500',
                              border: '1px solid #4B5CFF',
                              borderRadius: '6px',
                              background: '#4B5CFF',
                              color: 'white',
                            cursor: 'pointer',
                              transition: 'all 0.2s'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.background = '#3B4CE8';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.background = '#4B5CFF';
                            }}
                          >
                            Apply
                      </button>
                    </div>
                      </div>
                    )}

                    <img 
                      id="scripvoicetab1"
                      src="/images/scriptvoicetab1.png" 
                      alt="Voice tab interface" 
                      style={{ 
                        width: '100%', 
                        display: 'block', 
                        marginTop: '16px',
                        cursor: 'pointer',
                        transition: 'box-shadow 0.3s ease, border-radius 0.3s ease',
                        boxShadow: isImageHovered ? '0 4px 12px rgba(0, 0, 0, 0.15)' : 'none',
                        borderRadius: isImageHovered ? '8px' : '0'
                      }}
                      onMouseEnter={() => setIsImageHovered(true)}
                      onMouseLeave={() => setIsImageHovered(false)}
                      onClick={() => navigate('/clone-voice')}
                    />
                    
                    {/* Voice Grid Layout */}
                    {loading ? (
                      <Loading inline size="small" text="Loading voices..." />
                    ) : voices.length === 0 ? (
                      <Loading inline size="small" text="Loading voices..." />
                    ) : (
                      <div style={{ marginTop: '32px' }}>
                        {(() => {
                          const organizedVoices = organizeVoicesBySource();
                          const sources = [
                            { key: 'cloned', label: 'Cloned' },
                            { key: 'scalysis', label: 'Scalysis' },
                            { key: 'other', label: 'Other' }
                          ];

                          return sources.map(({ key, label }) => {
                            const sourceVoices = organizedVoices[key];
                            const sourceGender = selectedSourceGender[key];
                            const sourceLanguages = selectedSourceLanguages[key] || [];

                            // Get voices to display based on selected gender filter
                            let voicesToShow = [];
                            if (sourceGender === 'male') {
                              voicesToShow = [...sourceVoices.male, ...sourceVoices.neutral]; // Include neutral in both
                            } else if (sourceGender === 'female') {
                              voicesToShow = [...sourceVoices.female, ...sourceVoices.neutral]; // Include neutral in both
                            } else {
                              // Show all when no filter is selected
                              voicesToShow = [...sourceVoices.male, ...sourceVoices.female, ...sourceVoices.neutral];
                            }

                            // V3 Flagship filter: Scalysis voices are already filtered to show only Ultra Realistic in organizeVoicesBySource
                            // The V3 Flagship tag is always active as a visual indicator

                            // Apply language filter if any languages are selected
                            if (sourceLanguages.length > 0) {
                              voicesToShow = voicesToShow.filter(voice => {
                                const metadata = getVoiceMetadata(voice);
                                const voiceLanguage = (metadata.language || '').toLowerCase();
                                // Check if voice language matches any selected language (case-insensitive partial match)
                                return sourceLanguages.some(selectedLang => 
                                  voiceLanguage.includes(selectedLang.toLowerCase()) || 
                                  selectedLang.toLowerCase().includes(voiceLanguage)
                                );
                              });
                            }

                            if (voicesToShow.length === 0) return null;
                          
                          return (
                              <div key={key} style={{ marginBottom: '48px' }}>
                                <h4 style={{ 
                                  fontSize: '16px', 
                                fontWeight: '600', 
                                  color: '#111827',
                                marginBottom: '16px'
                              }}>
                                  {label === 'Scalysis' ? 'Scalysis Voices' : label === 'Cloned' ? 'Cloned' : label === 'Other' ? 'Other Voices' : label}
                                </h4>
                                
                                {/* Filter Tags Row */}
                                <div style={{ display: 'flex', gap: '8px', marginBottom: '20px', flexWrap: 'wrap', alignItems: 'center' }}>
                                  {/* V3 Flagship Tag - Only for Scalysis */}
                                  {key === 'scalysis' && (
                                    <button
                                      type="button"
                                      onClick={() => setScalysisV3FlagshipFilter(!scalysisV3FlagshipFilter)}
                                      style={{
                                        padding: '6px 14px',
                                        fontSize: '13px',
                                        fontWeight: '500',
                                        borderRadius: '6px',
                                        border: '1px solid',
                                        borderColor: scalysisV3FlagshipFilter ? '#4B5CFF' : '#D1D5DB',
                                        background: scalysisV3FlagshipFilter ? '#F0F4FF' : '#FFFFFF',
                                        color: scalysisV3FlagshipFilter ? '#4B5CFF' : '#6B7280',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                      }}
                                      onMouseEnter={(e) => {
                                        if (!scalysisV3FlagshipFilter) {
                                          e.currentTarget.style.borderColor = '#9CA3AF';
                                          e.currentTarget.style.background = '#F9FAFB';
                                        }
                                      }}
                                      onMouseLeave={(e) => {
                                        if (!scalysisV3FlagshipFilter) {
                                          e.currentTarget.style.borderColor = '#D1D5DB';
                                          e.currentTarget.style.background = '#FFFFFF';
                                        }
                                      }}
                                    >
                                      V3 Flagship
                                    </button>
                                  )}
                                  
                                  {/* Gender Filter Tags */}
                                  <button
                                    type="button"
                                    onClick={() => setSelectedSourceGender(prev => ({ ...prev, [key]: undefined }))}
                                    style={{
                                      padding: '6px 14px',
                                      fontSize: '13px',
                                      fontWeight: '500',
                                      borderRadius: '6px',
                                      border: '1px solid',
                                      borderColor: !sourceGender ? '#4B5CFF' : '#D1D5DB',
                                      background: !sourceGender ? '#F0F4FF' : '#FFFFFF',
                                      color: !sourceGender ? '#4B5CFF' : '#6B7280',
                                      cursor: 'pointer',
                                      transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                      if (sourceGender) {
                                        e.currentTarget.style.borderColor = '#9CA3AF';
                                        e.currentTarget.style.background = '#F9FAFB';
                                      }
                                    }}
                                    onMouseLeave={(e) => {
                                      if (sourceGender) {
                                        e.currentTarget.style.borderColor = '#D1D5DB';
                                        e.currentTarget.style.background = '#FFFFFF';
                                      }
                                    }}
                                  >
                                    All
                                  </button>
                                  <button
                                    type="button"
                                    onClick={() => setSelectedSourceGender(prev => ({ ...prev, [key]: sourceGender === 'male' ? null : 'male' }))}
                                    style={{
                                      padding: '6px 14px',
                                      fontSize: '13px',
                                      fontWeight: '500',
                                      borderRadius: '6px',
                                      border: '1px solid',
                                      borderColor: sourceGender === 'male' ? '#4B5CFF' : '#D1D5DB',
                                      background: sourceGender === 'male' ? '#F0F4FF' : '#FFFFFF',
                                      color: sourceGender === 'male' ? '#4B5CFF' : '#6B7280',
                                      cursor: 'pointer',
                                      transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                      if (sourceGender !== 'male') {
                                        e.currentTarget.style.borderColor = '#9CA3AF';
                                        e.currentTarget.style.background = '#F9FAFB';
                                      }
                                    }}
                                    onMouseLeave={(e) => {
                                      if (sourceGender !== 'male') {
                                        e.currentTarget.style.borderColor = '#D1D5DB';
                                        e.currentTarget.style.background = '#FFFFFF';
                                      }
                                    }}
                                  >
                                    Male
                                  </button>
                                  <button
                                    type="button"
                                    onClick={() => setSelectedSourceGender(prev => ({ ...prev, [key]: sourceGender === 'female' ? null : 'female' }))}
                                    style={{
                                      padding: '6px 14px',
                                      fontSize: '13px',
                                      fontWeight: '500',
                                      borderRadius: '6px',
                                      border: '1px solid',
                                      borderColor: sourceGender === 'female' ? '#4B5CFF' : '#D1D5DB',
                                      background: sourceGender === 'female' ? '#F0F4FF' : '#FFFFFF',
                                      color: sourceGender === 'female' ? '#4B5CFF' : '#6B7280',
                                      cursor: 'pointer',
                                      transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                      if (sourceGender !== 'female') {
                                        e.currentTarget.style.borderColor = '#9CA3AF';
                                        e.currentTarget.style.background = '#F9FAFB';
                                      }
                                    }}
                                    onMouseLeave={(e) => {
                                      if (sourceGender !== 'female') {
                                        e.currentTarget.style.borderColor = '#D1D5DB';
                                        e.currentTarget.style.background = '#FFFFFF';
                                      }
                                    }}
                                  >
                                    Female
                                  </button>

                                  {/* Language Filter Dropdown - For Scalysis and Other */}
                                  {(key === 'scalysis' || key === 'other') && (
                                    <div style={{ position: 'relative' }} ref={key === 'scalysis' ? scalysisLanguageDropdownRef : otherLanguageDropdownRef}>
                                      <button
                                        type="button"
                                        onClick={() => {
                                          if (key === 'scalysis') {
                                            setIsScalysisLanguageDropdownOpen(!isScalysisLanguageDropdownOpen);
                                            setIsOtherLanguageDropdownOpen(false);
                                          } else {
                                            setIsOtherLanguageDropdownOpen(!isOtherLanguageDropdownOpen);
                                            setIsScalysisLanguageDropdownOpen(false);
                                          }
                                        }}
                                        style={{
                                          padding: '6px 14px',
                                          fontSize: '13px',
                                          fontWeight: '500',
                                          borderRadius: '6px',
                                          border: '1px solid',
                                          borderColor: (key === 'scalysis' ? isScalysisLanguageDropdownOpen : isOtherLanguageDropdownOpen) || (sourceLanguages && sourceLanguages.length > 0) ? '#4B5CFF' : '#D1D5DB',
                                          background: (key === 'scalysis' ? isScalysisLanguageDropdownOpen : isOtherLanguageDropdownOpen) || (sourceLanguages && sourceLanguages.length > 0) ? '#F0F4FF' : '#FFFFFF',
                                          color: (key === 'scalysis' ? isScalysisLanguageDropdownOpen : isOtherLanguageDropdownOpen) || (sourceLanguages && sourceLanguages.length > 0) ? '#4B5CFF' : '#6B7280',
                                          cursor: 'pointer',
                                          transition: 'all 0.2s',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '6px'
                                        }}
                                        onMouseEnter={(e) => {
                                          if (!(key === 'scalysis' ? isScalysisLanguageDropdownOpen : isOtherLanguageDropdownOpen) && (!sourceLanguages || sourceLanguages.length === 0)) {
                                            e.currentTarget.style.borderColor = '#9CA3AF';
                                            e.currentTarget.style.background = '#F9FAFB';
                                          }
                                        }}
                                        onMouseLeave={(e) => {
                                          if (!(key === 'scalysis' ? isScalysisLanguageDropdownOpen : isOtherLanguageDropdownOpen) && (!sourceLanguages || sourceLanguages.length === 0)) {
                                            e.currentTarget.style.borderColor = '#D1D5DB';
                                            e.currentTarget.style.background = '#FFFFFF';
                                          }
                                        }}
                                      >
                                        Language
                                        {sourceLanguages && sourceLanguages.length > 0 && (
                                          <span style={{
                                            background: '#4B5CFF',
                                            color: '#FFFFFF',
                                            borderRadius: '10px',
                                            padding: '2px 6px',
                                            fontSize: '11px',
                                            fontWeight: '600',
                                            minWidth: '18px',
                                            display: 'inline-flex',
                                            alignItems: 'center',
                                            justifyContent: 'center'
                                          }}>
                                            {sourceLanguages.length}
                                          </span>
                                        )}
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{
                                          transform: (key === 'scalysis' ? isScalysisLanguageDropdownOpen : isOtherLanguageDropdownOpen) ? 'rotate(180deg)' : 'rotate(0deg)',
                                          transition: 'transform 0.2s'
                                        }}>
                                          <path d="M6 9l6 6 6-6" />
                                        </svg>
                                      </button>

                                      {/* Language Dropdown Menu */}
                                      {((key === 'scalysis' && isScalysisLanguageDropdownOpen) || (key === 'other' && isOtherLanguageDropdownOpen)) && (() => {
                                        const allVoicesForSource = [...sourceVoices.male, ...sourceVoices.female, ...sourceVoices.neutral];
                                        const availableLangs = getAvailableLanguages(allVoicesForSource);
                                        
                                        return (
                                          <div
                                            style={{
                                              position: 'absolute',
                                              top: '100%',
                                              left: 0,
                                              marginTop: '4px',
                                              backgroundColor: '#FFFFFF',
                                              border: '1px solid #D1D5DB',
                                              borderRadius: '8px',
                                              boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                                              zIndex: 1000,
                                              minWidth: '200px',
                                              maxHeight: '300px',
                                              overflowY: 'auto',
                                              padding: '8px'
                                            }}
                                            onClick={(e) => e.stopPropagation()}
                                          >
                                            {availableLangs.length === 0 ? (
                                              <div style={{ padding: '12px', color: '#9CA3AF', fontSize: '13px', textAlign: 'center' }}>
                                                No languages available
                                              </div>
                                            ) : (
                                              <>
                                                {availableLangs.map((lang) => {
                                                  const isSelected = sourceLanguages && sourceLanguages.includes(lang);
                                                  const fullLanguageName = getLanguageFullName(lang);
                                                  return (
                                                    <label
                                                      key={lang}
                                                      style={{
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        padding: '8px 12px',
                                                        cursor: 'pointer',
                                                        borderRadius: '6px',
                                                        transition: 'background-color 0.2s',
                                                        marginBottom: '2px'
                                                      }}
                                                      onMouseEnter={(e) => {
                                                        e.currentTarget.style.backgroundColor = '#F9FAFB';
                                                      }}
                                                      onMouseLeave={(e) => {
                                                        e.currentTarget.style.backgroundColor = 'transparent';
                                                      }}
                                                    >
                                                      <input
                                                        type="checkbox"
                                                        checked={isSelected || false}
                                                        onChange={(e) => {
                                                          setSelectedSourceLanguages(prev => {
                                                            const current = prev[key] || [];
                                                            if (e.target.checked) {
                                                              return { ...prev, [key]: [...current, lang] };
                                                            } else {
                                                              return { ...prev, [key]: current.filter(l => l !== lang) };
                                                            }
                                                          });
                                                        }}
                                                        style={{
                                                          width: '16px',
                                                          height: '16px',
                                                          marginRight: '10px',
                                                          cursor: 'pointer',
                                                          accentColor: '#4B5CFF'
                                                        }}
                                                      />
                                                      <span style={{ fontSize: '13px', color: '#111827', fontWeight: isSelected ? '500' : '400' }}>
                                                        {fullLanguageName}
                                                      </span>
                                                    </label>
                                                  );
                                                })}
                                              </>
                                            )}
                                          </div>
                                        );
                                      })()}
                                    </div>
                                  )}
                                </div>

                              <div style={{ 
                                display: 'grid', 
                                gridTemplateColumns: 'repeat(4, 1fr)', 
                                gap: '12px' 
                              }}>
                                  {voicesToShow.map((voice) => {
                              const premiumName = formatPremiumVoiceName(voice);
                              const isPlaying = playingVoiceId === voice.id;
                              const isSelected = safeFormData?.voiceId === voice.id;
                                  const selectedLanguage = voiceLanguages[voice.id] || 'english';
                                  
                                  // Get new design elements
                                  const voiceImagePath = getVoiceImagePath(voice);
                                  const shortDescription = getVoiceShortDescription(voice);
                                  const languageIcons = getLanguageIconsWithColors(voice);
                                  const languageTextFull = getLanguageDisplayTextFull(voice);
                              
                              return (
                              <div
                                key={voice.id}
                                onClick={() => handleVoiceClick(voice)}
                style={{
                                        width: '100%',
                                    padding: '16px',
                                        border: `1px solid ${isSelected ? '#4B5CFF' : '#e5e7eb'}`,
                                    borderRadius: '12px',
                                  cursor: 'pointer',
                                        transition: 'background-color 0.2s ease',
                                        backgroundColor: isSelected ? '#f0f4ff' : '#ffffff',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        position: 'relative',
                                        alignItems: 'center',
                                }}
                                onMouseEnter={(e) => {
                                    if (!isSelected) {
                                          e.currentTarget.style.backgroundColor = '#f9fafb';
                                  }
                                }}
                                onMouseLeave={(e) => {
                                    if (!isSelected) {
                                          e.currentTarget.style.backgroundColor = '#ffffff';
                                        }
                                      }}
                                    >
                                      {/* 1. Circular Image - Centered */}
                                        <div
                                          style={{
                                          width: '48px',
                                          height: '48px',
                                            borderRadius: '50%',
                                          overflow: 'hidden',
                                            flexShrink: 0,
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                          marginBottom: '12px',
                                        }}
                                      >
                                        <img
                                          src={voiceImagePath}
                                          alt={premiumName}
                                          style={{
                                            width: '100%',
                                            height: '100%',
                                            objectFit: 'cover',
                                          }}
                                        />
                                        </div>
                                      
                                      {/* 2. Name - Centered */}
                                          <div style={{ 
                                            fontWeight: '600', 
                                        fontSize: '16px', 
                                            color: '#111827',
                                        marginBottom: '8px',
                                        textAlign: 'center',
                                        width: '100%'
                                          }}>
                                            {premiumName}
                                      </div>
                                      
                                      {/* 3. Description - Centered, Random 1-2 words */}
                                      <div style={{ 
                                        fontSize: '13px', 
                                        color: '#6b7280', 
                                        marginBottom: '12px',
                                        fontWeight: '400',
                                        textAlign: 'center',
                                        width: '100%'
                                      }}>
                                        {shortDescription}
                                      </div>
                                      
                                      {/* 4. Language Icons + Text - Overlapping icons with full language names */}
                                      <div style={{ 
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                                        marginBottom: '12px',
                                        justifyContent: 'center',
                                        width: '100%'
                                      }}>
                                        <div style={{ display: 'flex', alignItems: 'center', position: 'relative' }}>
                                          {languageIcons.map((icon, idx) => (
                                            <div
                                              key={idx}
                                              style={{
                                                width: '24px',
                                                height: '24px',
                                                borderRadius: '50%',
                                                backgroundColor: icon.color,
                                                color: '#374151',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                marginLeft: idx > 0 ? '-6px' : '0',
                                                border: '2px solid white',
                                                zIndex: languageIcons.length - idx,
                                                position: 'relative'
                                              }}
                                            >
                                              {icon.char}
                                            </div>
                                          ))}
                                        </div>
                                        <div style={{ 
                                          fontSize: '12px', 
                                          color: '#374151',
                                          fontWeight: '400',
                                          fontStyle: 'italic'
                                        }}>
                                          {languageTextFull}
                                        </div>
                                      </div>
                                      
                                      {/* 5. Bottom: Play Button + Language Selection (TTS Provider Style) */}
                                      <div style={{ 
                                        display: 'flex', 
                                        justifyContent: 'space-between', 
                                        alignItems: 'center',
                                        width: '100%',
                                        marginTop: 'auto',
                                        paddingTop: '8px'
                                      }}>
                                        {/* Play/Pause Button */}
                                  <button
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            handleInlineVoicePreview(voice.id, e);
                                          }}
                                style={{
                                            width: '36px',
                                            height: '36px',
                                      padding: '0',
                                            background: 'transparent',
                                      border: 'none',
                                  cursor: 'pointer',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                            flexShrink: 0
                                    }}
                                  >
                                    {isPlaying ? (
                                            <img 
                                              src="/images/poly.svg" 
                                              alt="Pause" 
                                              width="20" 
                                              height="20"
                                              style={{ filter: 'brightness(0)' }}
                                            />
                                          ) : (
                                            <img 
                                              src="/images/Polygon 2.svg" 
                                              alt="Play" 
                                              width="20" 
                                              height="20"
                                              style={{ filter: 'brightness(0)' }}
                                            />
                                    )}
                                  </button>
                                  
                                        {/* Language Selection Buttons - TTS Provider Style (Segmented Control) */}
                                  <div
                                    style={{
                                            display: 'flex',
                                            background: '#F3F4F6',
                                            borderRadius: '6px',
                                            padding: '2px',
                                            gap: '0',
                                            border: '1px solid #E5E7EB',
                                            position: 'relative'
                                          }} 
                                          onClick={(e) => e.stopPropagation()}
                                        >
                                          <div
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              e.preventDefault();
                                              setVoiceLanguages(prev => ({ ...prev, [voice.id]: 'english' }));
                                            }}
                          style={{
                                              padding: '4px 10px',
                                              borderRadius: '4px',
                                              background: selectedLanguage === 'english' ? '#FFFFFF' : 'transparent',
                            cursor: 'pointer',
                                              transition: 'all 0.2s',
                                              position: 'relative',
                                      display: 'flex',
                                      alignItems: 'center',
                                              justifyContent: 'center'
                                            }}
                                          >
                                            <span style={{ 
                                              fontSize: '11px', 
                                              fontWeight: '500', 
                                              color: '#1F2937'
                                            }}>
                                              En
                                            </span>
                                            {selectedLanguage !== 'english' && (
                                              <div style={{
                                                position: 'absolute',
                                                right: 0,
                                                top: '50%',
                                                transform: 'translateY(-50%)',
                                                width: '1px',
                                                height: '60%',
                                                background: '#E5E7EB'
                                              }} />
                                            )}
                                </div>
                                          <div
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              e.preventDefault();
                                              setVoiceLanguages(prev => ({ ...prev, [voice.id]: 'hinglish' }));
                            }}
                            style={{
                                              padding: '4px 10px',
                                              borderRadius: '4px',
                                              background: selectedLanguage === 'hinglish' ? '#FFFFFF' : 'transparent',
                                              cursor: 'pointer',
                                              transition: 'all 0.2s',
                                              display: 'flex',
                                              alignItems: 'center',
                                              justifyContent: 'center'
                                            }}
                                          >
                                        <span style={{ 
                                          fontSize: '11px', 
                                              fontWeight: '500', 
                                              color: '#1F2937'
                                            }}>
                                            Hi
                                            </span>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          );
                          });
                        })()}
                      </div>
                                      )}
                                </div>

                  {/* Right Box: Available Voices */}
                  <div className="form-section" style={{ gridColumn: 'span 1' }}>
                    <h4>Settings</h4>
                    <div className="form-group">
                      <h5 style={{ 
                        fontSize: '14px', 
                        fontWeight: '600', 
                        color: '#111827',
                        marginBottom: '12px'
                      }}>
                        Current
                      </h5>
                      <input
                        type="text"
                        id="voiceId"
                        name="voiceId"
                        value={safeFormData?.voiceId || ''}
                        onChange={handleFormChange}
                        placeholder="Enter voice ID or search voices"
                        style={{ width: '100%' }}
                      />
                                </div>

                    <div className="form-group">
                      <h5 style={{ 
                        fontSize: '14px', 
                        fontWeight: '600', 
                        color: '#111827',
                        marginBottom: '12px'
                      }}>
                        TTS Provider
                      </h5>
                      
                      {/* Dynamic Image based on selection */}
                      <div style={{ marginBottom: '8px' }}>
                        {(() => {
                          const getImageSrc = () => {
                            if (safeFormData?.ttsProvider === 'sarvam') return '/images/sarvam.png';
                            if (safeFormData?.ttsProvider === 'cartesia' || safeFormData?.ttsProvider === 'speechify') return '/images/speechify.png';
                            if (safeFormData?.ttsProvider === 'inworld') return '/images/inworld.png';
                            return '/images/scalysistts.png'; // default
                          };
                          
                          const getImageAlt = () => {
                            if (safeFormData?.ttsProvider === 'sarvam') return 'Sarvam';
                            if (safeFormData?.ttsProvider === 'cartesia' || safeFormData?.ttsProvider === 'speechify') return 'Cartesia';
                            if (safeFormData?.ttsProvider === 'inworld') return 'InWorld';
                            return 'Scalysis TTS';
                          };
                          
                          return (
                            <img 
                              src={getImageSrc()} 
                              alt={getImageAlt()} 
                              style={{ width: '100%', height: 'auto', objectFit: 'contain' }}
                            />
                          );
                        })()}
                                  </div>

                      {/* Scalysis TTS Button */}
                      <div style={{ marginBottom: '8px' }}>
                        <div
                          onClick={() => {
                            setFormData(prev => ({ ...prev, ttsProvider: null, voiceId: null }));
                          }}
                          style={{
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            padding: '6px 12px',
                            border: `1px solid ${(safeFormData?.ttsProvider === null || safeFormData?.ttsProvider === '') ? '#4B5CFF' : '#E5E7EB'}`,
                            borderRadius: '6px',
                            background: (safeFormData?.ttsProvider === null || safeFormData?.ttsProvider === '') ? '#F0F4FF' : '#FFFFFF',
                            cursor: 'pointer',
                            transition: 'all 0.2s'
                          }}
                        >
                          <span style={{ fontSize: '14px', fontWeight: '500', color: '#1F2937' }}>Scalysis TTS</span>
                        </div>
                      </div>

                      {/* TTS Other - Sarvam, Speechify, InWorld Segmented Control */}
                      <div style={{
                        display: 'flex',
                        background: '#F3F4F6',
                        borderRadius: '8px',
                        padding: '2px',
                        gap: '0',
                        border: '1px solid #E5E7EB',
                        position: 'relative'
                      }}>
                        {/* Sarvam */}
                        <div
                          onClick={() => {
                                setFormData(prev => ({ ...prev, ttsProvider: 'sarvam', voiceId: 'sarvam_anushka' }));
                            }}
                            style={{
                            flex: 1,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            padding: '6px 12px',
                            borderRadius: '6px',
                            background: safeFormData?.ttsProvider === 'sarvam' ? '#FFFFFF' : 'transparent',
                            cursor: 'pointer',
                            transition: 'all 0.2s',
                            position: 'relative'
                          }}
                        >
                          <span style={{ 
                            fontSize: '14px', 
                            fontWeight: '500', 
                            color: '#1F2937'
                          }}>
                            Sarvam
                          </span>
                          {safeFormData?.ttsProvider !== 'sarvam' && (
                            <div style={{
                              position: 'absolute',
                              right: 0,
                              top: '50%',
                              transform: 'translateY(-50%)',
                              width: '1px',
                              height: '60%',
                              background: '#E5E7EB'
                            }} />
                                )}
                              </div>
                                  
                        {/* Cartesia */}
                        <div
                          onClick={() => {
                            setFormData(prev => ({ ...prev, ttsProvider: 'cartesia', voiceId: 'sanya' }));
                                      }}
                                      style={{
                            flex: 1,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            padding: '6px 12px',
                                        borderRadius: '6px',
                            background: (safeFormData?.ttsProvider === 'cartesia' || safeFormData?.ttsProvider === 'speechify') ? '#FFFFFF' : 'transparent',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s',
                            position: 'relative'
                          }}
                        >
                          <span style={{ 
                            fontSize: '14px', 
                            fontWeight: '500', 
                            color: '#1F2937'
                          }}>
                            Cartesia
                          </span>
                          {(safeFormData?.ttsProvider !== 'cartesia' && safeFormData?.ttsProvider !== 'speechify') && safeFormData?.ttsProvider !== 'inworld' && (
                            <div style={{
                              position: 'absolute',
                              right: 0,
                              top: '50%',
                              transform: 'translateY(-50%)',
                              width: '1px',
                              height: '60%',
                              background: '#E5E7EB'
                            }} />
                          )}
                        </div>

                        {/* InWorld */}
                        <div
                          onClick={() => {
                            setFormData(prev => ({ ...prev, ttsProvider: 'inworld', voiceId: 'Riya' }));
                                      }}
                                      style={{
                            flex: 1,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            padding: '6px 12px',
                                        borderRadius: '6px',
                            background: safeFormData?.ttsProvider === 'inworld' ? '#FFFFFF' : 'transparent',
                                        cursor: 'pointer',
                            transition: 'all 0.2s'
                          }}
                        >
                          <span style={{ 
                            fontSize: '14px', 
                            fontWeight: '500', 
                            color: '#1F2937'
                          }}>
                            InWorld
                          </span>
                        </div>
                      </div>
                    </div>

                    {/* HIDDEN: Speed, Volume, and Emotion Settings - See HIDDEN_FEATURES.md for details */}
                    {/* Speed Slider */}
                    {/* <div className="form-group" style={{ marginTop: '24px' }}>
                      <h5 style={{ 
                        fontSize: '14px', 
                        fontWeight: '600', 
                        color: '#111827',
                        marginBottom: '0px',
                        borderBottom: '1px dotted #D1D5DB',
                        paddingBottom: '4px',
                        width: 'fit-content'
                      }}>
                        Speed
                      </h5>
                      <div style={{ position: 'relative', padding: '4px 0' }}>
                        <div style={{ 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          alignItems: 'center',
                          marginBottom: '8px'
                        }}>
                          <span style={{ fontSize: '12px', color: '#6B7280' }}>Slower</span>
                          <span style={{ fontSize: '12px', color: '#6B7280' }}>Faster</span>
                        </div>
                        <div
                        style={{
                            position: 'relative',
                            width: '100%',
                            height: '4px',
                            background: '#E5E7EB',
                            borderRadius: '2px',
                            cursor: 'pointer'
                          }}
                          onMouseDown={(e) => {
                            e.preventDefault();
                            const slider = e.currentTarget;
                            const rect = slider.getBoundingClientRect();
                            
                            const updateSpeed = (clientX) => {
                              const x = clientX - rect.left;
                              const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
                              setFormData(prev => ({ ...prev, speed: percentage }));
                            };
                            
                            updateSpeed(e.clientX);
                            
                            const handleMouseMove = (moveEvent) => {
                              const newRect = slider.getBoundingClientRect();
                              const x = moveEvent.clientX - newRect.left;
                              const percentage = Math.max(0, Math.min(100, (x / newRect.width) * 100));
                              setFormData(prev => ({ ...prev, speed: percentage }));
                            };
                            
                            const handleMouseUp = () => {
                              document.removeEventListener('mousemove', handleMouseMove);
                              document.removeEventListener('mouseup', handleMouseUp);
                            };
                            
                            document.addEventListener('mousemove', handleMouseMove);
                            document.addEventListener('mouseup', handleMouseUp);
                          }}
                        >
                          <div
                            style={{
                              position: 'absolute',
                              left: 0,
                              top: 0,
                              width: `${safeFormData?.speed || 50}%`,
                              height: '100%',
                              background: '#374151',
                              borderRadius: '2px',
                              transition: 'width 0.1s ease'
                            }}
                          />
                          <div
                            style={{
                              position: 'absolute',
                              left: `${safeFormData?.speed || 50}%`,
                              top: '50%',
                              transform: 'translate(-50%, -50%)',
                              width: '16px',
                              height: '16px',
                              borderRadius: '50%',
                              background: '#374151',
                              cursor: 'grab',
                              boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)'
                            }}
                          />
                        </div>
                      </div>
                    </div> */}

                    {/* Volume Slider */}
                    {/* <div className="form-group" style={{ marginTop: '24px' }}>
                      <h5 style={{ 
                        fontSize: '14px', 
                        fontWeight: '600', 
                        color: '#111827',
                        marginBottom: '0px',
                        borderBottom: '1px dotted #D1D5DB',
                        paddingBottom: '4px',
                        width: 'fit-content'
                      }}>
                        Volume
                      </h5>
                      <div style={{ position: 'relative', padding: '4px 0' }}>
                        <div style={{ 
                          display: 'flex',
                          justifyContent: 'space-between', 
                          alignItems: 'center',
                          marginBottom: '8px'
                        }}>
                          <span style={{ fontSize: '12px', color: '#6B7280' }}>Quiet</span>
                          <span style={{ fontSize: '12px', color: '#6B7280' }}>Loud</span>
                        </div>
                        <div
                          style={{
                            position: 'relative',
                            width: '100%',
                            height: '4px',
                            background: '#E5E7EB',
                            borderRadius: '2px',
                            cursor: 'pointer'
                          }}
                          onMouseDown={(e) => {
                            e.preventDefault();
                            const slider = e.currentTarget;
                            const rect = slider.getBoundingClientRect();
                            
                            const updateVolume = (clientX) => {
                              const x = clientX - rect.left;
                              const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
                              setFormData(prev => ({ ...prev, volume: percentage }));
                            };
                            
                            updateVolume(e.clientX);
                            
                            const handleMouseMove = (moveEvent) => {
                              const newRect = slider.getBoundingClientRect();
                              const x = moveEvent.clientX - newRect.left;
                              const percentage = Math.max(0, Math.min(100, (x / newRect.width) * 100));
                              setFormData(prev => ({ ...prev, volume: percentage }));
                            };
                            
                            const handleMouseUp = () => {
                              document.removeEventListener('mousemove', handleMouseMove);
                              document.removeEventListener('mouseup', handleMouseUp);
                            };
                            
                            document.addEventListener('mousemove', handleMouseMove);
                            document.addEventListener('mouseup', handleMouseUp);
                          }}
                        >
                          <div
                          style={{
                              position: 'absolute',
                              left: 0,
                              top: 0,
                              width: `${safeFormData?.volume || 50}%`,
                              height: '100%',
                              background: '#374151',
                              borderRadius: '2px',
                              transition: 'width 0.1s ease'
                            }}
                          />
                          <div
                            style={{
                              position: 'absolute',
                              left: `${safeFormData?.volume || 50}%`,
                              top: '50%',
                              transform: 'translate(-50%, -50%)',
                              width: '16px',
                              height: '16px',
                              borderRadius: '50%',
                              background: '#374151',
                              cursor: 'grab',
                              boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)'
                            }}
                          />
                        </div>
                    </div>
                  </div> */}

                    {/* Emotion Selection */}
                    {/* <div className="form-group" style={{ marginTop: '24px' }}>
                      <h5 style={{ 
                        fontSize: '14px', 
                        fontWeight: '600', 
                        color: '#111827',
                        marginBottom: '0px',
                        borderBottom: '1px dotted #D1D5DB',
                        paddingBottom: '4px',
                        width: 'fit-content'
                      }}>
                        Emotion
                      </h5>
                      <div style={{ 
                        display: 'flex', 
                        flexWrap: 'wrap', 
                        gap: '8px',
                        marginTop: '4px'
                      }}>
                        {[
                          { id: 'neutral', label: 'Neutral', svg: '/images/emotionneutral.svg' },
                          { id: 'calm', label: 'Calm', svg: '/images/emotioncalm.svg' },
                          { id: 'happy', label: 'Happy', svg: '/images/emotionhappy.svg' },
                          { id: 'excited', label: 'Excited', svg: '/images/emotionexcited.svg' },
                          { id: 'sad', label: 'Sad', svg: '/images/emotionsad.svg' },
                          { id: 'angry', label: 'Angry', svg: '/images/emotionangry.svg' },
                          { id: 'scared', label: 'Scared', svg: '/images/emotinscared.svg' }
                        ].map((emotion) => {
                          const isSelected = (safeFormData?.emotions || []).includes(emotion.id);
                          return (
                      <button
                              key={emotion.id}
                        type="button"
                              onClick={() => {
                                const currentEmotions = safeFormData?.emotions || [];
                                if (isSelected) {
                                  setFormData(prev => ({
                                    ...prev,
                                    emotions: currentEmotions.filter(e => e !== emotion.id)
                                  }));
                                } else {
                                  setFormData(prev => ({
                                    ...prev,
                                    emotions: [...currentEmotions, emotion.id]
                                  }));
                                }
                              }}
                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                gap: '6px',
                                padding: '4px 10px',
                                height: '28px',
                                borderRadius: '8px',
                                border: '1.5px solid',
                                borderColor: isSelected 
                                  ? '#9CA3AF' 
                                  : '#D1D5DB',
                                background: isSelected
                                  ? 'linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%)'
                                  : '#FFFFFF',
                                boxShadow: isSelected
                                  ? 'inset 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 1px 2px rgba(107, 114, 128, 0.2), inset 0 0 3px rgba(139, 92, 246, 0.15)'
                                  : 'none',
                                  cursor: 'pointer',
                                transition: 'all 0.2s ease',
                                fontSize: '12px',
                                fontWeight: '500',
                                color: '#111827',
                                outline: 'none',
                                position: 'relative'
                                }}
                                onMouseEnter={(e) => {
                                    if (!isSelected) {
                                  e.currentTarget.style.borderColor = '#9CA3AF';
                                  e.currentTarget.style.background = 'linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%)';
                                  }
                                }}
                                onMouseLeave={(e) => {
                                    if (!isSelected) {
                                  e.currentTarget.style.borderColor = '#D1D5DB';
                                  e.currentTarget.style.background = '#FFFFFF';
                                }
                              }}
                            >
                              <img 
                                src={emotion.svg} 
                                alt={emotion.label}
                                style={{
                                  width: '16px',
                                  height: '16px',
                                  objectFit: 'contain'
                                }}
                              />
                              <span>{emotion.label}</span>
                            </button>
                              );
                            })}
                      </div>
                  </div> */}
                  </div>
                </div>
              </div>
            )}


            {/* Config Tab Content */}
            {activeTab === 'config' && (
              <div className="tab-content" style={{ overflowY: 'auto', overflowX: 'hidden', maxHeight: 'calc(100vh - 240px)' }}>
                <div className="form-section">
                  <h4>Configuration Settings</h4>

                  {/* Auto-Save Settings Section */}
                  <div
                    style={{
                      border: '1.5px solid #e5e7eb',
                      borderRadius: '12px',
                      padding: '24px',
                      marginTop: '20px',
                      marginBottom: '20px',
                      background: '#ffffff',
                      boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)',
                    }}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
                      <div>
                        <h5 style={{ margin: '0 0 4px 0', fontSize: '16px', fontWeight: '600', color: '#111827' }}>
                          Auto-Save
                        </h5>
                        <p style={{ margin: 0, fontSize: '13px', color: '#6b7280' }}>
                          Automatically save your script at regular intervals
                        </p>
                      </div>
                      <button
                        type="button"
                        onClick={() => setAutoSaveEnabled(!autoSaveEnabled)}
                        style={{
                          position: 'relative',
                          width: '52px',
                          height: '28px',
                          borderRadius: '14px',
                          border: 'none',
                          background: autoSaveEnabled ? '#4B5CFF' : '#e5e7eb',
                          cursor: 'pointer',
                          transition: 'all 0.3s ease',
                          boxShadow: autoSaveEnabled ? '0 2px 8px rgba(75, 92, 255, 0.3)' : 'none'
                        }}
                      >
                        <div
                          style={{
                            position: 'absolute',
                            top: '2px',
                            left: autoSaveEnabled ? '26px' : '2px',
                            width: '24px',
                            height: '24px',
                            borderRadius: '12px',
                            background: 'white',
                            boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)',
                            transition: 'all 0.3s ease'
                          }}
                        />
                      </button>
                    </div>

                    {autoSaveEnabled && (
                      <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px solid #f3f4f6' }}>
                        <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                          Save Interval
                        </label>
                        <select
                          value={autoSaveInterval}
                          onChange={(e) => setAutoSaveInterval(parseInt(e.target.value))}
                          style={{
                            width: '100%',
                            padding: '10px 12px',
                            border: '1.5px solid #e5e7eb',
                            borderRadius: '8px',
                            fontSize: '14px',
                            color: '#111827',
                            background: 'white',
                            cursor: 'pointer',
                            transition: 'all 0.2s',
                            fontFamily: 'inherit'
                          }}
                          onFocus={(e) => e.target.style.borderColor = '#4B5CFF'}
                          onBlur={(e) => e.target.style.borderColor = '#e5e7eb'}
                        >
                          <option value={1}>Every 1 minute</option>
                          <option value={2}>Every 2 minutes</option>
                          <option value={5}>Every 5 minutes</option>
                          <option value={10}>Every 10 minutes</option>
                          <option value={15}>Every 15 minutes</option>
                          <option value={30}>Every 30 minutes</option>
                        </select>
                        <p style={{ margin: '8px 0 0 0', fontSize: '12px', color: '#6b7280', display: 'flex', alignItems: 'center', gap: '6px' }}>
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" y1="16" x2="12" y2="12" />
                            <line x1="12" y1="8" x2="12.01" y2="8" />
                          </svg>
                          Your script will be saved automatically every {autoSaveInterval} minute{autoSaveInterval > 1 ? 's' : ''}
                        </p>
                      </div>
                    )}

                    {!autoSaveEnabled && (
                      <div style={{ marginTop: '16px', padding: '12px', background: '#f9fafb', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth="2">
                          <circle cx="12" cy="12" r="10" />
                          <line x1="12" y1="16" x2="12" y2="12" />
                          <line x1="12" y1="8" x2="12.01" y2="8" />
                        </svg>
                        <span style={{ fontSize: '13px', color: '#6b7280' }}>
                          Auto-save is disabled. Remember to save your changes manually.
                        </span>
                      </div>
                    )}
                  </div>

                  {/* Call Filtering Settings Section */}
                  <div
                    style={{
                      border: '1.5px solid #e5e7eb',
                      borderRadius: '12px',
                      padding: '24px',
                      marginTop: '20px',
                      marginBottom: '20px',
                      background: '#ffffff',
                      boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)',
                    }}
                  >
                    <h5 style={{ margin: '0 0 4px 0', fontSize: '16px', fontWeight: '600', color: '#111827' }}>
                      Order Status Filters
                    </h5>
                    <p style={{ margin: '0 0 20px 0', fontSize: '13px', color: '#6b7280' }}>
                      Control which orders should be called based on their status
                    </p>

                    {/* Call Fulfilled Orders Toggle */}
                    <div style={{ marginBottom: '16px' }}>
                      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '8px' }}>
                        <div>
                          <h6 style={{ margin: '0 0 4px 0', fontSize: '14px', fontWeight: '500', color: '#111827' }}>
                            Call Fulfilled Orders
                          </h6>
                          <p style={{ margin: 0, fontSize: '12px', color: '#6b7280' }}>
                            When disabled, the calling system will skip orders that are already fulfilled
                          </p>
                        </div>
                        <button
                          type="button"
                          onClick={() => setFormData(prev => ({ ...prev, callFulfilledOrders: !prev.callFulfilledOrders }))}
                          style={{
                            position: 'relative',
                            width: '52px',
                            height: '28px',
                            borderRadius: '14px',
                            border: 'none',
                            background: (safeFormData?.callFulfilledOrders !== false) ? '#4B5CFF' : '#e5e7eb',
                            cursor: 'pointer',
                            transition: 'all 0.3s ease',
                            boxShadow: (safeFormData?.callFulfilledOrders !== false) ? '0 2px 8px rgba(75, 92, 255, 0.3)' : 'none',
                            flexShrink: 0
                          }}
                        >
                          <div
                            style={{
                              position: 'absolute',
                              top: '2px',
                              left: (safeFormData?.callFulfilledOrders !== false) ? '26px' : '2px',
                              width: '24px',
                              height: '24px',
                              borderRadius: '12px',
                              background: 'white',
                              boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)',
                              transition: 'all 0.3s ease'
                            }}
                          />
                        </button>
                      </div>
                    </div>

                    {/* Call Cancelled Orders Toggle */}
                    <div style={{ paddingTop: '16px', borderTop: '1px solid #f3f4f6' }}>
                      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '8px' }}>
                        <div>
                          <h6 style={{ margin: '0 0 4px 0', fontSize: '14px', fontWeight: '500', color: '#111827' }}>
                            Call Cancelled Orders
                          </h6>
                          <p style={{ margin: 0, fontSize: '12px', color: '#6b7280' }}>
                            When disabled, the calling system will skip orders that are already cancelled
                          </p>
                        </div>
                        <button
                          type="button"
                          onClick={() => setFormData(prev => ({ ...prev, callCancelledOrders: !prev.callCancelledOrders }))}
                          style={{
                            position: 'relative',
                            width: '52px',
                            height: '28px',
                            borderRadius: '14px',
                            border: 'none',
                            background: (safeFormData?.callCancelledOrders !== false) ? '#4B5CFF' : '#e5e7eb',
                            cursor: 'pointer',
                            transition: 'all 0.3s ease',
                            boxShadow: (safeFormData?.callCancelledOrders !== false) ? '0 2px 8px rgba(75, 92, 255, 0.3)' : 'none',
                            flexShrink: 0
                          }}
                        >
                          <div
                            style={{
                              position: 'absolute',
                              top: '2px',
                              left: (safeFormData?.callCancelledOrders !== false) ? '26px' : '2px',
                              width: '24px',
                              height: '24px',
                              borderRadius: '12px',
                              background: 'white',
                              boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)',
                              transition: 'all 0.3s ease'
                            }}
                          />
                        </button>
                      </div>
                    </div>

                    {/* Max Call Duration Input */}
                    <div style={{ paddingTop: '16px', borderTop: '1px solid #f3f4f6', marginTop: '16px' }}>
                      <div style={{ marginBottom: '8px' }}>
                        <h6 style={{ margin: '0 0 4px 0', fontSize: '14px', fontWeight: '500', color: '#111827' }}>
                          Maximum Call Duration (minutes)
                        </h6>
                        <p style={{ margin: 0, fontSize: '12px', color: '#6b7280' }}>
                          Maximum duration for calls in minutes. Leave empty for no limit.
                        </p>
                      </div>
                      <input
                        type="number"
                        min="0"
                        step="1"
                        value={safeFormData?.maxCallDuration !== undefined && safeFormData?.maxCallDuration !== null ? Math.round(safeFormData.maxCallDuration / 60) : ''}
                        onChange={(e) => {
                          // Frontend works in minutes, convert to seconds for storage
                          const value = e.target.value === '' ? null : parseInt(e.target.value);
                          const secondsValue = value !== null ? value * 60 : null;
                          setFormData(prev => ({ ...prev, maxCallDuration: secondsValue }));
                        }}
                        placeholder="No limit"
                        style={{
                          width: '100%',
                          padding: '10px 12px',
                          fontSize: '14px',
                          border: '1px solid #d1d5db',
                          borderRadius: '8px',
                          backgroundColor: '#ffffff',
                          color: '#111827',
                          transition: 'border-color 0.2s',
                        }}
                        onFocus={(e) => e.target.style.borderColor = '#4B5CFF'}
                        onBlur={(e) => e.target.style.borderColor = '#d1d5db'}
                      />
                    </div>
                  </div>


              <div
                style={{
                  border: '1.5px solid #e5e7eb',
                  borderRadius: '12px',
                  padding: '24px',
                  marginTop: '20px',
                  background: '#ffffff',
                  boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)',
                }}
              >
                <h5>
                  Custom Analysis Settings
                </h5>

                <div className="form-group" style={{ marginBottom: '20px' }}>
                  <h6>
                    Call Type Configuration
                  </h6>
                  <div style={{ marginBottom: '12px' }}>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', marginBottom: '8px' }}>
                      <input
                        type="radio"
                        name="callType"
                        checked={!formData.useCustomAnalysis}
                        onChange={() => handleCallTypeChange(false)}
                        style={{
                          width: '16px',
                          height: '16px',
                          cursor: 'pointer',
                        }}
                      />
                      <div style={{ fontSize: '15px', color: '#111827', fontWeight: '600' }}>
                        Use Address Extraction (Default)
                      </div>
                    </label>
                    <div style={{ marginLeft: '28px', fontSize: '12px', color: '#6b7280', marginBottom: '16px', fontWeight: '500', lineHeight: '1.5' }}>
                      Uses the default "Address Extraction" script criteria for success and other outcomes
                    </div>
                    
                    <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                      <input
                        type="radio"
                        name="callType"
                        checked={safeFormData?.useCustomAnalysis || false}
                        onChange={() => handleCallTypeChange(true)}
                        style={{
                          width: '18px',
                          height: '18px',
                          cursor: 'pointer',
                        }}
                      />
                      <div style={{ fontSize: '15px', color: '#111827', fontWeight: '600' }}>
                        Use Custom Call Type
                      </div>
                    </label>
                    <div style={{ marginLeft: '28px', fontSize: '12px', color: '#6b7280', fontWeight: '500', lineHeight: '1.5' }}>
                      Define custom analysis prompt and criteria for this script
                    </div>
                  </div>
                </div>

                {formData.useCustomAnalysis && (
                  <>
                    <div className="form-group" id="customAnalysisPromptGroup" style={{ marginBottom: '20px' }}>
                      <label htmlFor="customAnalysisPrompt">
                        Custom Analysis Prompt
                      </label>
                      <textarea
                        id="customAnalysisPrompt"
                        name="customAnalysisPrompt"
                        value={safeFormData?.customAnalysisPrompt || ''}
                        onChange={handleFormChange}
                        placeholder="Analyze this call transcript..."
                        style={{
                          width: '100%',
                          minHeight: '120px',
                        }}
                      />
                      <div style={{ marginTop: '8px', fontSize: '12px', color: '#6b7280', fontWeight: '500' }}>
                        Custom GPT prompt for call analysis
                      </div>
                    </div>

                    {/* Success Criteria */}
                    <div className="form-group" style={{ marginBottom: '20px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                        <label style={{ fontWeight: '600', color: '#111827', fontSize: '15px' }}>
                          Success Criteria
                        </label>
                        <button
                          type="button"
                          onClick={() => handleAddCriteria('successCriteria')}
                          className="btn btn-success"
                          style={{
                            padding: '8px 16px',
                            fontSize: '12px',
                            fontWeight: '600',
                          }}
                        >
                          + Add
                        </button>
                      </div>
                      {formData.successCriteria && formData.successCriteria.length > 0 ? (
                        formData.successCriteria.map((criteria, index) => (
                          <div key={index} style={{ display: 'flex', gap: '10px', marginBottom: '10px', alignItems: 'center' }}>
                            <input
                              type="text"
                              value={criteria}
                              onChange={(e) => handleUpdateCriteria('successCriteria', index, e.target.value)}
                              placeholder="e.g., address change"
                              style={{
                                flex: 1,
                                padding: '14px 20px',
                                border: '1.5px solid #e5e7eb',
                                borderRadius: '8px',
                                fontSize: '14px',
                              }}
                            />
                            <button
                              type="button"
                              onClick={() => handleRemoveCriteria('successCriteria', index)}
                              style={{
                                padding: '12px 20px',
                                background: '#ef4444',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '12px',
                                fontWeight: '600',
                              }}
                            >
                              Remove
                            </button>
                          </div>
                        ))
                      ) : (
                        <div style={{ padding: '16px', background: '#f9fafb', borderRadius: '8px', color: '#6b7280', fontSize: '14px', fontWeight: '500', border: '1px solid #e5e7eb' }}>
                          No success criteria defined. Click "+ Add" to add one.
                        </div>
                      )}
                      <div style={{ marginTop: '8px', fontSize: '12px', color: '#6b7280', fontWeight: '500' }}>
                        Criteria that indicate a successful call outcome
                      </div>
                    </div>

                    {/* Other Criteria */}
                    <div className="form-group" style={{ marginBottom: '20px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                        <label style={{ fontWeight: '600', color: '#111827', fontSize: '15px' }}>
                          Other Criteria
                        </label>
                        <button
                          type="button"
                          onClick={() => handleAddCriteria('otherCriteria')}
                          style={{
                            padding: '8px 16px',
                            fontSize: '12px',
                            fontWeight: '600',
                            background: '#f59e0b',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: 'pointer',
                          }}
                        >
                          + Add
                        </button>
                      </div>
                      {formData.otherCriteria && formData.otherCriteria.length > 0 ? (
                        formData.otherCriteria.map((criteria, index) => (
                          <div key={index} style={{ display: 'flex', gap: '10px', marginBottom: '10px', alignItems: 'center' }}>
                            <input
                              type="text"
                              value={criteria}
                              onChange={(e) => handleUpdateCriteria('otherCriteria', index, e.target.value)}
                              placeholder="e.g., cancellation request"
                              style={{
                                flex: 1,
                                padding: '14px 20px',
                                border: '1.5px solid #e5e7eb',
                                borderRadius: '8px',
                                fontSize: '14px',
                              }}
                            />
                            <button
                              type="button"
                              onClick={() => handleRemoveCriteria('otherCriteria', index)}
                              style={{
                                padding: '12px 20px',
                                background: '#ef4444',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontSize: '12px',
                                fontWeight: '600',
                              }}
                            >
                              Remove
                            </button>
                          </div>
                        ))
                      ) : (
                        <div style={{ padding: '16px', background: '#f9fafb', borderRadius: '8px', color: '#6b7280', fontSize: '14px', fontWeight: '500', border: '1px solid #e5e7eb' }}>
                          No other criteria defined. Click "+ Add" to add one.
                        </div>
                      )}
                      <div style={{ marginTop: '8px', fontSize: '12px', color: '#6b7280', fontWeight: '500' }}>
                        Other call outcome categories (not success)
                      </div>
                    </div>

                    {/* Cancellation Criteria Selection */}
                    <div className="form-group" style={{ marginBottom: '20px', marginTop: '24px', paddingTop: '24px', borderTop: '2px solid #e5e7eb' }}>
                      <h6 style={{ marginBottom: '12px', fontSize: '15px', fontWeight: '600', color: '#111827' }}>
                        Cancellation Criteria
                      </h6>
                      <div style={{ marginBottom: '12px', fontSize: '12px', color: '#6b7280', fontWeight: '500' }}>
                        Select which criteria should be treated as order cancellations
                      </div>
                      {formData.otherCriteria && formData.otherCriteria.length > 0 ? (
                        formData.otherCriteria.map((criteria, index) => {
                          const isChecked = Array.isArray(safeFormData?.cancellationCriteria) && safeFormData.cancellationCriteria.includes(criteria);
                          
                          return (
                            <div key={index} style={{ marginBottom: '12px', padding: '12px', background: '#f9fafb', borderRadius: '8px', border: '1px solid #e5e7eb' }}>
                              <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                <input
                                  type="checkbox"
                                  checked={isChecked}
                                  onChange={(e) => {
                                    const currentCriteria = Array.isArray(safeFormData?.cancellationCriteria) ? [...safeFormData.cancellationCriteria] : [];
                                    if (e.target.checked) {
                                      if (!currentCriteria.includes(criteria)) {
                                        currentCriteria.push(criteria);
                                      }
                                    } else {
                                      const index = currentCriteria.indexOf(criteria);
                                      if (index > -1) {
                                        currentCriteria.splice(index, 1);
                                      }
                                    }
                                    setFormData(prev => ({ ...prev, cancellationCriteria: currentCriteria }));
                                  }}
                                  style={{
                                    width: '16px',
                                    height: '16px',
                                    cursor: 'pointer',
                                  }}
                                />
                                <span style={{ fontSize: '14px', color: '#111827', fontWeight: '500' }}>{criteria}</span>
                              </label>
                            </div>
                          );
                        })
                      ) : (
                        <div style={{ padding: '16px', background: '#f9fafb', borderRadius: '8px', color: '#6b7280', fontSize: '14px', fontWeight: '500', border: '1px solid #e5e7eb' }}>
                          No other criteria defined. Add other criteria above to enable selection.
                        </div>
                      )}
                    </div>

                    {/* Retry Criteria Selection */}
                    <div className="form-group" style={{ marginBottom: '20px', marginTop: '24px', paddingTop: '24px', borderTop: '2px solid #e5e7eb' }}>
                      <h6 style={{ marginBottom: '12px', fontSize: '15px', fontWeight: '600', color: '#111827' }}>
                        Retry Criteria
                      </h6>
                      <div style={{ marginBottom: '12px', fontSize: '12px', color: '#6b7280', fontWeight: '500' }}>
                        Select which criteria should trigger a retry attempt
                      </div>
                      {formData.otherCriteria && formData.otherCriteria.length > 0 ? (
                        formData.otherCriteria.map((criteria, index) => {
                          const isChecked = Array.isArray(safeFormData?.retryCriteria) && safeFormData.retryCriteria.includes(criteria);
                          
                          return (
                            <div key={index} style={{ marginBottom: '12px', padding: '12px', background: '#f9fafb', borderRadius: '8px', border: '1px solid #e5e7eb' }}>
                              <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                                <input
                                  type="checkbox"
                                  checked={isChecked}
                                  onChange={(e) => {
                                    const currentCriteria = Array.isArray(safeFormData?.retryCriteria) ? [...safeFormData.retryCriteria] : [];
                                    if (e.target.checked) {
                                      if (!currentCriteria.includes(criteria)) {
                                        currentCriteria.push(criteria);
                                      }
                                    } else {
                                      const index = currentCriteria.indexOf(criteria);
                                      if (index > -1) {
                                        currentCriteria.splice(index, 1);
                                      }
                                    }
                                    setFormData(prev => ({ ...prev, retryCriteria: currentCriteria }));
                                  }}
                                  style={{
                                    width: '16px',
                                    height: '16px',
                                    cursor: 'pointer',
                                  }}
                                />
                                <span style={{ fontSize: '14px', color: '#111827', fontWeight: '500' }}>{criteria}</span>
                              </label>
                            </div>
                          );
                        })
                      ) : (
                        <div style={{ padding: '16px', background: '#f9fafb', borderRadius: '8px', color: '#6b7280', fontSize: '14px', fontWeight: '500', border: '1px solid #e5e7eb' }}>
                          No other criteria defined. Add other criteria above to enable selection.
                        </div>
                      )}
                    </div>
                  </>
                )}

                {/* Auto Tagging Settings */}
                <div style={{ borderTop: '2px solid #e5e7eb', paddingTop: '24px', marginTop: '24px' }}>
                  <h6>
                    Auto Tagging Settings
                  </h6>
                  <label style={{ display: 'flex', alignItems: 'flex-start', gap: '12px', cursor: 'pointer', padding: '12px', background: '#fafbfc', borderRadius: '8px', border: '1px solid #e5e7eb', marginBottom: '20px' }}>
                    <input
                      type="checkbox"
                      id="autoTaggingEnabled"
                      name="autoTaggingEnabled"
                      checked={safeFormData?.autoTaggingEnabled || false}
                      onChange={handleFormChange}
                      style={{
                        width: '18px',
                        height: '18px',
                        marginTop: '2px',
                        cursor: 'pointer',
                        flexShrink: 0,
                      }}
                    />
                    <div style={{ fontSize: '14px', color: '#374151', lineHeight: '1.5', fontWeight: '500' }}>
                      Enable Auto Tagging
                    </div>
                  </label>

                  {safeFormData?.autoTaggingEnabled && (
                    <>
                      {/* Success Criteria Tagging */}
                      <div className="form-group" style={{ marginBottom: '20px' }}>
                        <label style={{ fontWeight: '600', color: '#111827', fontSize: '15px', marginBottom: '12px', display: 'block' }}>
                          Tag on Success Criteria
                        </label>
                        <div style={{ marginBottom: '12px', fontSize: '12px', color: '#6b7280', fontWeight: '500' }}>
                          Select which success criteria should trigger a tag on the Shopify order
                        </div>
                        {formData.successCriteria && formData.successCriteria.length > 0 ? (
                          formData.successCriteria.map((criteria, index) => {
                            const autoTaggingRules = safeFormData?.autoTaggingRules || {};
                            const successCriteriaTags = autoTaggingRules.successCriteria || {};
                            const isChecked = criteria in successCriteriaTags;
                            const customTagName = successCriteriaTags[criteria] || '';
                            
                            return (
                              <div key={index} style={{ marginBottom: '12px', padding: '12px', background: '#f9fafb', borderRadius: '8px', border: '1px solid #e5e7eb' }}>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer', marginBottom: isChecked ? '8px' : '0' }}>
                                  <input
                                    type="checkbox"
                                    checked={isChecked}
                                    onChange={(e) => {
                                      const currentRules = safeFormData?.autoTaggingRules || { successCriteria: {}, otherCriteria: {}, tagOnMaxRetries: false, maxRetriesTagName: '' };
                                      const newSuccessCriteria = { ...currentRules.successCriteria };
                                      
                                      if (e.target.checked) {
                                        newSuccessCriteria[criteria] = criteria; // Default to criteria name
                                      } else {
                                        delete newSuccessCriteria[criteria];
                                      }
                                      
                                      handleFormChange({
                                        target: {
                                          name: 'autoTaggingRules',
                                          value: {
                                            ...currentRules,
                                            successCriteria: newSuccessCriteria
                                          }
                                        }
                                      });
                                    }}
                                    style={{
                                      width: '16px',
                                      height: '16px',
                                      cursor: 'pointer',
                                    }}
                                  />
                                  <span style={{ fontSize: '14px', color: '#111827', fontWeight: '500' }}>{criteria}</span>
                                </label>
                                {isChecked && (
                                  <div style={{ marginLeft: '26px', marginTop: '8px' }}>
                                    <input
                                      type="text"
                                      placeholder={`Default: ${criteria}`}
                                      value={customTagName === criteria ? '' : customTagName}
                                      onChange={(e) => {
                                        const currentRules = safeFormData?.autoTaggingRules || { successCriteria: {}, otherCriteria: {}, tagOnMaxRetries: false, maxRetriesTagName: '' };
                                        const newSuccessCriteria = { ...currentRules.successCriteria };
                                        newSuccessCriteria[criteria] = e.target.value.trim() || criteria;
                                        
                                        handleFormChange({
                                          target: {
                                            name: 'autoTaggingRules',
                                            value: {
                                              ...currentRules,
                                              successCriteria: newSuccessCriteria
                                            }
                                          }
                                        });
                                      }}
                                      style={{
                                        width: '100%',
                                        padding: '8px 12px',
                                        border: '1px solid #d1d5db',
                                        borderRadius: '6px',
                                        fontSize: '13px',
                                      }}
                                    />
                                    <div style={{ marginTop: '4px', fontSize: '11px', color: '#6b7280' }}>
                                      Leave empty to use "{criteria}" as tag name
                                    </div>
                                  </div>
                                )}
                              </div>
                            );
                          })
                        ) : (
                          <div style={{ padding: '16px', background: '#f9fafb', borderRadius: '8px', color: '#6b7280', fontSize: '14px', fontWeight: '500', border: '1px solid #e5e7eb' }}>
                            No success criteria defined. Add success criteria above to enable tagging.
                          </div>
                        )}
                      </div>

                      {/* Other Criteria Tagging */}
                      <div className="form-group" style={{ marginBottom: '20px' }}>
                        <label style={{ fontWeight: '600', color: '#111827', fontSize: '15px', marginBottom: '12px', display: 'block' }}>
                          Tag on Other Criteria
                        </label>
                        <div style={{ marginBottom: '12px', fontSize: '12px', color: '#6b7280', fontWeight: '500' }}>
                          Select which other criteria should trigger a tag on the Shopify order
                        </div>
                        {formData.otherCriteria && formData.otherCriteria.length > 0 ? (
                          formData.otherCriteria.map((criteria, index) => {
                            const autoTaggingRules = safeFormData?.autoTaggingRules || {};
                            const otherCriteriaTags = autoTaggingRules.otherCriteria || {};
                            const isChecked = criteria in otherCriteriaTags;
                            const customTagName = otherCriteriaTags[criteria] || '';
                            
                            return (
                              <div key={index} style={{ marginBottom: '12px', padding: '12px', background: '#f9fafb', borderRadius: '8px', border: '1px solid #e5e7eb' }}>
                                <label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer', marginBottom: isChecked ? '8px' : '0' }}>
                                  <input
                                    type="checkbox"
                                    checked={isChecked}
                                    onChange={(e) => {
                                      const currentRules = safeFormData?.autoTaggingRules || { successCriteria: {}, otherCriteria: {}, tagOnMaxRetries: false, maxRetriesTagName: '' };
                                      const newOtherCriteria = { ...currentRules.otherCriteria };
                                      
                                      if (e.target.checked) {
                                        newOtherCriteria[criteria] = criteria; // Default to criteria name
                                      } else {
                                        delete newOtherCriteria[criteria];
                                      }
                                      
                                      handleFormChange({
                                        target: {
                                          name: 'autoTaggingRules',
                                          value: {
                                            ...currentRules,
                                            otherCriteria: newOtherCriteria
                                          }
                                        }
                                      });
                                    }}
                                    style={{
                                      width: '16px',
                                      height: '16px',
                                      cursor: 'pointer',
                                    }}
                                  />
                                  <span style={{ fontSize: '14px', color: '#111827', fontWeight: '500' }}>{criteria}</span>
                                </label>
                                {isChecked && (
                                  <div style={{ marginLeft: '26px', marginTop: '8px' }}>
                                    <input
                                      type="text"
                                      placeholder={`Default: ${criteria}`}
                                      value={customTagName === criteria ? '' : customTagName}
                                      onChange={(e) => {
                                        const currentRules = safeFormData?.autoTaggingRules || { successCriteria: {}, otherCriteria: {}, tagOnMaxRetries: false, maxRetriesTagName: '' };
                                        const newOtherCriteria = { ...currentRules.otherCriteria };
                                        newOtherCriteria[criteria] = e.target.value.trim() || criteria;
                                        
                                        handleFormChange({
                                          target: {
                                            name: 'autoTaggingRules',
                                            value: {
                                              ...currentRules,
                                              otherCriteria: newOtherCriteria
                                            }
                                          }
                                        });
                                      }}
                                      style={{
                                        width: '100%',
                                        padding: '8px 12px',
                                        border: '1px solid #d1d5db',
                                        borderRadius: '6px',
                                        fontSize: '13px',
                                      }}
                                    />
                                    <div style={{ marginTop: '4px', fontSize: '11px', color: '#6b7280' }}>
                                      Leave empty to use "{criteria}" as tag name
                                    </div>
                                  </div>
                                )}
                              </div>
                            );
                          })
                        ) : (
                          <div style={{ padding: '16px', background: '#f9fafb', borderRadius: '8px', color: '#6b7280', fontSize: '14px', fontWeight: '500', border: '1px solid #e5e7eb' }}>
                            No other criteria defined. Add other criteria above to enable tagging.
                          </div>
                        )}
                      </div>

                      {/* Max Retries Tagging */}
                      <div className="form-group" style={{ marginBottom: '20px' }}>
                        <label style={{ display: 'flex', alignItems: 'flex-start', gap: '12px', cursor: 'pointer', padding: '12px', background: '#fafbfc', borderRadius: '8px', border: '1px solid #e5e7eb', marginBottom: '12px' }}>
                          <input
                            type="checkbox"
                            checked={(safeFormData?.autoTaggingRules?.tagOnMaxRetries || false)}
                            onChange={(e) => {
                              const currentRules = safeFormData?.autoTaggingRules || { successCriteria: {}, otherCriteria: {}, tagOnMaxRetries: false, maxRetriesTagName: '' };
                              handleFormChange({
                                target: {
                                  name: 'autoTaggingRules',
                                  value: {
                                    ...currentRules,
                                    tagOnMaxRetries: e.target.checked,
                                    maxRetriesTagName: e.target.checked ? (currentRules.maxRetriesTagName || 'max_retries_reached') : ''
                                  }
                                }
                              });
                            }}
                            style={{
                              width: '18px',
                              height: '18px',
                              marginTop: '2px',
                              cursor: 'pointer',
                              flexShrink: 0,
                            }}
                          />
                          <div style={{ fontSize: '14px', color: '#374151', lineHeight: '1.5', fontWeight: '500' }}>
                            Tag on Max Retries Reached
                          </div>
                        </label>
                        {(safeFormData?.autoTaggingRules?.tagOnMaxRetries || false) && (
                          <div style={{ marginLeft: '30px', marginTop: '12px' }}>
                            <label htmlFor="maxRetriesTagName" style={{ display: 'block', marginBottom: '8px', fontSize: '13px', fontWeight: '500', color: '#374151' }}>
                              Tag Name
                            </label>
                            <input
                              type="text"
                              id="maxRetriesTagName"
                              placeholder="e.g., max_retries_reached"
                              value={safeFormData?.autoTaggingRules?.maxRetriesTagName || ''}
                              onChange={(e) => {
                                const currentRules = safeFormData?.autoTaggingRules || { successCriteria: {}, otherCriteria: {}, tagOnMaxRetries: true, maxRetriesTagName: '' };
                                handleFormChange({
                                  target: {
                                    name: 'autoTaggingRules',
                                    value: {
                                      ...currentRules,
                                      maxRetriesTagName: e.target.value.trim()
                                    }
                                  }
                                });
                              }}
                              style={{
                                width: '100%',
                                padding: '10px 14px',
                                border: '1px solid #d1d5db',
                                borderRadius: '6px',
                                fontSize: '14px',
                              }}
                            />
                            <div style={{ marginTop: '6px', fontSize: '12px', color: '#6b7280', fontWeight: '500' }}>
                              Tag name to apply when maximum retry attempts are reached
                            </div>
                          </div>
                        )}
                        
                        {/* Cancel on max retry reached */}
                        <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px solid #e5e7eb' }}>
                          <div
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'space-between',
                              gap: '12px',
                              padding: '12px',
                              borderRadius: '8px',
                              transition: 'background-color 0.2s',
                              background: '#FFFFFF'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#F9FAFB'}
                            onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#FFFFFF'}
                          >
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: '600', marginBottom: '4px', fontSize: '14px', color: '#111827' }}>Cancel on max retry reached</div>
                              <div style={{ fontSize: '12px', color: '#6b7280' }}>Automatically cancel the order in Shopify when max retries are reached</div>
                            </div>
                            <label className="profile-toggle-switch" style={{ margin: 0 }}>
                              <input
                                type="checkbox"
                                checked={safeFormData?.cancelOnRetry !== undefined ? safeFormData.cancelOnRetry : (formData?.cancelOnRetry !== undefined ? formData.cancelOnRetry : false)}
                                onChange={(e) => {
                                  setFormData(prev => ({ ...prev, cancelOnRetry: e.target.checked }));
                                }}
                              />
                              <span className="profile-toggle-slider"></span>
                            </label>
                          </div>
                        </div>
                      </div>
                    </>
                  )}
                </div>

                <div style={{ borderTop: '2px solid #e5e7eb', paddingTop: '24px', marginTop: '24px' }}>
                  <h6>
                    Disable Early Disconnect Retry Logic
                  </h6>
                  <label style={{ display: 'flex', alignItems: 'flex-start', gap: '12px', cursor: 'pointer', padding: '12px', background: '#fafbfc', borderRadius: '8px', border: '1px solid #e5e7eb' }}>
                    <input
                      type="checkbox"
                      id="disableUnder35Retries"
                      name="disableUnder35Retries"
                      checked={safeFormData?.disableUnder35Retries || false}
                      onChange={handleFormChange}
                      style={{
                        width: '18px',
                        height: '18px',
                        marginTop: '2px',
                        cursor: 'pointer',
                        flexShrink: 0,
                      }}
                    />
                    <div style={{ fontSize: '14px', color: '#374151', lineHeight: '1.5', fontWeight: '500' }}>
                      Disable automatic retries for early disconnect calls
                    </div>
                  </label>
                </div>

                <div style={{ borderTop: '2px solid #e5e7eb', paddingTop: '24px', marginTop: '24px' }}>
                  <h6>
                    Script-Specific Retry Settings (Optional)
                  </h6>
                  <div style={{ fontSize: '12px', color: '#6b7280', marginBottom: '20px', lineHeight: '1.5', fontWeight: '500', padding: '12px', background: '#f0f9ff', borderRadius: '8px', border: '1px solid #bae6fd' }}>
                    Leave empty to use shop settings. Only fill if you want to override shop settings for this script.
                  </div>

                  <div className="form-group" style={{ marginBottom: '16px' }}>
                    <label htmlFor="maxRetries">
                      Max Retries
                    </label>
                    <input
                      type="number"
                      id="maxRetries"
                      name="maxRetries"
                      value={safeFormData?.maxRetries || ''}
                      onChange={handleFormChange}
                      placeholder="Leave empty for shop default"
                      min="0"
                    />
                    <div style={{ marginTop: '8px', fontSize: '12px', color: '#6b7280', fontWeight: '500' }}>
                      Maximum number of retry attempts for failed calls
              </div>
            </div>

                  <div className="form-group" style={{ marginBottom: '16px' }}>
                    <label htmlFor="retryIntervalMinutes">
                      Retry Interval (Minutes)
                    </label>
                    <input
                      type="number"
                      id="retryIntervalMinutes"
                      name="retryIntervalMinutes"
                      value={safeFormData?.retryIntervalMinutes || ''}
                      onChange={handleFormChange}
                      placeholder="Leave empty for shop default"
                      min="1"
                    />
                    <div style={{ marginTop: '8px', fontSize: '12px', color: '#6b7280', fontWeight: '500' }}>
                      Minutes to wait between retry attempts
                    </div>
                  </div>

                </div>
              </div>
            </div>
              </div>
            )}

            {/* Edit Script Tab Content */}
            {activeTab === 'edit-script' && (
              <div className="tab-content" style={{ height: 'calc(100vh - 131px)' }}>
                <div style={{ 
                  display: 'flex', 
                  width: '100%', 
                  height: '100%',
                  overflow: 'hidden',
                  position: 'relative'
                }}>
                  {/* Show the edit script content from box2 */}
                  {(() => {
                    // Temporarily set box2ActiveTab to 'edit-script' for rendering
                    const originalBox2Tab = box2ActiveTab;
                    // We'll render the edit script content directly here
                    return (
                      <div style={{ width: '100%', height: '100%', background: `url('/images/Chat Bot UI.png')`, backgroundSize: 'cover', backgroundPosition: 'center', backgroundRepeat: 'no-repeat', padding: 0, display: 'flex', flexDirection: 'column' }}>
                        {/* Edit Script Chat Interface */}
                        <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden', padding: '20px' }}>
                          {/* Messages Area */}
                          <div style={{ flex: 1, overflowY: 'auto', marginBottom: '16px', display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            {editScriptMessages.map((msg, idx) => (
                              <div key={idx} style={{ display: 'flex', justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start' }}>
                                <div style={{
                                  maxWidth: '70%',
                                  padding: '12px 16px',
                                  borderRadius: '12px',
                                  background: msg.role === 'user' ? '#4B5CFF' : '#FFFFFF',
                                  color: msg.role === 'user' ? '#FFFFFF' : '#111827',
                                  fontSize: '14px',
                                  lineHeight: '1.5'
                                }}>
                                  {msg.content}
                                </div>
                              </div>
                            ))}
                            {isEditScriptLoading && (
                              <div style={{ display: 'flex', justifyContent: 'flex-start' }}>
                                <div style={{
                                  padding: '12px 16px',
                                  borderRadius: '12px',
                                  background: '#F3F4F6',
                                  color: '#6b7280',
                                  fontSize: '14px'
                                }}>
                                  Thinking...
                                </div>
                              </div>
                            )}
                          </div>
                          {/* Input Area */}
                          <div style={{ display: 'flex', gap: '8px' }}>
                            <textarea
                              value={editScriptInput}
                              onChange={(e) => setEditScriptInput(e.target.value)}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter' && !e.shiftKey) {
                                  e.preventDefault();
                                  if (editScriptInput.trim() && !isEditScriptLoading) {
                                    handleEditScriptSend(editScriptInput.trim());
                                  }
                                }
                              }}
                              placeholder="Ask me to edit your script..."
                              style={{
                                flex: 1,
                                padding: '12px',
                                border: '1px solid #D1D5DB',
                                borderRadius: '8px',
                                fontSize: '14px',
                                resize: 'none',
                                minHeight: '50px',
                                maxHeight: '120px'
                              }}
                            />
                            <button
                              onClick={() => {
                                if (editScriptInput.trim() && !isEditScriptLoading) {
                                  handleEditScriptSend(editScriptInput.trim());
                                }
                              }}
                              disabled={!editScriptInput.trim() || isEditScriptLoading}
                              style={{
                                padding: '12px 24px',
                                background: '#4B5CFF',
                                color: '#FFFFFF',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: !editScriptInput.trim() || isEditScriptLoading ? 'not-allowed' : 'pointer',
                                fontSize: '14px',
                                fontWeight: '500',
                                opacity: !editScriptInput.trim() || isEditScriptLoading ? 0.5 : 1
                              }}
                            >
                              Send
                            </button>
                          </div>
                        </div>
                      </div>
                    );
                  })()}
                </div>
              </div>
            )}

            {/* Test Agent Tab Content */}
            {activeTab === 'test-agent' && (
              <div className="tab-content" style={{ height: 'calc(100vh - 131px)' }}>
                <div style={{ 
                  display: 'flex', 
                  width: '100%', 
                  height: '100%',
                  overflow: 'hidden',
                  position: 'relative'
                }}>
                  {/* Show the chat content from box2 */}
                  <div style={{ width: '100%', height: '100%', background: `url('/images/Chat Bot UI.png')`, backgroundSize: 'cover', backgroundPosition: 'center', backgroundRepeat: 'no-repeat', padding: 0, display: 'flex', flexDirection: 'column' }}>
                    {/* Chat Interface */}
                    <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden', padding: '20px' }}>
                      {/* Messages Area */}
                      <div style={{ flex: 1, overflowY: 'auto', marginBottom: '16px', display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        {scriptBox2ChatMessages.map((msg, idx) => (
                          <div key={idx} style={{ display: 'flex', justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start' }}>
                            <div style={{
                              maxWidth: '70%',
                              padding: '12px 16px',
                              borderRadius: '12px',
                              background: msg.role === 'user' ? '#4B5CFF' : '#FFFFFF',
                              color: msg.role === 'user' ? '#FFFFFF' : '#111827',
                              fontSize: '14px',
                              lineHeight: '1.5'
                            }}>
                              {msg.content}
                            </div>
                          </div>
                        ))}
                        {scriptBox2ChatLoading && (
                          <div style={{ display: 'flex', justifyContent: 'flex-start' }}>
                            <div style={{
                              padding: '12px 16px',
                              borderRadius: '12px',
                              background: '#F3F4F6',
                              color: '#6b7280',
                              fontSize: '14px'
                            }}>
                              Thinking...
                            </div>
                          </div>
                        )}
                      </div>
                      {/* Input Area */}
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <textarea
                          value={scriptBox2ChatInput}
                          onChange={(e) => setScriptBox2ChatInput(e.target.value)}
                          onKeyDown={(e) => {
                            if (e.key === 'Enter' && !e.shiftKey) {
                              e.preventDefault();
                              if (scriptBox2ChatInput.trim() && !scriptBox2ChatLoading) {
                                handleScriptBox2ChatSend();
                              }
                            }
                          }}
                          placeholder="Type your message..."
                          style={{
                            flex: 1,
                            padding: '12px',
                            border: '1px solid #D1D5DB',
                            borderRadius: '8px',
                            fontSize: '14px',
                            resize: 'none',
                            minHeight: '50px',
                            maxHeight: '120px'
                          }}
                        />
                          <button
                            onClick={() => {
                              if (scriptBox2ChatInput.trim() && !scriptBox2ChatLoading) {
                                handleScriptBox2ChatSend();
                              }
                            }}
                          disabled={!scriptBox2ChatInput.trim() || scriptBox2ChatLoading}
                          style={{
                            padding: '12px 24px',
                            background: '#4B5CFF',
                            color: '#FFFFFF',
                            border: 'none',
                            borderRadius: '8px',
                            cursor: !scriptBox2ChatInput.trim() || scriptBox2ChatLoading ? 'not-allowed' : 'pointer',
                            fontSize: '14px',
                            fontWeight: '500',
                            opacity: !scriptBox2ChatInput.trim() || scriptBox2ChatLoading ? 0.5 : 1
                          }}
                        >
                          Send
                        </button>
                      </div>
                </div>
              </div>
            </div>
              </div>
            )}

            {/* Reply Quality Tab Content */}
            {activeTab === 'knowledge' && (
              <div className="tab-content" style={{ height: 'calc(100vh - 131px)' }}>
                <div className="form-section" style={{ height: '100%', marginBottom: '0px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h4>Set how to reply / Handle Objections</h4>
                    {!showReplyQualityForm && (
                      <button
                        type="button"
                        onClick={() => {
                          setShowReplyQualityForm(true);
                          setEditingReplyQualityId(null);
                          setReplyQualityFormData({
                            name: '',
                            description: '',
                            qnaPairs: [{ question: '', answer: '' }]
                          });
                        }}
                        style={{
                          padding: '8px 16px',
                          background: '#4B5CFF',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontWeight: '500',
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '6px'
                        }}
                      >
                        <span style={{ fontSize: '18px', lineHeight: '1' }}>+</span>
                        <span>Add Reply Quality</span>
                      </button>
                    )}
                  </div>

                  {showReplyQualityForm && (
                    <form onSubmit={handleReplyQualitySubmit} style={{
                      background: '#FFFFFF',
                      border: '1.5px solid #E5E7EB',
                      borderRadius: '12px',
                      padding: '24px',
                      marginBottom: '24px',
                      boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)'
                    }}>
                      {/* Universal Name and Description */}
                      <div style={{ marginBottom: '20px' }}>
                        <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                          Name <span style={{ color: '#ef4444' }}>*</span>
                        </label>
                        <input
                          type="text"
                          value={replyQualityFormData.name}
                          onChange={(e) => setReplyQualityFormData({ ...replyQualityFormData, name: e.target.value })}
                          placeholder="e.g., Shipping Policy Replies"
                          required
                          style={{
                            width: '100%',
                            padding: '10px 12px',
                            border: '1px solid #D1D5DB',
                            borderRadius: '8px',
                            fontSize: '14px',
                            fontFamily: 'inherit',
                            transition: 'all 0.2s ease',
                            background: '#ffffff'
                          }}
                          onFocus={(e) => {
                            e.currentTarget.style.borderColor = '#4B5CFF';
                            e.currentTarget.style.boxShadow = '0 0 0 3px rgba(75, 92, 255, 0.1)';
                          }}
                          onBlur={(e) => {
                            e.currentTarget.style.borderColor = '#D1D5DB';
                            e.currentTarget.style.boxShadow = 'none';
                          }}
                        />
                      </div>

                      <div style={{ marginBottom: '20px' }}>
                        <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                          Description <span style={{ fontSize: '12px', color: '#6b7280', fontWeight: '400' }}>(Optional)</span>
                        </label>
                        <input
                          type="text"
                          value={replyQualityFormData.description}
                          onChange={(e) => setReplyQualityFormData({ ...replyQualityFormData, description: e.target.value })}
                          placeholder="Brief description"
                          style={{
                            width: '100%',
                            padding: '10px 12px',
                            border: '1px solid #D1D5DB',
                            borderRadius: '8px',
                            fontSize: '14px',
                            fontFamily: 'inherit',
                            transition: 'all 0.2s ease',
                            background: '#ffffff'
                          }}
                          onFocus={(e) => {
                            e.currentTarget.style.borderColor = '#4B5CFF';
                            e.currentTarget.style.boxShadow = '0 0 0 3px rgba(75, 92, 255, 0.1)';
                          }}
                          onBlur={(e) => {
                            e.currentTarget.style.borderColor = '#D1D5DB';
                            e.currentTarget.style.boxShadow = 'none';
                          }}
                        />
                      </div>

                      {/* QnA Pairs Section */}
                      <div style={{ marginBottom: '20px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', color: '#111827', marginBottom: '16px' }}>
                          Q&A Pairs
                        </div>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        {replyQualityFormData.qnaPairs.map((pair, index) => (
                          <div
                            key={index}
                            style={{
                                padding: '16px',
                              background: '#F9FAFB',
                                borderRadius: '8px',
                              border: '1px solid #E5E7EB',
                                transition: 'all 0.2s ease'
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.borderColor = '#d1d5db';
                                e.currentTarget.style.background = '#ffffff';
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.borderColor = '#E5E7EB';
                                e.currentTarget.style.background = '#F9FAFB';
                              }}
                            >
                              <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-start' }}>
                                <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                  <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '600', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                      Question
                                    </label>
                              <input
                                type="text"
                                value={pair.question}
                                onChange={(e) => handleQnAPairChange(index, 'question', e.target.value)}
                                      placeholder="What should the agent reply to?"
                                style={{
                                        width: '100%',
                                        padding: '10px 12px',
                                  border: '1px solid #D1D5DB',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        transition: 'all 0.2s ease',
                                        background: '#ffffff'
                                      }}
                                      onFocus={(e) => {
                                        e.currentTarget.style.borderColor = '#4B5CFF';
                                        e.currentTarget.style.boxShadow = '0 0 0 3px rgba(75, 92, 255, 0.1)';
                                      }}
                                      onBlur={(e) => {
                                        e.currentTarget.style.borderColor = '#D1D5DB';
                                        e.currentTarget.style.boxShadow = 'none';
                                      }}
                                    />
                                  </div>
                                  <div>
                                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '12px', fontWeight: '600', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                      Answer
                                    </label>
                                    <textarea
                                value={pair.answer}
                                onChange={(e) => handleQnAPairChange(index, 'answer', e.target.value)}
                                      placeholder="How should the agent reply?"
                                style={{
                                        width: '100%',
                                        minHeight: '80px',
                                        padding: '10px 12px',
                                  border: '1px solid #D1D5DB',
                                        borderRadius: '8px',
                                        fontSize: '14px',
                                        fontFamily: 'inherit',
                                        resize: 'vertical',
                                        transition: 'all 0.2s ease',
                                        background: '#ffffff',
                                        lineHeight: '1.6'
                                      }}
                                      onFocus={(e) => {
                                        e.currentTarget.style.borderColor = '#4B5CFF';
                                        e.currentTarget.style.boxShadow = '0 0 0 3px rgba(75, 92, 255, 0.1)';
                                      }}
                                      onBlur={(e) => {
                                        e.currentTarget.style.borderColor = '#D1D5DB';
                                        e.currentTarget.style.boxShadow = 'none';
                                      }}
                                    />
                                  </div>
                            </div>
                            {replyQualityFormData.qnaPairs.length > 1 && (
                              <button
                                type="button"
                                onClick={() => handleRemoveQnAPair(index)}
                                style={{
                                      padding: '8px',
                                      background: '#FEF2F2',
                                      color: '#EF4444',
                                      border: '1px solid #FECACA',
                                      borderRadius: '8px',
                                      fontSize: '18px',
                                      fontWeight: '600',
                                  cursor: 'pointer',
                                      flexShrink: 0,
                                      width: '36px',
                                      height: '36px',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      transition: 'all 0.2s ease'
                                    }}
                                    onMouseEnter={(e) => {
                                      e.currentTarget.style.background = '#EF4444';
                                      e.currentTarget.style.color = '#ffffff';
                                      e.currentTarget.style.borderColor = '#EF4444';
                                    }}
                                    onMouseLeave={(e) => {
                                      e.currentTarget.style.background = '#FEF2F2';
                                      e.currentTarget.style.color = '#EF4444';
                                      e.currentTarget.style.borderColor = '#FECACA';
                                }}
                              >
                                Ã—
                              </button>
                            )}
                              </div>
                          </div>
                        ))}
                        </div>
                        
                        {/* Add More QnA Pair Button */}
                        <button
                          type="button"
                          onClick={handleAddQnAPair}
                          style={{
                            width: '100%',
                            padding: '12px',
                            background: '#F9FAFB',
                            color: '#4B5CFF',
                            border: '1.5px dashed #D1D5DB',
                            borderRadius: '8px',
                            fontSize: '14px',
                            fontWeight: '500',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px',
                            marginTop: '12px',
                            transition: 'all 0.2s ease'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.background = '#EFF6FF';
                            e.currentTarget.style.borderColor = '#4B5CFF';
                            e.currentTarget.style.borderStyle = 'solid';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.background = '#F9FAFB';
                            e.currentTarget.style.borderColor = '#D1D5DB';
                            e.currentTarget.style.borderStyle = 'dashed';
                          }}
                        >
                          <span style={{ fontSize: '18px', fontWeight: '600' }}>+</span>
                          <span>Add Another Q&A Pair</span>
                        </button>
                      </div>

                      {/* Form Actions */}
                      <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', paddingTop: '20px', borderTop: '1px solid #E5E7EB', marginTop: '8px' }}>
                        <button
                          type="button"
                          onClick={() => {
                            setShowReplyQualityForm(false);
                            setEditingReplyQualityId(null);
                            setReplyQualityFormData({
                              name: '',
                              description: '',
                              qnaPairs: [{ question: '', answer: '' }]
                            });
                          }}
                          style={{
                            padding: '10px 20px',
                            background: '#F3F4F6',
                            color: '#374151',
                            border: '1px solid #D1D5DB',
                            borderRadius: '8px',
                            fontSize: '14px',
                            fontWeight: '500',
                            cursor: 'pointer',
                            transition: 'all 0.2s ease'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.background = '#E5E7EB';
                            e.currentTarget.style.borderColor = '#9CA3AF';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.background = '#F3F4F6';
                            e.currentTarget.style.borderColor = '#D1D5DB';
                          }}
                        >
                          Cancel
                        </button>
                        <button
                          type="submit"
                          style={{
                            padding: '10px 20px',
                            background: '#4B5CFF',
                            color: 'white',
                            border: 'none',
                            borderRadius: '8px',
                            fontSize: '14px',
                            fontWeight: '600',
                            cursor: 'pointer',
                            transition: 'all 0.2s ease',
                            boxShadow: '0 1px 2px rgba(75, 92, 255, 0.2)'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.background = '#3b4ae6';
                            e.currentTarget.style.boxShadow = '0 2px 4px rgba(75, 92, 255, 0.3)';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.background = '#4B5CFF';
                            e.currentTarget.style.boxShadow = '0 1px 2px rgba(75, 92, 255, 0.2)';
                          }}
                        >
                          {editingReplyQualityId ? 'Update' : 'Save'} Reply Quality
                        </button>
                      </div>
                    </form>
                  )}

                  {/* List of Existing QnA Books */}
                  {!showReplyQualityForm && (
                    <div style={{ marginTop: '24px' }}>
                      <h5 style={{ fontSize: '16px', fontWeight: '600', color: '#111827', marginBottom: '16px' }}>
                        Attached QnA Books
                      </h5>
                      {(() => {
                        // Filter QnA books from knowledgeBooks
                        const qnaBooks = knowledgeBooks.filter(kb => {
                          try {
                            if (kb.extraContent) {
                              const parsed = JSON.parse(kb.extraContent);
                              return parsed.qnaPairs && Array.isArray(parsed.qnaPairs) && parsed.qnaPairs.length > 0;
                            }
                          } catch (e) {}
                          return false;
                        });

                        // Filter to only show books that are attached to the current agent
                        const attachedQnaBooks = qnaBooks.filter(kb => selectedQnaBookIds.includes(kb.id));

                        if (attachedQnaBooks.length === 0) {
                          return (
                            <div style={{
                              padding: '24px',
                              background: '#F9FAFB',
                              border: '1px solid #E5E7EB',
                              borderRadius: '8px',
                              textAlign: 'center',
                              color: '#6b7280',
                              fontSize: '14px'
                            }}>
                              No QnA books attached to this agent. Create one above or attach from the Script tab.
                            </div>
                          );
                        }

                        return (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            {attachedQnaBooks.map((kb) => {
                              let qnaPairs = [];
                              try {
                                if (kb.extraContent) {
                                  const parsed = JSON.parse(kb.extraContent);
                                  qnaPairs = parsed.qnaPairs || [];
                                }
                              } catch (e) {}

                              return (
                                <div
                                  key={kb.id}
                                  style={{
                                    padding: '16px',
                                    background: '#FFFFFF',
                                    border: '1px solid #E5E7EB',
                                    borderRadius: '8px',
                                    transition: 'all 0.2s ease'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.borderColor = '#4B5CFF';
                                    e.currentTarget.style.boxShadow = '0 1px 3px rgba(75, 92, 255, 0.1)';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.borderColor = '#E5E7EB';
                                    e.currentTarget.style.boxShadow = 'none';
                                  }}
                                >
                                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                                    <div>
                                      <h6 style={{ fontSize: '15px', fontWeight: '600', color: '#111827', margin: '0 0 4px 0' }}>
                                        {kb.name}
                                      </h6>
                                      {kb.description && (
                                        <p style={{ fontSize: '13px', color: '#6b7280', margin: 0 }}>
                                          {kb.description}
                                        </p>
                                      )}
                                    </div>
                                    <button
                                      type="button"
                                      onClick={() => {
                                        setShowReplyQualityForm(true);
                                        setEditingReplyQualityId(kb.id);
                                        try {
                                          const parsed = kb.extraContent ? JSON.parse(kb.extraContent) : {};
                                          setReplyQualityFormData({
                                            name: kb.name || '',
                                            description: kb.description || '',
                                            qnaPairs: parsed.qnaPairs || [{ question: '', answer: '' }]
                                          });
                                        } catch (e) {
                                          setReplyQualityFormData({
                                            name: kb.name || '',
                                            description: kb.description || '',
                                            qnaPairs: [{ question: '', answer: '' }]
                                          });
                                        }
                                      }}
                                      style={{
                                        padding: '6px 12px',
                                        background: '#F3F4F6',
                                        color: '#374151',
                                        border: '1px solid #D1D5DB',
                                        borderRadius: '6px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s ease'
                                      }}
                                      onMouseEnter={(e) => {
                                        e.currentTarget.style.background = '#E5E7EB';
                                      }}
                                      onMouseLeave={(e) => {
                                        e.currentTarget.style.background = '#F3F4F6';
                                      }}
                                    >
                                      Edit
                                    </button>
                                  </div>
                                  <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid #E5E7EB' }}>
                                    <div style={{ fontSize: '12px', fontWeight: '600', color: '#6b7280', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                      Q&A Pairs ({qnaPairs.length})
                                    </div>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '200px', overflowY: 'auto' }}>
                                      {qnaPairs.slice(0, 3).map((pair, idx) => (
                                        <div
                                          key={idx}
                                          style={{
                                            padding: '10px',
                                            background: '#F9FAFB',
                                            borderRadius: '6px',
                                            fontSize: '13px'
                                          }}
                                        >
                                          <div style={{ fontWeight: '600', color: '#111827', marginBottom: '4px' }}>
                                            Q: {pair.question || '(No question)'}
                                          </div>
                                          <div style={{ color: '#6b7280' }}>
                                            A: {pair.answer || '(No answer)'}
                                          </div>
                                        </div>
                                      ))}
                                      {qnaPairs.length > 3 && (
                                        <div style={{ fontSize: '12px', color: '#6b7280', fontStyle: 'italic', padding: '8px' }}>
                                          + {qnaPairs.length - 3} more pair{qnaPairs.length - 3 !== 1 ? 's' : ''}
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        );
                      })()}
                    </div>
                  )}

                  </div>
              </div>
            )}

            {/* Results Tab Content */}
            {activeTab === 'results' && (
              <div className="tab-content">
                <div className="form-section">
                  <h4>Call Results</h4>
                  
                  <div className="form-group">
                    <label htmlFor="successMetric">Describe success metric for this script</label>
                    <textarea
                      id="successMetric"
                      name="successMetric"
                      value={safeFormData?.successMetric || ''}
                      onChange={handleFormChange}
                      placeholder="Define what constitutes a successful call for this script..."
                      style={{ minHeight: '120px' }}
                    />
            </div>
                    </div>
                            </div>
                          )}

            {/* HIDDEN: Top queries Tab Content - See HIDDEN_FEATURES.md for details */}
            {/* {activeTab === 'suggestions' && (
              <div className="tab-content">
                <div className="form-section">
                  <h4>Top queries spoken by customer</h4>
                  
                    <div>
                        <div style={{ padding: '20px', background: '#ffffff', borderRadius: '8px', border: '1px solid #e5e7eb' }}>
                        <div style={{ fontSize: '14px', color: '#6b7280', fontWeight: '500' }}>
                          {agentStats[currentAgentId]?.topQueries && agentStats[currentAgentId].topQueries.length > 0 ? (
                            <ul style={{ margin: 0, paddingLeft: '20px' }}>
                              {agentStats[currentAgentId].topQueries.map((query, idx) => (
                                <li key={idx} style={{ marginBottom: '8px' }}>{query}</li>
                              ))}
                            </ul>
                          ) : (
                            <p style={{ margin: 0 }}>No queries recorded yet. Top customer queries will appear here as conversations are analyzed.</p>
                          )}
                        </div>
                      </div>
                    </div>
                        </div>
              </div>
            )} */}

            {/* Transcript Analytics Tab Content */}
            {activeTab === 'transcript-analytics' && (
              <div className="tab-content">
                <div style={{ padding: '24px', maxWidth: '1400px', margin: '0 auto' }}>
                  <div style={{ marginBottom: '24px' }}>
                    <h3 style={{ fontSize: '20px', fontWeight: '600', color: '#111827', marginBottom: '8px' }}>
                      Transcript Analytics
                    </h3>
                    <p style={{ fontSize: '14px', color: '#6b7280' }}>
                      Analyze dropoff rates by turn and duration across your call transcripts
                    </p>
                  </div>

                  {/* Controls */}
                  <div style={{
                    display: 'flex',
                    gap: '16px',
                    marginBottom: '24px',
                    alignItems: 'center',
                    padding: '20px',
                    background: '#f9fafb',
                    borderRadius: '12px',
                    border: '1px solid #e5e7eb'
                  }}>
                    <div style={{ flex: 1 }}>
                      <label style={{ fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px', display: 'block' }}>
                        Number of Calls to Analyze
                      </label>
                      <input
                        type="number"
                        value={analyticsLimit}
                        onChange={(e) => setAnalyticsLimit(parseInt(e.target.value) || 100)}
                        min="10"
                        max="1000"
                        step="10"
                        style={{
                          width: '100%',
                          padding: '10px 14px',
                          border: '1px solid #d1d5db',
                          borderRadius: '8px',
                          fontSize: '14px'
                        }}
                      />
                      {analyticsData && (
                        <div style={{ marginTop: '6px', fontSize: '13px', color: '#6b7280' }}>
                          Total Lifetime: <strong>{analyticsData.totalLifetime}</strong> transcripts
                        </div>
                      )}
                    </div>
                    <div style={{ paddingTop: '28px' }}>
                      <button
                        onClick={loadAnalyticsData}
                        disabled={analyticsLoading}
                        style={{
                          padding: '12px 32px',
                          background: analyticsLoading ? '#e5e7eb' : '#4B5CFF',
                          color: analyticsLoading ? '#9ca3af' : '#ffffff',
                          border: 'none',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontWeight: '600',
                          cursor: analyticsLoading ? 'not-allowed' : 'pointer',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                          if (!analyticsLoading) e.currentTarget.style.background = '#3d4ecc';
                        }}
                        onMouseLeave={(e) => {
                          if (!analyticsLoading) e.currentTarget.style.background = '#4B5CFF';
                        }}
                      >
                        {analyticsLoading ? 'Processing...' : 'Analyze Transcripts'}
                      </button>
                    </div>
                  </div>

                  {/* Error */}
                  {analyticsError && (
                    <div style={{
                      padding: '16px',
                      background: '#fef2f2',
                      border: '1px solid #fecaca',
                      borderRadius: '8px',
                      color: '#dc2626',
                      fontSize: '14px',
                      marginBottom: '24px'
                    }}>
                      âš ï¸ {analyticsError}
                    </div>
                  )}

                  {/* Loading State */}
                  {analyticsLoading && (
                    <div style={{
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      justifyContent: 'center',
                      padding: '80px 20px',
                      fontSize: '14px',
                      color: '#6b7280'
                    }}>
                      <div style={{ 
                        width: '40px', 
                        height: '40px', 
                        border: '3px solid #e5e7eb',
                        borderTopColor: '#4B5CFF',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite',
                        marginBottom: '16px'
                      }} />
                      Processing {analyticsLimit} call transcripts...
                    </div>
                  )}

                  {/* Results */}
                  {!analyticsLoading && analyticsData && (
                    <>
                      {/* Statistics Cards */}
                      <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
                        gap: '20px',
                        marginBottom: '40px'
                      }}>
                        <div style={{
                          padding: '24px',
                          background: '#ffffff',
                          borderRadius: '12px',
                          border: '1px solid #e5e7eb',
                          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)'
                        }}>
                          <div style={{ fontSize: '13px', color: '#6b7280', marginBottom: '8px', fontWeight: '500' }}>
                            ðŸ“ž Calls Analyzed
                          </div>
                          <div style={{ fontSize: '32px', fontWeight: '700', color: '#111827' }}>
                            {analyticsData.totalAnalyzed}
                          </div>
                        </div>
                        <div style={{
                          padding: '24px',
                          background: '#ffffff',
                          borderRadius: '12px',
                          border: '1px solid #e5e7eb',
                          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)'
                        }}>
                          <div style={{ fontSize: '13px', color: '#6b7280', marginBottom: '8px', fontWeight: '500' }}>
                            ðŸ”„ Average Turns
                          </div>
                          <div style={{ fontSize: '32px', fontWeight: '700', color: '#111827' }}>
                            {analyticsData.statistics.avgTurns}
                          </div>
                        </div>
                        <div style={{
                          padding: '24px',
                          background: '#ffffff',
                          borderRadius: '12px',
                          border: '1px solid #e5e7eb',
                          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)'
                        }}>
                          <div style={{ fontSize: '13px', color: '#6b7280', marginBottom: '8px', fontWeight: '500' }}>
                            â±ï¸ Average Duration
                          </div>
                          <div style={{ fontSize: '32px', fontWeight: '700', color: '#111827' }}>
                            {analyticsData.statistics.avgDuration}s
                          </div>
                        </div>
                      </div>

                      {/* Graphs Container */}
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr', gap: '32px' }}>
                        {/* Dropoff by Turn Graph */}
                        <div style={{
                          padding: '28px',
                          background: '#ffffff',
                          borderRadius: '12px',
                          border: '1px solid #e5e7eb',
                          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)'
                        }}>
                          <h4 style={{ fontSize: '18px', fontWeight: '600', color: '#111827', marginBottom: '20px' }}>
                            ðŸ“‰ Dropoff Rate by Turn
                          </h4>
                          <canvas
                            ref={turnChartRef}
                            style={{ maxHeight: '400px' }}
                          />
                        </div>

                        {/* Dropoff by Second Graph */}
                        <div style={{
                          padding: '28px',
                          background: '#ffffff',
                          borderRadius: '12px',
                          border: '1px solid #e5e7eb',
                          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)'
                        }}>
                          <h4 style={{ fontSize: '18px', fontWeight: '600', color: '#111827', marginBottom: '20px' }}>
                            â±ï¸ Dropoff Rate by Duration
                          </h4>
                          <canvas
                            ref={secondChartRef}
                            style={{ maxHeight: '400px' }}
                          />
                        </div>
                      </div>
                    </>
                  )}

                  {/* Empty State */}
                  {!analyticsLoading && !analyticsData && !analyticsError && (
                    <div style={{
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      justifyContent: 'center',
                      padding: '80px 20px',
                      textAlign: 'center'
                    }}>
                      <img 
                        src="/images/Raycons Icons Pack (Community)/chart-8535829.svg" 
                        alt="Analytics" 
                        style={{ 
                          width: '48px', 
                          height: '48px', 
                          marginBottom: '16px',
                          opacity: 0.6
                        }} 
                      />
                      <div style={{ fontSize: '18px', fontWeight: '600', color: '#111827', marginBottom: '8px' }}>
                        Ready to Analyze
                      </div>
                      <div style={{ fontSize: '14px', color: '#6b7280', maxWidth: '400px' }}>
                        Set the number of calls you want to analyze and click "Analyze Transcripts" to see dropoff rates by turn and duration.
                      </div>
                    </div>
                  )}
                        </div>
              </div>
            )}


            {activeTab === 'versions' && (
              <div className="tab-content">
                <div className="form-section">
                  <div style={{ marginBottom: '16px' }}>
                    <h3 style={{ margin: 0, fontSize: '16px', fontWeight: '600', color: '#111827' }}>
                      Version History
                    </h3>
                    <p style={{ margin: '4px 0 0 0', fontSize: '13px', color: '#6b7280' }}>
                      View and restore previous versions of this agent
                    </p>
                  </div>

                  {/* Versions List */}
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {loadingVersions ? (
                      <div style={{ textAlign: 'center', padding: '20px', color: '#6b7280' }}>
                        Loading versions...
                      </div>
                    ) : !scriptVersions || scriptVersions.length === 0 ? (
                      <div style={{ textAlign: 'center', padding: '20px', color: '#6b7280' }}>
                        No versions yet. Save your agent to create the first version.
                      </div>
                    ) : (
                      scriptVersions.map((version, index) => (
                      <div
                        key={version.id}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          padding: '12px 16px',
                          background: 'white',
                          border: '1px solid #e5e7eb',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          transition: 'all 0.2s',
                        }}
                        onClick={() => handleVersionClick(version)}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.borderColor = '#d1d5db';
                          e.currentTarget.style.background = '#f9fafb';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.borderColor = '#e5e7eb';
                          e.currentTarget.style.background = 'white';
                        }}
                      >
                        <div style={{ flex: 1 }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                            <span style={{
                              fontSize: '14px',
                              fontWeight: '500',
                              color: '#111827'
                            }}>
                              {version.versionName}
                            </span>
                            {index === 0 && (
                              <span style={{
                                padding: '2px 8px',
                                background: '#dbeafe',
                                color: '#1e40af',
                                fontSize: '11px',
                                fontWeight: '600',
                                borderRadius: '4px'
                              }}>
                                Current
                              </span>
                            )}
                          </div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth="2">
                              <circle cx="12" cy="12" r="10" />
                              <polyline points="12 6 12 12 16 14" />
                            </svg>
                            <span style={{ fontSize: '12px', color: '#6b7280' }}>
                              {new Date(version.createdAt).toLocaleString()}
                            </span>
                          </div>
                        </div>

                        {/* Revert Button */}
                        {index !== 0 && (
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              handleRevertVersion(version.id);
                            }}
                            style={{
                              padding: '6px 12px',
                              background: 'white',
                              border: '1px solid #e5e7eb',
                              borderRadius: '6px',
                              fontSize: '12px',
                              fontWeight: '500',
                              color: '#374151',
                              cursor: 'pointer',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '4px',
                              transition: 'all 0.2s'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.background = '#f9fafb';
                              e.currentTarget.style.borderColor = '#4B5CFF';
                              e.currentTarget.style.color = '#4B5CFF';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.background = 'white';
                              e.currentTarget.style.borderColor = '#e5e7eb';
                              e.currentTarget.style.color = '#374151';
                            }}
                          >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <polyline points="1 4 1 10 7 10" />
                              <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
                            </svg>
                            Revert
                          </button>
                        )}
                      </div>
                    ))
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* HIDDEN: Run Simulation Tab Content - See HIDDEN_FEATURES.md for details */}
            {false && activeTab === 'evaluate' && (
              <div className="form-section" style={{ padding: '24px', marginBottom: 0, maxHeight: 'none', borderRadius: 0, border: '0px solid transparent', display: 'grid', gridTemplateColumns: '3fr 1fr', gap: '24px', height: 'calc(100vh - 131px)' }}>
                {/* Box 1: Left side (3 columns) */}
                <div style={{ display: 'flex', flexDirection: 'column', overflowY: 'auto', gap: '24px' }}>
                  {/* Run Simulation Button */}
                  <div style={{ 
                    padding: '24px', 
                    background: '#ffffff', 
                    borderRadius: '12px', 
                    border: '1.5px solid #e5e7eb',
                    boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)'
                  }}>
                    <h4 style={{ fontSize: '20px', fontWeight: '600', color: '#111827', marginBottom: '8px' }}>Run Simulation</h4>
                    <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '20px', lineHeight: '1.6' }}>
                    Run thousands of simulations in minutes. Test your script against various customer scenarios and personalities. The system will simulate conversations and score them out of 10.
                  </p>
                    <button
                      type="button"
                      onClick={async () => {
                        if (!formData.content) {
                          alert('Please add script content first');
                          return;
                        }
                        setIsRunningEvaluation(true);
                        setEvaluationResults(null);
                        try {
                          const result = await api.runEvaluation({
                            scriptContent: formData.content,
                            variables: evaluationVariables,
                            extractorPrompt: extractorPrompt || null,
                            evaluatorPrompt: evaluatorPrompt || null,
                            testCasePrompt: testCasePrompt || null,
                            scenario: scenario || null,
                            personalityPrompts: personalityPrompts || null,
                            testCaseIds: selectedTestCases.length > 0 ? selectedTestCases : null,
                            maxPersonalitiesPerCase: 2,
                            languages: ['english', 'hindi']
                          });
                          if (result.success) {
                            setEvaluationResults(result.results);
                          }
                        } catch (error) {
                          console.error('Error running simulation:', error);
                          alert('Error running simulation: ' + error.message);
                        } finally {
                          setIsRunningEvaluation(false);
                        }
                      }}
                      disabled={isRunningEvaluation || !formData.content}
                      style={{
                        padding: '10px 20px',
                        background: isRunningEvaluation || !formData.content ? '#d1d5db' : '#4B5CFF',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: isRunningEvaluation || !formData.content ? 'not-allowed' : 'pointer',
                        transition: 'all 0.2s ease',
                        boxShadow: isRunningEvaluation || !formData.content ? 'none' : '0 1px 2px rgba(75, 92, 255, 0.2)'
                      }}
                      onMouseEnter={(e) => {
                        if (!isRunningEvaluation && formData.content) {
                          e.currentTarget.style.background = '#3b4ae6';
                          e.currentTarget.style.boxShadow = '0 2px 4px rgba(75, 92, 255, 0.3)';
                        }
                      }}
                      onMouseLeave={(e) => {
                        if (!isRunningEvaluation && formData.content) {
                          e.currentTarget.style.background = '#4B5CFF';
                          e.currentTarget.style.boxShadow = '0 1px 2px rgba(75, 92, 255, 0.2)';
                        }
                      }}
                    >
                      {isRunningEvaluation ? 'Running Simulation...' : 'Run Simulation'}
                    </button>
                  </div>

                  {/* Template Variables Section */}
                  <div style={{ 
                    padding: '24px', 
                    background: '#ffffff', 
                    borderRadius: '12px', 
                    border: '1.5px solid #e5e7eb',
                    boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)'
                  }}>
                    <h5 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '8px', color: '#111827' }}>
                      Template Variables
                    </h5>
                    <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '20px', lineHeight: '1.6' }}>
                      Set values for template variables used in the script (e.g., {'{customer_name}'}, {'{order_number}'}).
                    </p>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px' }}>
                      {Object.entries(evaluationVariables).map(([key, value]) => (
                        <div key={key}>
                          <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                            {key.replace(/_/g, ' ')}
                          </label>
                          <input
                            type="text"
                            value={value}
                            onChange={(e) => setEvaluationVariables({ ...evaluationVariables, [key]: e.target.value })}
                            style={{
                              width: '100%',
                              padding: '10px 12px',
                              border: '1px solid #d1d5db',
                              borderRadius: '8px',
                              fontSize: '14px',
                              fontFamily: 'inherit',
                              transition: 'all 0.2s ease',
                              background: '#ffffff'
                            }}
                            onFocus={(e) => {
                              e.currentTarget.style.borderColor = '#4B5CFF';
                              e.currentTarget.style.boxShadow = '0 0 0 3px rgba(75, 92, 255, 0.1)';
                            }}
                            onBlur={(e) => {
                              e.currentTarget.style.borderColor = '#d1d5db';
                              e.currentTarget.style.boxShadow = 'none';
                            }}
                          />
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Simulation Results Section */}
                  {evaluationResults && (
                    <div>
                      <h5 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '20px', color: '#111827' }}>
                        Simulation Results
                      </h5>
                      <div style={{ 
                        padding: '24px', 
                        background: '#ffffff', 
                        borderRadius: '12px', 
                        border: '1.5px solid #e5e7eb',
                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)',
                        marginBottom: '24px'
                      }}>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '20px' }}>
                          <div style={{ padding: '16px', background: '#f9fafb', borderRadius: '8px', border: '1px solid #e5e7eb' }}>
                            <div style={{ fontSize: '12px', color: '#6b7280', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Total Simulations</div>
                            <div style={{ fontSize: '28px', fontWeight: '700', color: '#111827' }}>
                              {evaluationResults.summary.totalTests}
                            </div>
                          </div>
                          <div style={{ padding: '16px', background: '#f9fafb', borderRadius: '8px', border: '1px solid #e5e7eb' }}>
                            <div style={{ fontSize: '12px', color: '#6b7280', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Average Score</div>
                            <div style={{ fontSize: '28px', fontWeight: '700', color: '#111827' }}>
                              {(evaluationResults.summary.averageScore ?? 0).toFixed(2)}/10
                            </div>
                          </div>
                          <div style={{ padding: '16px', background: '#ecfdf5', borderRadius: '8px', border: '1px solid #a7f3d0' }}>
                            <div style={{ fontSize: '12px', color: '#065f46', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Passed ({'â‰¥7'})</div>
                            <div style={{ fontSize: '28px', fontWeight: '700', color: '#10b981' }}>
                              {evaluationResults.summary.passed}
                            </div>
                          </div>
                          <div style={{ padding: '16px', background: '#fef2f2', borderRadius: '8px', border: '1px solid #fecaca' }}>
                            <div style={{ fontSize: '12px', color: '#991b1b', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Failed ({'<7'})</div>
                            <div style={{ fontSize: '28px', fontWeight: '700', color: '#ef4444' }}>
                              {evaluationResults.summary.failed}
                            </div>
                          </div>
                        </div>
                      </div>

                      <div style={{ maxHeight: '600px', overflowY: 'auto', paddingRight: '4px' }}>
                        {evaluationResults.testResults.map((result, index) => (
                          <div
                            key={index}
                            style={{
                              marginBottom: '20px',
                              padding: '20px',
                              background: '#ffffff',
                              borderRadius: '12px',
                              border: '1.5px solid #e5e7eb',
                              boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)',
                              transition: 'all 0.2s ease'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.borderColor = '#d1d5db';
                              e.currentTarget.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.08)';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.borderColor = '#e5e7eb';
                              e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.05)';
                            }}
                          >
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', paddingBottom: '12px', borderBottom: '1px solid #e5e7eb' }}>
                              <div>
                                <div style={{ fontWeight: '600', fontSize: '16px', color: '#111827', marginBottom: '4px' }}>
                                  {result.testCaseName}
                                </div>
                                <div style={{ fontSize: '13px', color: '#6b7280' }}>
                                  {result.personality} â€¢ {result.language}
                                </div>
                              </div>
                              <div style={{
                                padding: '6px 14px',
                                borderRadius: '8px',
                                background: result.passed ? '#d1fae5' : '#fee2e2',
                                color: result.passed ? '#065f46' : '#991b1b',
                                fontSize: '14px',
                                fontWeight: '600',
                                border: `1px solid ${result.passed ? '#a7f3d0' : '#fecaca'}`
                              }}>
                                {((result.score ?? result.evaluation?.overallScore) ?? 0).toFixed(2)}/10 {result.passed ? 'âœ“' : 'âœ—'}
                              </div>
                            </div>

                            {result.error ? (
                              <div style={{ padding: '12px', background: '#fef2f2', borderRadius: '8px', border: '1px solid #fecaca', color: '#991b1b', fontSize: '14px' }}>
                                <strong>Error:</strong> {result.error}
                              </div>
                            ) : (
                              <>
                                {result.evaluation.feedback && (
                                  <div style={{ marginBottom: '16px' }}>
                                    {result.evaluation.feedback.strengths && result.evaluation.feedback.strengths.length > 0 && (
                                      <div style={{ marginBottom: '12px', padding: '12px', background: '#ecfdf5', borderRadius: '8px', border: '1px solid #a7f3d0' }}>
                                        <div style={{ fontSize: '13px', fontWeight: '600', color: '#065f46', marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                          <span>âœ“</span> Strengths
                                        </div>
                                        <ul style={{ margin: 0, paddingLeft: '20px', fontSize: '14px', color: '#374151', lineHeight: '1.6' }}>
                                          {result.evaluation.feedback.strengths.map((s, i) => (
                                            <li key={i} style={{ marginBottom: '4px' }}>{s}</li>
                                          ))}
                                        </ul>
                                      </div>
                                    )}
                                    {result.evaluation.feedback.weaknesses && result.evaluation.feedback.weaknesses.length > 0 && (
                                      <div style={{ marginBottom: '12px', padding: '12px', background: '#fef2f2', borderRadius: '8px', border: '1px solid #fecaca' }}>
                                        <div style={{ fontSize: '13px', fontWeight: '600', color: '#991b1b', marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                          <span>âš </span> Weaknesses
                                        </div>
                                        <ul style={{ margin: 0, paddingLeft: '20px', fontSize: '14px', color: '#374151', lineHeight: '1.6' }}>
                                          {result.evaluation.feedback.weaknesses.map((w, i) => (
                                            <li key={i} style={{ marginBottom: '4px' }}>{w}</li>
                                          ))}
                                        </ul>
                                      </div>
                                    )}
                                  </div>
                                )}

                                <details style={{ marginTop: '12px' }}>
                                  <summary style={{ 
                                    cursor: 'pointer', 
                                    fontSize: '14px', 
                                    fontWeight: '500', 
                                    color: '#4B5CFF',
                                    padding: '8px 12px',
                                    background: '#f9fafb',
                                    borderRadius: '8px',
                                    border: '1px solid #e5e7eb',
                                    listStyle: 'none',
                                    transition: 'all 0.2s ease'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.background = '#f3f4f6';
                                    e.currentTarget.style.borderColor = '#d1d5db';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.background = '#f9fafb';
                                    e.currentTarget.style.borderColor = '#e5e7eb';
                                  }}
                                  >
                                    View Conversation Transcript
                                  </summary>
                                  <div style={{ marginTop: '12px', padding: '16px', background: '#f9fafb', borderRadius: '8px', border: '1px solid #e5e7eb', fontSize: '14px', lineHeight: '1.6' }}>
                                    {result.conversation.map((msg, i) => (
                                      <div key={i} style={{ marginBottom: '12px', paddingBottom: '12px', borderBottom: i < result.conversation.length - 1 ? '1px solid #e5e7eb' : 'none' }}>
                                        <span style={{ 
                                          fontWeight: '600', 
                                          color: msg.role === 'agent' ? '#4B5CFF' : '#10b981',
                                          display: 'inline-block',
                                          minWidth: '60px',
                                          fontSize: '12px',
                                          textTransform: 'uppercase',
                                          letterSpacing: '0.5px'
                                        }}>
                                          {msg.role}:
                                        </span>
                                        <span style={{ marginLeft: '12px', color: '#374151' }}>{msg.text}</span>
                                      </div>
                                    ))}
                                  </div>
                                </details>
                              </>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                {/* Box 2: Right side (1 column) */}
                <div style={{ display: 'flex', flexDirection: 'column', overflowY: 'auto', gap: '24px' }}>
                  {/* Scenario Section */}
                  <div style={{ 
                    padding: '24px', 
                    background: '#ffffff', 
                    borderRadius: '12px', 
                    border: '1.5px solid #e5e7eb',
                    boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)'
                  }}>
                    <h5 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '8px', color: '#111827' }}>
                      Scenario
                    </h5>
                    <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '16px', lineHeight: '1.6' }}>
                      The scenario that applies to all test cases. This describes the context of the call.
                    </p>
                    <textarea
                      value={scenario}
                      onChange={(e) => setScenario(e.target.value)}
                      placeholder="Enter scenario..."
                      style={{
                        width: '100%',
                        minHeight: '100px',
                        padding: '12px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontFamily: 'inherit',
                        resize: 'vertical',
                        transition: 'all 0.2s ease',
                        background: '#ffffff',
                        lineHeight: '1.6'
                      }}
                      onFocus={(e) => {
                        e.currentTarget.style.borderColor = '#4B5CFF';
                        e.currentTarget.style.boxShadow = '0 0 0 3px rgba(75, 92, 255, 0.1)';
                      }}
                      onBlur={(e) => {
                        e.currentTarget.style.borderColor = '#d1d5db';
                        e.currentTarget.style.boxShadow = 'none';
                      }}
                    />
                    <button
                      type="button"
                      onClick={async () => {
                        try {
                          const res = await api.getEvaluationDefaultPrompts();
                          if (res.success && res.scenario) {
                            setScenario(res.scenario);
                          }
                        } catch (error) {
                          console.error('Error loading default scenario:', error);
                        }
                      }}
                      style={{
                        marginTop: '12px',
                        padding: '8px 16px',
                        background: '#f3f4f6',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '13px',
                        fontWeight: '500',
                        color: '#374151',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.background = '#e5e7eb';
                        e.currentTarget.style.borderColor = '#9ca3af';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.background = '#f3f4f6';
                        e.currentTarget.style.borderColor = '#d1d5db';
                      }}
                    >
                      Reset to Default
                    </button>
                  </div>

                  {/* Select Scenarios Section */}
                  <div style={{ 
                    padding: '24px', 
                    background: '#ffffff', 
                    borderRadius: '12px', 
                    border: '1.5px solid #e5e7eb',
                    boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)'
                  }}>
                    <h5 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '8px', color: '#111827' }}>
                      Select Scenarios
                    </h5>
                    <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '16px', lineHeight: '1.6' }}>
                      Select which scenarios to simulate. Each scenario includes multiple personalities and languages.
                    </p>
                    <div style={{ 
                      maxHeight: '400px', 
                      overflowY: 'auto', 
                      border: '1px solid #e5e7eb', 
                      borderRadius: '8px', 
                      padding: '8px',
                      background: '#f9fafb'
                    }}>
                      {testCases.map(tc => (
                        <label
                          key={tc.id}
                          style={{
                            display: 'flex',
                            alignItems: 'center',
                            padding: '12px',
                            cursor: 'pointer',
                            borderRadius: '8px',
                            marginBottom: '4px',
                            transition: 'all 0.2s ease',
                            background: selectedTestCases.includes(tc.id) ? '#eff6ff' : '#ffffff',
                            border: selectedTestCases.includes(tc.id) ? '1px solid #4B5CFF' : '1px solid transparent'
                          }}
                          onMouseEnter={(e) => {
                            if (!selectedTestCases.includes(tc.id)) {
                              e.currentTarget.style.background = '#f9fafb';
                            }
                          }}
                          onMouseLeave={(e) => {
                            if (!selectedTestCases.includes(tc.id)) {
                              e.currentTarget.style.background = '#ffffff';
                            }
                          }}
                        >
                          <input
                            type="checkbox"
                            checked={selectedTestCases.includes(tc.id)}
                            onChange={(e) => {
                              if (e.target.checked) {
                                setSelectedTestCases([...selectedTestCases, tc.id]);
                              } else {
                                setSelectedTestCases(selectedTestCases.filter(id => id !== tc.id));
                              }
                            }}
                            style={{ marginRight: '8px' }}
                          />
                          <div>
                            <div style={{ fontWeight: '500', fontSize: '14px' }}>{tc.name}</div>
                            <div style={{ fontSize: '12px', color: '#6b7280' }}>
                              {tc.personality ? `${tc.personality.charAt(0).toUpperCase() + tc.personality.slice(1)} â€¢ ${tc.language ? tc.language.charAt(0).toUpperCase() + tc.language.slice(1) : ''}` : (tc.baseScenario || 'Test Case')}
                            </div>
                          </div>
                        </label>
                      ))}
                    </div>
                  </div>

                  {/* Simulation Script Section */}
                  <div>
                    <h5 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '12px', color: '#111827' }}>
                      Simulation Script
                    </h5>
                    <p style={{ fontSize: '13px', color: '#6b7280', marginBottom: '16px' }}>
                      Customize the prompts used for extracting rules and simulating conversations.
                    </p>

                    <div style={{ marginBottom: '20px' }}>
                      <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                        Extractor Prompt
                      </label>
                      <textarea
                        value={extractorPrompt}
                        onChange={(e) => setExtractorPrompt(e.target.value)}
                        placeholder="Enter extractor prompt..."
                        style={{
                          width: '100%',
                          minHeight: '200px',
                          padding: '12px',
                          border: '1px solid #d1d5db',
                          borderRadius: '8px',
                          fontSize: '13px',
                          fontFamily: 'monospace',
                          resize: 'vertical'
                        }}
                      />
                      <button
                        type="button"
                        onClick={async () => {
                          try {
                            const res = await api.getEvaluationDefaultPrompts();
                            if (res.success) {
                              setExtractorPrompt(res.extractorPrompt);
                            }
                          } catch (error) {
                            console.error('Error loading default extractor prompt:', error);
                          }
                        }}
                        style={{
                          marginTop: '8px',
                          padding: '6px 12px',
                          background: '#f3f4f6',
                          border: '1px solid #d1d5db',
                          borderRadius: '6px',
                          fontSize: '12px',
                          cursor: 'pointer'
                        }}
                      >
                        Reset to Default
                      </button>
                    </div>

                    <div>
                      <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                        Simulator Prompt
                      </label>
                      <textarea
                        value={evaluatorPrompt}
                        onChange={(e) => setEvaluatorPrompt(e.target.value)}
                        placeholder="Enter evaluator prompt..."
                        style={{
                          width: '100%',
                          minHeight: '200px',
                          padding: '12px',
                          border: '1px solid #d1d5db',
                          borderRadius: '8px',
                          fontSize: '13px',
                          fontFamily: 'monospace',
                          resize: 'vertical'
                        }}
                      />
                      <button
                        type="button"
                        onClick={async () => {
                          try {
                            const res = await api.getEvaluationDefaultPrompts();
                            if (res.success) {
                              setEvaluatorPrompt(res.evaluatorPrompt);
                            }
                          } catch (error) {
                            console.error('Error loading default simulator prompt:', error);
                          }
                        }}
                        style={{
                          marginTop: '8px',
                          padding: '6px 12px',
                          background: '#f3f4f6',
                          border: '1px solid #d1d5db',
                          borderRadius: '6px',
                          fontSize: '12px',
                          cursor: 'pointer'
                        }}
                      >
                        Reset to Default
                      </button>
                  </div>

                    <div>
                      <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                        Test Case Prompt
                      </label>
                      <textarea
                        value={testCasePrompt}
                        onChange={(e) => setTestCasePrompt(e.target.value)}
                        placeholder="Enter test case prompt..."
                        style={{
                          width: '100%',
                          minHeight: '200px',
                          padding: '12px',
                          border: '1px solid #d1d5db',
                      borderRadius: '8px', 
                          fontSize: '13px',
                          fontFamily: 'monospace',
                          resize: 'vertical'
                        }}
                      />
                      <button
                        type="button"
                        onClick={async () => {
                          try {
                            const res = await api.getEvaluationDefaultPrompts();
                            if (res.success) {
                              setTestCasePrompt(res.testCasePrompt);
                            }
                          } catch (error) {
                            console.error('Error loading default test case prompt:', error);
                          }
                        }}
                          style={{
                          marginTop: '8px',
                          padding: '6px 12px',
                          background: '#f3f4f6',
                          border: '1px solid #d1d5db',
                            borderRadius: '6px',
                          fontSize: '12px',
                          cursor: 'pointer'
                        }}
                      >
                        Reset to Default
                      </button>
                    </div>
                  </div>

                  {/* Personality Prompts Section */}
                  <div>
                    <h5 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '12px', color: '#111827' }}>
                      Personality Prompts
                    </h5>
                    <p style={{ fontSize: '13px', color: '#6b7280', marginBottom: '16px' }}>
                      Define how each personality type behaves. These prompts describe the customer's behavior and response style.
                    </p>
                    {Object.entries(personalityPrompts).map(([personality, prompt]) => (
                      <div key={personality} style={{ marginBottom: '16px' }}>
                        <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151', textTransform: 'capitalize' }}>
                          {personality}
                          </label>
                        <textarea
                          value={prompt}
                          onChange={(e) => setPersonalityPrompts({ ...personalityPrompts, [personality]: e.target.value })}
                          placeholder={`Enter ${personality} personality prompt...`}
                            style={{
                              width: '100%',
                            minHeight: '100px',
                            padding: '12px',
                              border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '13px',
                            fontFamily: 'monospace',
                            resize: 'vertical'
                            }}
                          />
                        </div>
                      ))}
                    <button
                      type="button"
                      onClick={async () => {
                        try {
                          const res = await api.getEvaluationDefaultPrompts();
                          if (res.success && res.personalityPrompts) {
                            setPersonalityPrompts(res.personalityPrompts);
                          }
                        } catch (error) {
                          console.error('Error loading default personality prompts:', error);
                        }
                      }}
                      style={{
                        marginTop: '8px',
                        padding: '6px 12px',
                        background: '#f3f4f6',
                        border: '1px solid #d1d5db',
                        borderRadius: '6px',
                        fontSize: '12px',
                        cursor: 'pointer'
                      }}
                    >
                      Reset All to Default
                    </button>
                  </div>
                            </div>
        </div>
                                )}


      {/* Knowledge Book Form */}
      {showKnowledgeBookForm && (
        <div className="playground-form active">
          <div style={{ marginBottom: '20px' }}>
            <button
              type="button"
              onClick={handleBackToList}
              style={{
                background: 'none',
                border: '1px solid #d1d5db',
                padding: '8px 16px',
                borderRadius: '6px',
                cursor: 'pointer',
                fontSize: '14px',
              }}
            >
              â† Back to List
            </button>
          </div>
          <form onSubmit={handleKnowledgeBookSubmit}>
            <div className="form-group">
              <label htmlFor="kbName">Knowledge Book Name *</label>
              <input
                type="text"
                id="kbName"
                name="name"
                value={knowledgeBookFormData.name}
                onChange={handleKnowledgeBookFormChange}
                required
              />
            </div>

            <div className="form-group">
              <label htmlFor="kbDescription">Description (Optional)</label>
              <input
                type="text"
                id="kbDescription"
                name="description"
                value={knowledgeBookFormData.description}
                onChange={handleKnowledgeBookFormChange}
              />
            </div>

            <div className="form-group">
              <label htmlFor="kbContent">Content *</label>
              <textarea
                id="kbContent"
                name="content"
                value={knowledgeBookFormData.content}
                onChange={handleKnowledgeBookFormChange}
                required
                placeholder="Enter knowledge book content here. This will be appended to scripts that select this knowledge book."
                style={{ minHeight: '200px' }}
              />
              <div style={{ marginTop: '8px', fontSize: '12px', color: '#6d7175' }}>
                This content will be automatically appended to the end of scripts that select this knowledge book.
              </div>
            </div>

            <div className="form-group" style={{ marginTop: '24px', display: 'flex', gap: '12px' }}>
              <button type="submit" className="btn btn-primary">
                Save Knowledge Book
              </button>
              {currentKnowledgeBookId && (
                <button
                  type="button"
                  onClick={() => handleDeleteKnowledgeBook(currentKnowledgeBookId)}
                  className="btn"
                  style={{ background: '#ef4444', color: 'white' }}
                >
                  Delete
                </button>
              )}
            </div>
          </form>
        </div>
      )}

      {/* Voice Search Modal */}
      {showVoiceModal && (
        <div
          id="voiceSearchModal"
          style={{
            display: 'block',
            position: 'fixed',
            inset: '0',
            background: 'rgba(0,0,0,0.4)',
            zIndex: 9999,
          }}
          onClick={(e) => {
            if (e.target.id === 'voiceSearchModal') {
              handleCloseVoiceModal();
            }
          }}
        >
          <div
            style={{
              maxWidth: '720px',
              margin: '60px auto',
              background: '#fff',
              borderRadius: '12px',
              padding: '16px',
            }}
          >
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <h3 style={{ margin: 0 }}>Select a voice</h3>
              <button
                id="closeVoiceSearch"
                onClick={handleCloseVoiceModal}
                style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer' }}
              >
                Ã—
              </button>
            </div>
            <div style={{ display: 'flex', gap: '8px', marginBottom: '12px' }}>
              <input
                id="voiceSearchInput"
                placeholder="Search by name/language"
                value={voiceSearchQuery}
                onChange={(e) => setVoiceSearchQuery(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    handleVoiceSearch();
                  }
                }}
                style={{
                  flex: 1,
                  padding: '8px 10px',
                  border: '1px solid #d1d5db',
                  borderRadius: '8px',
                }}
              />
              <button
                id="voiceSearchBtn"
                onClick={handleVoiceSearch}
                style={{ padding: '8px 12px' }}
              >
                ðŸ”
              </button>
            </div>
            <div
              id="voiceList"
              style={{
                maxHeight: '380px',
                overflow: 'auto',
                border: '1px solid #e5e7eb',
                borderRadius: '8px',
                padding: '8px',
              }}
            >
              {/* Scalysis Voices Section */}
              {voices.filter(v => v.isScalysisVoice || v.isDefaultIndian).length > 0 && (
                <div style={{ marginBottom: '16px' }}>
                  <h4 style={{ fontSize: '14px', fontWeight: 600, marginBottom: '8px', color: '#1F2937' }}>
                    Scalysis Voices
                  </h4>
                  {voices.filter(v => v.isScalysisVoice || v.isDefaultIndian).map((voice) => (
                    <div
                      key={voice.id}
                      style={{
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        marginBottom: '8px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                      }}
                      title={voice.languages ? `It can understand ${voice.languages.join(' and ')}` : ''}
                    >
                      <div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                          <span style={{ fontSize: '16px' }}>ðŸ‡®ðŸ‡³</span>
                          <div style={{ fontWeight: '600' }}>{voice.name}</div>
                        </div>
                        <div style={{ fontSize: '12px', color: '#6b7280' }}>
                          {voice.language || 'Unknown'} | {voice.id}
                        </div>
                      </div>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <button
                          className="previewVoiceBtn"
                          onClick={(e) => handlePreviewVoice(voice.id, e.target)}
                          style={{ padding: '6px 12px', fontSize: '12px' }}
                        >
                          Preview
                        </button>
                        <button
                          className="copyVoiceBtn"
                          onClick={(e) => handleCopyVoiceId(voice.id, e.target)}
                          data-id={voice.id}
                          style={{ padding: '6px 12px', fontSize: '12px', background: '#0073e6', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                        >
                          Copy ID
                        </button>
                        <button
                          onClick={() => handleSelectVoice(voice.id)}
                          style={{
                            padding: '6px 12px',
                            fontSize: '12px',
                            background: '#10b981',
                            color: 'white',
                            border: 'none',
                            borderRadius: '4px',
                            cursor: 'pointer',
                          }}
                        >
                          Select
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* My Voices Section */}
              {voices.filter(v => v.isUserVoice && !v.isScalysisVoice).length > 0 && (
                <div style={{ marginBottom: '16px' }}>
                  <h4 style={{ fontSize: '14px', fontWeight: 600, marginBottom: '8px', color: '#1F2937' }}>
                    My Voices
                  </h4>
                  {voices.filter(v => v.isUserVoice && !v.isScalysisVoice).map((voice) => (
                    <div
                      key={voice.id}
                      style={{
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        marginBottom: '8px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                      }}
                      title={voice.languages ? `It can understand ${voice.languages.join(' and ')}` : ''}
                    >
                      <div>
                        <div style={{ fontWeight: '600', marginBottom: '4px' }}>{voice.name}</div>
                        <div style={{ fontSize: '12px', color: '#6b7280' }}>
                          {voice.language || 'Unknown'} | {voice.id}
                        </div>
                      </div>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <button
                          className="previewVoiceBtn"
                          onClick={(e) => handlePreviewVoice(voice.id, e.target)}
                          style={{ padding: '6px 12px', fontSize: '12px' }}
                        >
                          Preview
                        </button>
                        <button
                          className="copyVoiceBtn"
                          onClick={(e) => handleCopyVoiceId(voice.id, e.target)}
                          data-id={voice.id}
                          style={{ padding: '6px 12px', fontSize: '12px', background: '#0073e6', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                        >
                          Copy ID
                        </button>
                        <button
                          onClick={() => handleSelectVoice(voice.id)}
                          style={{
                            padding: '6px 12px',
                            fontSize: '12px',
                            background: '#10b981',
                            color: 'white',
                            border: 'none',
                            borderRadius: '4px',
                            cursor: 'pointer',
                          }}
                        >
                          Select
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* Other Voices Section */}
              {voices.filter(v => !v.isUserVoice && !v.isScalysisVoice).length > 0 && (
                <div>
                  <h4 style={{ fontSize: '14px', fontWeight: 600, marginBottom: '8px', color: '#1F2937' }}>
                    Other Voices
                  </h4>
                  {voices.filter(v => !v.isUserVoice && !v.isScalysisVoice).map((voice) => (
                    <div
                      key={voice.id}
                      style={{
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        marginBottom: '8px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                      }}
                      title={voice.languages ? `It can understand ${voice.languages.join(' and ')}` : ''}
                    >
                      <div>
                        <div style={{ fontWeight: '600', marginBottom: '4px' }}>{voice.name}</div>
                        <div style={{ fontSize: '12px', color: '#6b7280' }}>
                          {voice.language || 'Unknown'} | {voice.id}
                        </div>
                      </div>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <button
                          className="previewVoiceBtn"
                          onClick={(e) => handlePreviewVoice(voice.id, e.target)}
                          style={{ padding: '6px 12px', fontSize: '12px' }}
                        >
                          Preview
                        </button>
                        <button
                          className="copyVoiceBtn"
                          onClick={(e) => handleCopyVoiceId(voice.id, e.target)}
                          data-id={voice.id}
                          style={{ padding: '6px 12px', fontSize: '12px', background: '#0073e6', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
                        >
                          Copy ID
                        </button>
                        <button
                          onClick={() => handleSelectVoice(voice.id)}
                          style={{
                            padding: '6px 12px',
                            fontSize: '12px',
                            background: '#10b981',
                            color: 'white',
                            border: 'none',
                            borderRadius: '4px',
                            cursor: 'pointer',
                          }}
                        >
                          Select
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {voices.length === 0 && (
                <div style={{ textAlign: 'center', padding: '20px', color: '#6d7175' }}>
                  No voices found. Try a different search query.
                </div>
              )}
            </div>
          </div>
        </div>
      )}


      {/* Test Call Modal */}
      {showTestCallModal && (
        <div
          id="testCallModal"
          className="modal"
          style={{ display: 'block' }}
          onClick={(e) => {
            if (e.target.id === 'testCallModal') {
              handleCloseTestCallModal();
            }
          }}
        >
          <div className="modal-content">
            <div className="modal-header">
              <h3>Test Call</h3>
              <button className="close-modal" onClick={handleCloseTestCallModal}>
                Ã—
              </button>
            </div>

            <div className="modal-tabs">
              <button
                className={`tab-btn ${testCallTab === 'create' ? 'active' : ''}`}
                onClick={() => setTestCallTab('create')}
              >
                Create Test Order
              </button>
              <button
                className={`tab-btn ${testCallTab === 'existing' ? 'active' : ''}`}
                onClick={() => {
                  setTestCallTab('existing');
                  loadTestOrders();
                }}
              >
                Existing Test Orders
              </button>
            </div>

            {/* Create Test Order Tab */}
            {testCallTab === 'create' && (
              <div id="createTab" className="tab-content active">
                <form id="testOrderForm" onSubmit={handleTestOrderSubmit}>
                  <div className="form-row">
                    <div className="form-group">
                      <label htmlFor="testCustomerName">Customer Name *</label>
                      <input
                        type="text"
                        id="testCustomerName"
                        value={testOrderForm.customerName}
                        onChange={(e) =>
                          setTestOrderForm((prev) => ({ ...prev, customerName: e.target.value }))
                        }
                        required
                      />
                    </div>
                    <div className="form-group">
                      <label htmlFor="testCustomerPhone">Phone Number *</label>
                      <input
                        type="tel"
                        id="testCustomerPhone"
                        value={testOrderForm.customerPhone}
                        onChange={(e) =>
                          setTestOrderForm((prev) => ({ ...prev, customerPhone: e.target.value }))
                        }
                        required
                      />
                    </div>
                  </div>

                  <div className="form-row">
                    <div className="form-group">
                      <label htmlFor="testCustomerEmail">Email</label>
                      <input
                        type="email"
                        id="testCustomerEmail"
                        value={testOrderForm.customerEmail}
                        onChange={(e) =>
                          setTestOrderForm((prev) => ({ ...prev, customerEmail: e.target.value }))
                        }
                      />
                    </div>
                    <div className="form-group">
                      <label htmlFor="testOrderNumber">Order Number</label>
                      <input
                        type="text"
                        id="testOrderNumber"
                        value={testOrderForm.orderNumber}
                        onChange={(e) =>
                          setTestOrderForm((prev) => ({ ...prev, orderNumber: e.target.value }))
                        }
                        placeholder="Auto-generated if empty"
                      />
                    </div>
                  </div>

                  <div className="form-group">
                    <label htmlFor="testCustomerAddress">Address</label>
                    <textarea
                      id="testCustomerAddress"
                      rows="3"
                      value={testOrderForm.customerAddress}
                      onChange={(e) =>
                        setTestOrderForm((prev) => ({ ...prev, customerAddress: e.target.value }))
                      }
                    />
                  </div>

                  <div className="form-row">
                    <div className="form-group">
                      <label htmlFor="testTotalPrice">Total Price</label>
                      <input
                        type="text"
                        id="testTotalPrice"
                        value={testOrderForm.totalPrice}
                        onChange={(e) =>
                          setTestOrderForm((prev) => ({ ...prev, totalPrice: e.target.value }))
                        }
                      />
                    </div>
                    <div className="form-group">
                      <label htmlFor="testCurrency">Currency</label>
                      <input
                        type="text"
                        id="testCurrency"
                        value={testOrderForm.currency}
                        onChange={(e) =>
                          setTestOrderForm((prev) => ({ ...prev, currency: e.target.value }))
                        }
                      />
                    </div>
                  </div>

                  <div className="form-group">
                    <button type="submit" className="btn btn-primary">
                      Create & Queue Order
                    </button>
                  </div>
                </form>
              </div>
            )}

            {/* Existing Test Orders Tab */}
            {testCallTab === 'existing' && (
              <div id="existingTab" className="tab-content">
                <div id="testOrdersList" className="test-order-list">
                  {testOrders.length > 0 ? (
                    testOrders.map((order) => (
                      <div key={order.orderId || order.id} className="test-order-item">
                        <div className="test-order-info">
                          <h4>{escapeHtml(order.customerName || 'Unknown')}</h4>
                          <p>
                            {escapeHtml(order.customerPhone || 'No phone')} |{' '}
                            {escapeHtml(order.orderNumber || order.orderId)}
                          </p>
                          <p style={{ marginTop: '4px', fontSize: '11px', color: '#9ca3af' }}>
                            Status: {escapeHtml(order.callStatus || 'N/A')} | Created:{' '}
                            {order.createdAt ? new Date(order.createdAt).toLocaleString() : 'N/A'}
                          </p>
                        </div>
                        <button
                          className="btn btn-success"
                          onClick={() => handleQueueTestOrder(order.orderId)}
                        >
                          Queue for Call
                        </button>
                      </div>
                    ))
                  ) : (
                    <p style={{ textAlign: 'center', color: '#6b7280', padding: '40px' }}>
                      No test orders yet. Create one in the "Create Test Order" tab.
                    </p>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Template Selection Modal */}
      {showTemplateModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 10000
        }} onClick={() => setShowTemplateModal(false)}>
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '32px',
            maxWidth: '600px',
            width: '90%',
            maxHeight: '80vh',
            overflowY: 'auto'
          }} onClick={(e) => e.stopPropagation()}>
            <h2 style={{ margin: '0 0 24px 0', fontSize: '24px', fontWeight: 600 }}>Select Template</h2>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              <button
                style={{
                  padding: '16px',
                  border: '2px solid #E5E7EB',
                  borderRadius: '8px',
                  background: 'white',
                  cursor: 'pointer',
                  textAlign: 'left',
                  fontSize: '16px',
                  fontWeight: 500
                }}
                onClick={() => {
                  setShowTemplateModal(false);
                  setCurrentAgentId(null);
                  setShowForm(true);
                  setActiveTab('script'); // Reset to Script tab when creating new agent
                  
                  // Try to find default script for voice
                  getCallScripts(shop).then(scripts => {
                    const scriptsArray = scripts?.scripts || scripts || [];
                    const defaultScript = scriptsArray.find(s => {
                      const nameLower = s.name.toLowerCase();
                      return (nameLower.includes('address') && nameLower.includes('extraction')) ||
                             (nameLower.includes('house') && nameLower.includes('direction')) ||
                             nameLower.includes('house dir');
                    });
                    
                    setFormData({
                      name: '',
                      description: '',
                      content: '',
                      voiceId: defaultScript?.voiceId || '',
                      initialGreeting: '',
                      prePhrase: 'ji',
                      useCustomAnalysis: false,
                      customAnalysisPrompt: '',
                      disableUnder35Retries: false,
                      successCriteria: [],
                      otherCriteria: [],
                      maxRetries: '',
                      retryIntervalMinutes: '',
                      successMetric: '',
                      variableDefinitions: {},
                      variableBookId: '',
                      ttsProvider: null,
                      interruptions: false,
                    });

                    const newParams = new URLSearchParams(searchParams);
                    newParams.set('agent', 'new');
                    setSearchParams(newParams);
                  }).catch(error => {
                    console.error('[Playground] Error loading scripts for blank:', error);
                    const fallbackTemplate = templates['smart-address-recovery'];
                    setFormData({
                      name: fallbackTemplate.name,
                      description: '',
                      content: fallbackTemplate.content,
                      voiceId: fallbackTemplate.voiceId || '',
                      initialGreeting: fallbackTemplate.initialGreeting || '',
                      prePhrase: fallbackTemplate.prePhrase || 'ji',
                      useCustomAnalysis: false,
                      customAnalysisPrompt: '',
                      disableUnder35Retries: false,
                      successCriteria: fallbackTemplate.successCriteria || [],
                      otherCriteria: fallbackTemplate.otherCriteria || [],
                      maxRetries: '',
                      retryIntervalMinutes: '',
                      successMetric: '',
                      variableDefinitions: fallbackTemplate.variableDefinitions || {},
                      variableBookId: fallbackTemplate.variableBookId || '',
                      ttsProvider: null,
                    });

                    const newParams = new URLSearchParams(searchParams);
                    newParams.set('agent', 'new');
                    setSearchParams(newParams);
                  });
                }}
              >
                Blank
              </button>
              <button
                style={{
                  padding: '16px',
                  border: '2px solid #E5E7EB',
                  borderRadius: '8px',
                  background: 'white',
                  cursor: 'pointer',
                  textAlign: 'left',
                  fontSize: '16px',
                  fontWeight: 500
                }}
                onClick={() => {
                  setShowTemplateModal(false);
                  handleCreateNewWithTemplate('cod-thank-you-intent');
                }}
              >
                COD Thank You Call + Intent Capture
              </button>
              <button
                style={{
                  padding: '16px',
                  border: '2px solid #E5E7EB',
                  borderRadius: '8px',
                  background: 'white',
                  cursor: 'pointer',
                  textAlign: 'left',
                  fontSize: '16px',
                  fontWeight: 500
                }}
                onClick={() => {
                  setShowTemplateModal(false);
                  handleCreateNewWithTemplate('address-update');
                }}
              >
                Address Update
              </button>
              <button
                style={{
                  padding: '16px',
                  border: '2px solid #E5E7EB',
                  borderRadius: '8px',
                  background: 'white',
                  cursor: 'pointer',
                  textAlign: 'left',
                  fontSize: '16px',
                  fontWeight: 500
                }}
                onClick={() => {
                  setShowTemplateModal(false);
                  handleCreateNewWithTemplate('ndr-call');
                }}
              >
                NDR Call
              </button>
              <button
                style={{
                  padding: '16px',
                  border: '2px solid #E5E7EB',
                  borderRadius: '8px',
                  background: 'white',
                  cursor: 'pointer',
                  textAlign: 'left',
                  fontSize: '16px',
                  fontWeight: 500
                }}
                onClick={() => {
                  setShowTemplateModal(false);
                  handleCreateNewWithTemplate('order-confirmation');
                }}
              >
                Order Confirmation
              </button>
            </div>
            <button
              style={{
                marginTop: '24px',
                padding: '12px 24px',
                background: '#F3F4F6',
                border: 'none',
                borderRadius: '8px',
                cursor: 'pointer',
                fontSize: '14px',
                fontWeight: 500
              }}
              onClick={() => setShowTemplateModal(false)}
            >
              Cancel
            </button>
          </div>
        </div>
      )}
      {showFlowMaker && (
        <FlowMaker
          initialFlowData={flowData || undefined}
          onSave={(savedFlowData, textContent) => {
            console.log('[Playground] FlowMaker onSave called:', {
              flowDataNodeCount: savedFlowData?.nodes?.length || 0,
              flowDataNodesWithContent: savedFlowData?.nodes?.filter(n => n.data?.content?.trim()).length || 0,
              textContentLength: textContent?.length || 0,
              textContentPreview: textContent?.substring(0, 200),
              flowDataPreview: JSON.stringify(savedFlowData).substring(0, 300)
            });
            setFlowData(savedFlowData);
            setFormData(prev => {
              const updated = { ...prev, content: textContent };
              console.log('[Playground] Updated formData.content:', {
                oldLength: prev.content?.length || 0,
                newLength: updated.content?.length || 0,
                preview: updated.content?.substring(0, 200)
              });
              return updated;
            });
            setShowFlowMaker(false);
            // Don't auto-save the agent - user needs to click Save in the main form
          }}
          onClose={() => setShowFlowMaker(false)}
        />
      )}

      {showAIModal && (
        <div
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000,
          }}
          onClick={handleCloseAIModal}
        >
          <div
            style={{
              backgroundColor: 'white',
              borderRadius: '12px',
              padding: '32px',
              width: '90%',
              maxWidth: '900px',
              maxHeight: '90vh',
              overflow: 'auto',
              boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <div style={{ marginBottom: '20px' }}>
              <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600', color: '#111827' }}>
                {aiModalMode === 'write' ? 'Write with AI' : 'Edit with AI'}
              </h2>
              <p style={{ margin: '8px 0 0 0', fontSize: '14px', color: '#6b7280' }}>
                {aiModalMode === 'write' 
                  ? 'Enter a simple description of the script you want to create. AI will generate a complete system prompt.'
                  : 'Enhance your current script with AI. Your existing script will be used as context.'}
              </p>
            </div>
              <div style={{ marginBottom: '20px' }}>
              <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                Enter your prompt:
                </label>
              <textarea
                value={aiPrompt}
                onChange={(e) => setAiPrompt(e.target.value)}
                placeholder={aiModalMode === 'write' 
                  ? 'e.g., "create a system prompt for abandonment checkout, cloud shark brand, and i abandoned some sneakers"'
                  : 'e.g., "Make it more conversational and add a section about delivery options"'}
                disabled={isGeneratingScript}
                  style={{
                    width: '100%',
                  minHeight: '120px',
                    padding: '12px',
                    border: '1px solid #d1d5db',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontFamily: 'inherit',
                  resize: 'vertical',
                  opacity: isGeneratingScript ? 0.6 : 1,
                }}
                onKeyDown={(e) => {
                  if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                    e.preventDefault();
                    handleGenerateScript();
                    }
                  }}
                />
                <div style={{ marginTop: '8px' }}>
                  <label
                    htmlFor="aiPromptFile"
                    style={{
                      display: 'inline-flex',
                      alignItems: 'center',
                      gap: '8px',
                      padding: '8px 12px',
                      border: '1px solid #d1d5db',
                      borderRadius: '6px',
                      background: '#f9fafb',
                      cursor: 'pointer',
                      fontSize: '13px',
                      fontWeight: '500',
                      color: '#374151',
                      transition: 'all 0.2s',
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.background = '#f3f4f6';
                      e.currentTarget.style.borderColor = '#9ca3af';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.background = '#f9fafb';
                      e.currentTarget.style.borderColor = '#d1d5db';
                    }}
                  >
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                      <polyline points="17 8 12 3 7 8" />
                      <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    Upload .txt or .md file
                  </label>
                  <input
                    id="aiPromptFile"
                    type="file"
                    accept=".txt,.md"
                    style={{ display: 'none' }}
                    onChange={async (e) => {
                      const file = e.target.files?.[0];
                      if (file) {
                        if (file.size > 5 * 1024 * 1024) {
                          alert('File size must be less than 5MB');
                          return;
                        }
                        try {
                          const text = await file.text();
                          setAiPrompt(text);
                        } catch (error) {
                          console.error('Error reading file:', error);
                          alert('Error reading file. Please try again.');
                        }
                      }
                      e.target.value = '';
                    }}
                  />
                </div>
              </div>

            {/* Language Settings (only for Write mode) */}
            {aiModalMode === 'write' && (
              <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                  Set Primary Language:
                </label>
                <select
                  value={writeAISettings.primaryLanguage || ''}
                  onChange={(e) => setWriteAISettings(prev => ({ ...prev, primaryLanguage: e.target.value }))}
                  disabled={isGeneratingScript}
                  style={{
                    width: '100%',
                    padding: '8px 12px',
                    border: '1px solid #d1d5db',
                    borderRadius: '6px',
                    fontSize: '14px',
                    background: 'white',
                    color: '#111827',
                    cursor: isGeneratingScript ? 'not-allowed' : 'pointer',
                    opacity: isGeneratingScript ? 0.5 : 1,
                    marginBottom: '12px'
                  }}
                >
                  <option value="">Select Primary Language</option>
                  <option value="Hindi">Hindi</option>
                  <option value="English">English</option>
                  <option value="Hinglish">Hinglish</option>
                  <option value="Telugu">Telugu</option>
                  <option value="Tamil">Tamil</option>
                  <option value="Kannada">Kannada</option>
                  <option value="Marathi">Marathi</option>
                  <option value="Bengali">Bengali</option>
                  <option value="Gujarati">Gujarati</option>
                </select>
                
                <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                  Set Secondary Languages (with tags):
                </label>
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px', marginBottom: '12px' }}>
                  {['Hindi', 'English', 'Hinglish', 'Telugu', 'Tamil', 'Kannada', 'Marathi', 'Bengali', 'Gujarati'].map(lang => {
                    const isSelected = writeAISettings.secondaryLanguages?.includes(lang) || false;
                    return (
                      <button
                        key={lang}
                        type="button"
                        onClick={() => {
                          const current = writeAISettings.secondaryLanguages || [];
                          if (isSelected) {
                            setWriteAISettings(prev => ({ 
                              ...prev, 
                              secondaryLanguages: current.filter(l => l !== lang) 
                            }));
                          } else {
                            setWriteAISettings(prev => ({ 
                              ...prev, 
                              secondaryLanguages: [...current, lang] 
                            }));
                          }
                        }}
                        disabled={isGeneratingScript}
                        style={{
                          padding: '6px 12px',
                          border: `1px solid ${isSelected ? '#4B5CFF' : '#d1d5db'}`,
                          borderRadius: '6px',
                          fontSize: '13px',
                          background: isSelected ? '#EEF2FF' : 'white',
                          color: isSelected ? '#4B5CFF' : '#374151',
                          cursor: isGeneratingScript ? 'not-allowed' : 'pointer',
                          fontWeight: isSelected ? '500' : '400',
                          opacity: isGeneratingScript ? 0.5 : 1
                        }}
                      >
                        {lang}
                      </button>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Gender Selection (only for Write mode) */}
            {aiModalMode === 'write' && (
              <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', marginBottom: '12px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                  Agent Gender:
                </label>
                <div style={{ display: 'flex', gap: '16px' }}>
                  <label
                  style={{
                  display: 'flex',
                  alignItems: 'center',
                      gap: '8px',
                      cursor: isGeneratingScript ? 'not-allowed' : 'pointer',
                      opacity: isGeneratingScript ? 0.5 : 1,
                    }}
                  >
                    <input
                      type="radio"
                      name="aiGender"
                      value="female"
                      checked={aiGenderSelection === 'female'}
                      onChange={(e) => setAiGenderSelection(e.target.value)}
                      disabled={isGeneratingScript}
                    style={{ 
                                width: '16px',
                                height: '16px',
                        cursor: isGeneratingScript ? 'not-allowed' : 'pointer',
                      }}
                    />
                    <span style={{ fontSize: '14px', color: '#374151' }}>Female</span>
                  </label>
                        <label
                          style={{
                            display: 'flex',
                            alignItems: 'center',
                      gap: '8px',
                      cursor: isGeneratingScript ? 'not-allowed' : 'pointer',
                      opacity: isGeneratingScript ? 0.5 : 1,
                          }}
                        >
                          <input
                      type="radio"
                      name="aiGender"
                      value="male"
                      checked={aiGenderSelection === 'male'}
                      onChange={(e) => setAiGenderSelection(e.target.value)}
                      disabled={isGeneratingScript}
                      style={{
                        width: '16px',
                        height: '16px',
                        cursor: isGeneratingScript ? 'not-allowed' : 'pointer',
                      }}
                    />
                    <span style={{ fontSize: '14px', color: '#374151' }}>Male</span>
                        </label>
                    </div>
                  </div>
            )}

            {/* End Call When (only for Write mode) */}
            {aiModalMode === 'write' && (
              <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                  end call when:
                </label>
                <textarea
                  value={aiEndCallWhen}
                  onChange={(e) => setAiEndCallWhen(e.target.value)}
                  placeholder="e.g., customer confirms order, customer requests cancellation, etc."
                  disabled={isGeneratingScript}
                  style={{
                    width: '100%',
                    minHeight: '80px',
                    padding: '12px',
                    border: '1px solid #d1d5db',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontFamily: 'inherit',
                    resize: 'vertical',
                    opacity: isGeneratingScript ? 0.6 : 1,
                  }}
                />
              </div>
            )}
            
            <div style={{ display: 'flex', gap: '12px', justifyContent: 'space-between', alignItems: 'center' }}>
              <button
                type="button"
                onClick={() => {
                  const modal = document.getElementById('editWithAIModal');
                  if (modal) modal.style.display = 'none';
                }}
                style={{
                  padding: '10px 20px',
                  background: 'none',
                  border: 'none',
                  cursor: 'pointer',
                  fontSize: '24px',
                  fontWeight: '600',
                  color: '#10B981'
                }}
              >
                {aiModalMode === 'write' ? (
                  <>
                    Write with AI
                  </>
                ) : (
                  <>
                    Edit with AI
                  </>
                )}
              </button>
              <button
                type="button"
                onClick={() => {
                  const modal = document.getElementById('editWithAIModal');
                  if (modal) modal.style.display = 'none';
                }}
                style={{
                  background: 'none',
                  border: 'none',
                  cursor: 'pointer',
                  padding: '8px',
                  fontSize: '20px'
                }}
              >
                Ã—
              </button>
            </div>
            
            {/* Comparison Container */}
            <div style={{ 
              display: 'grid', 
              gridTemplateColumns: '1fr 1fr', 
              gap: '20px',
              marginBottom: '20px' 
            }}>
              {/* Original Script (Left) */}
              <div>
                <h3 style={{ 
                  fontSize: '16px', 
                  fontWeight: '600', 
                  color: '#6B7280', 
                  marginBottom: '12px' 
                }}>
                  Original (Current)
                </h3>
                <div style={{ 
                  padding: '16px', 
                  background: '#F9FAFB', 
                  borderRadius: '8px', 
                  border: '1px solid #E5E7EB',
                  fontFamily: 'monospace', 
                  fontSize: '13px',
                  color: '#374151',
                  maxHeight: '400px',
                  overflow: 'auto'
                }}>
                  {formData?.content || 'No content'}
                </div>
              </div>
              
              {/* Proposed Script (Right) */}
              <div>
                <h3 style={{ 
                  fontSize: '16px', 
                  fontWeight: '600', 
                  color: '#10B981', 
                  marginBottom: '12px' 
                }}>
                  Proposed (AI)
                </h3>
                <div style={{ 
                  padding: '16px',
                  background: '#F0FDF4', 
                  borderRadius: '8px', 
                  border: '1px solid #E5E7EB',
                  fontFamily: 'monospace', 
                  fontSize: '13px',
                  color: '#0F766E',
                  maxHeight: '400px',
                  overflow: 'auto'
                }}>
                  {proposedScript || 'No content'}
                </div>
              </div>
            </div>
            
            {/* Footer with Actions */}
            <div style={{ 
              borderTop: '1px solid #E5E7EB',
              paddingTop: '20px',
              display: 'flex',
              gap: '12px',
              justifyContent: 'center'
            }}>
              <button
                type="button"
                onClick={() => {
                  setFormData(prev => ({ ...prev, content: proposedScript || '' }));
                  setShowEditDiffModal(false);
                  alert('Changes applied successfully!');
                }}
                style={{
                  padding: '10px 20px',
                  background: '#10B981',
                  color: 'white',
                  border: 'none',
                  borderRadius: '6px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: 'pointer'
                }}
              >
                Accept
              </button>
              <button
                type="button"
                onClick={() => {
                  setProposedScript(null);
                  setShowEditDiffModal(false);
                }}
                style={{
                  padding: '10px 20px',
                  background: 'white',
                  color: '#374151',
                  border: '1px solid #D1D5DB',
                  borderRadius: "6px",
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: 'pointer'
                }}
              >
                Reject
              </button>
            </div>
          </div>
        </div>
      )}

            {/* Edit with AI Modal - Shows diff between current and proposed scripts */}
      {aiModalMode === 'rewrite' && proposedScript && (
        <div
          id="editWithAIModal"
          style={{
            display: 'none',
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            zIndex: 10000,
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px'
          }}
          onClick={(e) => {
            if (e.target.id === 'editWithAIModal') {
              e.stopPropagation();
            }
          }}
        >
          <div style={{
            background: 'white',
            borderRadius: '12px',
            boxShadow: '0 20px 60px -10px rgba(0, 0, 0, 0.1)',
            width: '90%',
            maxWidth: '900px',
            maxHeight: '90vh',
            overflow: 'auto'
          }}>
            {/* Header */}
            <div style={{ 
              display: 'flex', 
              justifyContent: 'space-between', 
              alignItems: 'center', 
              padding: '20px 24px 20px',
              borderBottom: '1px solid #E5E7EB',
              marginBottom: '16px' 
            }}>
              <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600', color: '#111827' }}>
                Edit with AI
              </h2>
              <button
                type="button"
                onClick={() => {
                  const modal = document.getElementById('editWithAIModal');
                  if (modal) modal.style.display = 'none';
                }}
                style={{
                  background: 'none',
                  border: 'none',
                  cursor: 'pointer',
                  fontSize: '20px',
                  fontWeight: '600',
                  color: '#10B981'
                }}
              >
                Ã—
              </button>
            </div>
            
            {/* Comparison Container */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: '1fr 1fr',
              gap: '20px',
              marginBottom: '20px'
            }}>
              {/* Original Script (Left) */}
              <div>
                <h3 style={{ 
                  fontSize: '16px', 
                  fontWeight: '600', 
                  color: '#6B7280', 
                  marginBottom: '12px' 
                }}>
                  Original (Current)
                </h3>
                <div style={{
                  padding: '16px', 
                  background: '#F9FAFB', 
                  borderRadius: '8px', 
                  border: '1px solid #E5E7EB',
                  fontFamily: 'monospace', 
                  fontSize: '13px',
                  color: '#111827',
                  maxHeight: '400px',
                  overflow: 'auto'
                }}>
                  {formData?.content || 'No content'}
                </div>
              </div>
              
              {/* Proposed Script (Right) */}
              <div>
                <h3 style={{ 
                  fontSize: '16px', 
                  fontWeight: '600', 
                  color: '#10B981', 
                  marginBottom: '12px' 
                }}>
                  Proposed (AI)
                </h3>
                <div style={{
                  padding: '16px', 
                  background: '#F0FDF4', 
                  borderRadius: '8px', 
                  border: '1px solid #FBBF24',
                  fontFamily: 'monospace', 
                  fontSize: '13px',
                  color: '#0F766E',
                  maxHeight: '400px',
                  overflow: 'auto'
                }}>
                  {proposedScript || 'No content'}
                </div>
              </div>
            </div>
            
            {/* Footer with Actions */}
            <div style={{ 
              borderTop: '1px solid #E5E7EB',
              paddingTop: '20px',
              display: 'flex',
              gap: '12px',
              justifyContent: 'center'
            }}>
              <button
                type="button"
                onClick={handleAcceptEditChanges}
                disabled={isGeneratingEditDiff}
                style={{
                  padding: '10px 20px',
                  background: '#10B981',
                  color: 'white',
                  border: 'none',
                  borderRadius: '6px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: isGeneratingEditDiff ? 'not-allowed' : 'pointer'
                }}
              >
                {isGeneratingEditDiff ? 'Generating...' : 'Accept'}
              </button>
              <button
                type="button"
                onClick={handleRejectEditChanges}
                style={{
                  padding: '10px 20px',
                  background: 'white',
                  color: '#374151',
                  border: '1px solid #D1D5DB',
                  borderRadius: '6px',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: 'pointer'
                }}
              >
                Reject
              </button>
            </div>
          </div>
        )}
      
      {/* Note Taker Modal */}
      <div
        id="noteTakerModal"
          style={{
            display: 'none',
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            zIndex: 10000,
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px'
          }}
          onClick={(e) => {
            if (e.target.id === 'noteTakerModal') {
              e.stopPropagation();
            }
            const modal = document.getElementById('noteTakerModal');
            if (modal) modal.style.display = 'none';
          }}
        >
          <div
            style={{
              background: 'white',
              borderRadius: '12px',
              boxShadow: '0 20px 60px -10px rgba(0, 0, 0, 0.1)',
              width: '90%',
              maxWidth: '900px',
              maxHeight: '90vh',
              overflow: 'auto'
            }}
          >
            {/* Header */}
            <div style={{ 
              display: 'flex', 
              justifyContent: 'space-between', 
              alignItems: 'center', 
              padding: '20px 24px 20px',
              borderBottom: '1px solid #E5E7EB',
              marginBottom: '16px' 
            }}>
              <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600', color: '#111827' }}>
                Note Taker
              </h2>
              <button
                type="button"
                onClick={() => {
                  const modal = document.getElementById('noteTakerModal');
                  if (modal) modal.style.display = 'none';
                }}
                style={{
                  background: 'none',
                  border: 'none',
                  cursor: 'pointer',
                  padding: '8px',
                  fontSize: '20px'
                }}
              >
                Ã—
              </button>
            </div>
            
            {/* Content Area */}
            <div style={{
              display: 'flex',
              flexDirection: 'column',
              gap: '16px',
              padding: '24px'
            }}>
              <textarea
                value={noteTakerContent}
                onChange={(e) => setNoteTakerContent(e.target.value)}
                placeholder="Add your notes here...&#10;Use + for additions, - for removals&#10;Example:&#10;+ Add greeting section&#10;- Remove old pricing info&#10;+ Update delivery timeline"
                style={{
                  width: '100%',
                  minHeight: '200px',
                  padding: '12px',
                  border: '1px solid #d1d5db',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontFamily: 'monospace',
                  lineHeight: '1.6'
                }}
              />
              
              {/* Git-like diff preview */}
              {noteTakerContent.trim() && (
                <div style={{
                  marginBottom: '16px',
                  padding: '16px',
                  background: '#F9FAFB',
                  border: '1px solid #E5E7EB',
                  borderRadius: '8px',
                  fontFamily: 'monospace',
                  fontSize: '13px',
                  maxHeight: '200px',
                  overflow: 'auto'
                }}>
                  {noteTakerContent.split('\n').map((line, idx) => {
                    const trimmed = line.trim();
                    if (!trimmed) return <div key={idx} style={{ height: '4px' }} />;
                    
                    const isAdd = trimmed.startsWith('+');
                    const isRemove = trimmed.startsWith('-');
                    const isNeutral = !isAdd && !isRemove;
                    
                    return (
                      <span
                        key={idx}
                        style={{
                          display: 'inline-flex',
                          alignItems: 'center',
                          gap: '4px',
                          padding: '4px 8px',
                          backgroundColor: isAdd ? '#10b981' : isRemove ? '#DC2626' : 'transparent',
                          borderRadius: '4px',
                          paddingLeft: '8px',
                          paddingRight: '8px',
                          color: isAdd ? '#059669' : '#9CA3AF',
                          fontSize: '12px',
                          fontWeight: 'bold',
                          marginLeft: '2px'
                        }}
                      >
                        <span style={{ 
                          marginRight: '8px', 
                          fontWeight: '600',
                          color: isAdd ? '#059669' : isRemove ? '#DC2626' : '#9CA3AF',
                          minWidth: '20px',
                          textAlign: 'right'
                        }}>
                          {isAdd ? '+' : isRemove ? '-' : ' '}
                        </span>
                        <span style={{ flex: 1, wordBreak: 'break-word' }}>
                          {isAdd || isRemove ? trimmed.substring(1).trim() : trimmed}
                        </span>
                      </span>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        )}
        </div>

      {/* Support Ticket Modal */}
      {showSupportTicketModal && (
        <div
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.4)',
            backdropFilter: 'blur(8px)',
            zIndex: 10000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px'
          }}
          onClick={(e) => {
            if (e.target === e.currentTarget && !supportTicketSuccess) {
              setShowSupportTicketModal(false);
            }
          }}
        >
          <div
            style={{
              background: '#ffffff',
              borderRadius: '20px',
              width: '100%',
              maxWidth: '520px',
              boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
              overflow: 'hidden',
              animation: 'fadeIn 0.3s ease-out'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {!supportTicketSuccess ? (
              <>
                {/* Header */}
                <div style={{
                  padding: '24px 28px',
                  borderBottom: '1px solid #e5e5e7',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center'
                }}>
                  <h2 style={{
                    margin: 0,
                    fontSize: '22px',
                    fontWeight: '600',
                    color: '#1d1d1f',
                    letterSpacing: '-0.3px'
                  }}>
                    Create Support Ticket
                  </h2>
                  <button
                    type="button"
                    onClick={() => setShowSupportTicketModal(false)}
                    style={{
                      width: '32px',
                      height: '32px',
                      borderRadius: '8px',
                      border: 'none',
                      background: '#f5f5f7',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.background = '#e5e5e7';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.background = '#f5f5f7';
                    }}
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M18 6L6 18M6 6L18 18" stroke="#1d1d1f" strokeWidth="2" strokeLinecap="round"/>
                    </svg>
                  </button>
                </div>

                {/* Content */}
                <div style={{ padding: '28px' }}>
                  <label style={{
                    display: 'block',
                    fontSize: '14px',
                    fontWeight: '500',
                    color: '#1d1d1f',
                    marginBottom: '10px'
                  }}>
                    Describe your issue with script
                  </label>
                  <textarea
                    value={supportTicketDescription}
                    onChange={(e) => setSupportTicketDescription(e.target.value)}
                    placeholder="I need help with ..."
                    style={{
                      width: '100%',
                      minHeight: '120px',
                      padding: '12px',
                      border: '1px solid #d2d2d7',
                      borderRadius: '10px',
                      fontSize: '14px',
                      fontFamily: 'inherit',
                      resize: 'vertical',
                      lineHeight: '1.5',
                      color: '#1d1d1f',
                      background: '#ffffff',
                      marginBottom: '20px',
                      transition: 'all 0.2s'
                    }}
                    onFocus={(e) => {
                      e.currentTarget.style.borderColor = '#667eea';
                      e.currentTarget.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
                    }}
                    onBlur={(e) => {
                      e.currentTarget.style.borderColor = '#d2d2d7';
                      e.currentTarget.style.boxShadow = 'none';
                    }}
                  />

                  {/* Create Button */}
                  <button
                    type="button"
                    onClick={() => {
                      // Generate ticket ID
                      const ticketId = 'TKT-' + Date.now().toString().slice(-8);
                      setSupportTicketId(ticketId);
                      setSupportTicketSuccess(true);
                    }}
                    disabled={!supportTicketDescription.trim() || supportTicketDescription.trim() === 'I need help with ...'}
                    style={{
                      width: '100%',
                      padding: '12px 24px',
                      background: supportTicketDescription.trim() && supportTicketDescription.trim() !== 'I need help with ...'
                        ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                        : '#e5e5e7',
                      color: '#ffffff',
                      border: 'none',
                      borderRadius: '10px',
                      fontSize: '15px',
                      fontWeight: '600',
                      cursor: supportTicketDescription.trim() && supportTicketDescription.trim() !== 'I need help with ...'
                        ? 'pointer'
                        : 'not-allowed',
                      transition: 'all 0.2s',
                      boxShadow: supportTicketDescription.trim() && supportTicketDescription.trim() !== 'I need help with ...'
                        ? '0 4px 12px rgba(102, 126, 234, 0.3)'
                        : 'none'
                    }}
                    onMouseEnter={(e) => {
                      if (supportTicketDescription.trim() && supportTicketDescription.trim() !== 'I need help with ...') {
                        e.currentTarget.style.transform = 'translateY(-1px)';
                        e.currentTarget.style.boxShadow = '0 6px 16px rgba(102, 126, 234, 0.4)';
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (supportTicketDescription.trim() && supportTicketDescription.trim() !== 'I need help with ...') {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
                      }
                    }}
                  >
                    Create
                  </button>
                </div>
              </>
            ) : (
              <>
                {/* Success State */}
                <div style={{ padding: '48px 28px', textAlign: 'center' }}>
                  {/* Success Icon */}
                  <div style={{
                    width: '64px',
                    height: '64px',
                    borderRadius: '50%',
                    background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    margin: '0 auto 24px',
                    boxShadow: '0 4px 12px rgba(16, 185, 129, 0.3)'
                  }}>
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M20 6L9 17L4 12" stroke="white" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"/>
                    </svg>
                  </div>

                  {/* Success Message */}
                  <h2 style={{
                    margin: '0 0 8px 0',
                    fontSize: '24px',
                    fontWeight: '600',
                    color: '#1d1d1f',
                    letterSpacing: '-0.4px'
                  }}>
                    Created
                  </h2>

                  {/* Ticket ID */}
                  <div style={{
                    marginBottom: '24px',
                    padding: '12px 20px',
                    background: '#f5f5f7',
                    borderRadius: '10px',
                    display: 'inline-block'
                  }}>
                    <div style={{
                      fontSize: '12px',
                      fontWeight: '500',
                      color: '#6b7280',
                      marginBottom: '4px'
                    }}>
                      Ticket ID
                    </div>
                    <div style={{
                      fontSize: '16px',
                      fontWeight: '600',
                      color: '#1d1d1f',
                      fontFamily: 'Menlo, Monaco, monospace'
                    }}>
                      {supportTicketId}
                    </div>
                  </div>

                  {/* Contact Info */}
                  <div style={{
                    marginTop: '32px',
                    padding: '20px',
                    background: '#f9fafb',
                    borderRadius: '12px',
                    border: '1px solid #e5e7eb'
                  }}>
                    <div style={{
                      fontSize: '14px',
                      fontWeight: '500',
                      color: '#374151',
                      marginBottom: '12px'
                    }}>
                      We will reach out in 1-2 hours
                    </div>
                    <div style={{
                      fontSize: '13px',
                      color: '#6b7280',
                      marginBottom: '16px'
                    }}>
                      Or contact us directly:
                    </div>
                    <div style={{
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '8px',
                      alignItems: 'center'
                    }}>
                      {['9149874123', '7006801706', '9682165725'].map((phone, index) => (
                        <a
                          key={index}
                          href={`tel:${phone}`}
                          style={{
                            fontSize: '15px',
                            fontWeight: '500',
                            color: '#667eea',
                            textDecoration: 'none',
                            padding: '8px 16px',
                            borderRadius: '8px',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.background = '#f0f4ff';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.background = 'transparent';
                          }}
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                          </svg>
                          {phone}
                        </a>
                      ))}
                    </div>
                  </div>

                  {/* Close Button */}
                  <button
                    type="button"
                    onClick={() => {
                      setShowSupportTicketModal(false);
                      setSupportTicketSuccess(false);
                      setSupportTicketDescription('I need help with ...');
                      setSupportTicketId('');
                    }}
                    style={{
                      marginTop: '24px',
                      padding: '10px 24px',
                      background: '#f5f5f7',
                      color: '#1d1d1f',
                      border: '1px solid #d2d2d7',
                      borderRadius: '10px',
                      fontSize: '14px',
                      fontWeight: '500',
                      cursor: 'pointer',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.background = '#e5e5e7';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.background = '#f5f5f7';
                    }}
                  >
                    Close
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      )}

      {/* Personality Selection Popup */}
      {showPersonalityPopup && (
        <>
          {/* Overlay */}
          <div
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.5)',
              zIndex: 10000,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              animation: 'fadeIn 0.2s ease-out'
            }}
            onClick={() => setShowPersonalityPopup(false)}
          >
            <div
              style={{
                background: 'white',
                borderRadius: '16px',
                padding: '28px',
                width: '90%',
                maxWidth: '480px',
                boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                animation: 'scaleIn 0.2s ease-out'
              }}
              onClick={(e) => e.stopPropagation()}
            >
              {/* Header */}
              <div style={{ marginBottom: '24px', textAlign: 'center' }}>
                <div style={{ 
                  width: '56px', 
                  height: '56px', 
                  margin: '0 auto 16px', 
                  borderRadius: '12px',
                  background: '#f3f4f6',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#4B5CFF" strokeWidth="2">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                  </svg>
                </div>
                <h3 style={{ margin: '0 0 8px 0', fontSize: '20px', fontWeight: '600', color: '#111827' }}>
                  Run Simulation
                </h3>
                <p style={{ margin: 0, fontSize: '14px', color: '#6b7280', lineHeight: '1.5' }}>
                  Select a personality type to simulate a conversation
                </p>
              </div>

              {/* Personality Options */}
              <div style={{ marginBottom: '24px', display: 'flex', flexDirection: 'column', gap: '10px' }}>
                {[
                  { id: 'friendly', label: 'Friendly & Cooperative', description: 'Polite and willing to help' },
                  { id: 'skeptical', label: 'Skeptical', description: 'Questions everything, needs convincing' },
                  { id: 'busy', label: 'Busy & Rushed', description: 'Short on time, wants quick answers' },
                  { id: 'confused', label: 'Confused', description: 'Needs extra explanation and clarity' },
                  { id: 'angry', label: 'Angry & Frustrated', description: 'Upset about previous experience' }
                ].map((personality) => (
                  <label
                    key={personality.id}
                    style={{
                      display: 'flex',
                      alignItems: 'flex-start',
                      gap: '12px',
                      padding: '14px',
                      border: selectedPersonality === personality.id ? '2px solid #4B5CFF' : '2px solid #e5e7eb',
                      borderRadius: '10px',
                      background: selectedPersonality === personality.id ? '#f0f4ff' : 'white',
                      cursor: 'pointer',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      if (selectedPersonality !== personality.id) {
                        e.currentTarget.style.borderColor = '#d1d5db';
                        e.currentTarget.style.background = '#f9fafb';
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (selectedPersonality !== personality.id) {
                        e.currentTarget.style.borderColor = '#e5e7eb';
                        e.currentTarget.style.background = 'white';
                      }
                    }}
                  >
                    <input
                      type="radio"
                      name="personality"
                      value={personality.id}
                      checked={selectedPersonality === personality.id}
                      onChange={(e) => setSelectedPersonality(e.target.value)}
                      style={{
                        marginTop: '2px',
                        width: '18px',
                        height: '18px',
                        cursor: 'pointer',
                        accentColor: '#4B5CFF'
                      }}
                    />
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: '14px', fontWeight: '600', color: '#111827', marginBottom: '4px' }}>
                        {personality.label}
                      </div>
                      <div style={{ fontSize: '13px', color: '#6b7280', lineHeight: '1.4' }}>
                        {personality.description}
                      </div>
                    </div>
                  </label>
                ))}
              </div>

              {/* Actions */}
              <div style={{ display: 'flex', gap: '12px' }}>
                <button
                  onClick={() => {
                    setShowPersonalityPopup(false);
                    setSelectedPersonality('');
                  }}
                  style={{
                    flex: 1,
                    padding: '12px 20px',
                    background: 'white',
                    border: '1px solid #e5e7eb',
                    borderRadius: '10px',
                    fontSize: '14px',
                    fontWeight: '500',
                    color: '#374151',
                    cursor: 'pointer',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.background = '#f9fafb';
                    e.currentTarget.style.borderColor = '#d1d5db';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.background = 'white';
                    e.currentTarget.style.borderColor = '#e5e7eb';
                  }}
                >
                  Cancel
                </button>
                <button
                  onClick={() => {
                    if (selectedPersonality) {
                      setIsRunningPersonalitySimulation(true);
                      setShowPersonalityPopup(false);
                      // TODO: Backend will handle simulation
                      alert(`Running simulation with "${selectedPersonality}" personality...\n\n(Feature coming soon - backend integration needed)`);
                      setTimeout(() => {
                        setIsRunningPersonalitySimulation(false);
                        setSelectedPersonality('');
                      }, 2000);
                    }
                  }}
                  disabled={!selectedPersonality}
                  style={{
                    flex: 1,
                    padding: '12px 20px',
                    background: selectedPersonality ? '#4B5CFF' : '#d1d5db',
                    border: 'none',
                    borderRadius: '10px',
                    fontSize: '14px',
                    fontWeight: '600',
                    color: 'white',
                    cursor: selectedPersonality ? 'pointer' : 'not-allowed',
                    transition: 'all 0.2s',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px'
                  }}
                  onMouseEnter={(e) => {
                    if (selectedPersonality) {
                      e.currentTarget.style.background = '#3b4ed8';
                      e.currentTarget.style.transform = 'translateY(-1px)';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (selectedPersonality) {
                      e.currentTarget.style.background = '#4B5CFF';
                      e.currentTarget.style.transform = 'translateY(0)';
                    }
                  }}
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                  </svg>
                  Start Simulation
                </button>
              </div>
            </div>
          </div>

          <style>{`
            /* Monaco Editor Change Highlighting */
            .monaco-line-highlight-added {
              background-color: rgba(34, 197, 94, 0.15) !important;
            }
            .monaco-glyph-highlight-added {
              background-color: #22c55e !important;
            }
            .monaco-inline-highlight-added {
              background-color: rgba(34, 197, 94, 0.2) !important;
            }
          `}</style>
          <style>{`
            @keyframes scaleIn {
              from {
                opacity: 0;
                transform: scale(0.95);
              }
              to {
                opacity: 1;
                transform: scale(1);
              }
            }
            /* Monaco Editor Change Highlighting */
            .monaco-line-highlight-added {
              background-color: rgba(34, 197, 94, 0.15) !important;
            }
            .monaco-glyph-highlight-added {
              background-color: #22c55e !important;
            }
            .monaco-inline-highlight-added {
              background-color: rgba(34, 197, 94, 0.2) !important;
            }
          `}</style>
        </>
      )}

      {/* Version Details Slide-in Panel */}
      {showVersionPanel && selectedVersion && (
        <>
          {/* Overlay */}
          <div
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.3)',
              zIndex: 9998,
              animation: 'fadeIn 0.2s ease-out'
            }}
            onClick={() => setShowVersionPanel(false)}
          />

          {/* Slide-in Panel */}
          <div
            style={{
              position: 'fixed',
              top: 0,
              right: 0,
              bottom: 0,
              width: '400px',
              background: 'white',
              boxShadow: '-4px 0 24px rgba(0, 0, 0, 0.1)',
              zIndex: 9999,
              display: 'flex',
              flexDirection: 'column',
              animation: 'slideInRight 0.3s ease-out'
            }}
          >
            {/* Panel Header */}
            <div style={{
              padding: '20px 24px',
              borderBottom: '1px solid #e5e7eb',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between'
            }}>
              <div>
                <h3 style={{ margin: '0 0 4px 0', fontSize: '18px', fontWeight: '600', color: '#111827' }}>
                  {selectedVersion.versionName || 'Version'}
                </h3>
                <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth="2">
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                  </svg>
                  <span style={{ fontSize: '13px', color: '#6b7280' }}>
                    {selectedVersion.createdAt ? new Date(selectedVersion.createdAt).toLocaleString() : ''}
                  </span>
                </div>
              </div>
              <button
                onClick={() => setShowVersionPanel(false)}
                style={{
                  background: 'none',
                  border: 'none',
                  padding: '8px',
                  cursor: 'pointer',
                  borderRadius: '6px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  transition: 'background 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.background = '#f3f4f6'}
                onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth="2">
                  <line x1="18" y1="6" x2="6" y2="18" />
                  <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
              </button>
            </div>

            {/* Panel Content */}
            <div style={{ flex: 1, overflowY: 'auto', padding: '24px' }}>
              <div style={{ marginBottom: '20px' }}>
                <h4 style={{ margin: '0 0 12px 0', fontSize: '14px', fontWeight: '600', color: '#111827', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                  Version Details
                </h4>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                  <div style={{ padding: '12px', background: '#f9fafb', borderRadius: '8px', fontSize: '13px', color: '#6b7280' }}>
                    <div style={{ marginBottom: '8px' }}>
                      <strong style={{ color: '#111827' }}>Voice ID:</strong> {selectedVersion.voiceId || 'Not set'}
                      </div>
                    <div style={{ marginBottom: '8px' }}>
                      <strong style={{ color: '#111827' }}>Description:</strong> {selectedVersion.description || 'No description'}
                        </div>
                    <div style={{ marginBottom: '8px' }}>
                      <strong style={{ color: '#111827' }}>Script Length:</strong> {selectedVersion.content?.length || 0} characters
                        </div>
                    {selectedVersion.ttsProvider && (
                      <div style={{ marginBottom: '8px' }}>
                        <strong style={{ color: '#111827' }}>TTS Provider:</strong> {selectedVersion.ttsProvider}
                      </div>
                    )}
                    </div>
                  <div style={{ padding: '12px', background: '#f0f4ff', borderRadius: '8px', fontSize: '13px', color: '#4B5CFF' }}>
                    Click "Restore Version" below to load this version into the editor
                  </div>
                </div>
              </div>
            </div>

            {/* Panel Footer */}
            <div style={{
              padding: '16px 24px',
              borderTop: '1px solid #e5e7eb',
              display: 'flex',
              gap: '12px'
            }}>
              <button
                onClick={() => setShowVersionPanel(false)}
                style={{
                  flex: 1,
                  padding: '10px 16px',
                  background: 'white',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '500',
                  color: '#374151',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = '#f9fafb';
                  e.currentTarget.style.borderColor = '#d1d5db';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'white';
                  e.currentTarget.style.borderColor = '#e5e7eb';
                }}
              >
                Close
              </button>
              {selectedVersion && (
                <button
                  onClick={() => {
                    loadVersion(selectedVersion.id);
                    setShowVersionPanel(false);
                  }}
                  style={{
                    flex: 1,
                    padding: '10px 16px',
                    background: '#4B5CFF',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    color: 'white',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '6px',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.background = '#3b4ed8';
                    e.currentTarget.style.transform = 'translateY(-1px)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.background = '#4B5CFF';
                    e.currentTarget.style.transform = 'translateY(0)';
                  }}
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="1 4 1 10 7 10" />
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
                  </svg>
                  Revert to this Version
                </button>
              )}
            </div>
          </div>

          <style>{`
            /* Monaco Editor Change Highlighting */
            .monaco-line-highlight-added {
              background-color: rgba(34, 197, 94, 0.15) !important;
            }
            .monaco-glyph-highlight-added {
              background-color: #22c55e !important;
            }
            .monaco-inline-highlight-added {
              background-color: rgba(34, 197, 94, 0.2) !important;
            }
          `}</style>
          <style>{`
            @keyframes fadeIn {
              from { opacity: 0; }
              to { opacity: 1; }
            }
            @keyframes slideInRight {
              from {
                transform: translateX(100%);
              }
              to {
                transform: translateX(0);
              }
            }
          `}</style>
        </>
      )}

      {/* Edit Script Animation Styles */}
      <style>{`
        @keyframes pulse {
          0%, 100% {
            opacity: 0.4;
            transform: scale(1);
          }
          50% {
            opacity: 1;
            transform: scale(1.1);
          }
        }
      `}</style>
    </div>
  );
}

export default Playground;

